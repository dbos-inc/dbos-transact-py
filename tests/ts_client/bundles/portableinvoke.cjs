var CS=Object.create;var $d=Object.defineProperty;var NS=Object.getOwnPropertyDescriptor;var AS=Object.getOwnPropertyNames;var PS=Object.getPrototypeOf,LS=Object.prototype.hasOwnProperty;var w=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var xS=(t,e,r,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of AS(e))!LS.call(t,n)&&n!==r&&$d(t,n,{get:()=>e[n],enumerable:!(s=NS(e,n))||s.enumerable});return t};var qS=(t,e,r)=>(r=t!=null?CS(PS(t)):{},xS(e||!t||!t.__esModule?$d(r,"default",{value:t,enumerable:!0}):r,t));var He=w(R=>{"use strict";Object.defineProperty(R,"__esModule",{value:!0});R.getDBOSErrorCode=R.DBOSAwaitedWorkflowExceededMaxRecoveryAttempts=R.DBOSInvalidQueuePriorityError=R.DBOSQueueDuplicatedError=R.QueueDedupIDDuplicated=R.DBOSAwaitedWorkflowCancelledError=R.DBOSUnexpectedStepError=R.DBOSConflictingRegistrationError=R.DBOSWorkflowCancelledError=R.DBOSMaxStepRetriesError=R.DBOSConflictingWorkflowError=R.DBOSInvalidWorkflowTransitionError=R.DBOSExecutorNotInitializedError=R.DBOSMaxRecoveryAttemptsExceededError=R.DBOSFailLoadOperationsError=R.DBOSNonExistentWorkflowError=R.DBOSConfigKeyTypeError=R.DBOSNotAuthorizedError=R.DBOSDataValidationError=R.DBOSNotRegisteredError=R.DBOSWorkflowConflictError=R.DBOSInitializationError=R.DBOSError=R.isDataValidationError=void 0;function MS(t){let e=t?.dbosErrorCode;return e?e===Wd:!1}R.isDataValidationError=MS;var oe=class extends Error{dbosErrorCode;constructor(e,r=1){super(e),this.dbosErrorCode=r}};R.DBOSError=oe;var BS=3,oa=class extends oe{error;constructor(e,r){super(e,BS),this.error=r}};R.DBOSInitializationError=oa;var $S=5,aa=class extends oe{constructor(e){super(`Conflicting WF ID ${e}`,$S)}};R.DBOSWorkflowConflictError=aa;var WS=6,la=class extends oe{constructor(e,r){let s=r??`Operation (Name: ${e}) not registered`;super(s,WS)}};R.DBOSNotRegisteredError=la;var Wd=9,ca=class extends oe{constructor(e){super(e,Wd)}};R.DBOSDataValidationError=ca;var US=12,ua=class extends oe{status;constructor(e,r=403){super(e,US),this.status=r}};R.DBOSNotAuthorizedError=ua;var FS=14,fa=class extends oe{constructor(e,r,s){super(`${e} should be of type ${r}, but got ${s}`,FS)}};R.DBOSConfigKeyTypeError=fa;var zS=16,da=class extends oe{constructor(e){super(e,zS)}};R.DBOSNonExistentWorkflowError=da;var jS=17,ha=class extends oe{constructor(e){super(e,jS)}};R.DBOSFailLoadOperationsError=ha;var VS=18,pa=class extends oe{constructor(e,r){super(`Workflow ${e} has exceeded its maximum of ${r} execution or recovery attempts. Further attempts to execute or recover it will fail.`,VS)}};R.DBOSMaxRecoveryAttemptsExceededError=pa;var GS=20,ma=class extends oe{constructor(){super("DBOS not initialized",GS)}};R.DBOSExecutorNotInitializedError=ma;var QS=21,wa=class extends oe{constructor(e){super(e??"Invalid workflow state",QS)}};R.DBOSInvalidWorkflowTransitionError=wa;var KS=22,ga=class extends oe{constructor(e,r){super(`Conflicting workflow invocation with the same ID (${e}): ${r}`,KS)}};R.DBOSConflictingWorkflowError=ga;var HS=23,ya=class extends oe{errors;constructor(e,r,s){let n=s.map((i,o)=>`Error ${o+1}: ${i.message}`).join(". ");super(`Step ${e} has exceeded its maximum of ${r} retries. Previous errors: ${n}`,HS),this.errors=s}};R.DBOSMaxStepRetriesError=ya;var JS=24,_a=class extends oe{workflowID;constructor(e){super(`Workflow ${e} has been cancelled`,JS),this.workflowID=e}};R.DBOSWorkflowCancelledError=_a;var YS=25,Sa=class extends oe{constructor(e){super(e,YS)}};R.DBOSConflictingRegistrationError=Sa;var XS=26,Ea=class extends oe{workflowID;stepID;expectedName;constructor(e,r,s,n){super(n.startsWith("DBOS.patch")?`During execution of workflow ${e} step ${r}, function ${n} was recorded when ${s} was expected.

          Check that your patches are backward compatible, that you do not have older code trying to recover workflows with newer patches, and that your workflow is deterministic.`:`During execution of workflow ${e} step ${r}, function ${n} was recorded when ${s} was expected. Check that your workflow is deterministic.`,XS),this.workflowID=e,this.stepID=r,this.expectedName=s}};R.DBOSUnexpectedStepError=Ea;var ZS=27,ba=class extends oe{workflowID;constructor(e){super(`Awaited ${e} was cancelled`,ZS),this.workflowID=e}};R.DBOSAwaitedWorkflowCancelledError=ba;R.QueueDedupIDDuplicated=28;var ka=class extends oe{workflowID;queue;deduplicationID;constructor(e,r,s){super(`Workflow ${e} was deduplicated due to an existing workflow in queue ${r} with deduplication ID ${s}.`,R.QueueDedupIDDuplicated),this.workflowID=e,this.queue=r,this.deduplicationID=s}};R.DBOSQueueDuplicatedError=ka;var eE=29,va=class extends oe{priority;min;max;constructor(e,r,s){super(`Invalid priority ${e}. Priority must be between ${r} and ${s}.`,eE),this.priority=e,this.min=r,this.max=s}};R.DBOSInvalidQueuePriorityError=va;var tE=30,Oa=class extends oe{workflowID;constructor(e){super(`Awaited ${e} exceeded its maximum recovery attempts`,tE),this.workflowID=e}};R.DBOSAwaitedWorkflowExceededMaxRecoveryAttempts=Oa;function rE(t){if(t&&typeof t=="object"&&"dbosErrorCode"in t){let e=t.dbosErrorCode;return typeof e=="number"?e:void 0}}R.getDBOSErrorCode=rE});var Wn=w((lP,Ud)=>{"use strict";var Da=class t extends Error{constructor(e){super(t._prepareSuperMessage(e)),Object.defineProperty(this,"name",{value:"NonError",configurable:!0,writable:!0}),Error.captureStackTrace&&Error.captureStackTrace(this,t)}static _prepareSuperMessage(e){try{return JSON.stringify(e)}catch{return String(e)}}},sE=[{property:"name",enumerable:!1},{property:"message",enumerable:!1},{property:"stack",enumerable:!1},{property:"code",enumerable:!0}],Ta=Symbol(".toJSON called"),nE=t=>{t[Ta]=!0;let e=t.toJSON();return delete t[Ta],e},Ia=({from:t,seen:e,to_:r,forceEnumerable:s,maxDepth:n,depth:i})=>{let o=r||(Array.isArray(t)?[]:{});if(e.push(t),i>=n)return o;if(typeof t.toJSON=="function"&&t[Ta]!==!0)return nE(t);for(let[a,l]of Object.entries(t)){if(typeof Buffer=="function"&&Buffer.isBuffer(l)){o[a]="[object Buffer]";continue}if(typeof l!="function"){if(!l||typeof l!="object"){o[a]=l;continue}if(!e.includes(t[a])){i++,o[a]=Ia({from:t[a],seen:e.slice(),forceEnumerable:s,maxDepth:n,depth:i});continue}o[a]="[Circular]"}}for(let{property:a,enumerable:l}of sE)typeof t[a]=="string"&&Object.defineProperty(o,a,{value:t[a],enumerable:s?!0:l,configurable:!0,writable:!0});return o},iE=(t,e={})=>{let{maxDepth:r=Number.POSITIVE_INFINITY}=e;return typeof t=="object"&&t!==null?Ia({from:t,seen:[],forceEnumerable:!0,maxDepth:r,depth:0}):typeof t=="function"?`[Function: ${t.name||"anonymous"}]`:t},oE=(t,e={})=>{let{maxDepth:r=Number.POSITIVE_INFINITY}=e;if(t instanceof Error)return t;if(typeof t=="object"&&t!==null&&!Array.isArray(t)){let s=new Error;return Ia({from:t,seen:[],to_:s,maxDepth:r,depth:0}),s}return new Da(t)};Ud.exports={serializeError:iE,deserializeError:oE}});var Fd=w(Un=>{"use strict";Un.__esModule=!0;Un.DoubleIndexedKV=void 0;var aE=(function(){function t(){this.keyToValue=new Map,this.valueToKey=new Map}return t.prototype.set=function(e,r){this.keyToValue.set(e,r),this.valueToKey.set(r,e)},t.prototype.getByKey=function(e){return this.keyToValue.get(e)},t.prototype.getByValue=function(e){return this.valueToKey.get(e)},t.prototype.clear=function(){this.keyToValue.clear(),this.valueToKey.clear()},t})();Un.DoubleIndexedKV=aE});var Ra=w(Fn=>{"use strict";Fn.__esModule=!0;Fn.Registry=void 0;var lE=Fd(),cE=(function(){function t(e){this.generateIdentifier=e,this.kv=new lE.DoubleIndexedKV}return t.prototype.register=function(e,r){this.kv.getByValue(e)||(r||(r=this.generateIdentifier(e)),this.kv.set(r,e))},t.prototype.clear=function(){this.kv.clear()},t.prototype.getIdentifier=function(e){return this.kv.getByValue(e)},t.prototype.getValue=function(e){return this.kv.getByKey(e)},t})();Fn.Registry=cE});var zd=w(Or=>{"use strict";var uE=Or&&Or.__extends||(function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(s,n){s.__proto__=n}||function(s,n){for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(s[i]=n[i])},t(e,r)};return function(e,r){if(typeof r!="function"&&r!==null)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");t(e,r);function s(){this.constructor=e}e.prototype=r===null?Object.create(r):(s.prototype=r.prototype,new s)}})();Or.__esModule=!0;Or.ClassRegistry=void 0;var fE=Ra(),dE=(function(t){uE(e,t);function e(){var r=t.call(this,function(s){return s.name})||this;return r.classToAllowedProps=new Map,r}return e.prototype.register=function(r,s){typeof s=="object"?(s.allowProps&&this.classToAllowedProps.set(r,s.allowProps),t.prototype.register.call(this,r,s.identifier)):t.prototype.register.call(this,r,s)},e.prototype.getAllowedProps=function(r){return this.classToAllowedProps.get(r)},e})(fE.Registry);Or.ClassRegistry=dE});var bs=w(Je=>{"use strict";var hE=Je&&Je.__read||function(t,e){var r=typeof Symbol=="function"&&t[Symbol.iterator];if(!r)return t;var s=r.call(t),n,i=[],o;try{for(;(e===void 0||e-- >0)&&!(n=s.next()).done;)i.push(n.value)}catch(a){o={error:a}}finally{try{n&&!n.done&&(r=s.return)&&r.call(s)}finally{if(o)throw o.error}}return i};Je.__esModule=!0;Je.findArr=Je.includes=Je.forEach=Je.find=void 0;function pE(t){if("values"in Object)return Object.values(t);var e=[];for(var r in t)t.hasOwnProperty(r)&&e.push(t[r]);return e}function mE(t,e){var r=pE(t);if("find"in r)return r.find(e);for(var s=r,n=0;n<s.length;n++){var i=s[n];if(e(i))return i}}Je.find=mE;function wE(t,e){Object.entries(t).forEach(function(r){var s=hE(r,2),n=s[0],i=s[1];return e(i,n)})}Je.forEach=wE;function gE(t,e){return t.indexOf(e)!==-1}Je.includes=gE;function yE(t,e){for(var r=0;r<t.length;r++){var s=t[r];if(e(s))return s}}Je.findArr=yE});var jd=w(zn=>{"use strict";zn.__esModule=!0;zn.CustomTransformerRegistry=void 0;var _E=bs(),SE=(function(){function t(){this.transfomers={}}return t.prototype.register=function(e){this.transfomers[e.name]=e},t.prototype.findApplicable=function(e){return _E.find(this.transfomers,function(r){return r.isApplicable(e)})},t.prototype.findByName=function(e){return this.transfomers[e]},t})();zn.CustomTransformerRegistry=SE});var jn=w(C=>{"use strict";C.__esModule=!0;C.isURL=C.isTypedArray=C.isInfinite=C.isBigint=C.isPrimitive=C.isNaNValue=C.isError=C.isDate=C.isSymbol=C.isSet=C.isMap=C.isRegExp=C.isBoolean=C.isNumber=C.isString=C.isArray=C.isEmptyObject=C.isPlainObject=C.isNull=C.isUndefined=void 0;var EE=function(t){return Object.prototype.toString.call(t).slice(8,-1)},bE=function(t){return typeof t>"u"};C.isUndefined=bE;var kE=function(t){return t===null};C.isNull=kE;var vE=function(t){return typeof t!="object"||t===null||t===Object.prototype?!1:Object.getPrototypeOf(t)===null?!0:Object.getPrototypeOf(t)===Object.prototype};C.isPlainObject=vE;var OE=function(t){return C.isPlainObject(t)&&Object.keys(t).length===0};C.isEmptyObject=OE;var DE=function(t){return Array.isArray(t)};C.isArray=DE;var TE=function(t){return typeof t=="string"};C.isString=TE;var IE=function(t){return typeof t=="number"&&!isNaN(t)};C.isNumber=IE;var RE=function(t){return typeof t=="boolean"};C.isBoolean=RE;var CE=function(t){return t instanceof RegExp};C.isRegExp=CE;var NE=function(t){return t instanceof Map};C.isMap=NE;var AE=function(t){return t instanceof Set};C.isSet=AE;var PE=function(t){return EE(t)==="Symbol"};C.isSymbol=PE;var LE=function(t){return t instanceof Date&&!isNaN(t.valueOf())};C.isDate=LE;var xE=function(t){return t instanceof Error};C.isError=xE;var qE=function(t){return typeof t=="number"&&isNaN(t)};C.isNaNValue=qE;var ME=function(t){return C.isBoolean(t)||C.isNull(t)||C.isUndefined(t)||C.isNumber(t)||C.isString(t)||C.isSymbol(t)};C.isPrimitive=ME;var BE=function(t){return typeof t=="bigint"};C.isBigint=BE;var $E=function(t){return t===1/0||t===-1/0};C.isInfinite=$E;var WE=function(t){return ArrayBuffer.isView(t)&&!(t instanceof DataView)};C.isTypedArray=WE;var UE=function(t){return t instanceof URL};C.isURL=UE});var Ca=w(kt=>{"use strict";kt.__esModule=!0;kt.parsePath=kt.stringifyPath=kt.escapeKey=void 0;var FE=function(t){return t.replace(/\./g,"\\.")};kt.escapeKey=FE;var zE=function(t){return t.map(String).map(kt.escapeKey).join(".")};kt.stringifyPath=zE;var jE=function(t){for(var e=[],r="",s=0;s<t.length;s++){var n=t.charAt(s),i=n==="\\"&&t.charAt(s+1)===".";if(i){r+=".",s++;continue}var o=n===".";if(o){e.push(r),r="";continue}r+=n}var a=r;return e.push(a),e};kt.parsePath=jE});var Zd=w(xe=>{"use strict";var Na=xe&&xe.__assign||function(){return Na=Object.assign||function(t){for(var e,r=1,s=arguments.length;r<s;r++){e=arguments[r];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])}return t},Na.apply(this,arguments)},Aa=xe&&xe.__read||function(t,e){var r=typeof Symbol=="function"&&t[Symbol.iterator];if(!r)return t;var s=r.call(t),n,i=[],o;try{for(;(e===void 0||e-- >0)&&!(n=s.next()).done;)i.push(n.value)}catch(a){o={error:a}}finally{try{n&&!n.done&&(r=s.return)&&r.call(s)}finally{if(o)throw o.error}}return i},Pa=xe&&xe.__spreadArray||function(t,e){for(var r=0,s=e.length,n=t.length;r<s;r++,n++)t[n]=e[r];return t};xe.__esModule=!0;xe.untransformValue=xe.transformValue=xe.isInstanceOfRegisteredClass=void 0;var Le=jn(),Vd=bs();function ht(t,e,r,s){return{isApplicable:t,annotation:e,transform:r,untransform:s}}var Gd=[ht(Le.isUndefined,"undefined",function(){return null},function(){}),ht(Le.isBigint,"bigint",function(t){return t.toString()},function(t){return typeof BigInt<"u"?BigInt(t):(console.error("Please add a BigInt polyfill."),t)}),ht(Le.isDate,"Date",function(t){return t.toISOString()},function(t){return new Date(t)}),ht(Le.isError,"Error",function(t,e){var r={name:t.name,message:t.message};return e.allowedErrorProps.forEach(function(s){r[s]=t[s]}),r},function(t,e){var r=new Error(t.message);return r.name=t.name,r.stack=t.stack,e.allowedErrorProps.forEach(function(s){r[s]=t[s]}),r}),ht(Le.isRegExp,"regexp",function(t){return""+t},function(t){var e=t.slice(1,t.lastIndexOf("/")),r=t.slice(t.lastIndexOf("/")+1);return new RegExp(e,r)}),ht(Le.isSet,"set",function(t){return Pa([],Aa(t.values()))},function(t){return new Set(t)}),ht(Le.isMap,"map",function(t){return Pa([],Aa(t.entries()))},function(t){return new Map(t)}),ht(function(t){return Le.isNaNValue(t)||Le.isInfinite(t)},"number",function(t){return Le.isNaNValue(t)?"NaN":t>0?"Infinity":"-Infinity"},Number),ht(function(t){return t===0&&1/t===-1/0},"number",function(){return"-0"},Number),ht(Le.isURL,"URL",function(t){return t.toString()},function(t){return new URL(t)})];function Vn(t,e,r,s){return{isApplicable:t,annotation:e,transform:r,untransform:s}}var Qd=Vn(function(t,e){if(Le.isSymbol(t)){var r=!!e.symbolRegistry.getIdentifier(t);return r}return!1},function(t,e){var r=e.symbolRegistry.getIdentifier(t);return["symbol",r]},function(t){return t.description},function(t,e,r){var s=r.symbolRegistry.getValue(e[1]);if(!s)throw new Error("Trying to deserialize unknown symbol");return s}),VE=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array,Uint8ClampedArray].reduce(function(t,e){return t[e.name]=e,t},{}),Kd=Vn(Le.isTypedArray,function(t){return["typed-array",t.constructor.name]},function(t){return Pa([],Aa(t))},function(t,e){var r=VE[e[1]];if(!r)throw new Error("Trying to deserialize unknown typed array");return new r(t)});function Hd(t,e){if(t?.constructor){var r=!!e.classRegistry.getIdentifier(t.constructor);return r}return!1}xe.isInstanceOfRegisteredClass=Hd;var Jd=Vn(Hd,function(t,e){var r=e.classRegistry.getIdentifier(t.constructor);return["class",r]},function(t,e){var r=e.classRegistry.getAllowedProps(t.constructor);if(!r)return Na({},t);var s={};return r.forEach(function(n){s[n]=t[n]}),s},function(t,e,r){var s=r.classRegistry.getValue(e[1]);if(!s)throw new Error("Trying to deserialize unknown class - check https://github.com/blitz-js/superjson/issues/116#issuecomment-773996564");return Object.assign(Object.create(s.prototype),t)}),Yd=Vn(function(t,e){return!!e.customTransformerRegistry.findApplicable(t)},function(t,e){var r=e.customTransformerRegistry.findApplicable(t);return["custom",r.name]},function(t,e){var r=e.customTransformerRegistry.findApplicable(t);return r.serialize(t)},function(t,e,r){var s=r.customTransformerRegistry.findByName(e[1]);if(!s)throw new Error("Trying to deserialize unknown custom value");return s.deserialize(t)}),GE=[Jd,Qd,Yd,Kd],QE=function(t,e){var r=Vd.findArr(GE,function(n){return n.isApplicable(t,e)});if(r)return{value:r.transform(t,e),type:r.annotation(t,e)};var s=Vd.findArr(Gd,function(n){return n.isApplicable(t,e)});if(s)return{value:s.transform(t,e),type:s.annotation}};xe.transformValue=QE;var Xd={};Gd.forEach(function(t){Xd[t.annotation]=t});var KE=function(t,e,r){if(Le.isArray(e))switch(e[0]){case"symbol":return Qd.untransform(t,e,r);case"class":return Jd.untransform(t,e,r);case"custom":return Yd.untransform(t,e,r);case"typed-array":return Kd.untransform(t,e,r);default:throw new Error("Unknown transformation: "+e)}else{var s=Xd[e];if(!s)throw new Error("Unknown transformation: "+e);return s.untransform(t,r)}};xe.untransformValue=KE});var th=w(Tr=>{"use strict";Tr.__esModule=!0;Tr.setDeep=Tr.getDeep=void 0;var pt=jn(),La=bs(),Dr=function(t,e){for(var r=t.keys();e>0;)r.next(),e--;return r.next().value};function eh(t){if(La.includes(t,"__proto__"))throw new Error("__proto__ is not allowed as a property");if(La.includes(t,"prototype"))throw new Error("prototype is not allowed as a property");if(La.includes(t,"constructor"))throw new Error("constructor is not allowed as a property")}var HE=function(t,e){eh(e);for(var r=0;r<e.length;r++){var s=e[r];if(pt.isSet(t))t=Dr(t,+s);else if(pt.isMap(t)){var n=+s,i=+e[++r]==0?"key":"value",o=Dr(t,n);switch(i){case"key":t=o;break;case"value":t=t.get(o);break}}else t=t[s]}return t};Tr.getDeep=HE;var JE=function(t,e,r){if(eh(e),e.length===0)return r(t);for(var s=t,n=0;n<e.length-1;n++){var i=e[n];if(pt.isArray(s)){var o=+i;s=s[o]}else if(pt.isPlainObject(s))s=s[i];else if(pt.isSet(s)){var a=+i;s=Dr(s,a)}else if(pt.isMap(s)){var l=n===e.length-2;if(l)break;var a=+i,c=+e[++n]==0?"key":"value",u=Dr(s,a);switch(c){case"key":s=u;break;case"value":s=s.get(u);break}}}var f=e[e.length-1];if(pt.isArray(s)?s[+f]=r(s[+f]):pt.isPlainObject(s)&&(s[f]=r(s[f])),pt.isSet(s)){var d=Dr(s,+f),p=r(d);d!==p&&(s.delete(d),s.add(p))}if(pt.isMap(s)){var a=+e[e.length-2],m=Dr(s,a),c=+f==0?"key":"value";switch(c){case"key":{var h=r(m);s.set(h,s.get(m)),h!==m&&s.delete(m);break}case"value":{s.set(m,r(s.get(m)));break}}}return t};Tr.setDeep=JE});var rh=w(Ne=>{"use strict";var vt=Ne&&Ne.__read||function(t,e){var r=typeof Symbol=="function"&&t[Symbol.iterator];if(!r)return t;var s=r.call(t),n,i=[],o;try{for(;(e===void 0||e-- >0)&&!(n=s.next()).done;)i.push(n.value)}catch(a){o={error:a}}finally{try{n&&!n.done&&(r=s.return)&&r.call(s)}finally{if(o)throw o.error}}return i},qt=Ne&&Ne.__spreadArray||function(t,e){for(var r=0,s=e.length,n=t.length;r<s;r++,n++)t[n]=e[r];return t};Ne.__esModule=!0;Ne.walker=Ne.generateReferentialEqualityAnnotations=Ne.applyReferentialEqualityAnnotations=Ne.applyValueAnnotations=void 0;var Ve=jn(),Gn=Ca(),Kn=Zd(),or=bs(),ks=Ca(),Qn=th();function xa(t,e,r){if(r===void 0&&(r=[]),!!t){if(!Ve.isArray(t)){or.forEach(t,function(o,a){return xa(o,e,qt(qt([],vt(r)),vt(ks.parsePath(a))))});return}var s=vt(t,2),n=s[0],i=s[1];i&&or.forEach(i,function(o,a){xa(o,e,qt(qt([],vt(r)),vt(ks.parsePath(a))))}),e(n,r)}}function YE(t,e,r){return xa(e,function(s,n){t=Qn.setDeep(t,n,function(i){return Kn.untransformValue(i,s,r)})}),t}Ne.applyValueAnnotations=YE;function XE(t,e){function r(o,a){var l=Qn.getDeep(t,ks.parsePath(a));o.map(ks.parsePath).forEach(function(c){t=Qn.setDeep(t,c,function(){return l})})}if(Ve.isArray(e)){var s=vt(e,2),n=s[0],i=s[1];n.forEach(function(o){t=Qn.setDeep(t,ks.parsePath(o),function(){return t})}),i&&or.forEach(i,r)}else or.forEach(e,r);return t}Ne.applyReferentialEqualityAnnotations=XE;var ZE=function(t,e){return Ve.isPlainObject(t)||Ve.isArray(t)||Ve.isMap(t)||Ve.isSet(t)||Kn.isInstanceOfRegisteredClass(t,e)};function eb(t,e,r){var s=r.get(t);s?s.push(e):r.set(t,[e])}function tb(t,e){var r={},s=void 0;return t.forEach(function(n){if(!(n.length<=1)){e||(n=n.map(function(l){return l.map(String)}).sort(function(l,c){return l.length-c.length}));var i=vt(n),o=i[0],a=i.slice(1);o.length===0?s=a.map(Gn.stringifyPath):r[Gn.stringifyPath(o)]=a.map(Gn.stringifyPath)}}),s?Ve.isEmptyObject(r)?[s]:[s,r]:Ve.isEmptyObject(r)?void 0:r}Ne.generateReferentialEqualityAnnotations=tb;var rb=function(t,e,r,s,n,i,o){var a;n===void 0&&(n=[]),i===void 0&&(i=[]),o===void 0&&(o=new Map);var l=Ve.isPrimitive(t);if(!l){eb(t,n,e);var c=o.get(t);if(c)return s?{transformedValue:null}:c}if(!ZE(t,r)){var u=Kn.transformValue(t,r),f=u?{transformedValue:u.value,annotations:[u.type]}:{transformedValue:t};return l||o.set(t,f),f}if(or.includes(i,t))return{transformedValue:null};var d=Kn.transformValue(t,r),p=(a=d?.value)!==null&&a!==void 0?a:t,m=Ve.isArray(p)?[]:{},h={};or.forEach(p,function(y,E){var b=Ne.walker(y,e,r,s,qt(qt([],vt(n)),[E]),qt(qt([],vt(i)),[t]),o);m[E]=b.transformedValue,Ve.isArray(b.annotations)?h[E]=b.annotations:Ve.isPlainObject(b.annotations)&&or.forEach(b.annotations,function(v,I){h[Gn.escapeKey(E)+"."+I]=v})});var g=Ve.isEmptyObject(h)?{transformedValue:m,annotations:d?[d.type]:void 0}:{transformedValue:m,annotations:d?[d.type,h]:h};return l||o.set(t,g),g};Ne.walker=rb});var lh=w($=>{"use strict";function ae(t){return Object.prototype.toString.call(t).slice(8,-1)}function sh(t){return ae(t)==="Object"}function qa(t){return ae(t)==="Array"}function sb(t){return ae(t)==="Blob"}function nh(t){return ae(t)==="Boolean"}function nb(t){return ae(t)==="Date"&&!isNaN(t)}function ib(t){return qa(t)&&t.length===0}function Hn(t){if(ae(t)!=="Object")return!1;let e=Object.getPrototypeOf(t);return!!e&&e.constructor===Object&&e===Object.prototype}function ob(t){return Hn(t)&&Object.keys(t).length===0}function ab(t){return t===""}function lb(t){return ae(t)==="Error"||t instanceof Error}function cb(t){return ae(t)==="File"}function ub(t){return qa(t)&&t.length>0}function fb(t){return Hn(t)&&Object.keys(t).length>0}function Ma(t){return ae(t)==="String"}function db(t){return Ma(t)&&t!==""}function hb(t){return typeof t=="function"}function ih(t,e){if(!(e instanceof Function))throw new TypeError("Type must be a function");if(!Object.prototype.hasOwnProperty.call(e,"prototype"))throw new TypeError("Type is not a class");let r=e.name;return ae(t)===r||!!(t&&t.constructor===e)}function pb(t,e){if(typeof e=="function"){for(let r=t;r;r=Object.getPrototypeOf(r))if(ih(r,e))return!0;return!1}else{for(let r=t;r;r=Object.getPrototypeOf(r))if(ae(r)===e)return!0;return!1}}function mb(t){return ae(t)==="Map"}function wb(t){return ae(t)==="Number"&&isNaN(t)}function Jn(t){return ae(t)==="Number"&&!isNaN(t)}function gb(t){return Jn(t)&&t<0}function Ba(t){return ae(t)==="Null"}function oh(t,e,r,s,n){return i=>t(i)||e(i)||!!r&&r(i)||!!s&&s(i)||!!n&&n(i)}function $a(t){return ae(t)==="Undefined"}var yb=oh(Ba,$a);function _b(t){return Hn(t)}function Sb(t){return sh(t)}function Eb(t){return Jn(t)&&t>0}function ah(t){return ae(t)==="Symbol"}function bb(t){return nh(t)||Ba(t)||$a(t)||Jn(t)||Ma(t)||ah(t)}function kb(t){return ae(t)==="Promise"}function vb(t){return ae(t)==="RegExp"}function Ob(t){return ae(t)==="Set"}function Db(t){return ae(t)==="WeakMap"}function Tb(t){return ae(t)==="WeakSet"}$.getType=ae;$.isAnyObject=sh;$.isArray=qa;$.isBlob=sb;$.isBoolean=nh;$.isDate=nb;$.isEmptyArray=ib;$.isEmptyObject=ob;$.isEmptyString=ab;$.isError=lb;$.isFile=cb;$.isFullArray=ub;$.isFullObject=fb;$.isFullString=db;$.isFunction=hb;$.isInstanceOf=pb;$.isMap=mb;$.isNaNValue=wb;$.isNegativeNumber=gb;$.isNull=Ba;$.isNullOrUndefined=yb;$.isNumber=Jn;$.isObject=_b;$.isObjectLike=Sb;$.isOneOf=oh;$.isPlainObject=Hn;$.isPositiveNumber=Eb;$.isPrimitive=bb;$.isPromise=kb;$.isRegExp=vb;$.isSet=Ob;$.isString=Ma;$.isSymbol=ah;$.isType=ih;$.isUndefined=$a;$.isWeakMap=Db;$.isWeakSet=Tb});var uh=w(ch=>{"use strict";var Wa=lh();function Ib(t,e,r,s,n){let i={}.propertyIsEnumerable.call(s,e)?"enumerable":"nonenumerable";i==="enumerable"&&(t[e]=r),n&&i==="nonenumerable"&&Object.defineProperty(t,e,{value:r,enumerable:!1,writable:!0,configurable:!0})}function Ua(t,e={}){if(Wa.isArray(t))return t.map(n=>Ua(n,e));if(!Wa.isPlainObject(t))return t;let r=Object.getOwnPropertyNames(t),s=Object.getOwnPropertySymbols(t);return[...r,...s].reduce((n,i)=>{if(Wa.isArray(e.props)&&!e.props.includes(i))return n;let o=t[i],a=Ua(o,e);return Ib(n,i,a,t,e.nonenumerable),n},{})}ch.copy=Ua});var fh=w(X=>{"use strict";var ar=X&&X.__assign||function(){return ar=Object.assign||function(t){for(var e,r=1,s=arguments.length;r<s;r++){e=arguments[r];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])}return t},ar.apply(this,arguments)},Rb=X&&X.__read||function(t,e){var r=typeof Symbol=="function"&&t[Symbol.iterator];if(!r)return t;var s=r.call(t),n,i=[],o;try{for(;(e===void 0||e-- >0)&&!(n=s.next()).done;)i.push(n.value)}catch(a){o={error:a}}finally{try{n&&!n.done&&(r=s.return)&&r.call(s)}finally{if(o)throw o.error}}return i},Cb=X&&X.__spreadArray||function(t,e){for(var r=0,s=e.length,n=t.length;r<s;r++,n++)t[n]=e[r];return t};X.__esModule=!0;X.allowErrorProps=X.registerSymbol=X.registerCustom=X.registerClass=X.parse=X.stringify=X.deserialize=X.serialize=X.SuperJSON=void 0;var Nb=zd(),Ab=Ra(),Pb=jd(),Yn=rh(),Lb=uh(),mt=(function(){function t(e){var r=e===void 0?{}:e,s=r.dedupe,n=s===void 0?!1:s;this.classRegistry=new Nb.ClassRegistry,this.symbolRegistry=new Ab.Registry(function(i){var o;return(o=i.description)!==null&&o!==void 0?o:""}),this.customTransformerRegistry=new Pb.CustomTransformerRegistry,this.allowedErrorProps=[],this.dedupe=n}return t.prototype.serialize=function(e){var r=new Map,s=Yn.walker(e,r,this,this.dedupe),n={json:s.transformedValue};s.annotations&&(n.meta=ar(ar({},n.meta),{values:s.annotations}));var i=Yn.generateReferentialEqualityAnnotations(r,this.dedupe);return i&&(n.meta=ar(ar({},n.meta),{referentialEqualities:i})),n},t.prototype.deserialize=function(e){var r=e.json,s=e.meta,n=Lb.copy(r);return s?.values&&(n=Yn.applyValueAnnotations(n,s.values,this)),s?.referentialEqualities&&(n=Yn.applyReferentialEqualityAnnotations(n,s.referentialEqualities)),n},t.prototype.stringify=function(e){return JSON.stringify(this.serialize(e))},t.prototype.parse=function(e){return this.deserialize(JSON.parse(e))},t.prototype.registerClass=function(e,r){this.classRegistry.register(e,r)},t.prototype.registerSymbol=function(e,r){this.symbolRegistry.register(e,r)},t.prototype.registerCustom=function(e,r){this.customTransformerRegistry.register(ar({name:r},e))},t.prototype.allowErrorProps=function(){for(var e,r=[],s=0;s<arguments.length;s++)r[s]=arguments[s];(e=this.allowedErrorProps).push.apply(e,Cb([],Rb(r)))},t.defaultInstance=new t,t.serialize=t.defaultInstance.serialize.bind(t.defaultInstance),t.deserialize=t.defaultInstance.deserialize.bind(t.defaultInstance),t.stringify=t.defaultInstance.stringify.bind(t.defaultInstance),t.parse=t.defaultInstance.parse.bind(t.defaultInstance),t.registerClass=t.defaultInstance.registerClass.bind(t.defaultInstance),t.registerSymbol=t.defaultInstance.registerSymbol.bind(t.defaultInstance),t.registerCustom=t.defaultInstance.registerCustom.bind(t.defaultInstance),t.allowErrorProps=t.defaultInstance.allowErrorProps.bind(t.defaultInstance),t})();X.SuperJSON=mt;X.default=mt;X.serialize=mt.serialize;X.deserialize=mt.deserialize;X.stringify=mt.stringify;X.parse=mt.parse;X.registerClass=mt.registerClass;X.registerCustom=mt.registerCustom;X.registerSymbol=mt.registerSymbol;X.allowErrorProps=mt.allowErrorProps});var dh=w(Xn=>{"use strict";Object.defineProperty(Xn,"__esModule",{value:!0});Xn.PortableWorkflowError=void 0;var Fa=class extends Error{name;code;data;constructor(e,r,s,n){super(e),this.name=r,this.code=s,this.data=n}};Xn.PortableWorkflowError=Fa});var Ot=w(k=>{"use strict";var xb=k&&k.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(k,"__esModule",{value:!0});k.serializeResErrorWithSerializer=k.serializeResError=k.serializeArgs=k.serializeValue=k.safeParseError=k.safeParsePositionalArgs=k.safeParse=k.deserializeResError=k.deserializePositionalArgs=k.deserializeValue=k.serializeFunctionInputOutputWithSerializer=k.serializeFunctionInputOutput=k.DBOSPortableJSON=k.DBOSJSON=k.SERIALIZER_MARKER_VALUE=k.SERIALIZER_MARKER_KEY=k.DBOSJSONLegacy=k.DBOSReviver=k.DBOSReplacer=k.registerSerializationRecipe=void 0;var Zn=Wn(),ja=xb(fh()),qb=dh();function mh(t){ja.default.registerCustom(t,t.name)}k.registerSerializationRecipe=mh;mh({isApplicable:t=>Buffer.isBuffer(t),serialize:t=>Array.from(t),deserialize:t=>Buffer.from(t),name:"Buffer"});function wh(t,e){let r=this[t];return r instanceof Date?{dbos_type:"dbos_Date",dbos_data:r.toISOString()}:typeof r=="bigint"?{dbos_type:"dbos_BigInt",dbos_data:r.toString()}:e}k.DBOSReplacer=wh;function Mb(t){return typeof t=="object"&&t!==null&&t.type==="Buffer"}function Bb(t){return typeof t=="object"&&t!==null&&t.dbos_type==="dbos_Date"}function $b(t){return typeof t=="object"&&t!==null&&t.dbos_type==="dbos_BigInt"}function gh(t,e){switch(!0){case Mb(e):return Buffer.from(e.data);case Bb(e):return new Date(Date.parse(e.dbos_data));case $b(e):return BigInt(e.dbos_data);default:return e}}k.DBOSReviver=gh;k.DBOSJSONLegacy={name:()=>"js_legacy",parse:t=>t===null?null:JSON.parse(t,gh),stringify:t=>JSON.stringify(t,wh)};k.SERIALIZER_MARKER_KEY="__dbos_serializer";k.SERIALIZER_MARKER_VALUE="superjson";var Wb=`"${k.SERIALIZER_MARKER_KEY}":"${k.SERIALIZER_MARKER_VALUE}"`;function Ub(t){return typeof t=="object"&&t!==null&&k.SERIALIZER_MARKER_KEY in t&&t[k.SERIALIZER_MARKER_KEY]===k.SERIALIZER_MARKER_VALUE&&"json"in t}function Fb(t){let e=ja.default.serialize(t);return JSON.stringify({...e,[k.SERIALIZER_MARKER_KEY]:k.SERIALIZER_MARKER_VALUE})}k.DBOSJSON={name:()=>"js_superjson",parse:t=>{if(t==null)return null;if(t.includes(Wb)){let r=JSON.parse(t);if(Ub(r))return ja.default.deserialize(r)}return k.DBOSJSONLegacy.parse(t)},stringify:Fb};function zb(t,e){if(e instanceof Date)return e.toISOString();if(typeof e=="bigint")return e.toString(10);if(e instanceof Map){let r=!0;for(let n of e.keys())if(typeof n!="string"){r=!1;break}if(!r)throw new TypeError("Attempt to do portable JSON serialization of a map with non-string keys");let s={};for(let[n,i]of e.entries())s[n]=i;return s}return e instanceof Set?Array.from(e.values()):e instanceof Error?{name:e.name,message:e.message}:e}k.DBOSPortableJSON={name:()=>"portable_json",parse:t=>t===null?null:JSON.parse(t),stringify:t=>JSON.stringify(t,zb)};function jb(t,e=[],r,s){let n=s==="portable"?k.DBOSPortableJSON.name():s==="native"?k.DBOSJSON.name():r.name();return yh(t,e,r,n)}k.serializeFunctionInputOutput=jb;function yh(t,e=[],r,s){for(let a of[k.DBOSPortableJSON,k.DBOSJSON])if(s===a.name()){let l=a.stringify(t),c=a.parse(l);return ph(c)&&hh(t,c,e),{deserialized:c,stringified:l,sername:a.name()}}let n=r.name();if(s&&s!==n)throw new TypeError(`Serializer provided (${n}) is not compatible with the required serialization (${s})`);let i=r.stringify(t),o=r.parse(i);return r.name()===k.DBOSJSON.name()&&ph(o)&&hh(t,o,e),{deserialized:o,stringified:i,sername:n}}k.serializeFunctionInputOutputWithSerializer=yh;function hh(t,e,r=[]){let s=new WeakSet,n=[{o:t,d:e,p:r}];for(;n.length;){let{o:i,d:o,p:a}=n.pop();if(!s.has(i)){s.add(i);for(let l of Gb(i))l in o||Vb(o,l,a);for(let l of _h(i))try{let c=i[l],u=o[l];if(!za(c,u))continue;n.push({o:c,d:u,p:[...a,l]})}catch{}if(i instanceof Map&&o instanceof Map)for(let[l,c]of i){let u=o.get(l);if(za(c,u)){let f=Kb(l)?String(l):"[MapValue]";n.push({o:c,d:u,p:[...a,f]})}}if(i instanceof Set&&o instanceof Set){let l=Array.from(i),c=Array.from(o);for(let u=0;u<Math.min(l.length,c.length);u++){let f=l[u],d=c[u];za(f,d)&&n.push({o:f,d,p:[...a,u]})}}}}}function ph(t){return typeof t=="object"&&t!==null||typeof t=="function"}function Vb(t,e,r){let s=function(...n){throw new Error(`Attempted to call '${String(e)}' at path ${Qb(r)} on an object that is a serialized function input our output value. Functions are not preserved through serialization; see 'DBOS.registerSerialization'. `)};try{Object.defineProperty(t,e,{value:s,configurable:!0,writable:!1,enumerable:!1})}catch{t[e]=s}}function za(t,e){return!(!t||!e||typeof t!="object"||typeof e!="object"||[Date,RegExp,WeakMap,WeakSet,ArrayBuffer,DataView].some(s=>t instanceof s))}function _h(t){let e=Object.getOwnPropertyNames(t),r=Object.getOwnPropertySymbols(t);return[...e,...r]}function Gb(t){let e=new Set;for(let s of _h(t)){let n=Object.getOwnPropertyDescriptor(t,s);n&&"value"in n&&typeof n.value=="function"&&e.add(s)}let r=Object.getPrototypeOf(t);for(;r&&r!==Object.prototype;){for(let s of Object.getOwnPropertyNames(r)){if(s==="constructor")continue;let n=Object.getOwnPropertyDescriptor(r,s);n&&"value"in n&&typeof n.value=="function"&&e.add(s)}r=Object.getPrototypeOf(r)}return Array.from(e)}function Qb(t){return t.length===0?"(root)":t.map(e=>typeof e=="number"?`[${e}]`:typeof e=="symbol"?`[${String(e)}]`:/^<?[A-Za-z_$][A-Za-z0-9_$]*>?$/.test(e)?`.${e}`:`[${JSON.stringify(e)}]`).join("").replace(/^\./,"")}function Kb(t){return typeof t=="string"||typeof t=="number"}function Sh(t,e,r){if(e===k.DBOSPortableJSON.name())return k.DBOSPortableJSON.parse(t);if(e===k.DBOSJSON.name())return k.DBOSJSON.parse(t);if(!e||e===r.name())return r.parse(t);throw new TypeError(`Value deserialization type ${e} is not available`)}k.deserializeValue=Sh;function Eh(t,e,r){if(e===k.DBOSPortableJSON.name())return k.DBOSPortableJSON.parse(t).positionalArgs??[];if(e===k.DBOSJSON.name())return k.DBOSJSON.parse(t);if(!e||e===r.name())return r.parse(t);throw new TypeError(`Value deserialization type ${e} is not available`)}k.deserializePositionalArgs=Eh;function bh(t,e,r){if(e===k.DBOSPortableJSON.name()){let s=k.DBOSPortableJSON.parse(t);throw new qb.PortableWorkflowError(s.message,s.name,s.code,s.data)}if(e===k.DBOSJSON.name())return(0,Zn.deserializeError)(k.DBOSJSON.parse(t));if(!e||e===r.name())return(0,Zn.deserializeError)(r.parse(t));throw new TypeError(`Value deserialization type ${e} is not available`)}k.deserializeResError=bh;function Hb(t,e,r){try{return Sh(e,r,t)}catch{return e}}k.safeParse=Hb;function Jb(t,e,r){try{return Eh(e,r,t)}catch{return e}}k.safeParsePositionalArgs=Jb;function Yb(t,e,r){try{return bh(e,r,t)}catch{return new Error(e)}}k.safeParseError=Yb;function Xb(t,e,r){return r==="portable"?{serializedValue:k.DBOSPortableJSON.stringify(t),serialization:k.DBOSPortableJSON.name()}:r==="native"?{serializedValue:k.DBOSJSON.stringify(t),serialization:k.DBOSJSON.name()}:{serializedValue:e.stringify(t),serialization:e.name()}}k.serializeValue=Xb;function Zb(t,e,r,s){if(s==="portable")return{serializedValue:k.DBOSPortableJSON.stringify({positionalArgs:t,namedArgs:e}),serialization:k.DBOSPortableJSON.name()};if(e)throw new TypeError(`Serialization format '${s}' does not currently support named args.`);return s==="native"?{serializedValue:k.DBOSJSON.stringify(t),serialization:k.DBOSJSON.name()}:{serializedValue:r.stringify(t),serialization:r.name()}}k.serializeArgs=Zb;function ek(t,e,r){let s=r==="portable"?k.DBOSPortableJSON.name():r==="native"?k.DBOSJSON.name():e.name();return kh(t,e,s)}k.serializeResError=ek;function kh(t,e,r){return r===k.DBOSPortableJSON.name()?{serializedValue:k.DBOSPortableJSON.stringify({name:t.name,message:t.message,code:t.code,data:t.data}),serialization:k.DBOSPortableJSON.name()}:r===k.DBOSJSON.name()?{serializedValue:k.DBOSJSON.stringify((0,Zn.serializeError)(t)),serialization:k.DBOSJSON.name()}:{serializedValue:e.stringify((0,Zn.serializeError)(t)),serialization:e.name()}}k.serializeResErrorWithSerializer=kh});var Ir=w(qe=>{"use strict";Object.defineProperty(qe,"__esModule",{value:!0});qe.RetrievedHandle=qe.InvokedHandle=qe.isWorkflowActive=qe.StatusString=qe.DEFAULT_MAX_RECOVERY_ATTEMPTS=void 0;var Va=Ot(),ei=Os(),tk=lr();qe.DEFAULT_MAX_RECOVERY_ATTEMPTS=100;qe.StatusString={PENDING:"PENDING",SUCCESS:"SUCCESS",ERROR:"ERROR",MAX_RECOVERY_ATTEMPTS_EXCEEDED:"MAX_RECOVERY_ATTEMPTS_EXCEEDED",CANCELLED:"CANCELLED",ENQUEUED:"ENQUEUED"};function rk(t){return t===qe.StatusString.PENDING||t===qe.StatusString.ENQUEUED}qe.isWorkflowActive=rk;var ti=class{systemDatabase;workflowPromise;workflowUUID;workflowName;constructor(e,r,s,n){this.systemDatabase=e,this.workflowPromise=r,this.workflowUUID=s,this.workflowName=n}getWorkflowUUID(){return this.workflowUUID}get workflowID(){return this.workflowUUID}async getStatus(){return await ei.DBOS.getWorkflowStatus(this.workflowUUID)}async getResult(e){return await(0,ei.runInternalStep)(async()=>await this.workflowPromise,"DBOS.getResult",this.workflowUUID,e)}async getWorkflowInputs(){let e=await this.systemDatabase.getWorkflowStatus(this.workflowUUID);return(0,Va.deserializePositionalArgs)(e.input,e.serialization,this.systemDatabase.getSerializer())}};qe.InvokedHandle=ti;var vs=class{systemDatabase;workflowUUID;constructor(e,r){this.systemDatabase=e,this.workflowUUID=r}getWorkflowUUID(){return this.workflowUUID}get workflowID(){return this.workflowUUID}async getStatus(){return await ei.DBOS.getWorkflowStatus(this.workflowUUID)}async getResult(e){return await ei.DBOS.getResultInternal(this.workflowUUID,void 0,void 0,e)}async getWorkflowInputs(){let e=await this.systemDatabase.getWorkflowStatus(this.workflowUUID);return(0,Va.deserializePositionalArgs)(e.input,e.serialization,this.systemDatabase.getSerializer())}};qe.RetrievedHandle=vs;(0,Va.registerSerializationRecipe)({name:"DBOS.WorkflowHandle",isApplicable:t=>t instanceof vs||t instanceof ti,serialize:t=>({wfid:t.workflowID}),deserialize:t=>new vs(tk.DBOSExecutor.globalInstance.systemDatabase,t.wfid)})});var vh=w(ri=>{"use strict";Object.defineProperty(ri,"__esModule",{value:!0});ri.TelemetryCollector=void 0;var Ga=class{data=[];push(e){this.data.push(e)}pop(){return this.data.shift()}size(){return this.data.length}},Qa=class{exporter;signals=new Ga;signalBufferID;processAndExportSignalsIntervalMs=100;constructor(e){this.exporter=e,this.signalBufferID=setInterval(()=>{this.processAndExportSignals()},this.processAndExportSignalsIntervalMs)}async destroy(){clearInterval(this.signalBufferID),await this.processAndExportSignals(),await this.exporter?.flush()}push(e){this.signals.push(e)}pop(){return this.signals.pop()}async processAndExportSignals(){let e=[];for(;this.signals.size()>0;){let r=this.pop();if(!r)break;e.push(r)}if(e.length>0&&this.exporter)try{await this.exporter.export(e)}catch(r){console.error(r.message)}}};ri.TelemetryCollector=Qa});var Oe=w(se=>{"use strict";var Oh=se&&se.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(se,"__esModule",{value:!0});se.getClientConfig=se.interceptStreams=se.exhaustiveCheckGuard=se.cancellableSleep=se.DEBOUNCER_WORKLOW_NAME=se.INTERNAL_QUEUE_NAME=se.sleepms=se.globalParams=se.defaultEnableOTLP=se.readFile=void 0;var Dh=Oh(require("node:fs")),Rr=Oh(require("node:path"));async function sk(t,e="utf8"){return await Dh.default.promises.readFile(t,{encoding:e})}se.readFile=sk;function nk(){try{let t=function(s){if(typeof s=="string"&&(s.endsWith(Rr.default.sep)||(s+=Rr.default.sep),s=s.split(Rr.default.sep)),s.length===0)throw new Error("package.json not found in path");s.pop();let n=s.join(Rr.default.sep);return Dh.default.existsSync(Rr.default.join(n,"package.json"))?n:t(s)},e=Rr.default.join(t(__dirname),"package.json");return require(e).version}catch{return"unknown"}}function Th(){return process.env.DBOS__CLOUD==="true"}se.defaultEnableOTLP=Th;se.globalParams={appVersion:process.env.DBOS__APPVERSION||"",wasComputed:!1,executorID:process.env.DBOS__VMID||"local",appID:process.env.DBOS__APPID||"",enableOTLP:Th(),dbosVersion:nk()};var ik=t=>new Promise(e=>setTimeout(e,t));se.sleepms=ik;se.INTERNAL_QUEUE_NAME="_dbos_internal_queue";se.DEBOUNCER_WORKLOW_NAME="_dbos_debouncer_workflow";function ok(t){let e,r,s=!1;return{promise:new Promise(o=>{r=()=>{s||(s=!0,o(),e=void 0)},e=setTimeout(r,t)}),cancel:()=>{e&&(clearTimeout(e),e=void 0,r())}}}se.cancellableSleep=ok;function ak(t){throw new Error("Exaustive matching is not applied")}se.exhaustiveCheckGuard=ak;var lk=process.stdout.write.bind(process.stdout),ck=process.stderr.write.bind(process.stderr);function uk(t){let e=(r,s)=>(n,i,o)=>{let a=n.toString();return t(a,r),typeof i=="function"?s(n,i):s(n,i,o)};process.stdout.write=e("stdout",lk),process.stderr.write=e("stderr",ck)}se.interceptStreams=uk;function fk(t){let e=typeof t=="string"?t:t.toString(),r=s(typeof t=="string"?new URL(t):t);return{connectionString:e,connectionTimeoutMillis:r?r*1e3:1e4};function s(n){try{let i=n.searchParams.get("connect_timeout");return i?Number.parseInt(i,10):void 0}catch{return}}}se.getClientConfig=fk});var Ha=w(Me=>{"use strict";Object.defineProperty(Me,"__esModule",{value:!0});Me.Tracer=Me.installTraceContextManager=Me.isTraceContextWorking=Me.getActiveSpan=Me.runWithTrace=Me.SpanStatusCode=void 0;var at=Oe(),Ih;(function(t){t[t.UNSET=0]="UNSET",t[t.OK=1]="OK",t[t.ERROR=2]="ERROR"})(Ih||(Me.SpanStatusCode=Ih={}));var si=class{attributes={};setStatus(e){return this}setAttribute(e,r){return this}addEvent(e,r,s){return this}};function dk(t,e){if(!at.globalParams.enableOTLP)return e();let{context:r,trace:s}=require("@opentelemetry/api");return r.with(s.setSpan(r.active(),t),e)}Me.runWithTrace=dk;function hk(){if(!at.globalParams.enableOTLP)return;let{trace:t}=require("@opentelemetry/api");return t.getActiveSpan()}Me.getActiveSpan=hk;function pk(){if(!at.globalParams.enableOTLP)return!1;let{context:t,trace:e}=require("@opentelemetry/api"),r=e.getTracer("otel-bootstrap-check").startSpan("probe"),s=e.setSpan(t.active(),r),n;return t.with(s,()=>{n=e.getSpan(t.active())===r}),r.end?.(),n===!0}Me.isTraceContextWorking=pk;function mk(t="dbos"){if(!at.globalParams.enableOTLP)return;let{AsyncLocalStorageContextManager:e}=require("@opentelemetry/context-async-hooks"),{context:r,trace:s}=require("@opentelemetry/api"),{BasicTracerProvider:n}=require("@opentelemetry/sdk-trace-base"),i=new e;i.enable(),r.setGlobalContextManager(i);let o=new n({resource:{attributes:{"service.name":t}}});s.setGlobalTracerProvider(o)}Me.installTraceContextManager=mk;var Ka=class{telemetryCollector;applicationID;executorID;constructor(e,r="dbos"){if(this.telemetryCollector=e,this.applicationID=at.globalParams.appID,this.executorID=at.globalParams.executorID,!at.globalParams.enableOTLP)return;let{trace:s}=require("@opentelemetry/api"),{BasicTracerProvider:n}=require("@opentelemetry/sdk-trace-base"),i=new n({resource:{attributes:{"service.name":r}}});s.setGlobalTracerProvider(i)}startSpanWithContext(e,r,s){if(!at.globalParams.enableOTLP)return new si;let n=require("@opentelemetry/api"),i=n.trace.getTracer("dbos-tracer"),o=n.trace.setSpanContext(n.context.active(),e);return i.startSpan(r,{startTime:performance.now(),attributes:s},o)}startSpan(e,r,s){if(!at.globalParams.enableOTLP)return new si;let n=s,i=require("@opentelemetry/api"),{hrTime:o}=require("@opentelemetry/core"),a=i.trace.getTracer("dbos-tracer"),l=o(performance.now());if(n){let c=i.trace.setSpan(i.context.active(),n);return a.startSpan(e,{startTime:l,attributes:r},c)}else return a.startSpan(e,{startTime:l,attributes:r})}endSpan(e){if(!at.globalParams.enableOTLP)return;let{hrTime:r}=require("@opentelemetry/core"),s=e;s.setAttributes({applicationID:this.applicationID,applicationVersion:at.globalParams.appVersion}),s.attributes&&!("executorID"in s.attributes)&&s.setAttribute("executorID",this.executorID),s.end(r(performance.now())),this.telemetryCollector.push(s)}};Me.Tracer=Ka});var ii=w(Bt=>{"use strict";Object.defineProperty(Bt,"__esModule",{value:!0});Bt.DBOSConsoleLogger=Bt.DBOSContextualLogger=Bt.GlobalLogger=void 0;var Mt=Oe(),Cr=Ot(),Nr;(function(t){t[t.UNSPECIFIED=0]="UNSPECIFIED",t[t.TRACE=1]="TRACE",t[t.TRACE2=2]="TRACE2",t[t.TRACE3=3]="TRACE3",t[t.TRACE4=4]="TRACE4",t[t.DEBUG=5]="DEBUG",t[t.DEBUG2=6]="DEBUG2",t[t.DEBUG3=7]="DEBUG3",t[t.DEBUG4=8]="DEBUG4",t[t.INFO=9]="INFO",t[t.INFO2=10]="INFO2",t[t.INFO3=11]="INFO3",t[t.INFO4=12]="INFO4",t[t.WARN=13]="WARN",t[t.WARN2=14]="WARN2",t[t.WARN3=15]="WARN3",t[t.WARN4=16]="WARN4",t[t.ERROR=17]="ERROR",t[t.ERROR2=18]="ERROR2",t[t.ERROR3=19]="ERROR3",t[t.ERROR4=20]="ERROR4",t[t.FATAL=21]="FATAL",t[t.FATAL2=22]="FATAL2",t[t.FATAL3=23]="FATAL3",t[t.FATAL4=24]="FATAL4"})(Nr||(Nr={}));var Ja=class{telemetryCollector;logger;addContextMetadata;isLogging=!1;constructor(e,r,s="dbos"){if(this.telemetryCollector=e,this.addContextMetadata=r?.addContextMetadata||!1,!Mt.globalParams.enableOTLP){this.logger=new ni(r??{});return}let n=require("winston-transport");class i extends n{telemetryCollector;name="OTLPLogQueueTransport";otelLogger;applicationID;executorID;constructor(f,d){super(),this.telemetryCollector=f,this.level=d;let{LoggerProvider:p}=require("@opentelemetry/sdk-logs"),m={forceFlush:async()=>{},onEmit(g){f.push(g)},shutdown:async()=>{}},h=new p({resource:{attributes:{"service.name":s}},processors:[m]});this.otelLogger=h.getLogger("dbos-logger"),this.applicationID=Mt.globalParams.appID,this.executorID=Mt.globalParams.executorID}log(f,d){let{level:p,message:m,stack:h,span:g}=f,y={error:Nr.ERROR,warn:Nr.WARN,info:Nr.INFO,debug:Nr.DEBUG};this.otelLogger.emit({severityNumber:y[p],severityText:p,body:m,timestamp:performance.now(),observedTimestamp:performance.now(),attributes:{...g?.attributes,traceId:g?.spanContext()?.traceId,spanId:g?.spanContext()?.spanId,stack:h,applicationID:this.applicationID,applicationVersion:Mt.globalParams.appVersion,executorID:this.executorID}}),d()}}let{transports:o,createLogger:a}=require("winston"),l=[];l.push(new o.Console({format:wk(),level:r?.logLevel||"info",silent:r?.silent||!1,forceConsole:r?.forceConsole||!1}));let c;Mt.globalParams.enableOTLP&&this.telemetryCollector?.exporter&&(c=new i(this.telemetryCollector,r?.logLevel||"info"),l.push(c)),this.logger=a({transports:l}),Mt.globalParams.enableOTLP&&process.env.DBOS__CAPTURE_STD!=="false"&&this.telemetryCollector?.exporter&&(0,Mt.interceptStreams)((u,f)=>{f==="stdout"?this.isLogging||c?.log({level:"info",message:u.trim()},()=>{}):this.isLogging||c?.log({level:"error",message:u.trim(),stack:new Error().stack},()=>{})})}info(e,r){this.isLogging=!0,typeof e=="string"?this.logger.info(e,r):this.logger.info(Cr.DBOSJSON.stringify(e),r),this.isLogging=!1}debug(e,r){this.isLogging=!0,typeof e=="string"?this.logger.debug(e,r):this.logger.debug(Cr.DBOSJSON.stringify(e),r),this.isLogging=!1}warn(e,r){this.isLogging=!0,typeof e=="string"?this.logger.warn(e,r):this.logger.warn(Cr.DBOSJSON.stringify(e),r),this.isLogging=!1}error(e,r){this.isLogging=!0,e instanceof Error?this.logger.error(e.message,{...r,stack:e.stack}):typeof e=="string"?this.logger.error(e,{...r,stack:new Error().stack}):this.logger.error(Cr.DBOSJSON.stringify(e),{...r,stack:new Error().stack}),this.isLogging=!1}async destroy(){await this.telemetryCollector?.destroy()}};Bt.GlobalLogger=Ja;var Ya=class{globalLogger;ctx;includeContextMetadata;constructor(e,r){this.globalLogger=e,this.ctx=r,this.includeContextMetadata=this.globalLogger.addContextMetadata}info(e,r){this.globalLogger.info(e,{includeContextMetadata:this.includeContextMetadata,span:this.ctx(),...r})}debug(e,r){this.globalLogger.debug(e,{includeContextMetadata:this.includeContextMetadata,span:this.ctx(),...r})}warn(e,r){this.globalLogger.warn(e,{includeContextMetadata:this.includeContextMetadata,span:this.ctx(),...r})}error(e,r){this.globalLogger.error(e,{includeContextMetadata:this.includeContextMetadata,span:this.ctx(),...r})}};Bt.DBOSContextualLogger=Ya;var ni=class{config;constructor(e){this.config=e}info(e,r){console.log(e)}debug(e,r){this.config.logLevel==="debug"&&console.debug(e)}warn(e,r){console.warn(e)}error(e,r){e instanceof Error?console.error(e):r?.stack?console.error(e,`
`,r.stack):console.error(e)}};Bt.DBOSConsoleLogger=ni;function wk(){let{format:t}=require("winston");return t.combine(t.errors({stack:!0}),t.timestamp(),t.colorize(),t.printf(e=>{let{timestamp:r,level:s,message:n,stack:i}=e,o=Mt.globalParams.appVersion,a=typeof r=="string"?r.slice(0,19).replace("T"," "):void 0,l=typeof i=="string"?i?.split(`
`).slice(1).join(`
`):void 0,u=`${typeof n=="string"?n:Cr.DBOSJSON.stringify(n)}${e.includeContextMetadata?` ${Cr.DBOSJSON.stringify(e.span?.attributes)}`:""}`,f=o?` [version ${o}]`:"";return`${a}${f} [${s}]: ${u} ${i?`
`+l:""}`}))}});var Rh=w(oi=>{"use strict";Object.defineProperty(oi,"__esModule",{value:!0});oi.TelemetryExporter=void 0;var Xa=Oe();function gk(t){return"kind"in t}function yk(t){return"severityText"in t&&"severityNumber"in t}var Za=class{tracesExporters=[];logsExporters=[];constructor(e){if(!Xa.globalParams.enableOTLP)return;let{OTLPTraceExporter:r}=require("@opentelemetry/exporter-trace-otlp-proto"),{OTLPLogExporter:s}=require("@opentelemetry/exporter-logs-otlp-proto"),n=new Set(e.tracesEndpoint);for(let o of n)this.tracesExporters.push(new r({url:o})),console.log(`Traces will be exported to ${o}`);let i=new Set(e.logsEndpoint);for(let o of i)this.logsExporters.push(new s({url:o})),console.log(`Logs will be exported to ${o}`)}async export(e){if(!Xa.globalParams.enableOTLP)return;let{ExportResultCode:r}=require("@opentelemetry/core"),s=[],n=[];e.forEach(o=>{gk(o)&&s.push(o),yk(o)&&n.push(o)});let i=[];if(s.length>0&&this.tracesExporters.length>0){let o=new Promise(a=>{let l=c=>{c.code!==r.SUCCESS&&(console.warn(`Trace export failed: ${c.code}`),console.warn(c)),a()};for(let c of this.tracesExporters)c.export(s,l)});i.push(o)}if(n.length>0&&this.logsExporters.length>0){let o=new Promise(a=>{let l=c=>{c.code!==r.SUCCESS&&(console.warn(`Log export failed: ${c.code}`),console.warn(c)),a()};for(let c of this.logsExporters)c.export(n,l)});i.push(o)}await Promise.all(i)}async flush(){if(Xa.globalParams.enableOTLP){for(let e of this.tracesExporters)await e.forceFlush();for(let e of this.logsExporters)await e.forceFlush()}}};oi.TelemetryExporter=Za});var tl=w(Ch=>{"use strict";Ch.parse=function(t,e){return new el(t,e).parse()};var el=class t{constructor(e,r){this.source=e,this.transform=r||_k,this.position=0,this.entries=[],this.recorded=[],this.dimension=0}isEof(){return this.position>=this.source.length}nextCharacter(){var e=this.source[this.position++];return e==="\\"?{value:this.source[this.position++],escaped:!0}:{value:e,escaped:!1}}record(e){this.recorded.push(e)}newEntry(e){var r;(this.recorded.length>0||e)&&(r=this.recorded.join(""),r==="NULL"&&!e&&(r=null),r!==null&&(r=this.transform(r)),this.entries.push(r),this.recorded=[])}consumeDimensions(){if(this.source[0]==="[")for(;!this.isEof();){var e=this.nextCharacter();if(e.value==="=")break}}parse(e){var r,s,n;for(this.consumeDimensions();!this.isEof();)if(r=this.nextCharacter(),r.value==="{"&&!n)this.dimension++,this.dimension>1&&(s=new t(this.source.substr(this.position-1),this.transform),this.entries.push(s.parse(!0)),this.position+=s.position-2);else if(r.value==="}"&&!n){if(this.dimension--,!this.dimension&&(this.newEntry(),e))return this.entries}else r.value==='"'&&!r.escaped?(n&&this.newEntry(!0),n=!n):r.value===","&&!n?this.newEntry():this.record(r.value);if(this.dimension!==0)throw new Error("array dimension not balanced");return this.entries}};function _k(t){return t}});var rl=w((NP,Nh)=>{var Sk=tl();Nh.exports={create:function(t,e){return{parse:function(){return Sk.parse(t,e)}}}}});var Lh=w((AP,Ph)=>{"use strict";var Ek=/(\d{1,})-(\d{2})-(\d{2}) (\d{2}):(\d{2}):(\d{2})(\.\d{1,})?.*?( BC)?$/,bk=/^(\d{1,})-(\d{2})-(\d{2})( BC)?$/,kk=/([Z+-])(\d{2})?:?(\d{2})?:?(\d{2})?/,vk=/^-?infinity$/;Ph.exports=function(e){if(vk.test(e))return Number(e.replace("i","I"));var r=Ek.exec(e);if(!r)return Ok(e)||null;var s=!!r[8],n=parseInt(r[1],10);s&&(n=Ah(n));var i=parseInt(r[2],10)-1,o=r[3],a=parseInt(r[4],10),l=parseInt(r[5],10),c=parseInt(r[6],10),u=r[7];u=u?1e3*parseFloat(u):0;var f,d=Dk(e);return d!=null?(f=new Date(Date.UTC(n,i,o,a,l,c,u)),sl(n)&&f.setUTCFullYear(n),d!==0&&f.setTime(f.getTime()-d)):(f=new Date(n,i,o,a,l,c,u),sl(n)&&f.setFullYear(n)),f};function Ok(t){var e=bk.exec(t);if(e){var r=parseInt(e[1],10),s=!!e[4];s&&(r=Ah(r));var n=parseInt(e[2],10)-1,i=e[3],o=new Date(r,n,i);return sl(r)&&o.setFullYear(r),o}}function Dk(t){if(t.endsWith("+00"))return 0;var e=kk.exec(t.split(" ")[1]);if(e){var r=e[1];if(r==="Z")return 0;var s=r==="-"?-1:1,n=parseInt(e[2],10)*3600+parseInt(e[3]||0,10)*60+parseInt(e[4]||0,10);return n*s*1e3}}function Ah(t){return-(t-1)}function sl(t){return t>=0&&t<100}});var qh=w((PP,xh)=>{xh.exports=Ik;var Tk=Object.prototype.hasOwnProperty;function Ik(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var s in r)Tk.call(r,s)&&(t[s]=r[s])}return t}});var $h=w((LP,Bh)=>{"use strict";var Rk=qh();Bh.exports=Ar;function Ar(t){if(!(this instanceof Ar))return new Ar(t);Rk(this,Uk(t))}var Ck=["seconds","minutes","hours","days","months","years"];Ar.prototype.toPostgres=function(){var t=Ck.filter(this.hasOwnProperty,this);return this.milliseconds&&t.indexOf("seconds")<0&&t.push("seconds"),t.length===0?"0":t.map(function(e){var r=this[e]||0;return e==="seconds"&&this.milliseconds&&(r=(r+this.milliseconds/1e3).toFixed(6).replace(/\.?0+$/,"")),r+" "+e},this).join(" ")};var Nk={years:"Y",months:"M",days:"D",hours:"H",minutes:"M",seconds:"S"},Ak=["years","months","days"],Pk=["hours","minutes","seconds"];Ar.prototype.toISOString=Ar.prototype.toISO=function(){var t=Ak.map(r,this).join(""),e=Pk.map(r,this).join("");return"P"+t+"T"+e;function r(s){var n=this[s]||0;return s==="seconds"&&this.milliseconds&&(n=(n+this.milliseconds/1e3).toFixed(6).replace(/0+$/,"")),n+Nk[s]}};var nl="([+-]?\\d+)",Lk=nl+"\\s+years?",xk=nl+"\\s+mons?",qk=nl+"\\s+days?",Mk="([+-])?([\\d]*):(\\d\\d):(\\d\\d)\\.?(\\d{1,6})?",Bk=new RegExp([Lk,xk,qk,Mk].map(function(t){return"("+t+")?"}).join("\\s*")),Mh={years:2,months:4,days:6,hours:9,minutes:10,seconds:11,milliseconds:12},$k=["hours","minutes","seconds","milliseconds"];function Wk(t){var e=t+"000000".slice(t.length);return parseInt(e,10)/1e3}function Uk(t){if(!t)return{};var e=Bk.exec(t),r=e[8]==="-";return Object.keys(Mh).reduce(function(s,n){var i=Mh[n],o=e[i];return!o||(o=n==="milliseconds"?Wk(o):parseInt(o,10),!o)||(r&&~$k.indexOf(n)&&(o*=-1),s[n]=o),s},{})}});var Fh=w((xP,Uh)=>{"use strict";var Wh=Buffer.from||Buffer;Uh.exports=function(e){if(/^\\x/.test(e))return Wh(e.substr(2),"hex");for(var r="",s=0;s<e.length;)if(e[s]!=="\\")r+=e[s],++s;else if(/[0-7]{3}/.test(e.substr(s+1,3)))r+=String.fromCharCode(parseInt(e.substr(s+1,3),8)),s+=4;else{for(var n=1;s+n<e.length&&e[s+n]==="\\";)n++;for(var i=0;i<Math.floor(n/2);++i)r+="\\";s+=Math.floor(n/2)*2}return Wh(r,"binary")}});var Hh=w((qP,Kh)=>{var Ds=tl(),Ts=rl(),ai=Lh(),jh=$h(),Vh=Fh();function li(t){return function(r){return r===null?r:t(r)}}function Gh(t){return t===null?t:t==="TRUE"||t==="t"||t==="true"||t==="y"||t==="yes"||t==="on"||t==="1"}function Fk(t){return t?Ds.parse(t,Gh):null}function zk(t){return parseInt(t,10)}function il(t){return t?Ds.parse(t,li(zk)):null}function jk(t){return t?Ds.parse(t,li(function(e){return Qh(e).trim()})):null}var Vk=function(t){if(!t)return null;var e=Ts.create(t,function(r){return r!==null&&(r=cl(r)),r});return e.parse()},ol=function(t){if(!t)return null;var e=Ts.create(t,function(r){return r!==null&&(r=parseFloat(r)),r});return e.parse()},Ye=function(t){if(!t)return null;var e=Ts.create(t);return e.parse()},al=function(t){if(!t)return null;var e=Ts.create(t,function(r){return r!==null&&(r=ai(r)),r});return e.parse()},Gk=function(t){if(!t)return null;var e=Ts.create(t,function(r){return r!==null&&(r=jh(r)),r});return e.parse()},Qk=function(t){return t?Ds.parse(t,li(Vh)):null},ll=function(t){return parseInt(t,10)},Qh=function(t){var e=String(t);return/^\d+$/.test(e)?e:t},zh=function(t){return t?Ds.parse(t,li(JSON.parse)):null},cl=function(t){return t[0]!=="("?null:(t=t.substring(1,t.length-1).split(","),{x:parseFloat(t[0]),y:parseFloat(t[1])})},Kk=function(t){if(t[0]!=="<"&&t[1]!=="(")return null;for(var e="(",r="",s=!1,n=2;n<t.length-1;n++){if(s||(e+=t[n]),t[n]===")"){s=!0;continue}else if(!s)continue;t[n]!==","&&(r+=t[n])}var i=cl(e);return i.radius=parseFloat(r),i},Hk=function(t){t(20,Qh),t(21,ll),t(23,ll),t(26,ll),t(700,parseFloat),t(701,parseFloat),t(16,Gh),t(1082,ai),t(1114,ai),t(1184,ai),t(600,cl),t(651,Ye),t(718,Kk),t(1e3,Fk),t(1001,Qk),t(1005,il),t(1007,il),t(1028,il),t(1016,jk),t(1017,Vk),t(1021,ol),t(1022,ol),t(1231,ol),t(1014,Ye),t(1015,Ye),t(1008,Ye),t(1009,Ye),t(1040,Ye),t(1041,Ye),t(1115,al),t(1182,al),t(1185,al),t(1186,jh),t(1187,Gk),t(17,Vh),t(114,JSON.parse.bind(JSON)),t(3802,JSON.parse.bind(JSON)),t(199,zh),t(3807,zh),t(3907,Ye),t(2951,Ye),t(791,Ye),t(1183,Ye),t(1270,Ye)};Kh.exports={init:Hk}});var Yh=w((MP,Jh)=>{"use strict";var Be=1e6;function Jk(t){var e=t.readInt32BE(0),r=t.readUInt32BE(4),s="";e<0&&(e=~e+(r===0),r=~r+1>>>0,s="-");var n="",i,o,a,l,c,u;{if(i=e%Be,e=e/Be>>>0,o=4294967296*i+r,r=o/Be>>>0,a=""+(o-Be*r),r===0&&e===0)return s+a+n;for(l="",c=6-a.length,u=0;u<c;u++)l+="0";n=l+a+n}{if(i=e%Be,e=e/Be>>>0,o=4294967296*i+r,r=o/Be>>>0,a=""+(o-Be*r),r===0&&e===0)return s+a+n;for(l="",c=6-a.length,u=0;u<c;u++)l+="0";n=l+a+n}{if(i=e%Be,e=e/Be>>>0,o=4294967296*i+r,r=o/Be>>>0,a=""+(o-Be*r),r===0&&e===0)return s+a+n;for(l="",c=6-a.length,u=0;u<c;u++)l+="0";n=l+a+n}return i=e%Be,o=4294967296*i+r,a=""+o%Be,s+a+n}Jh.exports=Jk});var rp=w((BP,tp)=>{var Yk=Yh(),le=function(t,e,r,s,n){r=r||0,s=s||!1,n=n||function(p,m,h){return p*Math.pow(2,h)+m};var i=r>>3,o=function(p){return s?~p&255:p},a=255,l=8-r%8;e<l&&(a=255<<8-e&255,l=e),r&&(a=a>>r%8);var c=0;r%8+e>=8&&(c=n(0,o(t[i])&a,l));for(var u=e+r>>3,f=i+1;f<u;f++)c=n(c,o(t[f]),8);var d=(e+r)%8;return d>0&&(c=n(c,o(t[u])>>8-d,d)),c},ep=function(t,e,r){var s=Math.pow(2,r-1)-1,n=le(t,1),i=le(t,r,1);if(i===0)return 0;var o=1,a=function(c,u,f){c===0&&(c=1);for(var d=1;d<=f;d++)o/=2,(u&1<<f-d)>0&&(c+=o);return c},l=le(t,e,r+1,!1,a);return i==Math.pow(2,r+1)-1?l===0?n===0?1/0:-1/0:NaN:(n===0?1:-1)*Math.pow(2,i-s)*l},Xk=function(t){return le(t,1)==1?-1*(le(t,15,1,!0)+1):le(t,15,1)},Xh=function(t){return le(t,1)==1?-1*(le(t,31,1,!0)+1):le(t,31,1)},Zk=function(t){return ep(t,23,8)},ev=function(t){return ep(t,52,11)},tv=function(t){var e=le(t,16,32);if(e==49152)return NaN;for(var r=Math.pow(1e4,le(t,16,16)),s=0,n=[],i=le(t,16),o=0;o<i;o++)s+=le(t,16,64+16*o)*r,r/=1e4;var a=Math.pow(10,le(t,16,48));return(e===0?1:-1)*Math.round(s*a)/a},Zh=function(t,e){var r=le(e,1),s=le(e,63,1),n=new Date((r===0?1:-1)*s/1e3+9466848e5);return t||n.setTime(n.getTime()+n.getTimezoneOffset()*6e4),n.usec=s%1e3,n.getMicroSeconds=function(){return this.usec},n.setMicroSeconds=function(i){this.usec=i},n.getUTCMicroSeconds=function(){return this.usec},n},Is=function(t){for(var e=le(t,32),r=le(t,32,32),s=le(t,32,64),n=96,i=[],o=0;o<e;o++)i[o]=le(t,32,n),n+=32,n+=32;var a=function(c){var u=le(t,32,n);if(n+=32,u==4294967295)return null;var f;if(c==23||c==20)return f=le(t,u*8,n),n+=u*8,f;if(c==25)return f=t.toString(this.encoding,n>>3,(n+=u<<3)>>3),f;console.log("ERROR: ElementType not implemented: "+c)},l=function(c,u){var f=[],d;if(c.length>1){var p=c.shift();for(d=0;d<p;d++)f[d]=l(c,u);c.unshift(p)}else for(d=0;d<c[0];d++)f[d]=a(u);return f};return l(i,s)},rv=function(t){return t.toString("utf8")},sv=function(t){return t===null?null:le(t,8)>0},nv=function(t){t(20,Yk),t(21,Xk),t(23,Xh),t(26,Xh),t(1700,tv),t(700,Zk),t(701,ev),t(16,sv),t(1114,Zh.bind(null,!1)),t(1184,Zh.bind(null,!0)),t(1e3,Is),t(1007,Is),t(1016,Is),t(1008,Is),t(1009,Is),t(25,rv)};tp.exports={init:nv}});var np=w(($P,sp)=>{sp.exports={BOOL:16,BYTEA:17,CHAR:18,INT8:20,INT2:21,INT4:23,REGPROC:24,TEXT:25,OID:26,TID:27,XID:28,CID:29,JSON:114,XML:142,PG_NODE_TREE:194,SMGR:210,PATH:602,POLYGON:604,CIDR:650,FLOAT4:700,FLOAT8:701,ABSTIME:702,RELTIME:703,TINTERVAL:704,CIRCLE:718,MACADDR8:774,MONEY:790,MACADDR:829,INET:869,ACLITEM:1033,BPCHAR:1042,VARCHAR:1043,DATE:1082,TIME:1083,TIMESTAMP:1114,TIMESTAMPTZ:1184,INTERVAL:1186,TIMETZ:1266,BIT:1560,VARBIT:1562,NUMERIC:1700,REFCURSOR:1790,REGPROCEDURE:2202,REGOPER:2203,REGOPERATOR:2204,REGCLASS:2205,REGTYPE:2206,UUID:2950,TXID_SNAPSHOT:2970,PG_LSN:3220,PG_NDISTINCT:3361,PG_DEPENDENCIES:3402,TSVECTOR:3614,TSQUERY:3615,GTSVECTOR:3642,REGCONFIG:3734,REGDICTIONARY:3769,JSONB:3802,REGNAMESPACE:4089,REGROLE:4096}});var Ns=w(Cs=>{var iv=Hh(),ov=rp(),av=rl(),lv=np();Cs.getTypeParser=cv;Cs.setTypeParser=uv;Cs.arrayParser=av;Cs.builtins=lv;var Rs={text:{},binary:{}};function ip(t){return String(t)}function cv(t,e){return e=e||"text",Rs[e]&&Rs[e][t]||ip}function uv(t,e,r){typeof e=="function"&&(r=e,e="text"),Rs[e][t]=r}iv.init(function(t,e){Rs.text[t]=e});ov.init(function(t,e){Rs.binary[t]=e})});var As=w((UP,ul)=>{"use strict";ul.exports={host:"localhost",user:process.platform==="win32"?process.env.USERNAME:process.env.USER,database:void 0,password:null,connectionString:void 0,port:5432,rows:0,binary:!1,max:10,idleTimeoutMillis:3e4,client_encoding:"",ssl:!1,application_name:void 0,fallback_application_name:void 0,options:void 0,parseInputDatesAsUTC:!1,statement_timeout:!1,lock_timeout:!1,idle_in_transaction_session_timeout:!1,query_timeout:!1,connect_timeout:0,keepalives:1,keepalives_idle:0};var Pr=Ns(),fv=Pr.getTypeParser(20,"text"),dv=Pr.getTypeParser(1016,"text");ul.exports.__defineSetter__("parseInt8",function(t){Pr.setTypeParser(20,"text",t?Pr.getTypeParser(23,"text"):fv),Pr.setTypeParser(1016,"text",t?Pr.getTypeParser(1007,"text"):dv)})});var Ps=w((FP,ap)=>{"use strict";var hv=As();function pv(t){var e=t.replace(/\\/g,"\\\\").replace(/"/g,'\\"');return'"'+e+'"'}function op(t){for(var e="{",r=0;r<t.length;r++)r>0&&(e=e+","),t[r]===null||typeof t[r]>"u"?e=e+"NULL":Array.isArray(t[r])?e=e+op(t[r]):t[r]instanceof Buffer?e+="\\\\x"+t[r].toString("hex"):e+=pv(ci(t[r]));return e=e+"}",e}var ci=function(t,e){if(t==null)return null;if(t instanceof Buffer)return t;if(ArrayBuffer.isView(t)){var r=Buffer.from(t.buffer,t.byteOffset,t.byteLength);return r.length===t.byteLength?r:r.slice(t.byteOffset,t.byteOffset+t.byteLength)}return t instanceof Date?hv.parseInputDatesAsUTC?gv(t):wv(t):Array.isArray(t)?op(t):typeof t=="object"?mv(t,e):t.toString()};function mv(t,e){if(t&&typeof t.toPostgres=="function"){if(e=e||[],e.indexOf(t)!==-1)throw new Error('circular reference detected while preparing "'+t+'" for query');return e.push(t),ci(t.toPostgres(ci),e)}return JSON.stringify(t)}function De(t,e){for(t=""+t;t.length<e;)t="0"+t;return t}function wv(t){var e=-t.getTimezoneOffset(),r=t.getFullYear(),s=r<1;s&&(r=Math.abs(r)+1);var n=De(r,4)+"-"+De(t.getMonth()+1,2)+"-"+De(t.getDate(),2)+"T"+De(t.getHours(),2)+":"+De(t.getMinutes(),2)+":"+De(t.getSeconds(),2)+"."+De(t.getMilliseconds(),3);return e<0?(n+="-",e*=-1):n+="+",n+=De(Math.floor(e/60),2)+":"+De(e%60,2),s&&(n+=" BC"),n}function gv(t){var e=t.getUTCFullYear(),r=e<1;r&&(e=Math.abs(e)+1);var s=De(e,4)+"-"+De(t.getUTCMonth()+1,2)+"-"+De(t.getUTCDate(),2)+"T"+De(t.getUTCHours(),2)+":"+De(t.getUTCMinutes(),2)+":"+De(t.getUTCSeconds(),2)+"."+De(t.getUTCMilliseconds(),3);return s+="+00:00",r&&(s+=" BC"),s}function yv(t,e,r){return t=typeof t=="string"?{text:t}:t,e&&(typeof e=="function"?t.callback=e:t.values=e),r&&(t.callback=r),t}var _v=function(t){return'"'+t.replace(/"/g,'""')+'"'},Sv=function(t){for(var e=!1,r="'",s=0;s<t.length;s++){var n=t[s];n==="'"?r+=n+n:n==="\\"?(r+=n+n,e=!0):r+=n}return r+="'",e===!0&&(r=" E"+r),r};ap.exports={prepareValue:function(e){return ci(e)},normalizeQueryConfig:yv,escapeIdentifier:_v,escapeLiteral:Sv}});var cp=w((zP,lp)=>{"use strict";var Ls=require("crypto");function fl(t){return Ls.createHash("md5").update(t,"utf-8").digest("hex")}function Ev(t,e,r){var s=fl(e+t),n=fl(Buffer.concat([Buffer.from(s),r]));return"md5"+n}function bv(t){return Ls.createHash("sha256").update(t).digest()}function kv(t,e){return Ls.createHmac("sha256",t).update(e).digest()}async function vv(t,e,r){return Ls.pbkdf2Sync(t,e,r,32,"sha256")}lp.exports={postgresMd5PasswordHash:Ev,randomBytes:Ls.randomBytes,deriveKey:vv,sha256:bv,hmacSha256:kv,md5:fl}});var hp=w((jP,dp)=>{var up=require("crypto");dp.exports={postgresMd5PasswordHash:Dv,randomBytes:Ov,deriveKey:Rv,sha256:Tv,hmacSha256:Iv,md5:dl};var fp=up.webcrypto||globalThis.crypto,Lr=fp.subtle,hl=new TextEncoder;function Ov(t){return fp.getRandomValues(Buffer.alloc(t))}async function dl(t){try{return up.createHash("md5").update(t,"utf-8").digest("hex")}catch{let r=typeof t=="string"?hl.encode(t):t,s=await Lr.digest("MD5",r);return Array.from(new Uint8Array(s)).map(n=>n.toString(16).padStart(2,"0")).join("")}}async function Dv(t,e,r){var s=await dl(e+t),n=await dl(Buffer.concat([Buffer.from(s),r]));return"md5"+n}async function Tv(t){return await Lr.digest("SHA-256",t)}async function Iv(t,e){let r=await Lr.importKey("raw",t,{name:"HMAC",hash:"SHA-256"},!1,["sign"]);return await Lr.sign("HMAC",r,hl.encode(e))}async function Rv(t,e,r){let s=await Lr.importKey("raw",hl.encode(t),"PBKDF2",!1,["deriveBits"]),n={name:"PBKDF2",hash:"SHA-256",salt:e,iterations:r};return await Lr.deriveBits(n,s,256,["deriveBits"])}});var ml=w((VP,pl)=>{"use strict";var Cv=parseInt(process.versions&&process.versions.node&&process.versions.node.split(".")[0])<15;Cv?pl.exports=cp():pl.exports=hp()});var gp=w((GP,wp)=>{"use strict";var cr=ml();function Nv(t){if(t.indexOf("SCRAM-SHA-256")===-1)throw new Error("SASL: Only mechanism SCRAM-SHA-256 is currently supported");let e=cr.randomBytes(18).toString("base64");return{mechanism:"SCRAM-SHA-256",clientNonce:e,response:"n,,n=*,r="+e,message:"SASLInitialResponse"}}async function Av(t,e,r){if(t.message!=="SASLInitialResponse")throw new Error("SASL: Last message was not SASLInitialResponse");if(typeof e!="string")throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: client password must be a string");if(e==="")throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: client password must be a non-empty string");if(typeof r!="string")throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: serverData must be a string");let s=xv(r);if(s.nonce.startsWith(t.clientNonce)){if(s.nonce.length===t.clientNonce.length)throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: server nonce is too short")}else throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: server nonce does not start with client nonce");var n="n=*,r="+t.clientNonce,i="r="+s.nonce+",s="+s.salt+",i="+s.iteration,o="c=biws,r="+s.nonce,a=n+","+i+","+o,l=Buffer.from(s.salt,"base64"),c=await cr.deriveKey(e,l,s.iteration),u=await cr.hmacSha256(c,"Client Key"),f=await cr.sha256(u),d=await cr.hmacSha256(f,a),p=Mv(Buffer.from(u),Buffer.from(d)).toString("base64"),m=await cr.hmacSha256(c,"Server Key"),h=await cr.hmacSha256(m,a);t.message="SASLResponse",t.serverSignature=Buffer.from(h).toString("base64"),t.response=o+",p="+p}function Pv(t,e){if(t.message!=="SASLResponse")throw new Error("SASL: Last message was not SASLResponse");if(typeof e!="string")throw new Error("SASL: SCRAM-SERVER-FINAL-MESSAGE: serverData must be a string");let{serverSignature:r}=qv(e);if(r!==t.serverSignature)throw new Error("SASL: SCRAM-SERVER-FINAL-MESSAGE: server signature does not match")}function Lv(t){if(typeof t!="string")throw new TypeError("SASL: text must be a string");return t.split("").map((e,r)=>t.charCodeAt(r)).every(e=>e>=33&&e<=43||e>=45&&e<=126)}function pp(t){return/^(?:[a-zA-Z0-9+/]{4})*(?:[a-zA-Z0-9+/]{2}==|[a-zA-Z0-9+/]{3}=)?$/.test(t)}function mp(t){if(typeof t!="string")throw new TypeError("SASL: attribute pairs text must be a string");return new Map(t.split(",").map(e=>{if(!/^.=/.test(e))throw new Error("SASL: Invalid attribute pair entry");let r=e[0],s=e.substring(2);return[r,s]}))}function xv(t){let e=mp(t),r=e.get("r");if(r){if(!Lv(r))throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: nonce must only contain printable characters")}else throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: nonce missing");let s=e.get("s");if(s){if(!pp(s))throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: salt must be base64")}else throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: salt missing");let n=e.get("i");if(n){if(!/^[1-9][0-9]*$/.test(n))throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: invalid iteration count")}else throw new Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: iteration missing");let i=parseInt(n,10);return{nonce:r,salt:s,iteration:i}}function qv(t){let r=mp(t).get("v");if(r){if(!pp(r))throw new Error("SASL: SCRAM-SERVER-FINAL-MESSAGE: server signature must be base64")}else throw new Error("SASL: SCRAM-SERVER-FINAL-MESSAGE: server signature is missing");return{serverSignature:r}}function Mv(t,e){if(!Buffer.isBuffer(t))throw new TypeError("first argument must be a Buffer");if(!Buffer.isBuffer(e))throw new TypeError("second argument must be a Buffer");if(t.length!==e.length)throw new Error("Buffer lengths must match");if(t.length===0)throw new Error("Buffers cannot be empty");return Buffer.from(t.map((r,s)=>t[s]^e[s]))}wp.exports={startSession:Nv,continueSession:Av,finalizeSession:Pv}});var wl=w((QP,yp)=>{"use strict";var Bv=Ns();function ui(t){this._types=t||Bv,this.text={},this.binary={}}ui.prototype.getOverrides=function(t){switch(t){case"text":return this.text;case"binary":return this.binary;default:return{}}};ui.prototype.setTypeParser=function(t,e,r){typeof e=="function"&&(r=e,e="text"),this.getOverrides(e)[t]=r};ui.prototype.getTypeParser=function(t,e){return e=e||"text",this.getOverrides(e)[t]||this._types.getTypeParser(t,e)};yp.exports=ui});var Ep=w((KP,Sp)=>{"use strict";function xr(t,e={}){if(t.charAt(0)==="/"){let l=t.split(" ");return{host:l[0],database:l[1]}}let r={},s,n=!1;/ |%[^a-f0-9]|%[a-f0-9][^a-f0-9]/i.test(t)&&(t=encodeURI(t).replace(/%25(\d\d)/g,"%$1"));try{try{s=new URL(t,"postgres://base")}catch{s=new URL(t.replace("@/","@___DUMMY___/"),"postgres://base"),n=!0}}catch(l){throw l.input&&(l.input="*****REDACTED*****"),l}for(let l of s.searchParams.entries())r[l[0]]=l[1];if(r.user=r.user||decodeURIComponent(s.username),r.password=r.password||decodeURIComponent(s.password),s.protocol=="socket:")return r.host=decodeURI(s.pathname),r.database=s.searchParams.get("db"),r.client_encoding=s.searchParams.get("encoding"),r;let i=n?"":s.hostname;r.host?i&&/^%2f/i.test(i)&&(s.pathname=i+s.pathname):r.host=decodeURIComponent(i),r.port||(r.port=s.port);let o=s.pathname.slice(1)||null;r.database=o?decodeURI(o):null,(r.ssl==="true"||r.ssl==="1")&&(r.ssl=!0),r.ssl==="0"&&(r.ssl=!1),(r.sslcert||r.sslkey||r.sslrootcert||r.sslmode)&&(r.ssl={});let a=r.sslcert||r.sslkey||r.sslrootcert?require("fs"):null;if(r.sslcert&&(r.ssl.cert=a.readFileSync(r.sslcert).toString()),r.sslkey&&(r.ssl.key=a.readFileSync(r.sslkey).toString()),r.sslrootcert&&(r.ssl.ca=a.readFileSync(r.sslrootcert).toString()),e.useLibpqCompat&&r.uselibpqcompat)throw new Error("Both useLibpqCompat and uselibpqcompat are set. Please use only one of them.");if(r.uselibpqcompat==="true"||e.useLibpqCompat)switch(r.sslmode){case"disable":{r.ssl=!1;break}case"prefer":{r.ssl.rejectUnauthorized=!1;break}case"require":{r.sslrootcert?r.ssl.checkServerIdentity=function(){}:r.ssl.rejectUnauthorized=!1;break}case"verify-ca":{if(!r.ssl.ca)throw new Error("SECURITY WARNING: Using sslmode=verify-ca requires specifying a CA with sslrootcert. If a public CA is used, verify-ca allows connections to a server that somebody else may have registered with the CA, making you vulnerable to Man-in-the-Middle attacks. Either specify a custom CA certificate with sslrootcert parameter or use sslmode=verify-full for proper security.");r.ssl.checkServerIdentity=function(){};break}case"verify-full":break}else switch(r.sslmode){case"disable":{r.ssl=!1;break}case"prefer":case"require":case"verify-ca":case"verify-full":{r.sslmode!=="verify-full"&&gl(r.sslmode);break}case"no-verify":{r.ssl.rejectUnauthorized=!1;break}}return r}function $v(t){return Object.entries(t).reduce((r,[s,n])=>(n!=null&&(r[s]=n),r),{})}function _p(t){return Object.entries(t).reduce((r,[s,n])=>{if(s==="ssl"){let i=n;typeof i=="boolean"&&(r[s]=i),typeof i=="object"&&(r[s]=$v(i))}else if(n!=null)if(s==="port"){if(n!==""){let i=parseInt(n,10);if(isNaN(i))throw new Error(`Invalid ${s}: ${n}`);r[s]=i}}else r[s]=n;return r},{})}function Wv(t){return _p(xr(t))}function gl(t){!gl.warned&&typeof process<"u"&&process.emitWarning&&(gl.warned=!0,process.emitWarning(`SECURITY WARNING: The SSL modes 'prefer', 'require', and 'verify-ca' are treated as aliases for 'verify-full'.
In the next major version (pg-connection-string v3.0.0 and pg v9.0.0), these modes will adopt standard libpq semantics, which have weaker security guarantees.

To prepare for this change:
- If you want the current behavior, explicitly use 'sslmode=verify-full'
- If you want libpq compatibility now, use 'uselibpqcompat=true&sslmode=${t}'

See https://www.postgresql.org/docs/current/libpq-ssl.html for libpq SSL mode definitions.`))}Sp.exports=xr;xr.parse=xr;xr.toClientConfig=_p;xr.parseIntoClientConfig=Wv});var _l=w((HP,vp)=>{"use strict";var Uv=require("dns"),kp=As(),bp=Ep().parse,Ae=function(t,e,r){return r===void 0?r=process.env["PG"+t.toUpperCase()]:r===!1||(r=process.env[r]),e[t]||r||kp[t]},Fv=function(){switch(process.env.PGSSLMODE){case"disable":return!1;case"prefer":case"require":case"verify-ca":case"verify-full":return!0;case"no-verify":return{rejectUnauthorized:!1}}return kp.ssl},qr=function(t){return"'"+(""+t).replace(/\\/g,"\\\\").replace(/'/g,"\\'")+"'"},Xe=function(t,e,r){var s=e[r];s!=null&&t.push(r+"="+qr(s))},yl=class{constructor(e){e=typeof e=="string"?bp(e):e||{},e.connectionString&&(e=Object.assign({},e,bp(e.connectionString))),this.user=Ae("user",e),this.database=Ae("database",e),this.database===void 0&&(this.database=this.user),this.port=parseInt(Ae("port",e),10),this.host=Ae("host",e),Object.defineProperty(this,"password",{configurable:!0,enumerable:!1,writable:!0,value:Ae("password",e)}),this.binary=Ae("binary",e),this.options=Ae("options",e),this.ssl=typeof e.ssl>"u"?Fv():e.ssl,typeof this.ssl=="string"&&this.ssl==="true"&&(this.ssl=!0),this.ssl==="no-verify"&&(this.ssl={rejectUnauthorized:!1}),this.ssl&&this.ssl.key&&Object.defineProperty(this.ssl,"key",{enumerable:!1}),this.client_encoding=Ae("client_encoding",e),this.replication=Ae("replication",e),this.isDomainSocket=!(this.host||"").indexOf("/"),this.application_name=Ae("application_name",e,"PGAPPNAME"),this.fallback_application_name=Ae("fallback_application_name",e,!1),this.statement_timeout=Ae("statement_timeout",e,!1),this.lock_timeout=Ae("lock_timeout",e,!1),this.idle_in_transaction_session_timeout=Ae("idle_in_transaction_session_timeout",e,!1),this.query_timeout=Ae("query_timeout",e,!1),e.connectionTimeoutMillis===void 0?this.connect_timeout=process.env.PGCONNECT_TIMEOUT||0:this.connect_timeout=Math.floor(e.connectionTimeoutMillis/1e3),e.keepAlive===!1?this.keepalives=0:e.keepAlive===!0&&(this.keepalives=1),typeof e.keepAliveInitialDelayMillis=="number"&&(this.keepalives_idle=Math.floor(e.keepAliveInitialDelayMillis/1e3))}getLibpqConnectionString(e){var r=[];Xe(r,this,"user"),Xe(r,this,"password"),Xe(r,this,"port"),Xe(r,this,"application_name"),Xe(r,this,"fallback_application_name"),Xe(r,this,"connect_timeout"),Xe(r,this,"options");var s=typeof this.ssl=="object"?this.ssl:this.ssl?{sslmode:this.ssl}:{};if(Xe(r,s,"sslmode"),Xe(r,s,"sslca"),Xe(r,s,"sslkey"),Xe(r,s,"sslcert"),Xe(r,s,"sslrootcert"),this.database&&r.push("dbname="+qr(this.database)),this.replication&&r.push("replication="+qr(this.replication)),this.host&&r.push("host="+qr(this.host)),this.isDomainSocket)return e(null,r.join(" "));this.client_encoding&&r.push("client_encoding="+qr(this.client_encoding)),Uv.lookup(this.host,function(n,i){return n?e(n,null):(r.push("hostaddr="+qr(i)),e(null,r.join(" ")))})}};vp.exports=yl});var Tp=w((JP,Dp)=>{"use strict";var zv=Ns(),Op=/^([A-Za-z]+)(?: (\d+))?(?: (\d+))?/,Sl=class{constructor(e,r){this.command=null,this.rowCount=null,this.oid=null,this.rows=[],this.fields=[],this._parsers=void 0,this._types=r,this.RowCtor=null,this.rowAsArray=e==="array",this.rowAsArray&&(this.parseRow=this._parseRowAsArray),this._prebuiltEmptyResultObject=null}addCommandComplete(e){var r;e.text?r=Op.exec(e.text):r=Op.exec(e.command),r&&(this.command=r[1],r[3]?(this.oid=parseInt(r[2],10),this.rowCount=parseInt(r[3],10)):r[2]&&(this.rowCount=parseInt(r[2],10)))}_parseRowAsArray(e){for(var r=new Array(e.length),s=0,n=e.length;s<n;s++){var i=e[s];i!==null?r[s]=this._parsers[s](i):r[s]=null}return r}parseRow(e){for(var r={...this._prebuiltEmptyResultObject},s=0,n=e.length;s<n;s++){var i=e[s],o=this.fields[s].name;i!==null&&(r[o]=this._parsers[s](i))}return r}addRow(e){this.rows.push(e)}addFields(e){this.fields=e,this.fields.length&&(this._parsers=new Array(e.length));for(var r=0;r<e.length;r++){var s=e[r];this._types?this._parsers[r]=this._types.getTypeParser(s.dataTypeID,s.format||"text"):this._parsers[r]=zv.getTypeParser(s.dataTypeID,s.format||"text")}this._createPrebuiltEmptyResultObject()}_createPrebuiltEmptyResultObject(){for(var e={},r=0;r<this.fields.length;r++)e[this.fields[r].name]=null;this._prebuiltEmptyResultObject={...e}}};Dp.exports=Sl});var Np=w((YP,Cp)=>{"use strict";var{EventEmitter:jv}=require("events"),Ip=Tp(),Rp=Ps(),El=class extends jv{constructor(e,r,s){super(),e=Rp.normalizeQueryConfig(e,r,s),this.text=e.text,this.values=e.values,this.rows=e.rows,this.types=e.types,this.name=e.name,this.binary=e.binary,this.portal=e.portal||"",this.callback=e.callback,this._rowMode=e.rowMode,process.domain&&e.callback&&(this.callback=process.domain.bind(e.callback)),this._result=new Ip(this._rowMode,this.types),this._results=this._result,this.isPreparedStatement=!1,this._canceledDueToError=!1,this._promise=null}requiresPreparation(){return this.name||this.rows?!0:!this.text||!this.values?!1:this.values.length>0}_checkForMultirow(){this._result.command&&(Array.isArray(this._results)||(this._results=[this._result]),this._result=new Ip(this._rowMode,this.types),this._results.push(this._result))}handleRowDescription(e){this._checkForMultirow(),this._result.addFields(e.fields),this._accumulateRows=this.callback||!this.listeners("row").length}handleDataRow(e){let r;if(!this._canceledDueToError){try{r=this._result.parseRow(e.fields)}catch(s){this._canceledDueToError=s;return}this.emit("row",r,this._result),this._accumulateRows&&this._result.addRow(r)}}handleCommandComplete(e,r){this._checkForMultirow(),this._result.addCommandComplete(e),this.rows&&r.sync()}handleEmptyQuery(e){this.rows&&e.sync()}handleError(e,r){if(this._canceledDueToError&&(e=this._canceledDueToError,this._canceledDueToError=!1),this.callback)return this.callback(e);this.emit("error",e)}handleReadyForQuery(e){if(this._canceledDueToError)return this.handleError(this._canceledDueToError,e);if(this.callback)try{this.callback(null,this._results)}catch(r){process.nextTick(()=>{throw r})}this.emit("end",this._results)}submit(e){if(typeof this.text!="string"&&typeof this.name!="string")return new Error("A query must have either text or a name. Supplying neither is unsupported.");let r=e.parsedStatements[this.name];return this.text&&r&&this.text!==r?new Error(`Prepared statements must be unique - '${this.name}' was used for a different statement`):this.values&&!Array.isArray(this.values)?new Error("Query values must be an array"):(this.requiresPreparation()?this.prepare(e):e.query(this.text),null)}hasBeenParsed(e){return this.name&&e.parsedStatements[this.name]}handlePortalSuspended(e){this._getRows(e,this.rows)}_getRows(e,r){e.execute({portal:this.portal,rows:r}),r?e.flush():e.sync()}prepare(e){this.isPreparedStatement=!0,this.hasBeenParsed(e)||e.parse({text:this.text,name:this.name,types:this.types});try{e.bind({portal:this.portal,statement:this.name,values:this.values,binary:this.binary,valueMapper:Rp.prepareValue})}catch(r){this.handleError(r,e);return}e.describe({type:"P",name:this.portal||""}),this._getRows(e,this.rows)}handleCopyInResponse(e){e.sendCopyFail("No source stream defined")}handleCopyData(e,r){}};Cp.exports=El});var ql=w(P=>{"use strict";Object.defineProperty(P,"__esModule",{value:!0});P.NoticeMessage=P.DataRowMessage=P.CommandCompleteMessage=P.ReadyForQueryMessage=P.NotificationResponseMessage=P.BackendKeyDataMessage=P.AuthenticationMD5Password=P.ParameterStatusMessage=P.ParameterDescriptionMessage=P.RowDescriptionMessage=P.Field=P.CopyResponse=P.CopyDataMessage=P.DatabaseError=P.copyDone=P.emptyQuery=P.replicationStart=P.portalSuspended=P.noData=P.closeComplete=P.bindComplete=P.parseComplete=void 0;P.parseComplete={name:"parseComplete",length:5};P.bindComplete={name:"bindComplete",length:5};P.closeComplete={name:"closeComplete",length:5};P.noData={name:"noData",length:5};P.portalSuspended={name:"portalSuspended",length:5};P.replicationStart={name:"replicationStart",length:4};P.emptyQuery={name:"emptyQuery",length:4};P.copyDone={name:"copyDone",length:4};var bl=class extends Error{constructor(e,r,s){super(e),this.length=r,this.name=s}};P.DatabaseError=bl;var kl=class{constructor(e,r){this.length=e,this.chunk=r,this.name="copyData"}};P.CopyDataMessage=kl;var vl=class{constructor(e,r,s,n){this.length=e,this.name=r,this.binary=s,this.columnTypes=new Array(n)}};P.CopyResponse=vl;var Ol=class{constructor(e,r,s,n,i,o,a){this.name=e,this.tableID=r,this.columnID=s,this.dataTypeID=n,this.dataTypeSize=i,this.dataTypeModifier=o,this.format=a}};P.Field=Ol;var Dl=class{constructor(e,r){this.length=e,this.fieldCount=r,this.name="rowDescription",this.fields=new Array(this.fieldCount)}};P.RowDescriptionMessage=Dl;var Tl=class{constructor(e,r){this.length=e,this.parameterCount=r,this.name="parameterDescription",this.dataTypeIDs=new Array(this.parameterCount)}};P.ParameterDescriptionMessage=Tl;var Il=class{constructor(e,r,s){this.length=e,this.parameterName=r,this.parameterValue=s,this.name="parameterStatus"}};P.ParameterStatusMessage=Il;var Rl=class{constructor(e,r){this.length=e,this.salt=r,this.name="authenticationMD5Password"}};P.AuthenticationMD5Password=Rl;var Cl=class{constructor(e,r,s){this.length=e,this.processID=r,this.secretKey=s,this.name="backendKeyData"}};P.BackendKeyDataMessage=Cl;var Nl=class{constructor(e,r,s,n){this.length=e,this.processId=r,this.channel=s,this.payload=n,this.name="notification"}};P.NotificationResponseMessage=Nl;var Al=class{constructor(e,r){this.length=e,this.status=r,this.name="readyForQuery"}};P.ReadyForQueryMessage=Al;var Pl=class{constructor(e,r){this.length=e,this.text=r,this.name="commandComplete"}};P.CommandCompleteMessage=Pl;var Ll=class{constructor(e,r){this.length=e,this.fields=r,this.name="dataRow",this.fieldCount=r.length}};P.DataRowMessage=Ll;var xl=class{constructor(e,r){this.length=e,this.message=r,this.name="notice"}};P.NoticeMessage=xl});var Ap=w(fi=>{"use strict";Object.defineProperty(fi,"__esModule",{value:!0});fi.Writer=void 0;var Ml=class{constructor(e=256){this.size=e,this.offset=5,this.headerPosition=0,this.buffer=Buffer.allocUnsafe(e)}ensure(e){if(this.buffer.length-this.offset<e){let s=this.buffer,n=s.length+(s.length>>1)+e;this.buffer=Buffer.allocUnsafe(n),s.copy(this.buffer)}}addInt32(e){return this.ensure(4),this.buffer[this.offset++]=e>>>24&255,this.buffer[this.offset++]=e>>>16&255,this.buffer[this.offset++]=e>>>8&255,this.buffer[this.offset++]=e>>>0&255,this}addInt16(e){return this.ensure(2),this.buffer[this.offset++]=e>>>8&255,this.buffer[this.offset++]=e>>>0&255,this}addCString(e){if(!e)this.ensure(1);else{let r=Buffer.byteLength(e);this.ensure(r+1),this.buffer.write(e,this.offset,"utf-8"),this.offset+=r}return this.buffer[this.offset++]=0,this}addString(e=""){let r=Buffer.byteLength(e);return this.ensure(r),this.buffer.write(e,this.offset),this.offset+=r,this}add(e){return this.ensure(e.length),e.copy(this.buffer,this.offset),this.offset+=e.length,this}join(e){if(e){this.buffer[this.headerPosition]=e;let r=this.offset-(this.headerPosition+1);this.buffer.writeInt32BE(r,this.headerPosition+1)}return this.buffer.slice(e?0:5,this.offset)}flush(e){let r=this.join(e);return this.offset=5,this.headerPosition=0,this.buffer=Buffer.allocUnsafe(this.size),r}};fi.Writer=Ml});var Lp=w(hi=>{"use strict";Object.defineProperty(hi,"__esModule",{value:!0});hi.serialize=void 0;var Bl=Ap(),ne=new Bl.Writer,Vv=t=>{ne.addInt16(3).addInt16(0);for(let s of Object.keys(t))ne.addCString(s).addCString(t[s]);ne.addCString("client_encoding").addCString("UTF8");let e=ne.addCString("").flush(),r=e.length+4;return new Bl.Writer().addInt32(r).add(e).flush()},Gv=()=>{let t=Buffer.allocUnsafe(8);return t.writeInt32BE(8,0),t.writeInt32BE(80877103,4),t},Qv=t=>ne.addCString(t).flush(112),Kv=function(t,e){return ne.addCString(t).addInt32(Buffer.byteLength(e)).addString(e),ne.flush(112)},Hv=function(t){return ne.addString(t).flush(112)},Jv=t=>ne.addCString(t).flush(81),Pp=[],Yv=t=>{let e=t.name||"";e.length>63&&(console.error("Warning! Postgres only supports 63 characters for query names."),console.error("You supplied %s (%s)",e,e.length),console.error("This can cause conflicts and silent errors executing queries"));let r=t.types||Pp,s=r.length,n=ne.addCString(e).addCString(t.text).addInt16(s);for(let i=0;i<s;i++)n.addInt32(r[i]);return ne.flush(80)},Mr=new Bl.Writer,Xv=function(t,e){for(let r=0;r<t.length;r++){let s=e?e(t[r],r):t[r];s==null?(ne.addInt16(0),Mr.addInt32(-1)):s instanceof Buffer?(ne.addInt16(1),Mr.addInt32(s.length),Mr.add(s)):(ne.addInt16(0),Mr.addInt32(Buffer.byteLength(s)),Mr.addString(s))}},Zv=(t={})=>{let e=t.portal||"",r=t.statement||"",s=t.binary||!1,n=t.values||Pp,i=n.length;return ne.addCString(e).addCString(r),ne.addInt16(i),Xv(n,t.valueMapper),ne.addInt16(i),ne.add(Mr.flush()),ne.addInt16(1),ne.addInt16(s?1:0),ne.flush(66)},e0=Buffer.from([69,0,0,0,9,0,0,0,0,0]),t0=t=>{if(!t||!t.portal&&!t.rows)return e0;let e=t.portal||"",r=t.rows||0,s=Buffer.byteLength(e),n=4+s+1+4,i=Buffer.allocUnsafe(1+n);return i[0]=69,i.writeInt32BE(n,1),i.write(e,5,"utf-8"),i[s+5]=0,i.writeUInt32BE(r,i.length-4),i},r0=(t,e)=>{let r=Buffer.allocUnsafe(16);return r.writeInt32BE(16,0),r.writeInt16BE(1234,4),r.writeInt16BE(5678,6),r.writeInt32BE(t,8),r.writeInt32BE(e,12),r},$l=(t,e)=>{let s=4+Buffer.byteLength(e)+1,n=Buffer.allocUnsafe(1+s);return n[0]=t,n.writeInt32BE(s,1),n.write(e,5,"utf-8"),n[s]=0,n},s0=ne.addCString("P").flush(68),n0=ne.addCString("S").flush(68),i0=t=>t.name?$l(68,`${t.type}${t.name||""}`):t.type==="P"?s0:n0,o0=t=>{let e=`${t.type}${t.name||""}`;return $l(67,e)},a0=t=>ne.add(t).flush(100),l0=t=>$l(102,t),di=t=>Buffer.from([t,0,0,0,4]),c0=di(72),u0=di(83),f0=di(88),d0=di(99),h0={startup:Vv,password:Qv,requestSsl:Gv,sendSASLInitialResponseMessage:Kv,sendSCRAMClientFinalMessage:Hv,query:Jv,parse:Yv,bind:Zv,execute:t0,describe:i0,close:o0,flush:()=>c0,sync:()=>u0,end:()=>f0,copyData:a0,copyDone:()=>d0,copyFail:l0,cancel:r0};hi.serialize=h0});var xp=w(pi=>{"use strict";Object.defineProperty(pi,"__esModule",{value:!0});pi.BufferReader=void 0;var p0=Buffer.allocUnsafe(0),Wl=class{constructor(e=0){this.offset=e,this.buffer=p0,this.encoding="utf-8"}setBuffer(e,r){this.offset=e,this.buffer=r}int16(){let e=this.buffer.readInt16BE(this.offset);return this.offset+=2,e}byte(){let e=this.buffer[this.offset];return this.offset++,e}int32(){let e=this.buffer.readInt32BE(this.offset);return this.offset+=4,e}uint32(){let e=this.buffer.readUInt32BE(this.offset);return this.offset+=4,e}string(e){let r=this.buffer.toString(this.encoding,this.offset,this.offset+e);return this.offset+=e,r}cstring(){let e=this.offset,r=e;for(;this.buffer[r++]!==0;);return this.offset=r,this.buffer.toString(this.encoding,e,r-1)}bytes(e){let r=this.buffer.slice(this.offset,this.offset+e);return this.offset+=e,r}};pi.BufferReader=Wl});var $p=w(mi=>{"use strict";Object.defineProperty(mi,"__esModule",{value:!0});mi.Parser=void 0;var ce=ql(),m0=xp(),Fl=1,w0=4,qp=Fl+w0,Ge=-1,Ul=Buffer.allocUnsafe(0),zl=class{constructor(e){if(this.buffer=Ul,this.bufferLength=0,this.bufferOffset=0,this.reader=new m0.BufferReader,e?.mode==="binary")throw new Error("Binary mode not supported yet");this.mode=e?.mode||"text"}parse(e,r){this.mergeBuffer(e);let s=this.bufferOffset+this.bufferLength,n=this.bufferOffset;for(;n+qp<=s;){let i=this.buffer[n],o=this.buffer.readUInt32BE(n+Fl),a=Fl+o;if(a+n<=s){let l=this.handlePacket(n+qp,i,o,this.buffer);r(l),n+=a}else break}n===s?(this.buffer=Ul,this.bufferLength=0,this.bufferOffset=0):(this.bufferLength=s-n,this.bufferOffset=n)}mergeBuffer(e){if(this.bufferLength>0){let r=this.bufferLength+e.byteLength;if(r+this.bufferOffset>this.buffer.byteLength){let n;if(r<=this.buffer.byteLength&&this.bufferOffset>=this.bufferLength)n=this.buffer;else{let i=this.buffer.byteLength*2;for(;r>=i;)i*=2;n=Buffer.allocUnsafe(i)}this.buffer.copy(n,0,this.bufferOffset,this.bufferOffset+this.bufferLength),this.buffer=n,this.bufferOffset=0}e.copy(this.buffer,this.bufferOffset+this.bufferLength),this.bufferLength=r}else this.buffer=e,this.bufferOffset=0,this.bufferLength=e.byteLength}handlePacket(e,r,s,n){let{reader:i}=this;i.setBuffer(e,n);let o;switch(r){case 50:o=ce.bindComplete;break;case 49:o=ce.parseComplete;break;case 51:o=ce.closeComplete;break;case 110:o=ce.noData;break;case 115:o=ce.portalSuspended;break;case 99:o=ce.copyDone;break;case 87:o=ce.replicationStart;break;case 73:o=ce.emptyQuery;break;case 68:o=D0(i);break;case 67:o=y0(i);break;case 90:o=g0(i);break;case 65:o=b0(i);break;case 82:o=R0(i,s);break;case 83:o=T0(i);break;case 75:o=I0(i);break;case 69:o=Mp(i,"error");break;case 78:o=Mp(i,"notice");break;case 84:o=k0(i);break;case 116:o=O0(i);break;case 71:o=S0(i);break;case 72:o=E0(i);break;case 100:o=_0(i,s);break;default:return new ce.DatabaseError("received invalid response: "+r.toString(16),s,"error")}return i.setBuffer(0,Ul),o.length=s,o}};mi.Parser=zl;var g0=t=>{let e=t.string(1);return new ce.ReadyForQueryMessage(Ge,e)},y0=t=>{let e=t.cstring();return new ce.CommandCompleteMessage(Ge,e)},_0=(t,e)=>{let r=t.bytes(e-4);return new ce.CopyDataMessage(Ge,r)},S0=t=>Bp(t,"copyInResponse"),E0=t=>Bp(t,"copyOutResponse"),Bp=(t,e)=>{let r=t.byte()!==0,s=t.int16(),n=new ce.CopyResponse(Ge,e,r,s);for(let i=0;i<s;i++)n.columnTypes[i]=t.int16();return n},b0=t=>{let e=t.int32(),r=t.cstring(),s=t.cstring();return new ce.NotificationResponseMessage(Ge,e,r,s)},k0=t=>{let e=t.int16(),r=new ce.RowDescriptionMessage(Ge,e);for(let s=0;s<e;s++)r.fields[s]=v0(t);return r},v0=t=>{let e=t.cstring(),r=t.uint32(),s=t.int16(),n=t.uint32(),i=t.int16(),o=t.int32(),a=t.int16()===0?"text":"binary";return new ce.Field(e,r,s,n,i,o,a)},O0=t=>{let e=t.int16(),r=new ce.ParameterDescriptionMessage(Ge,e);for(let s=0;s<e;s++)r.dataTypeIDs[s]=t.int32();return r},D0=t=>{let e=t.int16(),r=new Array(e);for(let s=0;s<e;s++){let n=t.int32();r[s]=n===-1?null:t.string(n)}return new ce.DataRowMessage(Ge,r)},T0=t=>{let e=t.cstring(),r=t.cstring();return new ce.ParameterStatusMessage(Ge,e,r)},I0=t=>{let e=t.int32(),r=t.int32();return new ce.BackendKeyDataMessage(Ge,e,r)},R0=(t,e)=>{let r=t.int32(),s={name:"authenticationOk",length:e};switch(r){case 0:break;case 3:s.length===8&&(s.name="authenticationCleartextPassword");break;case 5:if(s.length===12){s.name="authenticationMD5Password";let n=t.bytes(4);return new ce.AuthenticationMD5Password(Ge,n)}break;case 10:{s.name="authenticationSASL",s.mechanisms=[];let n;do n=t.cstring(),n&&s.mechanisms.push(n);while(n)}break;case 11:s.name="authenticationSASLContinue",s.data=t.string(e-8);break;case 12:s.name="authenticationSASLFinal",s.data=t.string(e-8);break;default:throw new Error("Unknown authenticationOk message type "+r)}return s},Mp=(t,e)=>{let r={},s=t.string(1);for(;s!=="\0";)r[s]=t.cstring(),s=t.string(1);let n=r.M,i=e==="notice"?new ce.NoticeMessage(Ge,n):new ce.DatabaseError(n,Ge,e);return i.severity=r.S,i.code=r.C,i.detail=r.D,i.hint=r.H,i.position=r.P,i.internalPosition=r.p,i.internalQuery=r.q,i.where=r.W,i.schema=r.s,i.table=r.t,i.column=r.c,i.dataType=r.d,i.constraint=r.n,i.file=r.F,i.line=r.L,i.routine=r.R,i}});var jl=w($t=>{"use strict";Object.defineProperty($t,"__esModule",{value:!0});$t.DatabaseError=$t.serialize=$t.parse=void 0;var C0=ql();Object.defineProperty($t,"DatabaseError",{enumerable:!0,get:function(){return C0.DatabaseError}});var N0=Lp();Object.defineProperty($t,"serialize",{enumerable:!0,get:function(){return N0.serialize}});var A0=$p();function P0(t,e){let r=new A0.Parser;return t.on("data",s=>r.parse(s,e)),new Promise(s=>t.on("end",()=>s()))}$t.parse=P0});var Wp=w(Vl=>{"use strict";Object.defineProperty(Vl,"__esModule",{value:!0});Vl.default={}});var Up=w((iL,Gl)=>{Gl.exports.getStream=function(e){let r=require("net");if(typeof r.Socket=="function")return new r.Socket;{let{CloudflareSocket:s}=Wp();return new s(e)}};Gl.exports.getSecureStream=function(e){var r=require("tls");return r.connect?r.connect(e):(e.socket.startTls(e),e.socket)}});var Kl=w((aL,Fp)=>{"use strict";var oL=require("net"),L0=require("events").EventEmitter,{parse:x0,serialize:Se}=jl(),{getStream:q0,getSecureStream:M0}=Up(),B0=Se.flush(),$0=Se.sync(),W0=Se.end(),Ql=class extends L0{constructor(e){super(),e=e||{},this.stream=e.stream||q0(e.ssl),typeof this.stream=="function"&&(this.stream=this.stream(e)),this._keepAlive=e.keepAlive,this._keepAliveInitialDelayMillis=e.keepAliveInitialDelayMillis,this.lastBuffer=!1,this.parsedStatements={},this.ssl=e.ssl||!1,this._ending=!1,this._emitMessage=!1;var r=this;this.on("newListener",function(s){s==="message"&&(r._emitMessage=!0)})}connect(e,r){var s=this;this._connecting=!0,this.stream.setNoDelay(!0),this.stream.connect(e,r),this.stream.once("connect",function(){s._keepAlive&&s.stream.setKeepAlive(!0,s._keepAliveInitialDelayMillis),s.emit("connect")});let n=function(i){s._ending&&(i.code==="ECONNRESET"||i.code==="EPIPE")||s.emit("error",i)};if(this.stream.on("error",n),this.stream.on("close",function(){s.emit("end")}),!this.ssl)return this.attachListeners(this.stream);this.stream.once("data",function(i){var o=i.toString("utf8");switch(o){case"S":break;case"N":return s.stream.end(),s.emit("error",new Error("The server does not support SSL connections"));default:return s.stream.end(),s.emit("error",new Error("There was an error establishing an SSL connection"))}let a={socket:s.stream};s.ssl!==!0&&(Object.assign(a,s.ssl),"key"in s.ssl&&(a.key=s.ssl.key));var l=require("net");l.isIP&&l.isIP(r)===0&&(a.servername=r);try{s.stream=M0(a)}catch(c){return s.emit("error",c)}s.attachListeners(s.stream),s.stream.on("error",n),s.emit("sslconnect")})}attachListeners(e){x0(e,r=>{var s=r.name==="error"?"errorMessage":r.name;this._emitMessage&&this.emit("message",r),this.emit(s,r)})}requestSsl(){this.stream.write(Se.requestSsl())}startup(e){this.stream.write(Se.startup(e))}cancel(e,r){this._send(Se.cancel(e,r))}password(e){this._send(Se.password(e))}sendSASLInitialResponseMessage(e,r){this._send(Se.sendSASLInitialResponseMessage(e,r))}sendSCRAMClientFinalMessage(e){this._send(Se.sendSCRAMClientFinalMessage(e))}_send(e){return this.stream.writable?this.stream.write(e):!1}query(e){this._send(Se.query(e))}parse(e){this._send(Se.parse(e))}bind(e){this._send(Se.bind(e))}execute(e){this._send(Se.execute(e))}flush(){this.stream.writable&&this.stream.write(B0)}sync(){this._ending=!0,this._send($0)}ref(){this.stream.ref()}unref(){this.stream.unref()}end(){if(this._ending=!0,!this._connecting||!this.stream.writable){this.stream.end();return}return this.stream.write(W0,()=>{this.stream.end()})}close(e){this._send(Se.close(e))}describe(e){this._send(Se.describe(e))}sendCopyFromChunk(e){this._send(Se.copyData(e))}endCopyFrom(){this._send(Se.copyDone())}sendCopyFail(e){this._send(Se.copyFail(e))}};Fp.exports=Ql});var Gp=w((lL,Vp)=>{"use strict";var{Transform:U0}=require("stream"),{StringDecoder:F0}=require("string_decoder"),Wt=Symbol("last"),wi=Symbol("decoder");function z0(t,e,r){let s;if(this.overflow){if(s=this[wi].write(t).split(this.matcher),s.length===1)return r();s.shift(),this.overflow=!1}else this[Wt]+=this[wi].write(t),s=this[Wt].split(this.matcher);this[Wt]=s.pop();for(let n=0;n<s.length;n++)try{jp(this,this.mapper(s[n]))}catch(i){return r(i)}if(this.overflow=this[Wt].length>this.maxLength,this.overflow&&!this.skipOverflow){r(new Error("maximum buffer reached"));return}r()}function j0(t){if(this[Wt]+=this[wi].end(),this[Wt])try{jp(this,this.mapper(this[Wt]))}catch(e){return t(e)}t()}function jp(t,e){e!==void 0&&t.push(e)}function zp(t){return t}function V0(t,e,r){switch(t=t||/\r?\n/,e=e||zp,r=r||{},arguments.length){case 1:typeof t=="function"?(e=t,t=/\r?\n/):typeof t=="object"&&!(t instanceof RegExp)&&!t[Symbol.split]&&(r=t,t=/\r?\n/);break;case 2:typeof t=="function"?(r=e,e=t,t=/\r?\n/):typeof e=="object"&&(r=e,e=zp)}r=Object.assign({},r),r.autoDestroy=!0,r.transform=z0,r.flush=j0,r.readableObjectMode=!0;let s=new U0(r);return s[Wt]="",s[wi]=new F0("utf8"),s.matcher=t,s.mapper=e,s.maxLength=r.maxLength,s.skipOverflow=r.skipOverflow||!1,s.overflow=!1,s._destroy=function(n,i){this._writableState.errorEmitted=!1,i(n)},s}Vp.exports=V0});var Hp=w((cL,Dt)=>{"use strict";var Qp=require("path"),G0=require("stream").Stream,Q0=Gp(),Kp=require("util"),K0=5432,gi=process.platform==="win32",xs=process.stderr,H0=56,J0=7,Y0=61440,X0=32768;function Z0(t){return(t&Y0)==X0}var Br=["host","port","database","user","password"],Hl=Br.length,eO=Br[Hl-1];function Jl(){var t=xs instanceof G0&&xs.writable===!0;if(t){var e=Array.prototype.slice.call(arguments).concat(`
`);xs.write(Kp.format.apply(Kp,e))}}Object.defineProperty(Dt.exports,"isWin",{get:function(){return gi},set:function(t){gi=t}});Dt.exports.warnTo=function(t){var e=xs;return xs=t,e};Dt.exports.getFileName=function(t){var e=t||process.env,r=e.PGPASSFILE||(gi?Qp.join(e.APPDATA||"./","postgresql","pgpass.conf"):Qp.join(e.HOME||"./",".pgpass"));return r};Dt.exports.usePgPass=function(t,e){return Object.prototype.hasOwnProperty.call(process.env,"PGPASSWORD")?!1:gi?!0:(e=e||"<unkn>",Z0(t.mode)?t.mode&(H0|J0)?(Jl('WARNING: password file "%s" has group or world access; permissions should be u=rw (0600) or less',e),!1):!0:(Jl('WARNING: password file "%s" is not a plain file',e),!1))};var tO=Dt.exports.match=function(t,e){return Br.slice(0,-1).reduce(function(r,s,n){return n==1&&Number(t[s]||K0)===Number(e[s])?r&&!0:r&&(e[s]==="*"||e[s]===t[s])},!0)};Dt.exports.getPassword=function(t,e,r){var s,n=e.pipe(Q0());function i(l){var c=rO(l);c&&sO(c)&&tO(t,c)&&(s=c[eO],n.end())}var o=function(){e.destroy(),r(s)},a=function(l){e.destroy(),Jl("WARNING: error on reading file: %s",l),r(void 0)};e.on("error",a),n.on("data",i).on("end",o).on("error",a)};var rO=Dt.exports.parseLine=function(t){if(t.length<11||t.match(/^\s+#/))return null;for(var e="",r="",s=0,n=0,i=0,o={},a=!1,l=function(u,f,d){var p=t.substring(f,d);Object.hasOwnProperty.call(process.env,"PGPASS_NO_DEESCAPE")||(p=p.replace(/\\([:\\])/g,"$1")),o[Br[u]]=p},c=0;c<t.length-1;c+=1){if(e=t.charAt(c+1),r=t.charAt(c),a=s==Hl-1,a){l(s,n);break}c>=0&&e==":"&&r!=="\\"&&(l(s,n,c+1),n=c+2,s+=1)}return o=Object.keys(o).length===Hl?o:null,o},sO=Dt.exports.isValidEntry=function(t){for(var e={0:function(o){return o.length>0},1:function(o){return o==="*"?!0:(o=Number(o),isFinite(o)&&o>0&&o<9007199254740992&&Math.floor(o)===o)},2:function(o){return o.length>0},3:function(o){return o.length>0},4:function(o){return o.length>0}},r=0;r<Br.length;r+=1){var s=e[r],n=t[Br[r]]||"",i=s(n);if(!i)return!1}return!0}});var Yp=w((fL,Yl)=>{"use strict";var uL=require("path"),Jp=require("fs"),yi=Hp();Yl.exports=function(t,e){var r=yi.getFileName();Jp.stat(r,function(s,n){if(s||!yi.usePgPass(n,r))return e(void 0);var i=Jp.createReadStream(r);yi.getPassword(t,i,e)})};Yl.exports.warnTo=yi.warnTo});var tm=w((dL,em)=>{"use strict";var nO=require("events").EventEmitter,Xp=Ps(),Xl=gp(),iO=wl(),oO=_l(),Zp=Np(),aO=As(),lO=Kl(),cO=ml(),_i=class extends nO{constructor(e){super(),this.connectionParameters=new oO(e),this.user=this.connectionParameters.user,this.database=this.connectionParameters.database,this.port=this.connectionParameters.port,this.host=this.connectionParameters.host,Object.defineProperty(this,"password",{configurable:!0,enumerable:!1,writable:!0,value:this.connectionParameters.password}),this.replication=this.connectionParameters.replication;var r=e||{};this._Promise=r.Promise||global.Promise,this._types=new iO(r.types),this._ending=!1,this._ended=!1,this._connecting=!1,this._connected=!1,this._connectionError=!1,this._queryable=!0,this.connection=r.connection||new lO({stream:r.stream,ssl:this.connectionParameters.ssl,keepAlive:r.keepAlive||!1,keepAliveInitialDelayMillis:r.keepAliveInitialDelayMillis||0,encoding:this.connectionParameters.client_encoding||"utf8"}),this.queryQueue=[],this.binary=r.binary||aO.binary,this.processID=null,this.secretKey=null,this.ssl=this.connectionParameters.ssl||!1,this.ssl&&this.ssl.key&&Object.defineProperty(this.ssl,"key",{enumerable:!1}),this._connectionTimeoutMillis=r.connectionTimeoutMillis||0}_errorAllQueries(e){let r=s=>{process.nextTick(()=>{s.handleError(e,this.connection)})};this.activeQuery&&(r(this.activeQuery),this.activeQuery=null),this.queryQueue.forEach(r),this.queryQueue.length=0}_connect(e){var r=this,s=this.connection;if(this._connectionCallback=e,this._connecting||this._connected){let n=new Error("Client has already been connected. You cannot reuse a client.");process.nextTick(()=>{e(n)});return}this._connecting=!0,this.connectionTimeoutHandle,this._connectionTimeoutMillis>0&&(this.connectionTimeoutHandle=setTimeout(()=>{s._ending=!0,s.stream.destroy(new Error("timeout expired"))},this._connectionTimeoutMillis)),this.host&&this.host.indexOf("/")===0?s.connect(this.host+"/.s.PGSQL."+this.port):s.connect(this.port,this.host),s.on("connect",function(){r.ssl?s.requestSsl():s.startup(r.getStartupConf())}),s.on("sslconnect",function(){s.startup(r.getStartupConf())}),this._attachListeners(s),s.once("end",()=>{let n=this._ending?new Error("Connection terminated"):new Error("Connection terminated unexpectedly");clearTimeout(this.connectionTimeoutHandle),this._errorAllQueries(n),this._ended=!0,this._ending||(this._connecting&&!this._connectionError?this._connectionCallback?this._connectionCallback(n):this._handleErrorEvent(n):this._connectionError||this._handleErrorEvent(n)),process.nextTick(()=>{this.emit("end")})})}connect(e){if(e){this._connect(e);return}return new this._Promise((r,s)=>{this._connect(n=>{n?s(n):r()})})}_attachListeners(e){e.on("authenticationCleartextPassword",this._handleAuthCleartextPassword.bind(this)),e.on("authenticationMD5Password",this._handleAuthMD5Password.bind(this)),e.on("authenticationSASL",this._handleAuthSASL.bind(this)),e.on("authenticationSASLContinue",this._handleAuthSASLContinue.bind(this)),e.on("authenticationSASLFinal",this._handleAuthSASLFinal.bind(this)),e.on("backendKeyData",this._handleBackendKeyData.bind(this)),e.on("error",this._handleErrorEvent.bind(this)),e.on("errorMessage",this._handleErrorMessage.bind(this)),e.on("readyForQuery",this._handleReadyForQuery.bind(this)),e.on("notice",this._handleNotice.bind(this)),e.on("rowDescription",this._handleRowDescription.bind(this)),e.on("dataRow",this._handleDataRow.bind(this)),e.on("portalSuspended",this._handlePortalSuspended.bind(this)),e.on("emptyQuery",this._handleEmptyQuery.bind(this)),e.on("commandComplete",this._handleCommandComplete.bind(this)),e.on("parseComplete",this._handleParseComplete.bind(this)),e.on("copyInResponse",this._handleCopyInResponse.bind(this)),e.on("copyData",this._handleCopyData.bind(this)),e.on("notification",this._handleNotification.bind(this))}_checkPgPass(e){let r=this.connection;if(typeof this.password=="function")this._Promise.resolve().then(()=>this.password()).then(s=>{if(s!==void 0){if(typeof s!="string"){r.emit("error",new TypeError("Password must be a string"));return}this.connectionParameters.password=this.password=s}else this.connectionParameters.password=this.password=null;e()}).catch(s=>{r.emit("error",s)});else if(this.password!==null)e();else try{Yp()(this.connectionParameters,n=>{n!==void 0&&(this.connectionParameters.password=this.password=n),e()})}catch(s){this.emit("error",s)}}_handleAuthCleartextPassword(e){this._checkPgPass(()=>{this.connection.password(this.password)})}_handleAuthMD5Password(e){this._checkPgPass(async()=>{try{let r=await cO.postgresMd5PasswordHash(this.user,this.password,e.salt);this.connection.password(r)}catch(r){this.emit("error",r)}})}_handleAuthSASL(e){this._checkPgPass(()=>{try{this.saslSession=Xl.startSession(e.mechanisms),this.connection.sendSASLInitialResponseMessage(this.saslSession.mechanism,this.saslSession.response)}catch(r){this.connection.emit("error",r)}})}async _handleAuthSASLContinue(e){try{await Xl.continueSession(this.saslSession,this.password,e.data),this.connection.sendSCRAMClientFinalMessage(this.saslSession.response)}catch(r){this.connection.emit("error",r)}}_handleAuthSASLFinal(e){try{Xl.finalizeSession(this.saslSession,e.data),this.saslSession=null}catch(r){this.connection.emit("error",r)}}_handleBackendKeyData(e){this.processID=e.processID,this.secretKey=e.secretKey}_handleReadyForQuery(e){this._connecting&&(this._connecting=!1,this._connected=!0,clearTimeout(this.connectionTimeoutHandle),this._connectionCallback&&(this._connectionCallback(null,this),this._connectionCallback=null),this.emit("connect"));let{activeQuery:r}=this;this.activeQuery=null,this.readyForQuery=!0,r&&r.handleReadyForQuery(this.connection),this._pulseQueryQueue()}_handleErrorWhileConnecting(e){if(!this._connectionError){if(this._connectionError=!0,clearTimeout(this.connectionTimeoutHandle),this._connectionCallback)return this._connectionCallback(e);this.emit("error",e)}}_handleErrorEvent(e){if(this._connecting)return this._handleErrorWhileConnecting(e);this._queryable=!1,this._errorAllQueries(e),this.emit("error",e)}_handleErrorMessage(e){if(this._connecting)return this._handleErrorWhileConnecting(e);let r=this.activeQuery;if(!r){this._handleErrorEvent(e);return}this.activeQuery=null,r.handleError(e,this.connection)}_handleRowDescription(e){this.activeQuery.handleRowDescription(e)}_handleDataRow(e){this.activeQuery.handleDataRow(e)}_handlePortalSuspended(e){this.activeQuery.handlePortalSuspended(this.connection)}_handleEmptyQuery(e){this.activeQuery.handleEmptyQuery(this.connection)}_handleCommandComplete(e){this.activeQuery.handleCommandComplete(e,this.connection)}_handleParseComplete(e){this.activeQuery.name&&(this.connection.parsedStatements[this.activeQuery.name]=this.activeQuery.text)}_handleCopyInResponse(e){this.activeQuery.handleCopyInResponse(this.connection)}_handleCopyData(e){this.activeQuery.handleCopyData(e,this.connection)}_handleNotification(e){this.emit("notification",e)}_handleNotice(e){this.emit("notice",e)}getStartupConf(){var e=this.connectionParameters,r={user:e.user,database:e.database},s=e.application_name||e.fallback_application_name;return s&&(r.application_name=s),e.replication&&(r.replication=""+e.replication),e.statement_timeout&&(r.statement_timeout=String(parseInt(e.statement_timeout,10))),e.lock_timeout&&(r.lock_timeout=String(parseInt(e.lock_timeout,10))),e.idle_in_transaction_session_timeout&&(r.idle_in_transaction_session_timeout=String(parseInt(e.idle_in_transaction_session_timeout,10))),e.options&&(r.options=e.options),r}cancel(e,r){if(e.activeQuery===r){var s=this.connection;this.host&&this.host.indexOf("/")===0?s.connect(this.host+"/.s.PGSQL."+this.port):s.connect(this.port,this.host),s.on("connect",function(){s.cancel(e.processID,e.secretKey)})}else e.queryQueue.indexOf(r)!==-1&&e.queryQueue.splice(e.queryQueue.indexOf(r),1)}setTypeParser(e,r,s){return this._types.setTypeParser(e,r,s)}getTypeParser(e,r){return this._types.getTypeParser(e,r)}escapeIdentifier(e){return Xp.escapeIdentifier(e)}escapeLiteral(e){return Xp.escapeLiteral(e)}_pulseQueryQueue(){if(this.readyForQuery===!0)if(this.activeQuery=this.queryQueue.shift(),this.activeQuery){this.readyForQuery=!1,this.hasExecuted=!0;let e=this.activeQuery.submit(this.connection);e&&process.nextTick(()=>{this.activeQuery.handleError(e,this.connection),this.readyForQuery=!0,this._pulseQueryQueue()})}else this.hasExecuted&&(this.activeQuery=null,this.emit("drain"))}query(e,r,s){var n,i,o,a,l;if(e==null)throw new TypeError("Client was passed a null or undefined query");return typeof e.submit=="function"?(o=e.query_timeout||this.connectionParameters.query_timeout,i=n=e,typeof r=="function"&&(n.callback=n.callback||r)):(o=this.connectionParameters.query_timeout,n=new Zp(e,r,s),n.callback||(i=new this._Promise((c,u)=>{n.callback=(f,d)=>f?u(f):c(d)}).catch(c=>{throw Error.captureStackTrace(c),c}))),o&&(l=n.callback,a=setTimeout(()=>{var c=new Error("Query read timeout");process.nextTick(()=>{n.handleError(c,this.connection)}),l(c),n.callback=()=>{};var u=this.queryQueue.indexOf(n);u>-1&&this.queryQueue.splice(u,1),this._pulseQueryQueue()},o),n.callback=(c,u)=>{clearTimeout(a),l(c,u)}),this.binary&&!n.binary&&(n.binary=!0),n._result&&!n._result._types&&(n._result._types=this._types),this._queryable?this._ending?(process.nextTick(()=>{n.handleError(new Error("Client was closed and is not queryable"),this.connection)}),i):(this.queryQueue.push(n),this._pulseQueryQueue(),i):(process.nextTick(()=>{n.handleError(new Error("Client has encountered a connection error and is not queryable"),this.connection)}),i)}ref(){this.connection.ref()}unref(){this.connection.unref()}end(e){if(this._ending=!0,!this.connection._connecting||this._ended)if(e)e();else return this._Promise.resolve();if(this.activeQuery||!this._queryable?this.connection.stream.destroy():this.connection.end(),e)this.connection.once("end",e);else return new this._Promise(r=>{this.connection.once("end",r)})}};_i.Query=Zp;em.exports=_i});var im=w((hL,nm)=>{"use strict";var uO=require("events").EventEmitter,rm=function(){},sm=(t,e)=>{let r=t.findIndex(e);return r===-1?void 0:t.splice(r,1)[0]},Zl=class{constructor(e,r,s){this.client=e,this.idleListener=r,this.timeoutId=s}},$r=class{constructor(e){this.callback=e}};function fO(){throw new Error("Release called on client which has already been released to the pool.")}function Si(t,e){if(e)return{callback:e,result:void 0};let r,s,n=function(o,a){o?r(o):s(a)},i=new t(function(o,a){s=o,r=a}).catch(o=>{throw Error.captureStackTrace(o),o});return{callback:n,result:i}}function dO(t,e){return function r(s){s.client=e,e.removeListener("error",r),e.on("error",()=>{t.log("additional client error after disconnection due to error",s)}),t._remove(e),t.emit("error",s,e)}}var ec=class extends uO{constructor(e,r){super(),this.options=Object.assign({},e),e!=null&&"password"in e&&Object.defineProperty(this.options,"password",{configurable:!0,enumerable:!1,writable:!0,value:e.password}),e!=null&&e.ssl&&e.ssl.key&&Object.defineProperty(this.options.ssl,"key",{enumerable:!1}),this.options.max=this.options.max||this.options.poolSize||10,this.options.min=this.options.min||0,this.options.maxUses=this.options.maxUses||1/0,this.options.allowExitOnIdle=this.options.allowExitOnIdle||!1,this.options.maxLifetimeSeconds=this.options.maxLifetimeSeconds||0,this.log=this.options.log||function(){},this.Client=this.options.Client||r||Ei().Client,this.Promise=this.options.Promise||global.Promise,typeof this.options.idleTimeoutMillis>"u"&&(this.options.idleTimeoutMillis=1e4),this._clients=[],this._idle=[],this._expired=new WeakSet,this._pendingQueue=[],this._endCallback=void 0,this.ending=!1,this.ended=!1}_isFull(){return this._clients.length>=this.options.max}_isAboveMin(){return this._clients.length>this.options.min}_pulseQueue(){if(this.log("pulse queue"),this.ended){this.log("pulse queue ended");return}if(this.ending){this.log("pulse queue on ending"),this._idle.length&&this._idle.slice().map(r=>{this._remove(r.client)}),this._clients.length||(this.ended=!0,this._endCallback());return}if(!this._pendingQueue.length){this.log("no queued requests");return}if(!this._idle.length&&this._isFull())return;let e=this._pendingQueue.shift();if(this._idle.length){let r=this._idle.pop();clearTimeout(r.timeoutId);let s=r.client;s.ref&&s.ref();let n=r.idleListener;return this._acquireClient(s,e,n,!1)}if(!this._isFull())return this.newClient(e);throw new Error("unexpected condition")}_remove(e,r){let s=sm(this._idle,i=>i.client===e);s!==void 0&&clearTimeout(s.timeoutId),this._clients=this._clients.filter(i=>i!==e);let n=this;e.end(()=>{n.emit("remove",e),typeof r=="function"&&r()})}connect(e){if(this.ending){let n=new Error("Cannot use a pool after calling end on the pool");return e?e(n):this.Promise.reject(n)}let r=Si(this.Promise,e),s=r.result;if(this._isFull()||this._idle.length){if(this._idle.length&&process.nextTick(()=>this._pulseQueue()),!this.options.connectionTimeoutMillis)return this._pendingQueue.push(new $r(r.callback)),s;let n=(a,l,c)=>{clearTimeout(o),r.callback(a,l,c)},i=new $r(n),o=setTimeout(()=>{sm(this._pendingQueue,a=>a.callback===n),i.timedOut=!0,r.callback(new Error("timeout exceeded when trying to connect"))},this.options.connectionTimeoutMillis);return o.unref&&o.unref(),this._pendingQueue.push(i),s}return this.newClient(new $r(r.callback)),s}newClient(e){let r=new this.Client(this.options);this._clients.push(r);let s=dO(this,r);this.log("checking client timeout");let n,i=!1;this.options.connectionTimeoutMillis&&(n=setTimeout(()=>{this.log("ending client due to timeout"),i=!0,r.connection?r.connection.stream.destroy():r.end()},this.options.connectionTimeoutMillis)),this.log("connecting new client"),r.connect(o=>{if(n&&clearTimeout(n),r.on("error",s),o)this.log("client failed to connect",o),this._clients=this._clients.filter(a=>a!==r),i&&(o=new Error("Connection terminated due to connection timeout",{cause:o})),this._pulseQueue(),e.timedOut||e.callback(o,void 0,rm);else{if(this.log("new client connected"),this.options.maxLifetimeSeconds!==0){let a=setTimeout(()=>{this.log("ending client due to expired lifetime"),this._expired.add(r),this._idle.findIndex(c=>c.client===r)!==-1&&this._acquireClient(r,new $r((c,u,f)=>f()),s,!1)},this.options.maxLifetimeSeconds*1e3);a.unref(),r.once("end",()=>clearTimeout(a))}return this._acquireClient(r,e,s,!0)}})}_acquireClient(e,r,s,n){n&&this.emit("connect",e),this.emit("acquire",e),e.release=this._releaseOnce(e,s),e.removeListener("error",s),r.timedOut?n&&this.options.verify?this.options.verify(e,e.release):e.release():n&&this.options.verify?this.options.verify(e,i=>{if(i)return e.release(i),r.callback(i,void 0,rm);r.callback(void 0,e,e.release)}):r.callback(void 0,e,e.release)}_releaseOnce(e,r){let s=!1;return n=>{s&&fO(),s=!0,this._release(e,r,n)}}_release(e,r,s){if(e.on("error",r),e._poolUseCount=(e._poolUseCount||0)+1,this.emit("release",s,e),s||this.ending||!e._queryable||e._ending||e._poolUseCount>=this.options.maxUses)return e._poolUseCount>=this.options.maxUses&&this.log("remove expended client"),this._remove(e,this._pulseQueue.bind(this));if(this._expired.has(e))return this.log("remove expired client"),this._expired.delete(e),this._remove(e,this._pulseQueue.bind(this));let i;this.options.idleTimeoutMillis&&this._isAboveMin()&&(i=setTimeout(()=>{this._isAboveMin()&&(this.log("remove idle client"),this._remove(e,this._pulseQueue.bind(this)))},this.options.idleTimeoutMillis),this.options.allowExitOnIdle&&i.unref()),this.options.allowExitOnIdle&&e.unref(),this._idle.push(new Zl(e,r,i)),this._pulseQueue()}query(e,r,s){if(typeof e=="function"){let i=Si(this.Promise,e);return setImmediate(function(){return i.callback(new Error("Passing a function as the first parameter to pool.query is not supported"))}),i.result}typeof r=="function"&&(s=r,r=void 0);let n=Si(this.Promise,s);return s=n.callback,this.connect((i,o)=>{if(i)return s(i);let a=!1,l=c=>{a||(a=!0,o.release(c),s(c))};o.once("error",l),this.log("dispatching query");try{o.query(e,r,(c,u)=>{if(this.log("query dispatched"),o.removeListener("error",l),!a)return a=!0,o.release(c),c?s(c):s(void 0,u)})}catch(c){return o.release(c),s(c)}}),n.result}end(e){if(this.log("ending"),this.ending){let s=new Error("Called end on pool more than once");return e?e(s):this.Promise.reject(s)}this.ending=!0;let r=Si(this.Promise,e);return this._endCallback=r.callback,this._pulseQueue(),r.result}get waitingCount(){return this._pendingQueue.length}get idleCount(){return this._idle.length}get expiredCount(){return this._clients.reduce((e,r)=>e+(this._expired.has(r)?1:0),0)}get totalCount(){return this._clients.length}};nm.exports=ec});var lm=w((pL,am)=>{"use strict";var om=require("events").EventEmitter,hO=require("util"),tc=Ps(),Wr=am.exports=function(t,e,r){om.call(this),t=tc.normalizeQueryConfig(t,e,r),this.text=t.text,this.values=t.values,this.name=t.name,this.callback=t.callback,this.state="new",this._arrayMode=t.rowMode==="array",this._emitRowEvents=!1,this.on("newListener",function(s){s==="row"&&(this._emitRowEvents=!0)}.bind(this))};hO.inherits(Wr,om);var pO={sqlState:"code",statementPosition:"position",messagePrimary:"message",context:"where",schemaName:"schema",tableName:"table",columnName:"column",dataTypeName:"dataType",constraintName:"constraint",sourceFile:"file",sourceLine:"line",sourceFunction:"routine"};Wr.prototype.handleError=function(t){var e=this.native.pq.resultErrorFields();if(e)for(var r in e){var s=pO[r]||r;t[s]=e[r]}this.callback?this.callback(t):this.emit("error",t),this.state="error"};Wr.prototype.then=function(t,e){return this._getPromise().then(t,e)};Wr.prototype.catch=function(t){return this._getPromise().catch(t)};Wr.prototype._getPromise=function(){return this._promise?this._promise:(this._promise=new Promise(function(t,e){this._once("end",t),this._once("error",e)}.bind(this)),this._promise)};Wr.prototype.submit=function(t){this.state="running";var e=this;this.native=t.native,t.native.arrayMode=this._arrayMode;var r=function(i,o,a){if(t.native.arrayMode=!1,setImmediate(function(){e.emit("_done")}),i)return e.handleError(i);e._emitRowEvents&&(a.length>1?o.forEach((l,c)=>{l.forEach(u=>{e.emit("row",u,a[c])})}):o.forEach(function(l){e.emit("row",l,a)})),e.state="end",e.emit("end",a),e.callback&&e.callback(null,a)};if(process.domain&&(r=process.domain.bind(r)),this.name){this.name.length>63&&(console.error("Warning! Postgres only supports 63 characters for query names."),console.error("You supplied %s (%s)",this.name,this.name.length),console.error("This can cause conflicts and silent errors executing queries"));var s=(this.values||[]).map(tc.prepareValue);if(t.namedQueries[this.name]){if(this.text&&t.namedQueries[this.name]!==this.text){let i=new Error(`Prepared statements must be unique - '${this.name}' was used for a different statement`);return r(i)}return t.native.execute(this.name,s,r)}return t.native.prepare(this.name,this.text,s.length,function(i){return i?r(i):(t.namedQueries[e.name]=e.text,e.native.execute(e.name,s,r))})}else if(this.values){if(!Array.isArray(this.values)){let i=new Error("Query values must be an array");return r(i)}var n=this.values.map(tc.prepareValue);t.native.query(this.text,n,r)}else t.native.query(this.text,r)}});var hm=w((mL,dm)=>{"use strict";var cm;try{cm=require("pg-native")}catch(t){throw t}var mO=wl(),um=require("events").EventEmitter,wO=require("util"),gO=_l(),fm=lm(),$e=dm.exports=function(t){um.call(this),t=t||{},this._Promise=t.Promise||global.Promise,this._types=new mO(t.types),this.native=new cm({types:this._types}),this._queryQueue=[],this._ending=!1,this._connecting=!1,this._connected=!1,this._queryable=!0;var e=this.connectionParameters=new gO(t);t.nativeConnectionString&&(e.nativeConnectionString=t.nativeConnectionString),this.user=e.user,Object.defineProperty(this,"password",{configurable:!0,enumerable:!1,writable:!0,value:e.password}),this.database=e.database,this.host=e.host,this.port=e.port,this.namedQueries={}};$e.Query=fm;wO.inherits($e,um);$e.prototype._errorAllQueries=function(t){let e=r=>{process.nextTick(()=>{r.native=this.native,r.handleError(t)})};this._hasActiveQuery()&&(e(this._activeQuery),this._activeQuery=null),this._queryQueue.forEach(e),this._queryQueue.length=0};$e.prototype._connect=function(t){var e=this;if(this._connecting){process.nextTick(()=>t(new Error("Client has already been connected. You cannot reuse a client.")));return}this._connecting=!0,this.connectionParameters.getLibpqConnectionString(function(r,s){if(e.connectionParameters.nativeConnectionString&&(s=e.connectionParameters.nativeConnectionString),r)return t(r);e.native.connect(s,function(n){if(n)return e.native.end(),t(n);e._connected=!0,e.native.on("error",function(i){e._queryable=!1,e._errorAllQueries(i),e.emit("error",i)}),e.native.on("notification",function(i){e.emit("notification",{channel:i.relname,payload:i.extra})}),e.emit("connect"),e._pulseQueryQueue(!0),t()})})};$e.prototype.connect=function(t){if(t){this._connect(t);return}return new this._Promise((e,r)=>{this._connect(s=>{s?r(s):e()})})};$e.prototype.query=function(t,e,r){var s,n,i,o,a;if(t==null)throw new TypeError("Client was passed a null or undefined query");if(typeof t.submit=="function")i=t.query_timeout||this.connectionParameters.query_timeout,n=s=t,typeof e=="function"&&(t.callback=e);else if(i=this.connectionParameters.query_timeout,s=new fm(t,e,r),!s.callback){let l,c;n=new this._Promise((u,f)=>{l=u,c=f}).catch(u=>{throw Error.captureStackTrace(u),u}),s.callback=(u,f)=>u?c(u):l(f)}return i&&(a=s.callback,o=setTimeout(()=>{var l=new Error("Query read timeout");process.nextTick(()=>{s.handleError(l,this.connection)}),a(l),s.callback=()=>{};var c=this._queryQueue.indexOf(s);c>-1&&this._queryQueue.splice(c,1),this._pulseQueryQueue()},i),s.callback=(l,c)=>{clearTimeout(o),a(l,c)}),this._queryable?this._ending?(s.native=this.native,process.nextTick(()=>{s.handleError(new Error("Client was closed and is not queryable"))}),n):(this._queryQueue.push(s),this._pulseQueryQueue(),n):(s.native=this.native,process.nextTick(()=>{s.handleError(new Error("Client has encountered a connection error and is not queryable"))}),n)};$e.prototype.end=function(t){var e=this;this._ending=!0,this._connected||this.once("connect",this.end.bind(this,t));var r;return t||(r=new this._Promise(function(s,n){t=i=>i?n(i):s()})),this.native.end(function(){e._errorAllQueries(new Error("Connection terminated")),process.nextTick(()=>{e.emit("end"),t&&t()})}),r};$e.prototype._hasActiveQuery=function(){return this._activeQuery&&this._activeQuery.state!=="error"&&this._activeQuery.state!=="end"};$e.prototype._pulseQueryQueue=function(t){if(this._connected&&!this._hasActiveQuery()){var e=this._queryQueue.shift();if(!e){t||this.emit("drain");return}this._activeQuery=e,e.submit(this);var r=this;e.once("_done",function(){r._pulseQueryQueue()})}};$e.prototype.cancel=function(t){this._activeQuery===t?this.native.cancel(function(){}):this._queryQueue.indexOf(t)!==-1&&this._queryQueue.splice(this._queryQueue.indexOf(t),1)};$e.prototype.ref=function(){};$e.prototype.unref=function(){};$e.prototype.setTypeParser=function(t,e,r){return this._types.setTypeParser(t,e,r)};$e.prototype.getTypeParser=function(t,e){return this._types.getTypeParser(t,e)}});var rc=w((wL,pm)=>{"use strict";pm.exports=hm()});var Ei=w((yL,qs)=>{"use strict";var yO=tm(),_O=As(),SO=Kl(),EO=im(),{DatabaseError:bO}=jl(),{escapeIdentifier:kO,escapeLiteral:vO}=Ps(),OO=t=>class extends EO{constructor(r){super(r,t)}},sc=function(t){this.defaults=_O,this.Client=t,this.Query=this.Client.Query,this.Pool=OO(this.Client),this._pools=[],this.Connection=SO,this.types=Ns(),this.DatabaseError=bO,this.escapeIdentifier=kO,this.escapeLiteral=vO};typeof process.env.NODE_PG_FORCE_NATIVE<"u"?qs.exports=new sc(rc()):(qs.exports=new sc(yO),Object.defineProperty(qs.exports,"native",{configurable:!0,enumerable:!1,get(){var t=null;try{t=new sc(rc())}catch(e){if(e.code!=="MODULE_NOT_FOUND")throw e}return Object.defineProperty(qs.exports,"native",{value:t}),t}}))});var ki=w(fe=>{"use strict";Object.defineProperty(fe,"__esModule",{value:!0});fe.getPGDatabaseOwner=fe.currentDBUserIdentity=fe.connectToPGAndReportOutcome=fe.connectToPGDatabase=fe.maskDatabaseUrl=fe.getDatabaseNameFromUrl=fe.getPGClientConfig=fe.deriveDatabaseUrl=fe.ensurePGDatabase=fe.dropPGDatabase=void 0;var mm=Ei();async function DO(t={}){if(!t.urlToDrop&&!t.dbToDrop)throw new TypeError("dropPGDatabase requires a target database name or URL to DROP");let e=[],r=u=>{e.push(u),(t.logger??console.log)(u)};function s(u,f){return r(`FAIL: ${u}${f?` | HINT: ${f}`:""}`),{message:u,status:"failed",notes:e,hint:f}}let n=t.adminUrl??(t.urlToDrop?ur(t.urlToDrop,"postgres"):void 0);if(!n)throw new TypeError("dropPostgresDatabase requires a connection string to a database with permission to perform the DROP");let i=ur(t.urlToDrop??n,"template1"),o=t.tryTemplate1Fallback??!0,a=t.dbToDrop??oc(t.urlToDrop);if(!a)return s("Target URL has no database name in the path (e.g., /mydb).","Fix the target URL and retry.");r(`Target DB to drop: ${a}`),r(`Admin URL (planned): ${Ws(n)}`);let l=await Bs(n,r);!l&&o&&(r("Admin connect failed. Trying template1 as a fallback..."),l=await Bs(i,r));let c=async()=>{if(!l)return"unknown";let{rows:u}=await l.query("SELECT EXISTS (SELECT 1 FROM pg_database WHERE datname = $1) AS exists",[a]);return u[0]?.exists??!1};try{let u="unknown";if(l&&(u=await c(),u===!1))return r(`DB "${a}" does not exist (confirmed via catalog).`),{status:"did_not_exist",notes:e,message:"Success (already dropped)"};if(!l){let m=await bi(t.urlToDrop??ur(n,a),r,"probe target (existence test)");return m.result==="ok"?(await m.client.end().catch(()=>{}),s(`Database "${a}" exists, but we could not establish an admin connection to drop it.`,"Provide an admin/alternate DB URL (same server) with privileges to DROP DATABASE")):m.code==="3D000"?(r(`DB "${a}" does not exist (error 3D000 while connecting). Database already does not exist.`),{status:"did_not_exist",notes:e,message:"Success (already dropped)"}):s(`Could not establish any admin connection, and target connect failed with ${m.code??m.result}.`,ym(m.code))}let f=await wm(l),d=await gm(l,a);!f.isSuperuser&&d&&d!==f.user&&(r(`Ownership check: DB owned by "${d}", current_user is "${f.user}" (superuser=${f.isSuperuser}).`),r("Warning: You might lack privileges to DROP this database unless you are the owner or superuser."));try{r("Attempting DROP ... WITH (FORCE)."),await IO(l,a)}catch(m){let h=m;if(CO(h)){r("WITH (FORCE) not supported by server (syntax error). Falling back to terminate-and-drop.");try{await NO(l,a,3e3,r)}catch(g){let y=g;return await l.end().catch(()=>{}),s(`Drop failed even after fallback: ${$s(y)}`,nc(y?.code))}}else return await l.end().catch(()=>{}),s(`Drop failed: ${$s(h)}`,nc(h?.code))}let p=await c();return p===!1?(r(`Verified: database "${a}" is gone.`),{status:"dropped",notes:e,message:"Success (dropped)"}):p===!0?s(`After drop attempt, database "${a}" still exists.`,"Terminate all sessions and retry."):(r("Could not verify drop due to unexpected state."),{status:"dropped",notes:e,message:"Success (dropped)"})}finally{await l?.end().catch(()=>{})}}fe.dropPGDatabase=DO;async function TO(t){if(!t.urlToEnsure&&!t.dbToEnsure)throw new TypeError("ensurePGDatabase requires a target database name or URL to check");let e=[],r=u=>{e.push(u),(t.logger??console.log)(u)};function s(u,f){return r(`FAIL: ${u}${f?` | HINT: ${f}`:""}`),{status:"failed",notes:e,hint:f,message:u}}let n=t.dbToEnsure??oc(t.urlToEnsure);if(!n)return s("Target URL has no database name in the path (e.g., /mydb).","Fix the target URL and retry.");if(t.urlToEnsure)try{let u=await bi(t.urlToEnsure,r,"probe target (existence test)");if(u.result==="ok")return await u.client.end().catch(()=>{}),{status:"already_exists",notes:e,message:"Success (already existed)"}}catch{r("Caught error probing database: (e as Error).message; attempting create.")}let i=t.adminUrl??(t.urlToEnsure?ur(t.urlToEnsure,"postgres"):void 0);if(!i)throw new TypeError("dropPostgresDatabase requires a connection string to a database with permission to perform the DROP");let o=ur(t.urlToEnsure??i,"template1"),a=t.tryTemplate1Fallback??!0,l=await Bs(i,r);!l&&a&&(r("Admin connect failed. Trying template1 as a fallback..."),l=await Bs(o,r));let c=async()=>{if(!l)return"unknown";let{rows:u}=await l.query("SELECT EXISTS (SELECT 1 FROM pg_database WHERE datname = $1) AS exists",[n]);return u[0]?.exists??!1};try{let u="unknown";if(l&&(u=await c(),u===!0))return r(`DB "${n}" exists (confirmed via catalog).`),{status:"already_exists",notes:e,message:"Success (already existed)"};if(!l){let d=t.urlToEnsure??ur(i,n),p=await bi(d,r,"probe target (existence test)");return p.result==="ok"?(await p.client.end().catch(()=>{}),r(`Probe of database ${n} via ${Ws(d)} succeeds.`),{status:"already_exists",notes:e,message:"Success (already existed)"}):s(`Could not establish any admin connection, and target connect failed with ${p.code??p.result}.`,ym(p.code))}try{r("Attempting CREATE."),await RO(l,n)}catch(d){let p=d;return await l.end().catch(()=>{}),s(`Create failed: ${$s(p)}`,nc(p?.code))}let f=await c();return f===!0?(r(`Verified: database "${n}" exists.`),{status:"created",notes:e,message:"Success (created)"}):f===!1?s(`After create attempt, database "${n}" does not exist still.`):(r("Could not verify creation due to unexpected state."),{status:"created",notes:e,message:"Success (unverified)"})}finally{await l?.end().catch(()=>{})}}fe.ensurePGDatabase=TO;function ur(t,e){try{let r=new URL(t);return r.pathname=`/${e}`,r.toString()}catch{return t}}fe.deriveDatabaseUrl=ur;function ic(t){let e=typeof t=="string"?t:t.toString(),r=s(typeof t=="string"?new URL(t):t);return{connectionString:e,connectionTimeoutMillis:r?r*1e3:1e4};function s(n){try{let i=n.searchParams.get("connect_timeout");return i?parseInt(i,10):void 0}catch{return}}}fe.getPGClientConfig=ic;function oc(t){return new URL(t).pathname?.replace(/^\//,"")||""}fe.getDatabaseNameFromUrl=oc;function Ws(t){try{let e=new URL(t);if(e.password){let r=decodeURIComponent(e.password),s=r.length<=2?r:`${r[0]}${"*".repeat(r.length-2)}${r[r.length-1]}`;e.password=encodeURIComponent(s)}return e.toString()}catch{return t}}fe.maskDatabaseUrl=Ws;async function Bs(t,e){e(`Connecting: ${Ws(t)}`);let r=new mm.Client(ic(t));r.on("error",s=>{e(`Unexpected error in startup client: ${s}`)});try{return await r.connect(),r}catch(s){let n=s;e(`Connect failed: ${$s(n)}${n?.code?` (code ${n.code})`:""}`);try{await r.end()}catch{}return null}}fe.connectToPGDatabase=Bs;async function bi(t,e,r){e(`Connecting to ${r}: ${Ws(t)}`);let s=new mm.Client(ic(t));s.on("error",n=>{e(`Unexpected error in startup client: ${n}`)});try{return await s.connect(),{result:"ok",client:s}}catch(n){let i=n;try{await s.end()}catch{}return{result:"error",code:i?.code,message:i?.message??String(i)}}}fe.connectToPGAndReportOutcome=bi;function $s(t){let e=t?.message??String(t);return e.length>500?`${e.slice(0,500)}\u2026`:e}async function wm(t){let{rows:e}=await t.query("SELECT current_user AS user"),r=e[0]?.user??"",{rows:s}=await t.query("SELECT rolsuper FROM pg_roles WHERE rolname = current_user");return{user:r,isSuperuser:!!s[0]?.rolsuper}}fe.currentDBUserIdentity=wm;async function gm(t,e){let{rows:r}=await t.query(`SELECT r.rolname AS owner
     FROM pg_database d JOIN pg_roles r ON r.oid = d.datdba
     WHERE d.datname = $1`,[e]);return r[0]?.owner??null}fe.getPGDatabaseOwner=gm;function Ms(t){return`"${t.replace(/"/g,'""')}"`}async function IO(t,e){await t.query(`DROP DATABASE IF EXISTS ${Ms(e)} WITH (FORCE)`)}async function RO(t,e){await t.query(`CREATE DATABASE ${Ms(e)}`)}function CO(t){return t?.code==="42601"||/WITH\s*\(\s*FORCE\s*\)/i.test(t?.message??"")}async function NO(t,e,r,s){try{await t.query(`ALTER DATABASE ${Ms(e)} WITH ALLOW_CONNECTIONS = false`)}catch(n){s(`ALTER DATABASE ... ALLOW_CONNECTIONS=false failed (continuing): ${$s(n)}`)}await t.query("SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE datname = $1 AND pid <> pg_backend_pid()",[e]),r>0&&(s(`Waiting ${r}ms for backends to terminate...`),await new Promise(n=>setTimeout(n,r)));try{await t.query(`DROP DATABASE IF EXISTS ${Ms(e)}`)}catch(n){let i=n;if(i?.code==="55006")s('DB still "being accessed by other users"; retrying after extra wait...'),await new Promise(o=>setTimeout(o,Math.max(1e3,r))),await t.query("SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE datname = $1 AND pid <> pg_backend_pid()",[e]),await t.query(`DROP DATABASE IF EXISTS ${Ms(e)}`);else throw i}}function ym(t){if(t)switch(t){case"ECONNREFUSED":return"Server not reachable. Check host/port or firewall.";case"ENOTFOUND":return"Hostname not resolvable. Check DNS/host.";case"ETIMEDOUT":return"Connection timed out. Check network/firewall.";case"28P01":return"Invalid password.";case"28000":return"Authentication rejected (pg_hba.conf or method).";default:return t.substring(0,2)==="28"?"Other connection security error":void 0}}function nc(t){switch(t?.substring(0,5)){case"42501":return"Insufficient privilege. You must be the owner or a superuser.";case"53300":return"Too many connections to server; free some slots.";default:break}switch(t?.substring(0,2)){case"42":return"Syntax error or access rule violation.";case"3D":return"Target database does not exist (already gone).";case"55":return"Database is in use. Terminate sessions or use PG13+ WITH (FORCE).";case"53":return"Insufficient resources.";default:return}}});var Sm=w(Ur=>{"use strict";Object.defineProperty(Ur,"__esModule",{value:!0});Ur.runSysMigrationsPg=Ur.getCurrentSysDBVersion=void 0;async function _m(t,e="dbos"){if(!(await t.query("SELECT table_name FROM information_schema.tables WHERE table_schema = $1 AND table_name = 'dbos_migrations'",[e])).rows[0]?.table_name)return 0;let s=await t.query(`select version from "${e}"."dbos_migrations" order by version desc limit 1`);if(s.rowCount===0)return 0;let n=s.rows[0].version,i=Number(n);return Number.isFinite(i)?i:0}Ur.getCurrentSysDBVersion=_m;var AO=new Set(["42P07","42710","42701","42P06","23505"]);function PO(t){return typeof t=="object"&&t!==null&&("code"in t||"message"in t)}function LO(t,e){if(!PO(t))return!1;if(t.code&&e.has(t.code))return!0;let r=t.message??"";return/already exists/i.test(r)||/duplicate/i.test(r)||/multiple.*?not allowed/i.test(r)}async function xO(t,e,r,s){for(let n of e)try{await t.query(n,[])}catch(i){if(LO(i,r)){s(`Ignoring migration error; migration was likely already applied.  Occurred while executing: ${n}`,i);continue}throw i}}async function qO(t,e,r="dbos",s={}){let{ignoreErrorCodes:n=AO,onWarn:i=p=>console.info(p)}=s,o=await _m(t,r),a=e.length;if(o>a)return{fromVersion:o,toVersion:o,appliedCount:0,skippedCount:e.length,notice:`Database version (${o}) is ahead of this build's max (${a}). A newer software version may be running concurrently.`};let l=0,c=0,u=o,f=!1;for(let p=0;p<e.length;p++){let m=e[p],h=p+1;if(h<=o){c++;continue}f||(i("Running DBOS system database migrations..."),f=!0);let g=m.pg??[];if(g.length===0){i(`Migration "${m.name}" has no Postgres statements; skipping.`),c++;continue}await xO(t,g,n,(y,E)=>i(`${y}${E?`
  \u2192 ${String(E.message??"")}`:""}`)),l++,u=h}return(await t.query(`UPDATE "${r}"."dbos_migrations" SET "version" = $1`,[u])).rowCount===0&&await t.query(`INSERT into "${r}"."dbos_migrations" ("version") values ($1)`,[u]),{fromVersion:o,toVersion:u,appliedCount:l,skippedCount:c,notice:o<a&&l===0&&c>0?"Nothing to apply; DB is already up-to-date relative to known migrations.":void 0}}Ur.runSysMigrationsPg=qO});var Em=w(vi=>{"use strict";Object.defineProperty(vi,"__esModule",{value:!0});vi.allMigrations=void 0;function MO(t="dbos"){return[{name:"20240123182943_schema",pg:[`CREATE SCHEMA IF NOT EXISTS "${t}"`]},{name:"20240123182944_dbos_migrations",pg:[`create table "${t}"."dbos_migrations" ("version" bigint not null, constraint "dbos_migrations_pkey" primary key ("version"))`]},{name:"20240123183021_tables",pg:[`create table "${t}"."operation_outputs" ("workflow_uuid" text not null, "function_id" integer not null, "output" text, "error" text, constraint "operation_outputs_pkey" primary key ("workflow_uuid", "function_id"))`,`create table "${t}"."workflow_inputs" ("workflow_uuid" text not null, "inputs" text not null, constraint "workflow_inputs_pkey" primary key ("workflow_uuid"))`,`create table "${t}"."workflow_status" ("workflow_uuid" text, "status" text, "name" text, "authenticated_user" text, "assumed_role" text, "authenticated_roles" text, "request" text, "output" text, "error" text, "executor_id" text, constraint "workflow_status_pkey" primary key ("workflow_uuid"))`,`create table "${t}"."notifications" ("destination_uuid" text not null, "topic" text, "message" text not null, "created_at_epoch_ms" bigint not null default (EXTRACT(EPOCH FROM now())*1000)::bigint)`,`create table "${t}"."workflow_events" ("workflow_uuid" text not null, "key" text not null, "value" text not null, constraint "workflow_events_pkey" primary key ("workflow_uuid", "key"))`]},{name:"20240123183025_indexes",pg:[`create index "idx_workflow_topic" on "${t}"."notifications" ("destination_uuid", "topic")`]},{name:"20240123183030_triggers",pg:[`
    CREATE OR REPLACE FUNCTION "${t}".notifications_function() RETURNS TRIGGER AS $$
    DECLARE
        payload text := NEW.destination_uuid || '::' || NEW.topic;
    BEGIN
        PERFORM pg_notify('dbos_notifications_channel', payload);
        RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;

    CREATE TRIGGER dbos_notifications_trigger
    AFTER INSERT ON "${t}".notifications
    FOR EACH ROW EXECUTE FUNCTION "${t}".notifications_function();

    CREATE OR REPLACE FUNCTION "${t}".workflow_events_function() RETURNS TRIGGER AS $$
    DECLARE
        payload text := NEW.workflow_uuid || '::' || NEW.key;
    BEGIN
        PERFORM pg_notify('dbos_workflow_events_channel', payload);
        RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;

    CREATE TRIGGER dbos_workflow_events_trigger
    AFTER INSERT ON "${t}".workflow_events
    FOR EACH ROW EXECUTE FUNCTION "${t}".workflow_events_function();
  `]},{name:"20240124015239_status_timestamp",pg:[`alter table "${t}"."workflow_status" add column "created_at" bigint not null default (EXTRACT(EPOCH FROM now())*1000)::bigint, add column "updated_at" bigint not null default (EXTRACT(EPOCH FROM now())*1000)::bigint`]},{name:"20240201213211_replica_identity",pg:['create extension if not exists "uuid-ossp"',`alter table "${t}"."notifications" add column "message_uuid" text default uuid_generate_v4()`,`alter table "${t}"."notifications" add constraint "notifications_pkey" primary key ("message_uuid")`]},{name:"20240205223925_foreign_keys",pg:[`create index "workflow_status_created_at_index" on "${t}"."workflow_status" ("created_at")`,`alter table "${t}"."operation_outputs" add constraint "operation_outputs_workflow_uuid_foreign" foreign key ("workflow_uuid") references "${t}"."workflow_status" ("workflow_uuid") on update CASCADE on delete CASCADE`,`alter table "${t}"."workflow_inputs" add constraint "workflow_inputs_workflow_uuid_foreign" foreign key ("workflow_uuid") references "${t}"."workflow_status" ("workflow_uuid") on update CASCADE on delete CASCADE`,`alter table "${t}"."notifications" add constraint "notifications_destination_uuid_foreign" foreign key ("destination_uuid") references "${t}"."workflow_status" ("workflow_uuid") on update CASCADE on delete CASCADE`,`alter table "${t}"."workflow_events" add constraint "workflow_events_workflow_uuid_foreign" foreign key ("workflow_uuid") references "${t}"."workflow_status" ("workflow_uuid") on update CASCADE on delete CASCADE`]},{name:"20240207192338_executor_id_index",pg:[`create index "workflow_status_executor_id_index" on "${t}"."workflow_status" ("executor_id")`]},{name:"20240430090000_tables",pg:[`create table "${t}"."scheduler_state" ("workflow_fn_name" text not null, "last_run_time" bigint not null, constraint "scheduler_state_pkey" primary key ("workflow_fn_name"))`]},{name:"20240516004341_application_version",pg:[`alter table "${t}"."workflow_status" add column "application_version" text, add column "application_id" text`]},{name:"20240517000000_status_class_config",pg:[`alter table "${t}"."workflow_status" add column "class_name" varchar(255) default null, add column "config_name" varchar(255) default null`]},{name:"20240621000000_workflow_tries",pg:[`alter table "${t}"."workflow_status" add column "recovery_attempts" bigint default '0'`]},{name:"20240924000000_workflowqueue",pg:[`alter table "${t}"."workflow_status" add column "queue_name" text default null`,`create table "${t}"."workflow_queue" ("queue_name" text not null, "workflow_uuid" text not null, "created_at_epoch_ms" bigint not null default (EXTRACT(EPOCH FROM now())*1000)::bigint, "started_at_epoch_ms" bigint, "completed_at_epoch_ms" bigint, constraint "workflow_queue_pkey" primary key ("workflow_uuid"))`,`alter table "${t}"."workflow_queue" add constraint "workflow_queue_workflow_uuid_foreign" foreign key ("workflow_uuid") references "${t}"."workflow_status" ("workflow_uuid") on update CASCADE on delete CASCADE`]},{name:"20241009150000_event_dispatch_kv",pg:[`create table "${t}"."event_dispatch_kv" ("service_name" text not null, "workflow_fn_name" text not null, "key" text not null, "value" text, "update_seq" decimal(38, 0), "update_time" decimal(38, 15), constraint "event_dispatch_kv_pkey" primary key ("service_name", "workflow_fn_name", "key"))`]},{name:"20250312171547_function_name_op_outputs",pg:[`alter table "${t}"."operation_outputs" add column "function_name" text not null default ''`]},{name:"20250319190617_add_childid_opoutputs",pg:[`alter table "${t}"."operation_outputs" add column "child_workflow_id" text`]},{name:"20252101000000_workflow_queues_executor_id",pg:[`alter table "${t}"."workflow_queue" add column "executor_id" text`]},{name:"20252501190959_queue_dedup_id",pg:[`alter table "${t}"."workflow_queue" add column "deduplication_id" text`,`alter table "${t}"."workflow_queue" add constraint "workflow_queue_queue_name_deduplication_id_unique" unique ("queue_name", "deduplication_id")`]},{name:"20252505000000_workflow_timeout",pg:[`alter table "${t}"."workflow_status" add column "workflow_timeout_ms" bigint, add column "workflow_deadline_epoch_ms" bigint`]},{name:"20252512000000_queue_priority",pg:[`alter table "${t}"."workflow_queue" add column "priority" integer not null default '0'`]},{name:"20252523000000_consolidate_inputs",pg:[`alter table "${t}"."workflow_status" add column "inputs" text null`]},{name:"20252528000000_consolidate_queues",pg:[`alter table "${t}"."workflow_status" add column "started_at_epoch_ms" bigint null, add column "deduplication_id" text null, add column "priority" integer not null default '0'`,`alter table "${t}"."workflow_status" add constraint "uq_workflow_status_queue_name_dedup_id" unique ("queue_name", "deduplication_id")`,`create index "workflow_status_status_index" on "${t}"."workflow_status" ("status")`]},{name:"20252806000000_streaming",pg:[`create table "${t}"."streams" ("workflow_uuid" text not null, "key" text not null, "value" text not null, "offset" integer not null, constraint "streams_pkey" primary key ("workflow_uuid", "key", "offset"))`,`alter table "${t}"."streams" add constraint "streams_workflow_uuid_foreign" foreign key ("workflow_uuid") references "${t}"."workflow_status" ("workflow_uuid") on update CASCADE on delete CASCADE`]},{name:"20252810000000_partitioned_queues",pg:[`alter table "${t}"."workflow_status" add column "queue_partition_key" text`]},{name:"20252950000000_workflow_status_queue_status_started_index",pg:[`create index "idx_workflow_status_queue_status_started" on "${t}"."workflow_status" ("queue_name", "status", "started_at_epoch_ms")`]},{pg:[`ALTER TABLE "${t}".workflow_status ADD COLUMN forked_from TEXT;`,`create index "idx_workflow_status_forked_from" on "${t}"."workflow_status" ("forked_from")`]},{pg:[`ALTER TABLE "${t}".operation_outputs ADD COLUMN started_at_epoch_ms BIGINT, ADD COLUMN completed_at_epoch_ms BIGINT;`]},{pg:[`ALTER TABLE "${t}"."workflow_status" ADD COLUMN "owner_xid" VARCHAR(40) DEFAULT NULL`]},{pg:[`
        CREATE TABLE "${t}".workflow_events_history (
            workflow_uuid TEXT NOT NULL,
            function_id INTEGER NOT NULL,
            key TEXT NOT NULL,
            value TEXT NOT NULL,
            PRIMARY KEY (workflow_uuid, function_id, key),
            FOREIGN KEY (workflow_uuid) REFERENCES "${t}".workflow_status(workflow_uuid)
                ON UPDATE CASCADE ON DELETE CASCADE
        );
        `,`ALTER TABLE "${t}".streams ADD COLUMN function_id INTEGER NOT NULL DEFAULT 0;`]},{pg:[`ALTER TABLE "${t}"."workflow_status" ADD COLUMN "parent_workflow_id" TEXT DEFAULT NULL;`,`CREATE INDEX "idx_workflow_status_parent_workflow_id" ON "${t}"."workflow_status" ("parent_workflow_id");`]},{pg:[`ALTER TABLE "${t}"."workflow_status" ADD COLUMN "serialization" TEXT DEFAULT NULL`,`ALTER TABLE "${t}"."notifications" ADD COLUMN "serialization" TEXT DEFAULT NULL`,`ALTER TABLE "${t}"."workflow_events" ADD COLUMN "serialization" TEXT DEFAULT NULL`,`ALTER TABLE "${t}"."workflow_events_history" ADD COLUMN "serialization" TEXT DEFAULT NULL`,`ALTER TABLE "${t}"."operation_outputs" ADD COLUMN "serialization" TEXT DEFAULT NULL`,`ALTER TABLE "${t}"."streams" ADD COLUMN "serialization" TEXT DEFAULT NULL`]}]}vi.allMigrations=MO});var Oi=w(H=>{"use strict";Object.defineProperty(H,"__esModule",{value:!0});H.DEBUG_TRIGGER_INITWF_COMMIT=H.DEBUG_TRIGGER_STEP_COMMIT=H.DEBUG_TRIGGER_WORKFLOW_ENQUEUE=H.DEBUG_TRIGGER_WORKFLOW_QUEUE_START=H.clearDebugTriggers=H.setDebugTrigger=H.debugTriggerPoint=H.pointLocations=H.pointTriggers=H.DebugAction=H.getCallSiteInfo=void 0;var BO=Oe();function bm(){let e=new Error().stack?.split(`
`);if(e&&e.length>2){let r=e[2].match(/at\s+(.*):(\d+):(\d+)/);if(r){let s=r[1],n=parseInt(r[2],10);return{fileName:s,lineNumber:n}}}return{fileName:"unknown",lineNumber:-1}}H.getCallSiteInfo=bm;var ac=class{sleepms;awaitEvent;callback;asyncCallback};H.DebugAction=ac;H.pointTriggers=new Map;H.pointLocations=new Map;async function $O(t){let e=bm();if(H.pointLocations.has(t)||H.pointLocations.set(t,{name:t,...e,hitCount:0}),H.pointTriggers.has(t)){let r=H.pointTriggers.get(t);r.sleepms&&await(0,BO.sleepms)(r.sleepms),r.asyncCallback&&await r.asyncCallback(),r.callback&&r.callback(),r.awaitEvent&&await r.awaitEvent}}H.debugTriggerPoint=$O;function WO(t,e){H.pointTriggers.set(t,e)}H.setDebugTrigger=WO;function UO(){H.pointTriggers.clear()}H.clearDebugTriggers=UO;H.DEBUG_TRIGGER_WORKFLOW_QUEUE_START="DEBUG_TRIGGER_WORKFLOW_QUEUE_START";H.DEBUG_TRIGGER_WORKFLOW_ENQUEUE="DEBUG_TRIGGER_WORKFLOW_ENQUEUE";H.DEBUG_TRIGGER_STEP_COMMIT="DEBUG_TRIGGER_STEP_COMMIT";H.DEBUG_TRIGGER_INITWF_COMMIT="DEBUG_TRIGGER_INITWF_COMMIT"});var Ii=w(A=>{"use strict";var he=A&&A.__decorate||function(t,e,r,s){var n=arguments.length,i=n<3?e:s===null?s=Object.getOwnPropertyDescriptor(e,r):s,o;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")i=Reflect.decorate(t,e,r,s);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(i=(n<3?o(i):n>3?o(e,r,i):o(e,r))||i);return n>3&&i&&Object.defineProperty(e,r,i),i},D=A&&A.__metadata||function(t,e){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(t,e)};Object.defineProperty(A,"__esModule",{value:!0});A.PostgresSystemDatabase=A.ensureSystemDatabase=A.grantDbosSchemaPermissions=A.DBOS_STREAM_CLOSED_SENTINEL=A.DEFAULT_POOL_SIZE=A.DBOS_FUNCNAME_CLOSESTREAM=A.DBOS_FUNCNAME_WRITESTREAM=A.DBOS_FUNCNAME_GETSTATUS=A.DBOS_FUNCNAME_SLEEP=A.DBOS_FUNCNAME_GETEVENT=A.DBOS_FUNCNAME_SETEVENT=A.DBOS_FUNCNAME_RECV=A.DBOS_FUNCNAME_SEND=void 0;var uc=lr(),Om=Ei(),de=He(),z=Ir(),wt=Oe(),FO=require("crypto"),Dm=Oe(),Us=ki(),zO=Sm(),jO=Em(),Di=Oi(),km=Ot();A.DBOS_FUNCNAME_SEND="DBOS.send";A.DBOS_FUNCNAME_RECV="DBOS.recv";A.DBOS_FUNCNAME_SETEVENT="DBOS.setEvent";A.DBOS_FUNCNAME_GETEVENT="DBOS.getEvent";A.DBOS_FUNCNAME_SLEEP="DBOS.sleep";A.DBOS_FUNCNAME_GETSTATUS="getStatus";A.DBOS_FUNCNAME_WRITESTREAM="DBOS.writeStream";A.DBOS_FUNCNAME_CLOSESTREAM="DBOS.closeStream";A.DEFAULT_POOL_SIZE=10;A.DBOS_STREAM_CLOSED_SENTINEL="__DBOS_STREAM_CLOSED__";async function VO(t,e,r,s="dbos"){r.info(`Granting permissions for ${s} schema to ${e}`);let n=new Om.Client((0,Dm.getClientConfig)(t));await n.connect();try{let i=`GRANT USAGE ON SCHEMA "${s}" TO "${e}"`;r.info(i),await n.query(i);let o=`GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA "${s}" TO "${e}"`;r.info(o),await n.query(o);let a=`GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA "${s}" TO "${e}"`;r.info(a),await n.query(a);let l=`GRANT EXECUTE ON ALL FUNCTIONS IN SCHEMA "${s}" TO "${e}"`;r.info(l),await n.query(l);let c=`ALTER DEFAULT PRIVILEGES IN SCHEMA "${s}" GRANT ALL ON TABLES TO "${e}"`;r.info(c),await n.query(c);let u=`ALTER DEFAULT PRIVILEGES IN SCHEMA "${s}" GRANT ALL ON SEQUENCES TO "${e}"`;r.info(u),await n.query(u);let f=`ALTER DEFAULT PRIVILEGES IN SCHEMA "${s}" GRANT EXECUTE ON FUNCTIONS TO "${e}"`;r.info(f),await n.query(f)}catch(i){throw r.error(`Failed to grant permissions to role ${e}: ${i.message}`),i}finally{await n.end()}}A.grantDbosSchemaPermissions=VO;async function Tm(t,e,r,s="dbos"){let n=null;if(r)n=await r.connect();else{let i=await(0,Us.ensurePGDatabase)({urlToEnsure:t,logger:a=>e.debug(a)});i.status==="failed"&&e.warn(`Database could not be verified / created: ${(0,Us.maskDatabaseUrl)(t)}: ${i.message} ${i.hint??""}
  ${i.notes.join(`
`)}`);let o=await(0,Us.connectToPGAndReportOutcome)(t,()=>{},"System Database");if(o.result!=="ok")throw e.warn(`Unable to connect to system database at ${(0,Us.maskDatabaseUrl)(t)}
        ${o.message}: (${o.code?o.code:"connectivity problem"})`),new de.DBOSInitializationError(`Unable to connect to system database at ${(0,Us.maskDatabaseUrl)(t)}`);n=o.client}try{await(0,zO.runSysMigrationsPg)(n,(0,jO.allMigrations)(s),s,{onWarn:i=>e.info(i)})}finally{try{r?n.release():await n.end()}catch{}}}A.ensureSystemDatabase=Tm;var Fs=class{map=new Map;curCK=0;registerCallback(e,r){this.map.has(e)||this.map.set(e,new Map);let s=this.curCK++;return this.map.get(e).set(s,r),{key:e,ck:s}}deregisterCallback(e){if(!this.map.has(e.key))return;let r=this.map.get(e.key);r.has(e.ck)&&(r.delete(e.ck),r.size===0&&this.map.delete(e.key))}callCallbacks(e,r){if(!this.map.has(e))return;let s=this.map.get(e);for(let n of s.values())n(r)}};async function vm(t,e,r,s,n=!1){try{let{rows:i}=await t.query(`INSERT INTO "${r}".workflow_status (
        workflow_uuid,
        status,
        name,
        class_name,
        config_name,
        queue_name,
        authenticated_user,
        assumed_role,
        authenticated_roles,
        request,
        executor_id,
        application_version,
        application_id,
        created_at,
        recovery_attempts,
        updated_at,
        workflow_timeout_ms,
        workflow_deadline_epoch_ms,
        inputs,
        deduplication_id,
        priority,
        queue_partition_key,
        forked_from,
        parent_workflow_id,
        serialization,
        owner_xid
      ) VALUES($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $26, $27)
      ON CONFLICT (workflow_uuid)
        DO UPDATE SET
          recovery_attempts = CASE
            WHEN workflow_status.status != '${z.StatusString.ENQUEUED}'
            THEN workflow_status.recovery_attempts + $25
            ELSE workflow_status.recovery_attempts
          END,
          updated_at = EXCLUDED.updated_at,
          executor_id = CASE
            WHEN EXCLUDED.status != '${z.StatusString.ENQUEUED}'
            THEN EXCLUDED.executor_id
            ELSE workflow_status.executor_id
          END
        RETURNING recovery_attempts, status, name, class_name, config_name, queue_name, workflow_deadline_epoch_ms, executor_id, owner_xid, serialization`,[e.workflowUUID,e.status,e.workflowName,e.workflowClassName===""?null:e.workflowClassName,e.workflowConfigName===""?null:e.workflowConfigName,e.queueName??null,e.authenticatedUser,e.assumedRole,JSON.stringify(e.authenticatedRoles),JSON.stringify(e.request),e.executorId,e.applicationVersion??null,e.applicationID,e.createdAt,e.status===z.StatusString.ENQUEUED?0:1,e.updatedAt??Date.now(),e.timeoutMS??null,e.deadlineEpochMS??null,e.input??null,e.deduplicationID??null,e.priority,e.queuePartitionKey??null,e.forkedFrom??null,e.parentWorkflowID??null,n??!1?1:0,e.serialization,s]);if(i.length===0)throw new Error(`Attempt to insert workflow ${e.workflowUUID} failed`);let o=i[0];return o.class_name=o.class_name??"",o.config_name=o.config_name??"",e.serialization=o.serialization,o}catch(i){throw i.code==="23505"?new de.DBOSQueueDuplicatedError(e.workflowUUID,e.queueName??"",e.deduplicationID??""):i}}async function lc(t,e,r){let{rows:s}=await t.query(`SELECT status FROM "${r}".workflow_status WHERE workflow_uuid=$1`,[e]);return s.length===0?void 0:s[0].status}async function Fr(t,e,r,s,n={}){let i="SET status=$2, updated_at=$3",o="WHERE workflow_uuid=$1",a=[e,r,Date.now()],l=n.update??{};if(l.output){let d=a.push(l.output);i+=`, output=$${d}`}if(l.error){let d=a.push(l.error);i+=`, error=$${d}`}if(l.resetRecoveryAttempts&&(i+=", recovery_attempts = 0"),l.resetDeadline&&(i+=", workflow_deadline_epoch_ms = NULL"),l.queueName!==void 0){let d=a.push(l.queueName??void 0);i+=`, queue_name=$${d}`}if(l.resetDeduplicationID&&(i+=", deduplication_id = NULL"),l.resetStartedAtEpochMs&&(i+=", started_at_epoch_ms = NULL"),l.executorId!==void 0){let d=a.push(l.executorId??void 0);i+=`, executor_id=$${d}`}if(l.resetNameTo!==void 0){let d=a.push(l.resetNameTo??void 0);i+=`, name=$${d}`}let c=n.where??{};if(c.status){let d=a.push(c.status);o+=` AND status=$${d}`}let u=await t.query(`UPDATE "${s}".workflow_status ${i} ${o}`,a);if((n.throwOnFailure??!0)&&u.rowCount!==1)throw new de.DBOSWorkflowConflictError(`Attempt to record transition of nonexistent workflow ${e}`)}async function Ti(t,e,r,s,n,i,o,a,l={}){try{let c=await t.query(`INSERT INTO ${i}.operation_outputs
       (workflow_uuid, function_id, output, error, function_name, child_workflow_id, started_at_epoch_ms, completed_at_epoch_ms, serialization)
       VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
       ON CONFLICT DO NOTHING RETURNING completed_at_epoch_ms;`,[e,r,l.output??null,l.error??null,s,l.childWorkflowID??null,o,a,l.serialization??null]);if(n&&(c?.rowCount??0)>0&&Number(c?.rows?.[0]?.completed_at_epoch_ms)!==a)throw uc.DBOSExecutor.globalInstance?.logger.warn(`Step output for ${e}(${r}):${s} already recorded`),new de.DBOSWorkflowConflictError(e)}catch(c){let u=c;throw u.code==="40001"||u.code==="23505"?new de.DBOSWorkflowConflictError(e):u}}function GO(t){return{workflowUUID:t.workflow_uuid,status:t.status,workflowName:t.name,output:t.output?t.output:null,error:t.error?t.error:null,workflowClassName:t.class_name??"",workflowConfigName:t.config_name??"",queueName:t.queue_name??void 0,authenticatedUser:t.authenticated_user,assumedRole:t.assumed_role,authenticatedRoles:JSON.parse(t.authenticated_roles),request:t.request?JSON.parse(t.request):{},executorId:t.executor_id,createdAt:Number(t.created_at),updatedAt:Number(t.updated_at),applicationVersion:t.application_version,applicationID:t.application_id,recoveryAttempts:Number(t.recovery_attempts),input:t.inputs?t.inputs:null,timeoutMS:t.workflow_timeout_ms?Number(t.workflow_timeout_ms):void 0,deadlineEpochMS:t.workflow_deadline_epoch_ms?Number(t.workflow_deadline_epoch_ms):void 0,deduplicationID:t.deduplication_id??void 0,priority:t.priority??0,queuePartitionKey:t.queue_partition_key??void 0,startedAtEpochMs:t.started_at_epoch_ms?Number(t.started_at_epoch_ms):void 0,forkedFrom:t.forked_from??void 0,parentWorkflowID:t.parent_workflow_id??void 0,serialization:t.serialization}}var QO=new Set(["08","53","57"]),KO=new Set(["40003"]),HO=new Set(["ECONNRESET","ECONNREFUSED","EHOSTUNREACH","ENETUNREACH","ETIMEDOUT","ECONNABORTED"]);function JO(t){return!!t&&typeof t=="object"&&typeof t.code=="string"&&t.code.length===5}function YO(t){if(!t)return!1;if(KO.has(t))return!0;let e=t.toString().slice(0,2);return QO.has(e)}function XO(t){let e=t.code;return!!e&&HO.has(e)}function cc(t){let e=t.toLowerCase();return t.includes("ECONNREFUSED")||t.includes("ECONNRESET")||e.includes("connection timeout")||e.includes("server closed the connection")||e.includes("connection terminated unexpectedly")||e.includes("client has encountered a connection error")||e.includes("timeout exceeded when trying to connect")||e.includes("could not connect to server")}function*ZO(t){let e=[t],r=new Set;for(;e.length;){let s=e.shift();if(s&&typeof s=="object"){if(r.has(s))continue;r.add(s);let n=s;Array.isArray(n.errors)&&e.push(...n.errors);let i=s;i.cause&&e.push(i.cause);let o=s;o.error&&e.push(o.error)}yield s}}function eD(t){for(let e of ZO(t)){let r=e;if(JO(r)&&YO(r.code)||XO(r))return!0;if(e instanceof Error){if(e.stack&&cc(e.stack)||e.message&&cc(e.message))return!0}else if(cc(String(e)))return!0}return!1}function pe(t={}){let{initialBackoff:e=1,maxBackoff:r=60}=t;return function(s,n,i){let o=i.value;return i.value=async function(...a){let l=0,c=e;for(;;)try{return await o.apply(this,a)}catch(u){if(eD(u)){l++;let f=c*(.5+Math.random());uc.DBOSExecutor.globalInstance?.logger.warn(`Database connection failed: ${u instanceof Error?u.message:String(u)}. Retrying in ${f.toFixed(2)}s (attempt ${l})`),await(0,wt.sleepms)(f*1e3),c=Math.min(c*2,r)}else throw u}},i}}var te=class{systemDatabaseUrl;logger;serializer;pool;schemaName;notificationsClient=null;dbPollingIntervalResultMs=1e3;dbPollingIntervalEventMs=1e4;shouldUseDBNotifications=!0;notificationsMap=new Fs;workflowEventsMap=new Fs;cancelWakeupMap=new Fs;customPool=!1;runningWorkflowMap=new Map;workflowCancellationMap=new Map;constructor(e,r,s,n=A.DEFAULT_POOL_SIZE,i,o="dbos"){if(this.systemDatabaseUrl=e,this.logger=r,this.serializer=s,this.schemaName=o,i)this.pool=i,this.customPool=!0;else{let a={...(0,Dm.getClientConfig)(e),application_name:`dbos_transact_${wt.globalParams.executorID}_${wt.globalParams.appVersion}`,max:n};this.pool=new Om.Pool(a)}this.pool.on("error",a=>{this.logger.warn(`Unexpected error in pool: ${a}`)}),this.pool.on("connect",a=>{a.on("error",l=>{this.logger.warn(`Unexpected error in idle client: ${l}`)})})}getSerializer(){return this.serializer}async init(){await Tm(this.systemDatabaseUrl,this.logger,this.customPool?this.pool:void 0,this.schemaName),this.shouldUseDBNotifications&&await this.#o()}async destroy(){if(this.reconnectTimeout&&clearTimeout(this.reconnectTimeout),this.notificationsClient)try{this.notificationsClient.release(!0)}catch(e){this.logger.warn(`Error ending notifications client: ${String(e)}`)}await this.pool.end()}async initWorkflowStatus(e,r,s){let n=await this.pool.connect(),i=!1;try{await n.query("BEGIN ISOLATION LEVEL READ COMMITTED");let o=await vm(n,e,this.schemaName,r,!!s?.isRecoveryRequest||!!s?.isDequeuedRequest);if(o.name!==e.workflowName){let u=`Workflow already exists with a different function name: ${o.name}, but the provided function name is: ${e.workflowName}`;throw new de.DBOSConflictingWorkflowError(e.workflowUUID,u)}else if(o.class_name!==e.workflowClassName){let u=`Workflow already exists with a different class name: ${o.class_name}, but the provided class name is: ${e.workflowClassName}`;throw new de.DBOSConflictingWorkflowError(e.workflowUUID,u)}else if((o.config_name||"")!==(e.workflowConfigName||"")){let u=`Workflow already exists with a different class configuration: ${o.config_name}, but the provided class configuration is: ${e.workflowConfigName}`;throw new de.DBOSConflictingWorkflowError(e.workflowUUID,u)}else(o.queue_name??void 0)!==(e.queueName??void 0)&&this.logger.warn(`Workflow (${e.workflowUUID}) already exists in queue: ${o.queue_name}, but the provided queue name is: ${e.queueName}. The queue is not updated. ${new Error().stack}`);let a=o.status,l=o.workflow_deadline_epoch_ms??void 0;if(r!==o.owner_xid&&!s?.isRecoveryRequest&&!s?.isDequeuedRequest){if(a===z.StatusString.MAX_RECOVERY_ATTEMPTS_EXCEEDED)throw new de.DBOSMaxRecoveryAttemptsExceededError(e.workflowUUID,s?.maxRetries??-1);return{status:a,deadlineEpochMS:l,shouldExecuteOnThisExecutor:!1,serialization:o.serialization}}i=!0;let c=o.recovery_attempts;if(s?.maxRetries&&c>s?.maxRetries+1)throw await Fr(n,e.workflowUUID,z.StatusString.MAX_RECOVERY_ATTEMPTS_EXCEEDED,this.schemaName,{where:{status:z.StatusString.PENDING},throwOnFailure:!1}),new de.DBOSMaxRecoveryAttemptsExceededError(e.workflowUUID,s.maxRetries);return this.logger.debug(`Workflow ${e.workflowUUID} attempt number: ${c}.`),{status:a,deadlineEpochMS:l,shouldExecuteOnThisExecutor:!0,serialization:o.serialization}}finally{try{i?(await n.query("COMMIT"),await(0,Di.debugTriggerPoint)(Di.DEBUG_TRIGGER_INITWF_COMMIT)):await n.query("ROLLBACK")}finally{n.release()}}}async recordWorkflowOutput(e,r){let s=await this.pool.connect();try{await Fr(s,e,z.StatusString.SUCCESS,this.schemaName,{update:{output:r.output,resetDeduplicationID:!0}})}finally{s.release()}}async recordWorkflowError(e,r){let s=await this.pool.connect();try{await Fr(s,e,z.StatusString.ERROR,this.schemaName,{update:{error:r.error,resetDeduplicationID:!0}})}finally{s.release()}}async getPendingWorkflows(e,r){return(await this.pool.query(`SELECT workflow_uuid, queue_name 
       FROM "${this.schemaName}".workflow_status 
       WHERE status=$1 AND executor_id=$2 AND application_version=$3`,[z.StatusString.PENDING,e,r])).rows.map(n=>({workflowUUID:n.workflow_uuid,queueName:n.queue_name}))}async#e(e,r,s){await this.#i(e,r);let{rows:n}=await e.query(`SELECT output, error, child_workflow_id, function_name
       FROM "${this.schemaName}".operation_outputs
      WHERE workflow_uuid=$1 AND function_id=$2`,[r,s]);if(n.length!==0)return{output:n[0].output,error:n[0].error,childWorkflowID:n[0].child_workflow_id,functionName:n[0].function_name}}async getOperationResultAndThrowIfCancelled(e,r){let s=await this.pool.connect();try{return await this.#e(s,e,r)}finally{s.release()}}async getAllOperationResults(e){let{rows:r}=await this.pool.query(`SELECT * FROM "${this.schemaName}".operation_outputs WHERE workflow_uuid=$1`,[e]);return r}async recordOperationResult(e,r,s,n,i,o={}){let a=await this.pool.connect(),l=Date.now();try{await Ti(a,e,r,s,n,this.schemaName,i,l,o)}finally{a.release(),await(0,Di.debugTriggerPoint)(Di.DEBUG_TRIGGER_STEP_COMMIT)}}async forkWorkflow(e,r,s={}){let n=s.newWorkflowID??(0,FO.randomUUID)(),i=await this.getWorkflowStatus(e);if(i===null)throw new de.DBOSNonExistentWorkflowError(`Workflow ${e} does not exist`);if(!i.input)throw new de.DBOSNonExistentWorkflowError(`Workflow ${e} has no input`);let o=await this.pool.connect();try{await o.query("BEGIN ISOLATION LEVEL READ COMMITTED");let a=Date.now();if(await vm(o,{workflowUUID:n,status:z.StatusString.ENQUEUED,workflowName:i.workflowName,workflowClassName:i.workflowClassName,workflowConfigName:i.workflowConfigName,queueName:wt.INTERNAL_QUEUE_NAME,authenticatedUser:i.authenticatedUser,assumedRole:i.assumedRole,authenticatedRoles:i.authenticatedRoles,output:null,error:null,request:i.request,executorId:wt.globalParams.executorID,applicationVersion:s.applicationVersion??i.applicationVersion,applicationID:i.applicationID,createdAt:a,recoveryAttempts:0,updatedAt:a,timeoutMS:s.timeoutMS??i.timeoutMS,input:i.input,deduplicationID:void 0,priority:0,queuePartitionKey:void 0,forkedFrom:e,serialization:i.serialization},this.schemaName,null),r>0){let l=`INSERT INTO "${this.schemaName}".operation_outputs
          (workflow_uuid, function_id, output, error, serialization, function_name, child_workflow_id)
          SELECT $1 AS workflow_uuid, function_id, output, error, serialization, function_name, child_workflow_id
          FROM "${this.schemaName}".operation_outputs
          WHERE workflow_uuid = $2 AND function_id < $3`;await o.query(l,[n,e,r]);let c=`INSERT INTO "${this.schemaName}".streams
          (workflow_uuid, key, value, serialization, "offset", function_id)
          SELECT $1 AS workflow_uuid, key, value, serialization, "offset", function_id
          FROM "${this.schemaName}".streams
          WHERE workflow_uuid = $2 AND function_id < $3`;await o.query(c,[n,e,r]);let u=`INSERT INTO "${this.schemaName}".workflow_events_history
          (workflow_uuid, function_id, key, value, serialization)
          SELECT $1 AS workflow_uuid, function_id, key, value, serialization
          FROM "${this.schemaName}".workflow_events_history
          WHERE workflow_uuid = $2 AND function_id < $3`;await o.query(u,[n,e,r]);let f=`INSERT INTO "${this.schemaName}".workflow_events
          (workflow_uuid, key, value, serialization)
          SELECT $1 AS workflow_uuid, weh1.key, weh1.value, serialization
          FROM "${this.schemaName}".workflow_events_history weh1
          WHERE weh1.workflow_uuid = $2
            AND weh1.function_id = (
              SELECT MAX(weh2.function_id)
              FROM "${this.schemaName}".workflow_events_history weh2
              WHERE weh2.workflow_uuid = $2
                AND weh2.key = weh1.key
                AND weh2.function_id < $3
            )`;await o.query(f,[n,e,r])}return await o.query("COMMIT"),n}catch(a){throw await o.query("ROLLBACK"),a}finally{o.release()}}async#t(e,r,s,n,i){let o=Date.now(),a=await this.#e(e,s,n);if(a!==void 0){if(a.functionName!==r)throw new de.DBOSUnexpectedStepError(s,n,r,a.functionName);return a.output}let l=await i();return await Ti(e,s,n,r,!0,this.schemaName,o,Date.now(),{output:l}),l}async durableSleepms(e,r,s){let n,i=new Promise(a=>{n=a}),o=this.cancelWakeupMap.registerCallback(e,n);try{let a=Promise.resolve(),{promise:l,cancel:c}=await this.#r(e,r,s);a=l;try{await Promise.race([i,a])}finally{c()}}finally{this.cancelWakeupMap.deregisterCallback(o)}await this.checkIfCanceled(e)}async#r(e,r,s,n){n===void 0&&(n=s);let i=Date.now(),o=i+s,a=await this.pool.connect();try{let l=await this.#e(a,e,r);if(l){if(l.functionName!==A.DBOS_FUNCNAME_SLEEP)throw new de.DBOSUnexpectedStepError(e,r,A.DBOS_FUNCNAME_SLEEP,l.functionName);o=JSON.parse(l.output)}else await Ti(a,e,r,A.DBOS_FUNCNAME_SLEEP,!1,this.schemaName,Date.now(),Date.now(),{output:km.DBOSPortableJSON.stringify(o),serialization:km.DBOSPortableJSON.name()});return{...(0,wt.cancellableSleep)(Math.max(Math.min(n,o-i),0)),endTime:o}}finally{a.release()}}nullTopic="__null__topic__";async send(e,r,s,n,i,o){i=i??this.nullTopic;let a=await this.pool.connect();try{await a.query("BEGIN ISOLATION LEVEL READ COMMITTED"),await this.#t(a,A.DBOS_FUNCNAME_SEND,e,r,async()=>{await a.query(`INSERT INTO "${this.schemaName}".notifications (destination_uuid, topic, message, serialization) VALUES ($1, $2, $3, $4);`,[s,i,n,o])}),await a.query("COMMIT")}catch(l){await a.query("ROLLBACK");let c=l;throw c.code==="23503"?new de.DBOSNonExistentWorkflowError(`Sent to non-existent destination workflow UUID: ${s}`):c}finally{a.release()}}async recv(e,r,s,n,i=uc.DBOSExecutor.defaultNotificationTimeoutSec){n=n??this.nullTopic;let o=Date.now(),a=await this.getOperationResultAndThrowIfCancelled(e,r);if(a){if(a.functionName!==A.DBOS_FUNCNAME_RECV)throw new de.DBOSUnexpectedStepError(e,r,A.DBOS_FUNCNAME_RECV,a.functionName);return{serializedValue:a.output,serialization:a.serialization??null}}let l=i!==void 0?i*1e3:void 0,c=l!==void 0?Date.now()+l:void 0;for(;;){let p,m=new Promise(E=>{p=E}),h=`${e}::${n}`,g=this.notificationsMap.registerCallback(h,p),y=this.cancelWakeupMap.registerCallback(e,E=>{p()});try{if(await this.checkIfCanceled(e),(await this.pool.query(`SELECT topic FROM "${this.schemaName}".notifications WHERE destination_uuid=$1 AND topic=$2;`,[e,n])).rows.length!==0)break;let b=Date.now();if(c&&b>c)break;let v=Promise.resolve(),I=()=>{};if(l){let{promise:S,cancel:L,endTime:x}=await this.#r(e,s,l,this.dbPollingIntervalEventMs);v=S,I=L,c=x}else{let S=c?c-b:this.dbPollingIntervalEventMs;S=Math.min(this.dbPollingIntervalEventMs,S);let{promise:L,cancel:x}=(0,wt.cancellableSleep)(S);v=L,I=x}try{await Promise.race([m,v])}finally{I()}}finally{this.notificationsMap.deregisterCallback(g),this.cancelWakeupMap.deregisterCallback(y)}}await this.checkIfCanceled(e);let u=null,f=null,d=await this.pool.connect();try{await d.query("BEGIN ISOLATION LEVEL READ COMMITTED");let p=(await d.query(`DELETE FROM "${this.schemaName}".notifications
        WHERE destination_uuid = $1
          AND topic = $2
          AND message_uuid = (
            SELECT message_uuid
            FROM "${this.schemaName}".notifications
            WHERE destination_uuid = $1
              AND topic = $2
            ORDER BY created_at_epoch_ms ASC
            LIMIT 1
          )
        RETURNING notifications.message, notifications.serialization;`,[e,n])).rows;p.length>0&&(u=p[0].message,f=p[0].serialization),await Ti(d,e,r,A.DBOS_FUNCNAME_RECV,!0,this.schemaName,o,Date.now(),{output:u,serialization:f}),await d.query("COMMIT")}catch(p){throw this.logger.error(p),await d.query("ROLLBACK"),p}finally{d.release()}return{serializedValue:u,serialization:f}}async setWorkflowStatus(e,r,s,n){let i=await this.pool.connect();try{await Fr(i,e,r,this.schemaName,{update:{resetRecoveryAttempts:s,resetNameTo:n?.updateName}})}finally{i.release()}}async setEvent(e,r,s,n,i){let o=await this.pool.connect();try{await o.query("BEGIN ISOLATION LEVEL READ COMMITTED"),await this.#t(o,A.DBOS_FUNCNAME_SETEVENT,e,r,async()=>{await o.query(`INSERT INTO "${this.schemaName}".workflow_events (workflow_uuid, key, value, serialization)
             VALUES ($1, $2, $3, $4)
             ON CONFLICT (workflow_uuid, key)
             DO UPDATE SET value = $3
             RETURNING workflow_uuid;`,[e,s,n,i]),await o.query(`INSERT INTO "${this.schemaName}".workflow_events_history (workflow_uuid, function_id, key, value, serialization)
             VALUES ($1, $2, $3, $4, $5)
             ON CONFLICT (workflow_uuid, function_id, key)
             DO UPDATE SET value = $4;`,[e,r,s,n,i])}),await o.query("COMMIT")}catch(a){throw this.logger.error(a),await o.query("ROLLBACK"),a}finally{o.release()}}async getEvent(e,r,s,n){let i=Date.now();if(n){let f=await this.getOperationResultAndThrowIfCancelled(n.workflowID,n.functionID);if(f){if(f.functionName!==A.DBOS_FUNCNAME_GETEVENT)throw new de.DBOSUnexpectedStepError(n.workflowID,n.functionID,A.DBOS_FUNCNAME_GETEVENT,f.functionName);return{serializedValue:f.output,serialization:null}}}let o=null,a=null,l=`${e}::${r}`,c=s!==void 0?s*1e3:void 0,u=c!==void 0?Date.now()+c:void 0;for(;;){let f,d=new Promise(h=>{f=h}),p=this.workflowEventsMap.registerCallback(l,f),m=n?.workflowID?this.cancelWakeupMap.registerCallback(n.workflowID,h=>{f()}):void 0;try{n?.workflowID&&await this.checkIfCanceled(n?.workflowID);let h=(await this.pool.query(`SELECT key, value, serialization
             FROM "${this.schemaName}".workflow_events
             WHERE workflow_uuid=$1 AND key=$2;`,[e,r])).rows;if(h.length>0){o=h[0].value,a=h[0].serialization;break}let g=Date.now();if(u&&g>u)break;let y=Promise.resolve(),E=()=>{};if(n&&c){let{promise:b,cancel:v,endTime:I}=await this.#r(n.workflowID,n.timeoutFunctionID??-1,c,this.dbPollingIntervalEventMs);y=b,E=v,u=I}else{let b=u?u-g:this.dbPollingIntervalEventMs;b=Math.min(this.dbPollingIntervalEventMs,b);let{promise:v,cancel:I}=(0,wt.cancellableSleep)(b);y=v,E=I}try{await Promise.race([d,y])}finally{E()}}finally{this.workflowEventsMap.deregisterCallback(p),m&&this.cancelWakeupMap.deregisterCallback(m)}}return n&&await this.recordOperationResult(n.workflowID,n.functionID,A.DBOS_FUNCNAME_GETEVENT,!0,i,{output:o,serialization:a}),{serializedValue:o,serialization:a}}#s(e){this.runningWorkflowMap.has(e)&&this.workflowCancellationMap.set(e,!0),this.cancelWakeupMap.callCallbacks(e)}#n(e){this.workflowCancellationMap.has(e)&&this.workflowCancellationMap.delete(e)}async cancelWorkflow(e){let r=await this.pool.connect();try{await r.query("BEGIN ISOLATION LEVEL READ COMMITTED");let s=await lc(r,e,this.schemaName);if(!s)throw new de.DBOSNonExistentWorkflowError(`Workflow ${e} does not exist`);if(s===z.StatusString.SUCCESS||s===z.StatusString.ERROR||s===z.StatusString.CANCELLED){await r.query("ROLLBACK");return}await Fr(r,e,z.StatusString.CANCELLED,this.schemaName,{update:{queueName:null,resetDeduplicationID:!0,resetStartedAtEpochMs:!0}}),await r.query("COMMIT")}catch(s){throw this.logger.error(s),await r.query("ROLLBACK"),s}finally{r.release()}this.#s(e)}async#i(e,r){if(this.workflowCancellationMap.get(r)===!0)throw new de.DBOSWorkflowCancelledError(r);if(await lc(e,r,this.schemaName)===z.StatusString.CANCELLED)throw new de.DBOSWorkflowCancelledError(r)}async checkIfCanceled(e){let r=await this.pool.connect();try{await this.#i(r,e)}finally{r.release()}}async resumeWorkflow(e){this.#n(e);let r=await this.pool.connect();try{await r.query("BEGIN ISOLATION LEVEL REPEATABLE READ");let s=await lc(r,e,this.schemaName);if(!s||s===z.StatusString.SUCCESS||s===z.StatusString.ERROR){if(await r.query("ROLLBACK"),!s&&s===void 0)throw new de.DBOSNonExistentWorkflowError(`Workflow ${e} does not exist`);return}await Fr(r,e,z.StatusString.ENQUEUED,this.schemaName,{update:{queueName:wt.INTERNAL_QUEUE_NAME,resetRecoveryAttempts:!0,resetDeadline:!0,resetDeduplicationID:!0,resetStartedAtEpochMs:!0},throwOnFailure:!1}),await r.query("COMMIT")}catch(s){throw this.logger.error(s),await r.query("ROLLBACK"),s}finally{r.release()}}async getWorkflowChildren(e){let r=new Set([e]),s=[e],n=[],i=await this.pool.connect();try{for(;s.length>0;){let o=s.splice(0,s.length),a=await i.query(`SELECT DISTINCT child_workflow_id
           FROM "${this.schemaName}".operation_outputs
           WHERE workflow_uuid = ANY($1)
             AND child_workflow_id IS NOT NULL`,[o]);for(let l of a.rows)r.has(l.child_workflow_id)||(r.add(l.child_workflow_id),s.push(l.child_workflow_id),n.push(l.child_workflow_id))}}finally{i.release()}return n}async deleteWorkflow(e,r=!1){let s=[e];if(r){let i=await this.getWorkflowChildren(e);s=[...s,...i]}let n=await this.pool.connect();try{await n.query(`DELETE FROM "${this.schemaName}".workflow_status
         WHERE workflow_uuid = ANY($1)`,[s])}finally{n.release()}for(let i of s)this.runningWorkflowMap.delete(i),this.workflowCancellationMap.delete(i)}async exportWorkflow(e,r=!1){let s=[e];r&&s.push(...await this.getWorkflowChildren(e));let n=[],i=await this.pool.connect();try{for(let o of s){let a=await i.query(`SELECT
            workflow_uuid, status, name, authenticated_user, assumed_role,
            authenticated_roles, request, output, error, executor_id,
            created_at, updated_at, application_version, application_id,
            class_name, config_name, recovery_attempts, queue_name,
            workflow_timeout_ms, workflow_deadline_epoch_ms, started_at_epoch_ms,
            deduplication_id, inputs, priority, queue_partition_key, forked_from,
            parent_workflow_id, serialization
          FROM "${this.schemaName}".workflow_status
          WHERE workflow_uuid = $1`,[o]);if(a.rows.length===0)throw new de.DBOSNonExistentWorkflowError(`Workflow ${o} does not exist`);let l=a.rows[0],c=await i.query(`SELECT
            workflow_uuid, function_id, function_name, output, error,
            child_workflow_id, started_at_epoch_ms, completed_at_epoch_ms,
            serialization
          FROM "${this.schemaName}".operation_outputs
          WHERE workflow_uuid = $1`,[o]),u=await i.query(`SELECT workflow_uuid, key, value, serialization
          FROM "${this.schemaName}".workflow_events
          WHERE workflow_uuid = $1`,[o]),f=await i.query(`SELECT workflow_uuid, function_id, key, value, serialization
          FROM "${this.schemaName}".workflow_events_history
          WHERE workflow_uuid = $1`,[o]),d=await i.query(`SELECT workflow_uuid, key, value, "offset", function_id, serialization
          FROM "${this.schemaName}".streams
          WHERE workflow_uuid = $1`,[o]);n.push({workflow_status:l,operation_outputs:c.rows,workflow_events:u.rows,workflow_events_history:f.rows,streams:d.rows})}}finally{i.release()}return n}async importWorkflow(e){let r=await this.pool.connect();try{await r.query("BEGIN");for(let s of e){let n=s.workflow_status;await r.query(`INSERT INTO "${this.schemaName}".workflow_status (
            workflow_uuid, status, name, authenticated_user, assumed_role,
            authenticated_roles, request, output, error, executor_id,
            created_at, updated_at, application_version, application_id,
            class_name, config_name, recovery_attempts, queue_name,
            workflow_timeout_ms, workflow_deadline_epoch_ms, started_at_epoch_ms,
            deduplication_id, inputs, priority, queue_partition_key, forked_from,
            parent_workflow_id, serialization
          ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28)`,[n.workflow_uuid,n.status,n.name,n.authenticated_user,n.assumed_role,n.authenticated_roles,n.request,n.output,n.error,n.executor_id,n.created_at,n.updated_at,n.application_version,n.application_id,n.class_name,n.config_name,n.recovery_attempts,n.queue_name,n.workflow_timeout_ms,n.workflow_deadline_epoch_ms,n.started_at_epoch_ms,n.deduplication_id,n.inputs,n.priority,n.queue_partition_key,n.forked_from,n.parent_workflow_id,n.serialization]);for(let i of s.operation_outputs)await r.query(`INSERT INTO "${this.schemaName}".operation_outputs (
              workflow_uuid, function_id, function_name, output, error,
              child_workflow_id, started_at_epoch_ms, completed_at_epoch_ms,
              serialization
            ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)`,[i.workflow_uuid,i.function_id,i.function_name,i.output,i.error,i.child_workflow_id,i.started_at_epoch_ms,i.completed_at_epoch_ms,i.serialization]);for(let i of s.workflow_events)await r.query(`INSERT INTO "${this.schemaName}".workflow_events (
              workflow_uuid, key, value, serialization
            ) VALUES ($1, $2, $3, $4)`,[i.workflow_uuid,i.key,i.value,i.serialization]);for(let i of s.workflow_events_history)await r.query(`INSERT INTO "${this.schemaName}".workflow_events_history (
              workflow_uuid, function_id, key, value, serialization
            ) VALUES ($1, $2, $3, $4, $5)`,[i.workflow_uuid,i.function_id,i.key,i.value,i.serialization]);for(let i of s.streams)await r.query(`INSERT INTO "${this.schemaName}".streams (
              workflow_uuid, key, value, "offset", function_id, serialization
            ) VALUES ($1, $2, $3, $4, $5, $6)`,[i.workflow_uuid,i.key,i.value,i.offset,i.function_id,i.serialization])}await r.query("COMMIT")}catch(s){throw await r.query("ROLLBACK"),s}finally{r.release()}}registerRunningWorkflow(e,r){let s=r.catch(n=>{this.logger.debug("Captured error in awaitWorkflowPromise: "+n)}).finally(()=>{this.runningWorkflowMap.delete(e),this.workflowCancellationMap.delete(e)});this.runningWorkflowMap.set(e,s)}checkForRunningWorkflow(e){return this.runningWorkflowMap.has(e)}async awaitRunningWorkflows(){this.runningWorkflowMap.size>0&&(this.logger.info("Waiting for pending workflows to finish."),await Promise.allSettled(this.runningWorkflowMap.values())),this.workflowEventsMap.map.size>0&&this.logger.warn("Workflow events map is not empty - shutdown is not clean."),this.notificationsMap.map.size>0&&this.logger.warn("Message notification map is not empty - shutdown is not clean.")}async getWorkflowStatus(e,r,s){let n=async()=>{let a=(await this.listWorkflows({workflowIDs:[e]})).find(l=>l.workflowUUID===e);return a?JSON.stringify(a):null};if(r&&s){let o=await this.pool.connect();try{let a=await this.#t(o,A.DBOS_FUNCNAME_GETSTATUS,r,s,n);return i(a)}finally{o.release()}}else{let o=await n();return i(o)}function i(o){return o?JSON.parse(o):null}}async awaitWorkflowResult(e,r,s,n){let i=r!==void 0?r*1e3:void 0,o=i!==void 0?Date.now()+i:void 0;for(;;){let a,l=new Promise(f=>{a=f}),c=this.cancelWakeupMap.registerCallback(e,f=>{a()}),u=s?this.cancelWakeupMap.registerCallback(s,f=>{a()}):void 0;try{s&&await this.checkIfCanceled(s);try{let{rows:m}=await this.pool.query(`SELECT status, output, error, serialization FROM "${this.schemaName}".workflow_status 
             WHERE workflow_uuid=$1`,[e]);if(m.length>0){let h=m[0].status;if(h===z.StatusString.SUCCESS)return{output:m[0].output,serialization:m[0].serialization};if(h===z.StatusString.ERROR)return{error:m[0].error,serialization:m[0].serialization};if(h===z.StatusString.CANCELLED)return{cancelled:!0};if(h===z.StatusString.MAX_RECOVERY_ATTEMPTS_EXCEEDED)return{maxRecoveryAttemptsExceeded:!0}}}catch(m){let h=m;throw this.logger.error(`Exception from system database: ${h}`,h),h}let f=Date.now();if(o&&f>o)return;let d=Promise.resolve(),p=()=>{};if(n!==void 0&&s!==void 0&&i!==void 0){let{promise:m,cancel:h,endTime:g}=await this.#r(s,n,i,this.dbPollingIntervalResultMs);o=g,d=m,p=h}else{let m=o?o-f:this.dbPollingIntervalResultMs;m=Math.min(this.dbPollingIntervalResultMs,m);let{promise:h,cancel:g}=(0,wt.cancellableSleep)(m);d=h,p=g}try{await Promise.race([l,d])}finally{p()}}finally{this.cancelWakeupMap.deregisterCallback(c),u&&this.cancelWakeupMap.deregisterCallback(u)}}}reconnectTimeout=null;async#o(){let e=async()=>{let r=()=>{this.reconnectTimeout||(this.reconnectTimeout=setTimeout(async()=>{this.reconnectTimeout=null,await e()},1e3))},s=null;try{s=await this.pool.connect(),await s.query("LISTEN dbos_notifications_channel;"),await s.query("LISTEN dbos_workflow_events_channel;");let n=i=>{this.shouldUseDBNotifications&&(i.channel==="dbos_notifications_channel"&&i.payload?this.notificationsMap.callCallbacks(i.payload):i.channel==="dbos_workflow_events_channel"&&i.payload&&this.workflowEventsMap.callCallbacks(i.payload))};s.on("notification",n),s.on("error",i=>{this.logger.warn(`Error in notifications client: ${i}`),s&&(s.removeAllListeners(),s.release(!0)),r()}),this.notificationsClient=s}catch(n){this.logger.warn(`Error in notifications listener: ${String(n)}`),s&&(s.removeAllListeners(),s.release(!0)),r()}};await e()}async getEventDispatchState(e,r,s){let n=await this.pool.query(`SELECT * FROM "${this.schemaName}".event_dispatch_kv
       WHERE workflow_fn_name = $1 AND service_name = $2 AND key = $3;`,[r,e,s]);if(n.rows.length!==0)return{service:n.rows[0].service_name,workflowFnName:n.rows[0].workflow_fn_name,key:n.rows[0].key,value:n.rows[0].value,updateTime:n.rows[0].update_time,updateSeq:n.rows[0].update_seq!==null&&n.rows[0].update_seq!==void 0?BigInt(n.rows[0].update_seq):void 0}}async upsertEventDispatchState(e){let r=await this.pool.query(`INSERT INTO "${this.schemaName}".event_dispatch_kv (
        service_name, workflow_fn_name, key, value, update_time, update_seq)
       VALUES ($1, $2, $3, $4, $5, $6)
       ON CONFLICT (service_name, workflow_fn_name, key)
       DO UPDATE SET
         update_time = GREATEST(EXCLUDED.update_time, event_dispatch_kv.update_time),
         update_seq =  GREATEST(EXCLUDED.update_seq,  event_dispatch_kv.update_seq),
         value = CASE WHEN (EXCLUDED.update_time > event_dispatch_kv.update_time 
            OR EXCLUDED.update_seq > event_dispatch_kv.update_seq 
            OR (event_dispatch_kv.update_time IS NULL and event_dispatch_kv.update_seq IS NULL)
         ) THEN EXCLUDED.value ELSE event_dispatch_kv.value END
       RETURNING value, update_time, update_seq;`,[e.service,e.workflowFnName,e.key,e.value,e.updateTime,e.updateSeq]);return{service:e.service,workflowFnName:e.workflowFnName,key:e.key,value:r.rows[0].value,updateTime:r.rows[0].update_time,updateSeq:r.rows[0].update_seq!==void 0&&r.rows[0].update_seq!==null?BigInt(r.rows[0].update_seq):void 0}}async listWorkflows(e){let r=this.schemaName,s=["workflow_uuid","status","name","recovery_attempts","config_name","class_name","authenticated_user","authenticated_roles","assumed_role","queue_name","executor_id","created_at","updated_at","application_version","application_id","workflow_deadline_epoch_ms","workflow_timeout_ms","deduplication_id","priority","queue_partition_key","started_at_epoch_ms","forked_from","parent_workflow_id"];e.loadInput=e.loadInput??!0,e.loadOutput=e.loadOutput??!0,e.loadInput&&s.push("inputs","request"),e.loadOutput&&s.push("output","error"),(e.loadInput||e.loadOutput)&&s.push("serialization"),e.sortDesc=e.sortDesc??!1;let n=[],i=[],o=1,a=(m,h)=>{if(h)if(Array.isArray(h)){let g=h.map((y,E)=>`$${o+E}`).join(", ");n.push(`${m} IN (${g})`),i.push(...h),o+=h.length}else n.push(`${m} = $${o}`),i.push(h),o++};if(e.queuesOnly&&(n.push("queue_name IS NOT NULL"),n.push(`status IN ($${o}, $${o+1})`),i.push(z.StatusString.ENQUEUED,z.StatusString.PENDING),o+=2),a("name",e.workflowName),a("queue_name",e.queueName),e.workflow_id_prefix)if(Array.isArray(e.workflow_id_prefix)){let m=e.workflow_id_prefix.map((h,g)=>`workflow_uuid LIKE $${o+g}`);n.push(`(${m.join(" OR ")})`),i.push(...e.workflow_id_prefix.map(h=>`${h}%`)),o+=e.workflow_id_prefix.length}else n.push(`workflow_uuid LIKE $${o}`),i.push(`${e.workflow_id_prefix}%`),o++;if(e.workflowIDs){let m=e.workflowIDs.map((h,g)=>`$${o+g}`).join(", ");n.push(`workflow_uuid IN (${m})`),i.push(...e.workflowIDs),o+=e.workflowIDs.length}a("authenticated_user",e.authenticatedUser),a("forked_from",e.forkedFrom),a("parent_workflow_id",e.parentWorkflowID),e.startTime&&(n.push(`created_at >= $${o}`),i.push(new Date(e.startTime).getTime()),o++),e.endTime&&(n.push(`created_at <= $${o}`),i.push(new Date(e.endTime).getTime()),o++),a("status",e.status),a("application_version",e.applicationVersion),a("executor_id",e.executorId);let l=n.length>0?`WHERE ${n.join(" AND ")}`:"",c=`ORDER BY created_at ${e.sortDesc?"DESC":"ASC"}`,u=e.limit?`LIMIT ${e.limit}`:"",f=e.offset?`OFFSET ${e.offset}`:"",d=`
      SELECT ${s.join(", ")}
      FROM "${r}".workflow_status
      ${l}
      ${c}
      ${u}
      ${f}
    `;return(await this.pool.query(d,i)).rows.map(GO)}async clearQueueAssignment(e){return((await this.pool.query(`UPDATE "${this.schemaName}".workflow_status
        SET started_at_epoch_ms = NULL, status = $2
        WHERE workflow_uuid = $1 AND queue_name is NOT NULL AND status = $3`,[e,z.StatusString.ENQUEUED,z.StatusString.PENDING])).rowCount??0)>0}async getDeduplicatedWorkflow(e,r){let{rows:s}=await this.pool.query(`SELECT workflow_uuid FROM "${this.schemaName}".workflow_status
       WHERE queue_name = $1 AND deduplication_id = $2`,[e,r]);return s.length===0?null:s[0].workflow_uuid}async getQueuePartitions(e){let{rows:r}=await this.pool.query(`SELECT DISTINCT queue_partition_key FROM "${this.schemaName}".workflow_status
       WHERE queue_name = $1
         AND status = $2
         AND queue_partition_key IS NOT NULL`,[e,z.StatusString.ENQUEUED]);return r.map(s=>s.queue_partition_key)}async findAndMarkStartableWorkflows(e,r,s,n){let i=Date.now(),o=e.rateLimit?e.rateLimit.periodSec*1e3:0,a=[],l="",c=[];n!==void 0&&(l="AND queue_partition_key = $PARTITION",c.push(n));let u=await this.pool.connect();try{await u.query("BEGIN ISOLATION LEVEL REPEATABLE READ");let f=0;if(e.rateLimit){let v=[e.name,z.StatusString.ENQUEUED,i-o,...c],I=await u.query(`SELECT COUNT(*) FROM "${this.schemaName}".workflow_status
           WHERE queue_name = $1
             AND status <> $2
             AND started_at_epoch_ms > $3
             ${l.replace("$PARTITION","$4")}`,v);if(f=Number(I.rows[0].count),f>=e.rateLimit.limitPerPeriod)return await u.query("COMMIT"),a}let d=1/0;if(e.workerConcurrency!==void 0||e.concurrency!==void 0){let v=[e.name,z.StatusString.PENDING,...c],I=await u.query(`SELECT executor_id, COUNT(*) as task_count
           FROM "${this.schemaName}".workflow_status
           WHERE queue_name = $1 AND status = $2
             ${l.replace("$PARTITION","$3")}
           GROUP BY executor_id`,v),S={};I.rows.forEach(x=>{S[x.executor_id]=Number(x.task_count)});let L=S[r]||0;if(e.workerConcurrency!==void 0&&(d=Math.max(0,e.workerConcurrency-L)),e.concurrency!==void 0){let x=Object.values(S).reduce((ve,K)=>ve+K,0);x>e.concurrency&&this.logger.warn(`Total running tasks (${x}) exceeds the global concurrency limit (${e.concurrency})`);let V=Math.max(0,e.concurrency-x);d=Math.min(d,V)}}if(d<=0)return await u.query("COMMIT"),a;let p=e.concurrency?"FOR UPDATE NOWAIT":"FOR UPDATE SKIP LOCKED",m=e.priorityEnabled?"ORDER BY priority ASC, created_at ASC":"ORDER BY created_at ASC",h=d!==1/0?`LIMIT ${d}`:"",g=[z.StatusString.ENQUEUED,e.name,s,...c],y=`
        SELECT workflow_uuid
        FROM "${this.schemaName}".workflow_status
        WHERE status = $1
          AND queue_name = $2
          AND (application_version IS NULL OR application_version = $3)
          ${l.replace("$PARTITION","$4")}
        ${m}
        ${h}
        ${p}
      `,{rows:E}=await u.query(y,g),b=E.map(v=>v.workflow_uuid);for(let v of b){if(e.rateLimit&&a.length+f>=e.rateLimit.limitPerPeriod)break;await u.query(`UPDATE "${this.schemaName}".workflow_status
           SET status = $1,
               executor_id = $2,
               application_version = $3,
               started_at_epoch_ms = $4,
               workflow_deadline_epoch_ms = CASE
                 WHEN workflow_timeout_ms IS NOT NULL AND workflow_deadline_epoch_ms IS NULL
                 THEN (EXTRACT(epoch FROM now()) * 1000)::bigint + workflow_timeout_ms
                 ELSE workflow_deadline_epoch_ms
               END
           WHERE workflow_uuid = $5`,[z.StatusString.PENDING,r,s,i,v]),a.push(v)}await u.query("COMMIT")}catch(f){throw await u.query("ROLLBACK"),f}finally{u.release()}return a}async writeStreamFromStep(e,r,s,n,i){let o=await this.pool.connect();try{await o.query("BEGIN ISOLATION LEVEL READ COMMITTED");let l=(await o.query(`SELECT MAX("offset") FROM "${this.schemaName}".streams
         WHERE workflow_uuid = $1 AND key = $2`,[e,s])).rows[0].max,c=l!==null?l+1:0;await o.query(`INSERT INTO "${this.schemaName}".streams (workflow_uuid, key, value, "offset", function_id, serialization)
         VALUES ($1, $2, $3, $4, $5, $6)`,[e,s,n,c,r,i]),await o.query("COMMIT")}catch(a){throw this.logger.error(a),await o.query("ROLLBACK"),a}finally{o.release()}}async writeStreamFromWorkflow(e,r,s,n,i,o){let a=await this.pool.connect();try{await a.query("BEGIN ISOLATION LEVEL READ COMMITTED"),await this.#t(a,o,e,r,async()=>{let c=(await a.query(`SELECT MAX("offset") FROM "${this.schemaName}".streams 
           WHERE workflow_uuid = $1 AND key = $2`,[e,s])).rows[0].max,u=c!==null?c+1:0;await a.query(`INSERT INTO "${this.schemaName}".streams (workflow_uuid, key, value, "offset", function_id, serialization)
           VALUES ($1, $2, $3, $4, $5, $6)`,[e,s,n,u,r,i])}),await a.query("COMMIT")}catch(l){throw this.logger.error(l),await a.query("ROLLBACK"),l}finally{a.release()}}async closeStream(e,r,s){await this.writeStreamFromWorkflow(e,r,s,A.DBOS_STREAM_CLOSED_SENTINEL,"portable_json",A.DBOS_FUNCNAME_CLOSESTREAM)}async readStream(e,r,s){let n=await this.pool.connect();try{let i=await n.query(`SELECT value, serialization FROM "${this.schemaName}".streams 
         WHERE workflow_uuid = $1 AND key = $2 AND "offset" = $3`,[e,r,s]);if(i.rows.length===0)throw new Error(`No value found for workflow_uuid=${e}, key=${r}, offset=${s}`);let o=i.rows[0];return{serializedValue:o.value,serialization:o.serialization}}finally{n.release()}}async garbageCollect(e,r){if(r!==void 0){let s=await this.pool.query(`SELECT created_at
         FROM "${this.schemaName}".workflow_status
         ORDER BY created_at DESC
         LIMIT 1 OFFSET $1`,[r-1]);if(s.rows.length>0){let n=s.rows[0].created_at;(e===void 0||n>e)&&(e=n)}}e!==void 0&&await this.pool.query(`DELETE FROM "${this.schemaName}".workflow_status
       WHERE created_at < $1
         AND status NOT IN ($2, $3)`,[e,z.StatusString.PENDING,z.StatusString.ENQUEUED])}async getMetrics(e,r){let s=new Date(e).getTime(),n=new Date(r).getTime(),i=[],o=await this.pool.query(`SELECT name, COUNT(workflow_uuid) as count
       FROM "${this.schemaName}".workflow_status
       WHERE created_at >= $1 AND created_at < $2
       GROUP BY name`,[s,n]);for(let l of o.rows)i.push({metricType:"workflow_count",metricName:l.name,value:Number(l.count)});let a=await this.pool.query(`SELECT function_name, COUNT(*) as count
       FROM "${this.schemaName}".operation_outputs
       WHERE completed_at_epoch_ms >= $1 AND completed_at_epoch_ms < $2
       GROUP BY function_name`,[s,n]);for(let l of a.rows)i.push({metricType:"step_count",metricName:l.function_name,value:Number(l.count)});return i}async checkPatch(e,r,s,n){if(r===void 0)throw new TypeError("functionID must be defined");s=`DBOS.patch-${s}`;let{rows:i}=await this.pool.query(`SELECT function_name
       FROM "${this.schemaName}".operation_outputs
      WHERE workflow_uuid=$1 AND function_id=$2`,[e,r]);if(n)return i.length===0?{isPatched:!0,hasEntry:!1}:{isPatched:!0,hasEntry:i[0].function_name===s};if(i.length!==0)return i[0].function_name===s?{isPatched:!0,hasEntry:!0}:{isPatched:!1,hasEntry:!1};let o=Date.now();return await this.pool.query(`INSERT INTO ${this.schemaName}.operation_outputs
       (workflow_uuid, function_id, output, error, function_name, child_workflow_id, started_at_epoch_ms, completed_at_epoch_ms)
       VALUES ($1, $2, $3, $4, $5, $6, $7, $8)
       ON CONFLICT DO NOTHING;`,[e,r,null,null,s,null,o,o]),{isPatched:!0,hasEntry:!0}}};A.PostgresSystemDatabase=te;he([pe(),D("design:type",Function),D("design:paramtypes",[Object,Object,Object]),D("design:returntype",Promise)],te.prototype,"initWorkflowStatus",null);he([pe(),D("design:type",Function),D("design:paramtypes",[String,Object]),D("design:returntype",Promise)],te.prototype,"recordWorkflowOutput",null);he([pe(),D("design:type",Function),D("design:paramtypes",[String,Object]),D("design:returntype",Promise)],te.prototype,"recordWorkflowError",null);he([pe(),D("design:type",Function),D("design:paramtypes",[String,Number]),D("design:returntype",Promise)],te.prototype,"getOperationResultAndThrowIfCancelled",null);he([pe(),D("design:type",Function),D("design:paramtypes",[String,Number,String,Boolean,Number,Object]),D("design:returntype",Promise)],te.prototype,"recordOperationResult",null);he([pe(),D("design:type",Function),D("design:paramtypes",[String,Number,Number]),D("design:returntype",Promise)],te.prototype,"durableSleepms",null);he([pe(),D("design:type",Function),D("design:paramtypes",[String,Number,String,Object,Object,Object]),D("design:returntype",Promise)],te.prototype,"send",null);he([pe(),D("design:type",Function),D("design:paramtypes",[String,Number,Number,String,Number]),D("design:returntype",Promise)],te.prototype,"recv",null);he([pe(),D("design:type",Function),D("design:paramtypes",[String,Number,String,Object,Object]),D("design:returntype",Promise)],te.prototype,"setEvent",null);he([pe(),D("design:type",Function),D("design:paramtypes",[String,String,Number,Object]),D("design:returntype",Promise)],te.prototype,"getEvent",null);he([pe(),D("design:type",Function),D("design:paramtypes",[String]),D("design:returntype",Promise)],te.prototype,"checkIfCanceled",null);he([pe(),D("design:type",Function),D("design:paramtypes",[String,String,Number]),D("design:returntype",Promise)],te.prototype,"getWorkflowStatus",null);he([pe(),D("design:type",Function),D("design:paramtypes",[String,Number,String,Number]),D("design:returntype",Promise)],te.prototype,"awaitWorkflowResult",null);he([pe(),D("design:type",Function),D("design:paramtypes",[String,String,String]),D("design:returntype",Promise)],te.prototype,"getEventDispatchState",null);he([pe(),D("design:type",Function),D("design:paramtypes",[Object]),D("design:returntype",Promise)],te.prototype,"upsertEventDispatchState",null);he([pe(),D("design:type",Function),D("design:paramtypes",[String,String]),D("design:returntype",Promise)],te.prototype,"getDeduplicatedWorkflow",null);he([pe(),D("design:type",Function),D("design:paramtypes",[String]),D("design:returntype",Promise)],te.prototype,"getQueuePartitions",null);he([pe(),D("design:type",Function),D("design:paramtypes",[String,Number,String,String,Object]),D("design:returntype",Promise)],te.prototype,"writeStreamFromStep",null);he([pe(),D("design:type",Function),D("design:paramtypes",[String,Number,String,String,Object,String]),D("design:returntype",Promise)],te.prototype,"writeStreamFromWorkflow",null);he([pe(),D("design:type",Function),D("design:paramtypes",[String,String,Number]),D("design:returntype",Promise)],te.prototype,"readStream",null);he([pe(),D("design:type",Function),D("design:paramtypes",[String,String]),D("design:returntype",Promise)],te.prototype,"getMetrics",null);he([pe(),D("design:type",Function),D("design:paramtypes",[String,Number,String,Boolean]),D("design:returntype",Promise)],te.prototype,"checkPatch",null)});var Ft=w(_=>{"use strict";Object.defineProperty(_,"__esModule",{value:!0});_.ArgName=_.getRegistrationsForExternal=_.associateParameterWithExternal=_.associateMethodWithExternal=_.associateClassWithExternal=_.getTransactionalDataSource=_.registerTransactionalDataSource=_.transactionalDataSources=_.finalizeClassRegistrations=_.getConfiguredInstance=_.getOrCreateClassRegistrationByTarget=_.getClassRegistrationByName=_.getAllRegisteredFunctions=_.getAllRegisteredClassNames=_.getClassRegistration=_.getNameForClass=_.wrapDBOSFunctionAndRegister=_.wrapDBOSFunctionAndRegisterDec=_.wrapDBOSFunctionAndRegisterByUniqueName=_.wrapDBOSFunctionAndRegisterByTarget=_.getOrCreateMethodArgsRegistration=_.getRegisteredOperations=_.getFunctionRegistrationByName=_.getFunctionRegistration=_.registerFunctionWrapper=_.getRegisteredFunctionName=_.getRegisteredFunctionClassName=_.getRegisteredFunctionQualifiedName=_.getRegisteredFunctionFullName=_.insertAllMiddleware=_.registerMiddlewareInstaller=_.getLifecycleListeners=_.registerLifecycleCallback=_.clearAllRegistrations=_.ensureDBOSIsLaunched=_.ensureDBOSIsNotLaunched=_.recordDBOSShutdown=_.recordDBOSLaunch=_.ClassRegistration=_.ConfiguredInstance=_.MethodRegistration=_.DBOS_AUTH=_.MethodParameter=_.DBOSDataType=_.setAlertHandler=_.getAlertHandler=void 0;var Rt=He(),mc;function tD(){return mc}_.getAlertHandler=tD;function rD(t){mc=t}_.setAlertHandler=rD;var Ri=class t{dataType="text";length=-1;precision=-1;scale=-1;static varchar(e){let r=new t;return r.dataType="varchar",r.length=e,r}static decimal(e,r){let s=new t;return s.dataType="decimal",s.precision=e,s.scale=r,s}static fromArg(e){if(!e)return;let r=new t;return e===String?r.dataType="text":e===Date?r.dataType="timestamp":e===Number?r.dataType="double":e===Boolean?r.dataType="boolean":r.dataType="json",r}formatAsString(){let e=this.dataType;return this.dataType==="varchar"&&this.length>0&&(e+=`(${this.length})`),this.dataType==="decimal"&&this.precision>0&&(this.scale>0?e+=`(${this.precision},${this.scale})`:e+=`(${this.precision})`),e}};_.DBOSDataType=Ri;function fc(t){let e=t.toString(),r=[],s="",n=0,i=!1,o=!1,a=!1,l=!1,c=!1,u=!1,f=e.indexOf("(");if(f===-1)return[];let d=e.substring(f+1);for(let p=0;p<d.length;p++){let m=d[p],h=d[p+1];if(c){m==="*"&&h==="/"&&(c=!1,p++);continue}else if(l){m===`
`&&(l=!1);continue}else if(m==="/"&&h==="*"){c=!0,p++;continue}else if(m==="/"&&h==="/"){l=!0;continue}if(!(l||c)&&(m==="'"&&!o&&!a?i=!i:m==='"'&&!i&&!a?o=!o:m==="`"&&!i&&!o&&(a=!a),!(i||o||a))){if(m==="="&&n===0){u=!0;continue}if((m==="("||m==="{"||m==="[")&&n++,m===")"||m==="}"||m==="]"){if(n===0)break;n--}if(m==="."&&h==="."&&d[p+2]==="."){p+=2;continue}if(m===","&&n===0){s.trim()&&r.push(s.trim()),s="",u=!1;continue}u||(s+=m)}}return s.trim()&&s.trim()&&r.push(s.trim()),r}var zr=class{name="";index=-1;externalRegInfo=new Map;getRegisteredInfo(e){return this.externalRegInfo.has(e)||this.externalRegInfo.set(e,{}),this.externalRegInfo.get(e)}get dataType(){return this.getRegisteredInfo("type").dataType}initializeBaseType(e){this.externalRegInfo.has("type")||this.externalRegInfo.set("type",{});let r=this.externalRegInfo.get("type");r.dataType=Ri.fromArg(e)}constructor(e,r){this.index=e,this.initializeBaseType(r)}};_.MethodParameter=zr;_.DBOS_AUTH="auth";var Ci=class{defaults;name="";className="";classReg;onEnter=[];addEntryInterceptor(e,r=10){this.onEnter.push({seqNum:r,func:e}),this.onEnter.sort((s,n)=>s.seqNum-n.seqNum)}args=[];constructor(e,r,s){this.classReg=e,this.origFunction=r,this.isInstance=s}needInitialized=!0;isInstance;origFunction;registeredFunction;wrappedFunction=void 0;workflowConfig;stepConfig;regLocation;externalRegInfo=new Map;getRegisteredInfo(e){return this.externalRegInfo.has(e)||this.externalRegInfo.set(e,{}),this.externalRegInfo.get(e)}getAssignedType(){if(this.workflowConfig)return"Workflow";if(this.stepConfig)return"Step"}getClassName(){return this.className||this.classReg.getClassName()}checkFuncTypeUnassigned(e){let r=this.getAssignedType(),s;if(r&&e!==r?s=`Operation (Name: ${this.getClassName()}.${this.name}) is already registered with a conflicting function type: ${r} vs. ${e}`:r&&(s=`Operation (Name: ${this.getClassName()}.${this.name}) is already registered.`),s)throw this.regLocation&&(s=s+`
Prior registration occurred at:
${this.regLocation.join(`
`)}`),new Rt.DBOSConflictingRegistrationError(`${s}`);this.regLocation=new Ut().getCleanStack(3)}setStepConfig(e){this.checkFuncTypeUnassigned("Step"),this.stepConfig=e}setWorkflowConfig(e){this.checkFuncTypeUnassigned("Workflow"),this.workflowConfig=e}init=!1;invoke(e,r){return(this.wrappedFunction??this.registeredFunction??this.origFunction).call(e,...r)}getRequiredRoles(){let e=this.getRegisteredInfo(_.DBOS_AUTH);return e?.requiredRole?e.requiredRole:this.defaults?.getRegisteredInfo(_.DBOS_AUTH)?.requiredRole||[]}};_.MethodRegistration=Ci;var dc=class{name;constructor(e){jr&&console.warn(`ConfiguredInstance '${e}' is being created after DBOS initialization and was not available for recovery.`),this.name=e,fD(this,e)}initialize(){return Promise.resolve()}};_.ConfiguredInstance=dc;var zs=class{name="";needsInitialized=!0;ormEntities=[];registeredOperationsByName=new Map;allRegisteredOperations=new Map;configuredInstances=new Map;configuredInstanceRegLocs=new Map;externalRegInfo=new Map;ctor;constructor(e){this.ctor=e}getClassName(){return this.name||this.ctor?.name||""}registerOperationByName(e,r){let s=this.registeredOperationsByName.get(e);if(s&&s!==r){let n=`Operation (Name: ${this.name}.${e}) is already registered.`;throw s.regLocation&&(n=n+`
Prior registration occurred at:
${s.regLocation.join(`
`)}`),new Rt.DBOSConflictingRegistrationError(`${n}`)}this.registeredOperationsByName.set(e,r),r.regLocation=new Ut().getCleanStack(3)}getRegisteredInfo(e){return this.externalRegInfo.has(e)||this.externalRegInfo.set(e,{}),this.externalRegInfo.get(e)}};_.ClassRegistration=zs;var Ut=class t extends Error{constructor(){super("StackGrabber"),Error.captureStackTrace(this,t)}getCleanStack(e=1){return this.stack?.split(`
`).slice(e+1).map(r=>">>> "+r.replace(/^\s*at\s*/,""))}},jr;function sD(){jr=new Ut().getCleanStack(2)}_.recordDBOSLaunch=sD;function nD(){jr=void 0}_.recordDBOSShutdown=nD;function Li(){if(jr)throw new Rt.DBOSConflictingRegistrationError(`DBOS code is being registered after DBOS.launch().  DBOS was launched from:
${jr.join(`
`)}
`)}_.ensureDBOSIsNotLaunched=Li;function iD(t){if(!jr)throw new TypeError(`\`DBOS.launch()\` must be called before running ${t}.`)}_.ensureDBOSIsLaunched=iD;function oD(){Ni.length=0,Ai=!1,Pi.length=0,It.clear(),hc.clear(),lt.clear(),Tt.clear(),_.transactionalDataSources.clear(),mc=void 0}_.clearAllRegistrations=oD;var Ni=[];function aD(t){Ni.includes(t)||Ni.push(t)}_.registerLifecycleCallback=aD;function lD(){return Ni}_.getLifecycleListeners=lD;var Ai=!1,Pi=[];function cD(t){if(Ai)throw new TypeError("Attempt to provide method middleware after insertion was performed");Pi.includes(t)||Pi.push(t)}_.registerMiddlewareInstaller=cD;function uD(){if(Ai)return;Ai=!0;let t=Am();for(let e of t)for(let r of e.allRegisteredOperations.values())for(let s of Pi)s.installMiddleware(r)}_.insertAllMiddleware=uD;var It=new Map;function fD(t,e){let r=Pm(t.constructor);if(r.configuredInstances.has(e))throw new Rt.DBOSConflictingRegistrationError(`An instance of class '${t.constructor.name}' with name '${e}' was already registered.  Earlier registration occurred at:
${(r.configuredInstanceRegLocs.get(e)??[]).join(`
`)}`);r.configuredInstances.set(e,t),r.configuredInstanceRegLocs.set(e,new Ut().getCleanStack(3)??[])}function xi(t){let e="",r=t.name??"";if(It.has(t)){let s=It.get(t);e=s.getClassName(),r=s.name}return{className:e,name:r}}_.getRegisteredFunctionFullName=xi;function dD(t){let e=xi(t);return e.className+"."+e.name}_.getRegisteredFunctionQualifiedName=dD;function hD(t){return xi(t).className}_.getRegisteredFunctionClassName=hD;function pD(t){return xi(t).name}_.getRegisteredFunctionName=pD;function mD(t,e){e.wrappedFunction=t,It.set(t,e)}_.registerFunctionWrapper=mD;function wc(t){return It.get(t)}_.getFunctionRegistration=wc;function wD(t,e){let r=js(t,!1);if(!r)return;let s=r.registeredOperationsByName.get(e);if(s)return s}_.getFunctionRegistrationByName=wD;function Im(t){let e=[];if(typeof t=="function")fr(t,!1).reg?.reg?.allRegisteredOperations?.forEach(s=>e.push(s));else{let r=t;for(;r;)e.push(...Im(r.constructor)),r=Object.getPrototypeOf(r)}return e}_.getRegisteredOperations=Im;var hc=new Map;function gc(t,e,r){let s=t;s&&typeof s!="function"&&(s=s.constructor),r||(r=Object.getOwnPropertyDescriptor(t,e).value);let n=hc.get(r);if(n===void 0){let i;if(t&&(i=function(a,l){let c=Reflect?.getMetadata;if(c)return c("design:paramtypes",a,l)}(t,e)),i)n=i.map((o,a)=>new zr(a,o));else if(r)n=fc(r).map((a,l)=>new zr(l));else{let o=Object.getOwnPropertyDescriptor(t,e);n=fc(o?.value).map((l,c)=>new zr(c))}hc.set(r,n)}return n}_.getOrCreateMethodArgsRegistration=gc;function Rm(t,e,r,s,n){let{classReg:i,isInstance:o}=pc(t,e),a=s??r.toString(),l=It.get(n)?.origFunction??n;if(!i.allRegisteredOperations.has(l)){let u=new Ci(i,n,o);i.allRegisteredOperations.set(n,u)}let c=i.allRegisteredOperations.get(n);if(c.needInitialized){c.needInitialized=!1,c.name=a,c.className=i.name,c.defaults=i,c.args=gc(t,r,n);let u=fc(n);c.args.forEach(d=>{d.name||d.index<u.length&&(d.name=u[d.index])});let f=async function(...d){let p=d;for(let m of c.onEnter)p=m.func(c,p);return c.origFunction.call(this,...p)};Object.defineProperty(f,"name",{value:c.name}),c.registeredFunction=f,It.set(c.registeredFunction,c),It.set(c.origFunction,c)}return c}function gD(t,e,r,s){if(!s.value)throw Error("Use of decorator when original method is undefined");let n=Cm(t,void 0,e,r,s.value);return s.value=n.wrappedFunction??n.registeredFunction,{descriptor:s,registration:n}}_.wrapDBOSFunctionAndRegisterByTarget=gD;function Cm(t,e,r,s,n){Li(),s||(s=typeof r=="string"?r:r.toString());let i=wc(n);if(i)return pc(t,e).classReg.registerOperationByName(s,i),i;let o=Rm(t,e,r,s,n);return pc(t,e).classReg.registerOperationByName(s,o),o}_.wrapDBOSFunctionAndRegisterByUniqueName=Cm;function yD(t,e,r,s){if(!s.value)throw Error("Use of decorator when original method is undefined");let n=qi(t,void 0,e,r,s.value);return s.value=n.wrappedFunction??n.registeredFunction,{descriptor:s,registration:n}}_.wrapDBOSFunctionAndRegisterDec=yD;function qi(t,e,r,s,n){Li();let i=wc(n);return i||Rm(t,e,r,s,n)}_.wrapDBOSFunctionAndRegister=qi;var lt=new Map,Tt=new Map;function Nm(t){let e=fr(t,!1);return e.reg?.name||e.regTarget.name}_.getNameForClass=Nm;function Am(){let t=new Set;for(let[e,r]of lt)t.add(r.reg);for(let[e,r]of Tt)t.add(r.reg);return t}function fr(t,e){let r;return typeof t=="function"?r=t:r=t.constructor,Tt.has(r)?{regTarget:r,reg:Tt.get(r)}:e?(Tt.set(r,{reg:new zs(r),name:r.name,regloc:new Ut().getCleanStack(1)??[]}),{regTarget:r,reg:Tt.get(r)}):{regTarget:r}}_.getClassRegistration=fr;function _D(){let t=[];for(let[e,r]of lt)t.push(e);return t}_.getAllRegisteredClassNames=_D;function SD(){let t=new Set,e=[];for(let[r,s]of It)t.has(s)||(e.push(s),t.add(s));return e}_.getAllRegisteredFunctions=SD;function js(t,e=!1){if(!lt.has(t)&&!e)throw new Rt.DBOSNotRegisteredError(t,`Class '${t}' is not registered`);lt.has(t)||lt.set(t,{reg:new zs(void 0),regloc:new Ut().getCleanStack(1)??[]});let r=lt.get(t).reg;return r.needsInitialized&&(r.name=t,r.needsInitialized=!1),r}_.getClassRegistrationByName=js;function Pm(t){return fr(t,!0).reg.reg}_.getOrCreateClassRegistrationByTarget=Pm;function pc(t,e){!t&&e===void 0&&(e="");let r,s=!1;if(t&&(typeof t=="function"?r=t:(r=t.constructor,s=!0)),e===void 0)return{classReg:fr(r,!0).reg.reg,isInstance:s,className:e};if(!r)return{classReg:js(e,!0),isInstance:!1,className:e};let n=fr(r,!0);if(n.reg.name&&n.reg.name!==e)throw new TypeError(`Attempt to register class under two names: ${n.reg.name} vs. ${e}`);return n.reg.name=e,{classReg:n.reg.reg,isInstance:s,className:e}}function ED(t,e){let r=js(t);return r?r.configuredInstances.get(e)??null:null}_.getConfiguredInstance=ED;function bD(){function t(e,r){e.name=r,e.needsInitialized=!1;for(let[s,n]of e.registeredOperationsByName)n.className=r}for(let[e,r]of Tt){let s=r.name||r.reg.name||Nm(e),n=lt.get(s);if(!n){lt.set(s,{reg:r.reg,ctor:e,regloc:r.regloc}),r.name=s,t(r.reg,s);continue}if(n.ctor&&n.ctor!==e)throw new Rt.DBOSConflictingRegistrationError(`Class ${s}(${e.name}) has been given a name that conflicts with another class ${n.ctor?.name}.`);if(n.reg!==r.reg)throw new Rt.DBOSConflictingRegistrationError(`Class: ${s}(${e.name}) has been given a name that was registered directly by name without a class.`);lt.set(s,{reg:r.reg,ctor:e,regloc:r.regloc}),r.name=s,t(r.reg,s)}}_.finalizeClassRegistrations=bD;_.transactionalDataSources=new Map;function kD(t,e){if(_.transactionalDataSources.has(t)){if(_.transactionalDataSources.get(t)!==e)throw new Rt.DBOSConflictingRegistrationError(`Data source with name ${t} is already registered`);return}Li(),_.transactionalDataSources.set(t,e)}_.registerTransactionalDataSource=kD;function vD(t){if(_.transactionalDataSources.has(t))return _.transactionalDataSources.get(t);throw new Rt.DBOSNotRegisteredError(t,`Data source '${t}' is not registered`)}_.getTransactionalDataSource=vD;function OD(t,e){let r;return typeof e=="string"?r=js(e,!0):r=fr(e,!0).reg.reg,r.getRegisteredInfo(t)}_.associateClassWithExternal=OD;function DD(t,e,r,s,n){let i=qi(e,r,s,s,n);return i.externalRegInfo.has(t)||i.externalRegInfo.set(t,{}),{registration:i,regInfo:i.externalRegInfo.get(t)}}_.associateMethodWithExternal=DD;function TD(t,e,r,s,n,i){n||(n=Object.getOwnPropertyDescriptor(e,s).value);let o=qi(e,r,s,s,n),a;if(typeof i=="number"?a=o.args[i]:a=o.args.find(l=>l.name===i),!!a)return a.externalRegInfo.has(t)||a.externalRegInfo.set(t,{}),a.externalRegInfo.get(t)}_.associateParameterWithExternal=TD;function ID(t,e,r){let s=new Array;if(e){let o;if(typeof e=="string"?o=lt.get(e)?.reg:typeof e=="function"?o=Tt.get(e)?.reg:e!==void 0&&typeof e=="object"&&(o=Tt.get(e.constructor)?.reg),o)if(r){let a=o.registeredOperationsByName.get(r);a&&i(a)}else n(o)}else{let o=Am();for(let a of o)n(a)}return s;function n(o){for(let a of o.allRegisteredOperations.values())i(a)}function i(o){let a=o.externalRegInfo.get(t),l=o.defaults?.externalRegInfo.get(t),c=[],u=!1;for(let f of o.args)f.externalRegInfo.has(t)&&(u=!0),c.push({name:f.name,index:f.index,paramConfig:f.externalRegInfo.get(t)});!a&&!l&&!u||s.push({methodReg:o,methodConfig:a,classConfig:l??{},paramConfig:c})}}_.getRegistrationsForExternal=ID;function RD(t){return function(e,r,s){let i=gc(e,r)[s];i.name=t}}_.ArgName=RD});var Vs=w(zt=>{"use strict";Object.defineProperty(zt,"__esModule",{value:!0});zt.wfQueueRunner=zt.WorkflowQueue=void 0;var Lm=Os(),xm=Oi(),yc=Oe(),_c=class{name;concurrency;rateLimit;workerConcurrency;priorityEnabled=!1;partitionQueue=!1;constructor(e,r,s){if(this.name=e,Lm.DBOS.isInitialized()&&Lm.DBOS.logger.warn(`Workflow queue '${e}' is being created after DBOS initialization and will not be considered for dequeue.`),typeof r=="object"&&r!==null?(this.concurrency=r.concurrency,this.rateLimit=r.rateLimit,this.workerConcurrency=r.workerConcurrency,this.priorityEnabled=r.priorityEnabled??!1,this.partitionQueue=r.partitionQueue??!1):(this.concurrency=r,this.rateLimit=s),zt.wfQueueRunner.wfQueuesByName.has(e))throw Error(`Workflow Queue '${e}' defined multiple times`);zt.wfQueueRunner.wfQueuesByName.set(e,this)}};zt.WorkflowQueue=_c;var Sc=class{wfQueuesByName=new Map;isRunning=!1;interruptResolve;pollingIntervalMs=1e3;minPollingIntervalMs=1e3;maxPollingIntervalMs=12e4;stop(){this.isRunning&&(this.isRunning=!1,this.interruptResolve&&this.interruptResolve())}clearRegistrations(){this.wfQueuesByName.clear()}async dispatchLoop(e,r){for(this.isRunning=!0;this.isRunning;){let s,n=new Promise(o=>{s=setTimeout(()=>{o()},this.pollingIntervalMs)});if(await Promise.race([n,new Promise((o,a)=>this.interruptResolve=a)]).catch(()=>{e.logger.debug("Workflow queue loop interrupted!")}),clearTimeout(s),!this.isRunning)break;let i;r!==null?i=[...r,this.wfQueuesByName.get(yc.INTERNAL_QUEUE_NAME)]:i=Array.from(this.wfQueuesByName.values());for(let o of i){let a=[];try{if(o.partitionQueue){let l=await e.systemDatabase.getQueuePartitions(o.name);for(let c of l){let u=await e.systemDatabase.findAndMarkStartableWorkflows(o,e.executorID,yc.globalParams.appVersion,c);a.push(...u)}}else a=await e.systemDatabase.findAndMarkStartableWorkflows(o,e.executorID,yc.globalParams.appVersion,void 0)}catch(l){let c=l;"code"in c&&(c.code==="40001"||c.code==="55P03")?(this.pollingIntervalMs=Math.min(this.maxPollingIntervalMs,this.pollingIntervalMs*2),e.logger.warn(`Contention detected in queue thread for ${o.name}. Increasing polling interval to ${(this.pollingIntervalMs/1e3).toFixed(2)}s.`)):e.logger.warn(`Error getting startable workflows: ${c.message}`),a=[]}a.length>0&&await(0,xm.debugTriggerPoint)(xm.DEBUG_TRIGGER_WORKFLOW_QUEUE_START);for(let l of a)try{let c=await e.executeWorkflowId(l,{isQueueDispatch:!0})}catch(c){e.logger.warn(`Could not execute workflow with id ${l}: ${c.message}`)}}this.pollingIntervalMs=Math.max(this.minPollingIntervalMs,this.pollingIntervalMs*.9)}}logRegisteredEndpoints(e){let r=e.logger;r.info("Workflow queues:");for(let[s,n]of this.wfQueuesByName){let i=n.concurrency!==void 0?`global concurrency limit: ${n.concurrency}`:"No concurrency limit set";r.info(`    ${s}: ${i}`);let o=n.workerConcurrency!==void 0?`worker concurrency limit: ${n.workerConcurrency}`:"No worker concurrency limit set";r.info(`    ${s}: ${o}`)}}};zt.wfQueueRunner=new Sc});var Wm=w(gt=>{"use strict";Object.defineProperty(gt,"__esModule",{value:!0});gt.TimeMatcher=gt.convertExpression=gt.validateCrontab=gt.convertAsterisksToRanges=void 0;function CD(t){return t.replace(/\s{2,}/g," ").trim()}function ND(t){return t.length===5?["0"].concat(t):t}var AD=["january","february","march","april","may","june","july","august","september","october","november","december"],PD=["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"];function qm(t,e){for(let r=0;r<e.length;r++)t=t.replace(new RegExp(e[r],"gi"),`${r+1}`);return t}function LD(t){return t=qm(t,AD),t=qm(t,PD),t}var xD=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"],qD=["sun","mon","tue","wed","thu","fri","sat"];function Mm(t,e){for(let r=0;r<e.length;r++)t=t.replace(new RegExp(e[r],"gi"),`${r}`);return t}function MD(t){return t=t.replace("7","0"),t=Mm(t,xD),Mm(t,qD)}function Vr(t,e){return t.indexOf("*")!==-1?t.replace("*",e):t}function Bm(t){return t[0]=Vr(t[0],"0-59"),t[1]=Vr(t[1],"0-59"),t[2]=Vr(t[2],"0-23"),t[3]=Vr(t[3],"1-31"),t[4]=Vr(t[4],"1-12"),t[5]=Vr(t[5],"0-6"),t}gt.convertAsterisksToRanges=Bm;function BD(t,e,r,s){let n=[],i=parseInt(s),o=parseInt(r);o>i&&(i=parseInt(r),o=parseInt(s));for(let a=o;a<=i;a++)n.push(a.toString());return t.replace(new RegExp(e,"i"),n.join())}function $D(t){let e=/(\d+)-(\d+)/,r=e.exec(t);for(;r!==null&&r.length>0;)t=BD(t,r[0],r[1],r[2]),r=e.exec(t);return t}function WD(t){for(let e=0;e<t.length;e++)t[e]=$D(t[e]);return t}function UD(t){let e=/^(.+)\/(\w+)$/;for(let r=0;r<t.length;r++){let s=e.exec(t[r]);if(s!==null&&s.length>0){let i=s[2];if(isNaN(parseInt(i)))throw new Error(i+" is not a valid step value");let o=s[1].split(","),a=[],l=parseInt(i,10);for(let c=0;c<=o.length;c++){let u=parseInt(o[c],10);u%l===0&&a.push(`${u}`)}t[r]=a.join(",")}}return t}function FD(t){for(let e=0;e<t.length;e++){let r=t[e].split(",");for(let s=0;s<r.length;s++)r[s]=parseInt(r[s]).toString();t[e]=r.join(",")}return t}var zD=/^(?:\d+|\*|\*\/\d+)$/;function Qr(t,e,r){let s=t.split(",");for(let n of s){let i=parseInt(n,10);if(!Number.isNaN(i)&&(i<e||i>r)||!zD.test(n))return!1}return!0}function jD(t){return!Qr(t,0,59)}function VD(t){return!Qr(t,0,59)}function GD(t){return!Qr(t,0,23)}function QD(t){return!Qr(t,1,31)}function KD(t){return!Qr(t,1,12)}function HD(t){return!Qr(t,0,7)}function JD(t,e){if(jD(e[0]))throw new Error(`${t[0]} is a invalid expression for second`);if(VD(e[1]))throw new Error(`${t[1]} is a invalid expression for minute`);if(GD(e[2]))throw new Error(`${t[2]} is a invalid expression for hour`);if(QD(e[3]))throw new Error(`${t[3]} is a invalid expression for day of month`);if(KD(e[4]))throw new Error(`${t[4]} is a invalid expression for month`);if(HD(e[5]))throw new Error(`${t[5]} is a invalid expression for week day`)}function $m(t){if(typeof t!="string")throw new TypeError("pattern must be a string!");let e=t.split(" "),r=bc(t).split(" ");return e.length===5&&e.unshift("0"),JD(e,r),r.join(" ")}gt.validateCrontab=$m;function bc(t){let e=CD(t).split(" ");return e=ND(e),e[4]=LD(e[4]),e[5]=MD(e[5]),e=Bm(e),e=WD(e),e=UD(e),e=FD(e),e.join(" ")}gt.convertExpression=bc;function Gr(t,e){let r=`${e}`;return t.indexOf(",")!==-1?t.split(",").includes(r):t===r}var Ec=class{#e;#t;#r;#s;constructor(e,r){$m(e),this.#e=bc(e),this.#s=r,this.#t=this.#e.split(" "),this.#r=this.#s?new Intl.DateTimeFormat("en-US",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hourCycle:"h23",fractionalSecondDigits:3,timeZone:this.#s}):null}match(e){e=this.#i(e);let r=Gr(this.#t[0],e.getSeconds()),s=Gr(this.#t[1],e.getMinutes()),n=Gr(this.#t[2],e.getHours()),i=this.#n(e);return r&&s&&n&&i}#n(e){let r=Gr(this.#t[3],e.getDate()),s=Gr(this.#t[4],e.getMonth()+1),n=Gr(this.#t[5],e.getDay());return r&&s&&n}nextWakeupTime(e){let r=typeof e=="number"?e:e.getTime(),s=Math.round(r);for(let n=3600;--n;n>0){s+=1e3;let i=new Date(s);if(this.match(i))return i}return new Date(s)}#i(e){return this.#r?new Date(this.#r.format(e)):typeof e=="number"?new Date(e):e}};gt.TimeMatcher=Ec});var Mi=w(Kr=>{"use strict";Object.defineProperty(Kr,"__esModule",{value:!0});Kr.ScheduledReceiver=Kr.SchedulerMode=void 0;var Te=Ks(),YD=Oe(),XD=Wm(),Qs;(function(t){t.ExactlyOncePerInterval="ExactlyOncePerInterval",t.ExactlyOncePerIntervalWhenActive="ExactlyOncePerIntervalWhenActive"})(Qs||(Kr.SchedulerMode=Qs={}));var Gs="dbos.scheduler",kc=class t{#e=new AbortController;#t=new Array;constructor(){Te.DBOS.registerLifecycleCallback(this)}async initialize(){for(let e of Te.DBOS.getAssociatedInfo(Gs)){if(e.methodReg.registeredFunction===void 0){Te.DBOS.logger.warn(`Scheduled workflow ${e.methodReg.className}.${e.methodReg.name} is missing registered function; skipping`);continue}let{crontab:r,mode:s,queueName:n}=e.methodConfig;if(!r){Te.DBOS.logger.warn(`Scheduled workflow ${e.methodReg.className}.${e.methodReg.name} is missing crontab; skipping`);continue}let i=new XD.TimeMatcher(r),o=t.#r(e.methodReg,i,s??Qs.ExactlyOncePerIntervalWhenActive,n,this.#e.signal);this.#t.push(o)}}async destroy(){this.#e.abort();let e=this.#t.splice(0);await Promise.allSettled(e)}logRegisteredEndpoints(){Te.DBOS.logger.info("Scheduled endpoints:");for(let e of Te.DBOS.getAssociatedInfo(Gs)){let r=`${e.methodReg.className}.${e.methodReg.name}`,{crontab:s,mode:n}=e.methodConfig;s?Te.DBOS.logger.info(`    ${r} @ ${s}; ${n??Qs.ExactlyOncePerIntervalWhenActive}`):Te.DBOS.logger.info(`    ${r} is missing crontab; skipping`)}}static async#r(e,r,s,n,i){let o=`${e.className}.${e.name}`,a=new Date().setMilliseconds(0);if(s===Qs.ExactlyOncePerInterval){let l=await Te.DBOS.getEventDispatchState(Gs,o,"lastState");l?.value&&(a=parseFloat(l.value))}for(;!i.aborted;){let l=r.nextWakeupTime(a).getTime(),c=l-Date.now();if(c>0){let f=Math.min(c/10,1e4),d=Math.random()*f;c+=d}if(c>0&&await new Promise((f,d)=>{let p,m=()=>{clearTimeout(p),d(new Error("Abort signal received"))};i.addEventListener("abort",m,{once:!0}),i.aborted&&(i.removeEventListener("abort",m),d(new Error("Abort signal received"))),p=setTimeout(()=>{i.removeEventListener("abort",m),f()},c)}),i.aborted)break;if(!r.match(l)){a=l;continue}let u=new Date(l);if(e.workflowConfig&&e.registeredFunction){let f=`sched-${o}-${u.toISOString()}`,d={workflowID:f,queueName:n??YD.INTERNAL_QUEUE_NAME};Te.DBOS.logger.debug(`Executing scheduled workflow ${f}`),await Te.DBOS.startWorkflow(e.registeredFunction,d)(u,new Date)}else Te.DBOS.logger.error(`${o} is @scheduled but not a workflow`);a=await t.#s(o,l)}}static async#s(e,r){try{let s={service:Gs,workflowFnName:e,key:"lastState",value:`${r}`,updateTime:r},n=await Te.DBOS.upsertEventDispatchState(s),i=parseFloat(n.value);if(i&&i>r)return i}catch(s){let n=s;Te.DBOS.logger.warn(`Scheduler caught an error writing to system DB: ${n.message}`),Te.DBOS.logger.error(s)}return r}static registerScheduled(e,r){let{regInfo:s}=Te.DBOS.associateFunctionWithInfo(Gs,e,{ctorOrProto:r.ctorOrProto,className:r.className,name:r.name??e.name}),n=s;n.crontab=r.crontab,n.mode=r.mode,n.queueName=r.queueName}};Kr.ScheduledReceiver=kc});var Js=w(Ie=>{"use strict";Object.defineProperty(Ie,"__esModule",{value:!0});Ie.globalTimeout=Ie.toWorkflowStatus=Ie.forkWorkflow=Ie.listWorkflowSteps=Ie.getWorkflow=Ie.listQueuedWorkflows=Ie.listWorkflows=void 0;var Hs=Ot(),ZD=require("node:crypto");async function vc(t,e){return(await t.listWorkflows(e)).map(s=>Bi(s,t.getSerializer()))}Ie.listWorkflows=vc;async function eT(t,e){return e.queuesOnly=!0,e.loadOutput=!1,(await t.listWorkflows(e)).map(s=>Bi(s,t.getSerializer()))}Ie.listQueuedWorkflows=eT;async function tT(t,e){let r=await t.getWorkflowStatus(e);return r?Bi(r,t.getSerializer()):void 0}Ie.getWorkflow=tT;async function rT(t,e){return await t.getWorkflowStatus(e)?(await t.getAllOperationResults(e)).map(i=>({functionID:i.function_id,name:i.function_name??"",output:i.output?(0,Hs.safeParse)(t.getSerializer(),i.output,i.serialization):null,error:i.error?(0,Hs.safeParseError)(t.getSerializer(),i.error,i.serialization):null,childWorkflowID:i.child_workflow_id,startedAtEpochMs:i.started_at_epoch_ms,completedAtEpochMs:i.completed_at_epoch_ms})).toSorted((i,o)=>i.functionID-o.functionID):void 0}Ie.listWorkflowSteps=rT;async function sT(t,e,r,s={}){let n=s.newWorkflowID??(0,ZD.randomUUID)();return await t.forkWorkflow(e,r,{...s,newWorkflowID:n}),n}Ie.forkWorkflow=sT;function Bi(t,e){return{workflowID:t.workflowUUID,status:t.status,workflowName:t.workflowName,workflowClassName:t.workflowClassName,workflowConfigName:t.workflowConfigName,queueName:t.queueName,authenticatedUser:t.authenticatedUser,assumedRole:t.assumedRole,authenticatedRoles:t.authenticatedRoles,input:t.input?(0,Hs.safeParsePositionalArgs)(e,t.input,t.serialization):void 0,output:t.output?(0,Hs.safeParse)(e,t.output??null,t.serialization):void 0,error:t.error?(0,Hs.safeParseError)(e,t.error,t.serialization):void 0,request:t.request,executorId:t.executorId,applicationVersion:t.applicationVersion,applicationID:t.applicationID,recoveryAttempts:t.recoveryAttempts,createdAt:t.createdAt,updatedAt:t.updatedAt,timeoutMS:t.timeoutMS,deadlineEpochMS:t.deadlineEpochMS,deduplicationID:t.deduplicationID,priority:t.priority,queuePartitionKey:t.queuePartitionKey,dequeuedAt:t.startedAtEpochMs,forkedFrom:t.forkedFrom,parentWorkflowID:t.parentWorkflowID}}Ie.toWorkflowStatus=Bi;async function nT(t,e){let r=new Date(e).toISOString();for(let s of await vc(t,{status:"PENDING",endTime:r}))await t.cancelWorkflow(s.workflowID);for(let s of await vc(t,{status:"ENQUEUED",endTime:r}))await t.cancelWorkflow(s.workflowID)}Ie.globalTimeout=nT});var Rc=w(jt=>{"use strict";Object.defineProperty(jt,"__esModule",{value:!0});jt.DebouncerClient=jt.Debouncer=jt.debouncerWorkflowFunction=void 0;var Um=require("node:crypto"),Ze=Ks(),Fm=lr(),Oc=Ft(),$i=He(),Ys=Oe(),Ic="DEBOUNCER_TOPIC",iT=async(t,e,...r)=>{let s=r,n=e.debounceTimeoutMs?Date.now()+e.debounceTimeoutMs:Number.MAX_VALUE,i=t;for(;Date.now()<n;){let l=Math.max(n-Date.now(),0),c=Math.min(i,l),u=await Ze.DBOS.recv(Ic,c/1e3);if(u===null)break;s=u.args,i=u.debouncePeriodMs,await Ze.DBOS.setEvent(u.messageID,u.messageID)}let o=(0,Oc.getFunctionRegistrationByName)(e.workflowClassName,e.workflowName);if(!o||!o.registeredFunction)throw Error(`Invalid workflow name provided to debouncer: ${e.workflowName}`);let a=o?.registeredFunction;await Ze.DBOS.startWorkflow(a,e.startWorkflowParams)(...s)};jt.debouncerWorkflowFunction=iT;var Dc=class{cfg;constructor(e){let r=(0,Oc.getFunctionRegistration)(e.workflow);this.cfg={workflowName:r?.name??e.workflow.name,workflowClassName:(0,Oc.getRegisteredFunctionClassName)(e.workflow),startWorkflowParams:e.startWorkflowParams,debounceTimeoutMs:e.debounceTimeoutMs}}async debounce(e,r,...s){if(r<=0)throw Error(`debouncePeriodMs must be positive, not ${r}`);let n={...this.cfg};for(n.startWorkflowParams=this.cfg.startWorkflowParams?{...this.cfg.startWorkflowParams}:{},n.startWorkflowParams.workflowID=n.startWorkflowParams.workflowID??await Ze.DBOS.randomUUID();;){let i=`${n.workflowClassName}.${n.workflowName}-${e}`;try{return await Ze.DBOS.startWorkflow(Fm.DBOSExecutor.debouncerWorkflow,{queueName:Ys.INTERNAL_QUEUE_NAME,enqueueOptions:{deduplicationID:i}})(r,n,...s),Ze.DBOS.retrieveWorkflow(n.startWorkflowParams.workflowID)}catch(o){if(o instanceof Error&&(0,$i.getDBOSErrorCode)(o)===$i.QueueDedupIDDuplicated){let a=await Ze.DBOS.runStep(async()=>await Fm.DBOSExecutor.globalInstance?.systemDatabase.getDeduplicatedWorkflow(Ys.INTERNAL_QUEUE_NAME,i));if(a){let l=await Ze.DBOS.randomUUID(),c={messageID:l,args:s,debouncePeriodMs:r};if(await Ze.DBOS.send(a,c,Ic),!await Ze.DBOS.getEvent(a,l,1e3))continue;let p=(await Ze.DBOS.retrieveWorkflow(a).getWorkflowInputs())[1].startWorkflowParams.workflowID;return Ze.DBOS.retrieveWorkflow(p)}else continue}else throw o}}}};jt.Debouncer=Dc;var Tc=class{client;cfg;constructor(e,r){this.client=e,this.cfg={workflowName:r.workflowName,workflowClassName:r.workflowClassName||"",startWorkflowParams:r.startWorkflowParams,debounceTimeoutMs:r.debounceTimeoutMs}}async debounce(e,r,...s){if(r<=0)throw Error(`debouncePeriodMs must be positive, not ${r}`);let n={...this.cfg};for(n.startWorkflowParams=this.cfg.startWorkflowParams?{...this.cfg.startWorkflowParams}:{},n.startWorkflowParams.workflowID=n.startWorkflowParams.workflowID??String((0,Um.randomUUID)());;){let i=`${n.workflowClassName}.${n.workflowName}-${e}`;try{return await this.client.enqueue({workflowName:Ys.DEBOUNCER_WORKLOW_NAME,queueName:Ys.INTERNAL_QUEUE_NAME,deduplicationID:i},r,n,...s),this.client.retrieveWorkflow(n.startWorkflowParams.workflowID)}catch(o){if(o instanceof Error&&(0,$i.getDBOSErrorCode)(o)===$i.QueueDedupIDDuplicated){let a=await this.client.systemDatabase.getDeduplicatedWorkflow(Ys.INTERNAL_QUEUE_NAME,i);if(a){let l=String((0,Um.randomUUID)()),c={messageID:l,args:s,debouncePeriodMs:r};if(await this.client.send(a,c,Ic),!await this.client.getEvent(a,l,1e3))continue;let p=(await this.client.retrieveWorkflow(a).getWorkflowInputs())[1].startWorkflowParams.workflowID;return this.client.retrieveWorkflow(p)}else continue}else throw o}}}};jt.DebouncerClient=Tc});var lr=w(Y=>{"use strict";var oT=Y&&Y.__createBinding||(Object.create?(function(t,e,r,s){s===void 0&&(s=r);var n=Object.getOwnPropertyDescriptor(e,r);(!n||("get"in n?!e.__esModule:n.writable||n.configurable))&&(n={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,s,n)}):(function(t,e,r,s){s===void 0&&(s=r),t[s]=e[r]})),aT=Y&&Y.__setModuleDefault||(Object.create?(function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}):function(t,e){t.default=e}),lT=Y&&Y.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(t!=null)for(var r in t)r!=="default"&&Object.prototype.hasOwnProperty.call(t,r)&&oT(e,t,r);return aT(e,t),e};Object.defineProperty(Y,"__esModule",{value:!0});Y.DBOSExecutor=Y.TempWorkflowType=Y.OperationType=Y.DBOS_QUEUE_MAX_PRIORITY=Y.DBOS_QUEUE_MIN_PRIORITY=void 0;var ye=He(),ct=Ir(),zm=vh(),et=Ha(),jm=ii(),cT=Rh(),uT=Ii(),Vm=require("node:crypto"),Qe=Ft(),We=Ui(),Cc=Wn(),Re=Oe(),Ce=Ot(),fT=Ks(),Wi=Vs(),Gm=Oi(),dT=Mi(),hT=lT(require("crypto")),Xs=Js(),pT=ki(),mT=Rc(),Zs={};Y.DBOS_QUEUE_MIN_PRIORITY=1;Y.DBOS_QUEUE_MAX_PRIORITY=2**31-1;Y.OperationType={HANDLER:"handler",WORKFLOW:"workflow",TRANSACTION:"transaction",STEP:"step"};Y.TempWorkflowType={step:"step",send:"send"};var Nc=class t{config;initialized;systemDatabase;static#e="temp_workflow";telemetryCollector;static defaultNotificationTimeoutSec=60;systemDBSchemaName;logger;ctxLogger;tracer;serializer;#t=void 0;executorID=Re.globalParams.executorID;static globalInstance=void 0;constructor(e,{systemDatabase:r}={}){if(this.config=e,this.systemDBSchemaName=e.systemDatabaseSchemaName,e.telemetry.OTLPExporter){let s=new cT.TelemetryExporter(e.telemetry.OTLPExporter);this.telemetryCollector=new zm.TelemetryCollector(s)}else this.telemetryCollector=new zm.TelemetryCollector;this.logger=new jm.GlobalLogger(this.telemetryCollector,this.config.telemetry.logs,this.appName),this.ctxLogger=new jm.DBOSContextualLogger(this.logger,()=>(0,et.getActiveSpan)()),this.tracer=new et.Tracer(this.telemetryCollector,this.appName),this.serializer=e.serializer,r?(this.logger.debug("Using provided system database"),this.systemDatabase=r):(this.logger.debug("Using Postgres system database"),this.systemDatabase=new uT.PostgresSystemDatabase(this.config.systemDatabaseUrl,this.logger,this.serializer,this.config.sysDbPoolSize,this.config.systemDatabasePool,this.systemDBSchemaName)),new dT.ScheduledReceiver,this.initialized=!1,t.globalInstance=this}get appName(){return this.config.name}async init(){if(this.initialized){this.logger.error("Workflow executor already initialized!");return}try{await this.systemDatabase.init()}catch(r){if(r instanceof ye.DBOSInitializationError)throw r;this.logger.error(r);let s="Failed to initialize workflow executor: ";if(r instanceof AggregateError)for(let n of r.errors)s+=`${n.message}; `;else r instanceof Error?s+=r.message:s+=String(r);throw new ye.DBOSInitializationError(s,r instanceof Error?r:void 0)}this.initialized=!0,Re.globalParams.appVersion===""&&(Re.globalParams.appVersion=this.computeAppVersion(),Re.globalParams.wasComputed=!0);let e=(0,Qe.getAllRegisteredClassNames)();for(let r of e){let s=(0,Qe.getClassRegistrationByName)(r);for(let[n,i]of s.configuredInstances)await i.initialize()}this.logger.info(`Initializing DBOS (v${Re.globalParams.dbosVersion})`),this.logger.info(`System Database URL: ${(0,pT.maskDatabaseUrl)(this.config.systemDatabaseUrl)}`),this.logger.info(`Executor ID: ${this.executorID}`),this.logger.info(`Application version: ${Re.globalParams.appVersion}`),await this.recoverPendingWorkflows([this.executorID]),this.logger.info("DBOS launched!")}async destroy(){try{await this.systemDatabase.awaitRunningWorkflows(),await this.systemDatabase.destroy(),await this.logger.destroy()}catch(e){let r=e;throw this.logger.error(r),e}}#r(e){return{methReg:(0,Qe.getFunctionRegistrationByName)(e.workflowClassName,e.workflowName),configuredInst:(0,Qe.getConfiguredInstance)(e.workflowClassName,e.workflowConfigName)}}static reviveResultOrError(e,r){if(e.error)throw(0,Ce.deserializeResError)(e.error,e.serialization??null,r);return(0,Ce.deserializeValue)(e.output??null,e.serialization??null,r)}async workflow(e,r,...s){return this.internalWorkflow(e,r,void 0,void 0,...s)}async internalWorkflow(e,r,s,n,...i){let o=r.workflowUUID?r.workflowUUID:(0,Vm.randomUUID)(),a=!!r.workflowUUID,l=r.timeoutMS??void 0,c=r.timeoutMS?r.queueName?void 0:Date.now()+r.timeoutMS:r.deadlineEpochMS,u=r?.enqueueOptions?.priority;if(u!==void 0&&(u<Y.DBOS_QUEUE_MIN_PRIORITY||u>Y.DBOS_QUEUE_MAX_PRIORITY))throw new ye.DBOSInvalidQueuePriorityError(u,Y.DBOS_QUEUE_MIN_PRIORITY,Y.DBOS_QUEUE_MAX_PRIORITY);if(r.queueName&&!this.getQueueByName(r.queueName).priorityEnabled&&u!==void 0)throw Error(`Priority is not enabled for queue ${r.queueName}. Setting priority will not have any effect.`);let f={...(0,We.getCurrentContextStore)()},d={},p=(0,Qe.getFunctionRegistration)(e),m=(0,Qe.getRegisteredFunctionFullName)(e),h=m.name,g=m.className,y=t.#e===h||!!r.tempWfType;if(y)r.tempWfName&&(h=r.tempWfName,g=r.tempWfClass??"");else{if(!p||!p.workflowConfig)throw new ye.DBOSNotRegisteredError(e.name);d=p.workflowConfig}let E=d.maxRecoveryAttempts?d.maxRecoveryAttempts:ct.DEFAULT_MAX_RECOVERY_ATTEMPTS,b=this.tracer.startSpan(h,{status:ct.StatusString.PENDING,operationUUID:o,operationType:Y.OperationType.WORKFLOW,operationName:p?.name??e.name,authenticatedUser:f?.authenticatedUser??"",authenticatedRoles:f?.authenticatedRoles??[],assumedRole:f?.assumedRole??""}),v=p?.workflowConfig?.serialization,I=(0,Ce.serializeFunctionInputOutput)(v==="portable"?{positionalArgs:i}:i,[h,"<arguments>"],this.serializer,v);i=v==="portable"?I.deserialized.positionalArgs:I.deserialized;let S={workflowUUID:o,status:r.queueName!==void 0?ct.StatusString.ENQUEUED:ct.StatusString.PENDING,workflowName:h,workflowClassName:g,workflowConfigName:r.configuredInstance?.name||"",queueName:r.queueName,output:null,error:null,authenticatedUser:f?.authenticatedUser||"",assumedRole:f?.assumedRole||"",authenticatedRoles:f?.authenticatedRoles||[],request:f?.request||{},executorId:Re.globalParams.executorID,applicationVersion:Re.globalParams.appVersion,applicationID:Re.globalParams.appID,createdAt:Date.now(),timeoutMS:l,deadlineEpochMS:c,input:I.stringified,deduplicationID:r.enqueueOptions?.deduplicationID,priority:u??0,queuePartitionKey:r.enqueueOptions?.queuePartitionKey,parentWorkflowID:s,serialization:I.sername};y&&(S.workflowName=`${t.#e}-${r.tempWfType}-${r.tempWfName}`);let L,x;if(n!==void 0&&s!==void 0){let ee=await this.systemDatabase.getOperationResultAndThrowIfCancelled(s,n);if(ee){if(ee.error)throw(0,Ce.deserializeResError)(ee.error,ee.serialization??null,this.serializer);return new ct.RetrievedHandle(this.systemDatabase,ee.childWorkflowID)}}let V;try{V=await this.systemDatabase.initWorkflowStatus(S,(0,Vm.randomUUID)(),{maxRetries:E,isDequeuedRequest:r.isQueueDispatch,isRecoveryRequest:r.isRecoveryDispatch}),v=V.serialization===Ce.DBOSPortableJSON.name()?"portable":void 0}catch(ee){if(ee instanceof ye.DBOSQueueDuplicatedError&&s&&n){let ue=(0,Ce.serializeResError)(ee,this.serializer,void 0);await this.systemDatabase.recordOperationResult(s,n,S.workflowName,!0,Date.now(),{error:ue.serializedValue,serialization:ue.serialization})}throw ee}n!==void 0&&s!==void 0&&await this.systemDatabase.recordOperationResult(s,n,S.workflowName,!0,Date.now(),{childWorkflowID:o}),L=V.deadlineEpochMS,x=V.shouldExecuteOnThisExecutor,await(0,Gm.debugTriggerPoint)(Gm.DEBUG_TRIGGER_WORKFLOW_ENQUEUE);async function ve(ee,ue,G){let ot,Ss={},sa=new Promise((nr,$n)=>{ot=setTimeout($n,ue-Date.now(),Ss)});try{return await Promise.race([ee,sa])}catch(nr){throw nr===Ss?(await G.cancelWorkflow(o),await ee.catch(()=>{}),new ye.DBOSWorkflowCancelledError(o)):nr}finally{clearTimeout(ot)}}let K=this.serializer;async function re(ee,ue){let G=ee;ue.logger.error(G),G.dbos_already_logged=!0;let ot=(0,Ce.serializeResErrorWithSerializer)(G,K,V.serialization??null);return S.error=ot.serializedValue,S.status=ct.StatusString.ERROR,await ue.systemDatabase.recordWorkflowError(o,S),b.setStatus({code:et.SpanStatusCode.ERROR,message:G.message}),(0,Ce.deserializeResError)(ot.serializedValue,ot.serialization,K)}let Bn=async()=>{let ee;try{ee=await(0,et.runWithTrace)(b,async()=>await(0,We.runWithParentContext)(f,{presetID:a,workflowTimeoutMS:void 0,deadlineEpochMS:c,workflowId:o,logger:this.ctxLogger,curWFFunctionId:void 0,serializationType:v},()=>{let ot=e.call(r.configuredInstance,...i);return L===void 0?ot:ve(ot,L,this.systemDatabase)}));let G=(0,Ce.serializeFunctionInputOutputWithSerializer)(ee,[h,"<result>"],this.serializer,V.serialization);ee=G.deserialized,S.output=G.stringified,S.status=ct.StatusString.SUCCESS,await this.systemDatabase.recordWorkflowOutput(o,S),b.setStatus({code:et.SpanStatusCode.OK})}catch(ue){if(ue instanceof ye.DBOSWorkflowConflictError)ee=await this.retrieveWorkflow(o).getResult(),b.setAttribute("cached",!0),b.setStatus({code:et.SpanStatusCode.OK});else if(ue instanceof ye.DBOSWorkflowCancelledError){if(b.setStatus({code:et.SpanStatusCode.ERROR,message:ue.message}),S.error=ue.message,ue.workflowID===o)throw S.status=ct.StatusString.CANCELLED,ue;{let G=new ye.DBOSAwaitedWorkflowCancelledError(ue.workflowID);throw await re(G,this),G}}else throw v==="portable"?await re(ue,this):(await re(ue,this),ue)}finally{this.tracer.endSpan(b)}return ee};if(x&&(r.queueName===void 0||r.executeWorkflow)&&!this.systemDatabase.checkForRunningWorkflow(o)){let ee=Bn();return this.systemDatabase.registerRunningWorkflow(o,ee),new ct.InvokedHandle(this.systemDatabase,ee,o,e.name)}else return new ct.RetrievedHandle(this.systemDatabase,o)}getQueueByName(e){let r=Wi.wfQueueRunner.wfQueuesByName.get(e);if(!r)throw new ye.DBOSNotRegisteredError(e,`Workflow queue '${e}' is not defined.`);return r}async runStepTempWF(e,r,...s){return await(await this.startStepTempWF(e,r,void 0,void 0,...s)).getResult()}async startStepTempWF(e,r,s,n,...i){let o=async(...a)=>await this.callStepFunction(e,void 0,void 0,r.configuredInstance??null,...a);return await this.internalWorkflow(o,{...r,tempWfType:Y.TempWorkflowType.step,tempWfName:(0,Qe.getRegisteredFunctionName)(e),tempWfClass:(0,Qe.getRegisteredFunctionClassName)(e)},s,n,...i)}async callStepFunction(e,r,s,n,...i){r=r??e.name??"<unnamed>";let o=Date.now();if(s||(s=(0,Qe.getFunctionRegistration)(e)?.stepConfig),s===void 0)throw new ye.DBOSNotRegisteredError(r);let a=(0,We.functionIDGetIncrement)(),l={...(0,We.getCurrentContextStore)()},c=l.workflowId;await this.systemDatabase.checkIfCanceled(c);let u=3600,f=this.tracer.startSpan(r,{operationUUID:c,operationType:Y.OperationType.STEP,operationName:r,authenticatedUser:l.authenticatedUser??"",assumedRole:l.assumedRole??"",authenticatedRoles:l.authenticatedRoles??[],retriesAllowed:s.retriesAllowed,intervalSeconds:s.intervalSeconds,maxAttempts:s.maxAttempts,backoffRate:s.backoffRate}),d=await this.systemDatabase.getOperationResultAndThrowIfCancelled(c,a);if(d){if(d.functionName!==r)throw new ye.DBOSUnexpectedStepError(c,a,r,d.functionName??"?");let y=t.reviveResultOrError(d,this.serializer);return f.setAttribute("cached",!0),f.setStatus({code:et.SpanStatusCode.OK}),this.tracer.endSpan(f),y}let p=s.maxAttempts??3,m=Zs,h=Zs,g=[];if(s.retriesAllowed){let y=0,E=s.intervalSeconds??1;for(E>u&&this.logger.warn(`Step config interval exceeds maximum allowed interval, capped to ${u} seconds!`);m===Zs&&y++<(p??3);)try{await this.systemDatabase.checkIfCanceled(c);let b;await(0,et.runWithTrace)(f,async()=>{await(0,We.runInStepContext)(l,a,p,y,async()=>{b=await e.call(n,...i)})}),m=b}catch(b){let v=b;g.push(v),this.logger.warn(`Error in step being automatically retried. Attempt ${y} of ${p}. ${v.stack}`),f.addEvent(`Step attempt ${y+1} failed`,{retryIntervalSeconds:E,error:b.message},performance.now()),y<p&&(await(0,Re.sleepms)(E*1e3),E*=s.backoffRate??2,E=E<u?E:u)}}else try{let y;await(0,et.runWithTrace)(f,async()=>{await(0,We.runInStepContext)(l,a,p,void 0,async()=>{y=await e.call(n,...i)})}),m=y}catch(y){h=y}if(m===Zs)throw h=h===Zs?new ye.DBOSMaxStepRetriesError(r,p,g):h,await this.systemDatabase.recordOperationResult(c,a,r,!0,o,{error:this.serializer.stringify((0,Cc.serializeError)(h)),serialization:this.serializer.name()}),f.setStatus({code:et.SpanStatusCode.ERROR,message:h.message}),this.tracer.endSpan(f),h;{let y=(0,Ce.serializeFunctionInputOutput)(m,[r,"<result>"],this.serializer);return await this.systemDatabase.recordOperationResult(c,a,r,!0,o,{output:y.stringified,serialization:y.sername}),f.setStatus({code:et.SpanStatusCode.OK}),this.tracer.endSpan(f),y.deserialized}}async runSendTempWF(e,r,s,n,i){let o=async(l,c,u,f)=>{let d=(0,We.getCurrentContextStore)(),p=(0,We.functionIDGetIncrement)(),m=(0,Ce.serializeValue)(c,this.serializer,f??void 0);await this.systemDatabase.send(d.workflowId,p,l,m.serializedValue,u,m.serialization)},a=n?e+n:void 0;return(await this.workflow(o,{workflowUUID:a,tempWfType:Y.TempWorkflowType.send,configuredInstance:null},e,r,s,i)).getResult()}async getEvent(e,r,s=t.defaultNotificationTimeoutSec){let n=await this.systemDatabase.getEvent(e,r,s);return(0,Ce.deserializeValue)(n.serializedValue,n.serialization,this.serializer)}forkWorkflow(e,r,s={}){let n=s.newWorkflowID??(0,We.getNextWFID)(void 0);return(0,Xs.forkWorkflow)(this.systemDatabase,e,r,{...s,newWorkflowID:n})}retrieveWorkflow(e){return new ct.RetrievedHandle(this.systemDatabase,e)}async runInternalStep(e,r,s,n,i){let o=Date.now(),a=await this.systemDatabase.getOperationResultAndThrowIfCancelled(s,n);if(a){if(a.functionName!==r)throw new ye.DBOSUnexpectedStepError(s,n,r,a.functionName);return t.reviveResultOrError(a,this.serializer)}try{let l=await e(),c=(0,Ce.serializeFunctionInputOutput)(l,[r,"<result>"],this.serializer);return await this.systemDatabase.recordOperationResult(s,n,r,!0,o,{output:c.stringified,childWorkflowID:i}),c.deserialized}catch(l){throw await this.systemDatabase.recordOperationResult(s,n,r,!1,o,{error:this.serializer.stringify((0,Cc.serializeError)(l)),childWorkflowID:i}),l}}async getWorkflowStatus(e,r,s){let n=await this.systemDatabase.getWorkflowStatus(e,r,s);return n?(0,Xs.toWorkflowStatus)(n,this.serializer):null}async listWorkflows(e){return(0,Xs.listWorkflows)(this.systemDatabase,e)}async listQueuedWorkflows(e){return(0,Xs.listQueuedWorkflows)(this.systemDatabase,e)}async listWorkflowSteps(e){return(0,Xs.listWorkflowSteps)(this.systemDatabase,e)}async recoverPendingWorkflows(e=["local"]){let r=[];for(let s of e){this.logger.debug(`Recovering workflows assigned to executor: ${s}`);let n=await this.systemDatabase.getPendingWorkflows(s,Re.globalParams.appVersion);n.length>0?this.logger.info(`Recovering ${n.length} workflows from application version ${Re.globalParams.appVersion}`):this.logger.info(`No workflows to recover from application version ${Re.globalParams.appVersion}`);for(let i of n){this.logger.debug(`Recovering workflow: ${i.workflowUUID}. Queue name: ${i.queueName}`);try{i.queueName?await this.systemDatabase.clearQueueAssignment(i.workflowUUID)?r.push(this.retrieveWorkflow(i.workflowUUID)):r.push(await this.executeWorkflowId(i.workflowUUID,{isRecoveryDispatch:!0})):r.push(await this.executeWorkflowId(i.workflowUUID,{isRecoveryDispatch:!0}))}catch(o){this.logger.warn(`Recovery of workflow ${i.workflowUUID} failed: ${o.message}`)}}}return r}async initEventReceivers(e){this.#t=Wi.wfQueueRunner.dispatchLoop(this,e);for(let r of(0,Qe.getLifecycleListeners)())await r.initialize?.()}async deactivateEventReceivers(e=!0){this.logger.debug("Deactivating lifecycle listeners");for(let r of(0,Qe.getLifecycleListeners)())try{await r.destroy?.()}catch(s){let n=s;this.logger.warn(`Error destroying lifecycle listener: ${n.message}`)}if(this.logger.debug("Deactivating queue runner"),e)try{Wi.wfQueueRunner.stop(),await this.#t}catch(r){let s=r;this.logger.warn(`Error destroying wf queue runner: ${s.message}`)}}async executeWorkflowId(e,r){let s=await this.systemDatabase.getWorkflowStatus(e);if(!s)throw this.logger.error(`Failed to find workflow status for workflowUUID: ${e}`),new ye.DBOSError(`Failed to find workflow status for workflow UUID: ${e}`);if(!s?.input)throw this.logger.error(`Failed to find inputs for workflowUUID: ${e}`),new ye.DBOSError(`Failed to find inputs for workflow UUID: ${e}`);let n=(0,Ce.deserializePositionalArgs)(s.input,s.serialization,this.serializer),i=this.#s(e,s),{methReg:o,configuredInst:a}=this.#r(s),l=r?.startNewWorkflow?void 0:e;if(o?.workflowConfig)return await(0,We.runWithTopContext)(i,async()=>await this.workflow(o.registeredFunction,{workflowUUID:l,configuredInstance:a,queueName:s.queueName,executeWorkflow:!0,deadlineEpochMS:s.deadlineEpochMS,isRecoveryDispatch:!!r?.isRecoveryDispatch,isQueueDispatch:!!r?.isQueueDispatch},...n));let c=s.workflowName,u=c.split("-");if(!u[0].startsWith(t.#e))throw new ye.DBOSError(`Cannot find workflow function for a non-temporary workflow, ID ${e}, class '${s.workflowClassName}', function '${c}'; did you change your code?`);if(u[1]===Y.TempWorkflowType.step){let f=(0,Qe.getFunctionRegistrationByName)(s.workflowClassName,u[2]);if(!f?.stepConfig)throw this.logger.error(`Cannot find step info for ID ${e}, name ${u[2]}`),new ye.DBOSNotRegisteredError(u[2]);return await(0,We.runWithTopContext)(i,async()=>await this.startStepTempWF(f.registeredFunction,{workflowUUID:l,configuredInstance:a,queueName:s.queueName,executeWorkflow:!0,isRecoveryDispatch:!!r?.isRecoveryDispatch,isQueueDispatch:!!r?.isQueueDispatch},void 0,void 0,...n))}else if(u[1]===Y.TempWorkflowType.send){let d=async(p,m,h,g)=>{let y=(0,We.getCurrentContextStore)(),E=(0,We.functionIDGetIncrement)(),b=(0,Ce.serializeValue)(m,this.serializer,g??void 0);await this.systemDatabase.send(y.workflowId,E,p,b.serializedValue,h,b.serialization)};return await(0,We.runWithTopContext)(i,async()=>this.workflow(d,{tempWfName:u[2],tempWfType:Y.TempWorkflowType.send,workflowUUID:l,queueName:s.queueName,executeWorkflow:!0,isRecoveryDispatch:!!r?.isRecoveryDispatch,isQueueDispatch:!!r?.isQueueDispatch},...n))}else throw this.logger.error(`Unrecognized temporary workflow! UUID ${e}, name ${c}`),new ye.DBOSNotRegisteredError(c)}async getEventDispatchState(e,r,s){return await this.systemDatabase.getEventDispatchState(e,r,s)}async upsertEventDispatchState(e){return await this.systemDatabase.upsertEventDispatchState(e)}#s(e,r){let s={};return s.request=r.request,s.authenticatedUser=r.authenticatedUser,s.authenticatedRoles=r.authenticatedRoles,s.assumedRole=r.assumedRole,s.serializationType=r.serialization===Ce.DBOSPortableJSON.name()?"portable":void 0,s}async cancelWorkflow(e){await this.systemDatabase.cancelWorkflow(e),this.logger.info(`Cancelling workflow ${e}`)}async getWorkflowSteps(e){return(await this.systemDatabase.getAllOperationResults(e)).map(s=>({function_id:s.function_id,function_name:s.function_name??"<unknown>",child_workflow_id:s.child_workflow_id,output:s.output!==null?this.serializer.parse(s.output):null,error:s.error!==null?(0,Cc.deserializeError)(this.serializer.parse(s.error)):null}))}async resumeWorkflow(e){await this.systemDatabase.resumeWorkflow(e)}async deleteWorkflow(e,r=!1){await this.systemDatabase.deleteWorkflow(e,r),this.logger.info(`Deleted workflow ${e}${r?" and its children":""}`)}computeAppVersion(){let e=hT.createHash("md5"),r=Array.from((0,Qe.getAllRegisteredFunctions)()).filter(s=>s.workflowConfig).map(s=>s.origFunction.toString()).sort();r.push(Re.globalParams.dbosVersion);for(let s of r)e.update(s);return e.digest("hex")}static internalQueue=void 0;static createInternalQueue(){t.internalQueue===void 0&&(t.internalQueue=new Wi.WorkflowQueue(Re.INTERNAL_QUEUE_NAME,{}))}static debouncerWorkflow=void 0;static createDebouncerWorkflow(){t.debouncerWorkflow===void 0&&(t.debouncerWorkflow=fT.DBOS.registerWorkflow(mT.debouncerWorkflowFunction,{name:Re.DEBOUNCER_WORKLOW_NAME}))}};Y.DBOSExecutor=Nc});var Ui=w(me=>{"use strict";Object.defineProperty(me,"__esModule",{value:!0});me.runInStepContext=me.runWithDataSourceContext=me.runWithParentContext=me.runWithTopContext=me.functionIDGet=me.functionIDGetIncrement=me.getNextWFID=me.getCurrentContextStore=me.isInWorkflowCtx=void 0;var wT=require("async_hooks"),Hr=He(),Qm=lr();function gT(t){return t.workflowId!==void 0}function yT(t){return t.workflowId===void 0?!1:!!t.curStepFunctionId}function _T(t){return t.workflowId===void 0?!1:!!t.curTxFunctionId}function Fi(t){return!(!gT(t)||yT(t)||_T(t))}me.isInWorkflowCtx=Fi;var zi=new wT.AsyncLocalStorage;function en(){return zi.getStore()}me.getCurrentContextStore=en;function ST(t){let e=t;if(!e){let r=en(),s=r?.idAssignedForNextWorkflow;s&&(e=s,r.idAssignedForNextWorkflow=void 0)}return e}me.getNextWFID=ST;function ET(){let t=en();if(!t)throw new Hr.DBOSInvalidWorkflowTransitionError("Attempt to get a call ID number outside of a workflow");if(!Fi(t))throw new Hr.DBOSInvalidWorkflowTransitionError("Attempt to get a call ID number in a workflow that is already in a call");return t.curWFFunctionId===void 0&&(t.curWFFunctionId=0),t.curWFFunctionId++}me.functionIDGetIncrement=ET;function bT(){let t=en();if(!t)throw new Hr.DBOSInvalidWorkflowTransitionError("Attempt to get a call ID number outside of a workflow");if(!Fi(t))throw new Hr.DBOSInvalidWorkflowTransitionError("Attempt to get a call ID number in a workflow that is already in a call");return t.curWFFunctionId===void 0&&(t.curWFFunctionId=0),t.curWFFunctionId}me.functionIDGet=bT;async function kT(t,e){return await zi.run(t,e)}me.runWithTopContext=kT;async function Km(t,e,r){return await zi.run({...t,...e,parentCtx:t},r)}me.runWithParentContext=Km;async function vT(t,e){let r=en()??{};return await zi.run({...r,curTxFunctionId:t,parentCtx:r,logger:Qm.DBOSExecutor.globalInstance.ctxLogger},e)}me.runWithDataSourceContext=vT;async function OT(t,e,r,s,n){if(!t)throw new Hr.DBOSInvalidWorkflowTransitionError;if(!Fi(t))throw new Hr.DBOSInvalidWorkflowTransitionError;return await Km(t,{stepStatus:{stepID:e,currentAttempt:s,maxAttempts:s?r:void 0},curStepFunctionId:e,parentCtx:t,logger:Qm.DBOSExecutor.globalInstance.ctxLogger},n)}me.runInStepContext=OT});var Q=w(be=>{"use strict";var Ac=Symbol.for("yaml.alias"),Hm=Symbol.for("yaml.document"),ji=Symbol.for("yaml.map"),Jm=Symbol.for("yaml.pair"),Pc=Symbol.for("yaml.scalar"),Vi=Symbol.for("yaml.seq"),Ct=Symbol.for("yaml.node.type"),DT=t=>!!t&&typeof t=="object"&&t[Ct]===Ac,TT=t=>!!t&&typeof t=="object"&&t[Ct]===Hm,IT=t=>!!t&&typeof t=="object"&&t[Ct]===ji,RT=t=>!!t&&typeof t=="object"&&t[Ct]===Jm,Ym=t=>!!t&&typeof t=="object"&&t[Ct]===Pc,CT=t=>!!t&&typeof t=="object"&&t[Ct]===Vi;function Xm(t){if(t&&typeof t=="object")switch(t[Ct]){case ji:case Vi:return!0}return!1}function NT(t){if(t&&typeof t=="object")switch(t[Ct]){case Ac:case ji:case Pc:case Vi:return!0}return!1}var AT=t=>(Ym(t)||Xm(t))&&!!t.anchor;be.ALIAS=Ac;be.DOC=Hm;be.MAP=ji;be.NODE_TYPE=Ct;be.PAIR=Jm;be.SCALAR=Pc;be.SEQ=Vi;be.hasAnchor=AT;be.isAlias=DT;be.isCollection=Xm;be.isDocument=TT;be.isMap=IT;be.isNode=NT;be.isPair=RT;be.isScalar=Ym;be.isSeq=CT});var tn=w(Lc=>{"use strict";var _e=Q(),Ue=Symbol("break visit"),Zm=Symbol("skip children"),yt=Symbol("remove node");function Gi(t,e){let r=ew(e);_e.isDocument(t)?Jr(null,t.contents,r,Object.freeze([t]))===yt&&(t.contents=null):Jr(null,t,r,Object.freeze([]))}Gi.BREAK=Ue;Gi.SKIP=Zm;Gi.REMOVE=yt;function Jr(t,e,r,s){let n=tw(t,e,r,s);if(_e.isNode(n)||_e.isPair(n))return rw(t,s,n),Jr(t,n,r,s);if(typeof n!="symbol"){if(_e.isCollection(e)){s=Object.freeze(s.concat(e));for(let i=0;i<e.items.length;++i){let o=Jr(i,e.items[i],r,s);if(typeof o=="number")i=o-1;else{if(o===Ue)return Ue;o===yt&&(e.items.splice(i,1),i-=1)}}}else if(_e.isPair(e)){s=Object.freeze(s.concat(e));let i=Jr("key",e.key,r,s);if(i===Ue)return Ue;i===yt&&(e.key=null);let o=Jr("value",e.value,r,s);if(o===Ue)return Ue;o===yt&&(e.value=null)}}return n}async function Qi(t,e){let r=ew(e);_e.isDocument(t)?await Yr(null,t.contents,r,Object.freeze([t]))===yt&&(t.contents=null):await Yr(null,t,r,Object.freeze([]))}Qi.BREAK=Ue;Qi.SKIP=Zm;Qi.REMOVE=yt;async function Yr(t,e,r,s){let n=await tw(t,e,r,s);if(_e.isNode(n)||_e.isPair(n))return rw(t,s,n),Yr(t,n,r,s);if(typeof n!="symbol"){if(_e.isCollection(e)){s=Object.freeze(s.concat(e));for(let i=0;i<e.items.length;++i){let o=await Yr(i,e.items[i],r,s);if(typeof o=="number")i=o-1;else{if(o===Ue)return Ue;o===yt&&(e.items.splice(i,1),i-=1)}}}else if(_e.isPair(e)){s=Object.freeze(s.concat(e));let i=await Yr("key",e.key,r,s);if(i===Ue)return Ue;i===yt&&(e.key=null);let o=await Yr("value",e.value,r,s);if(o===Ue)return Ue;o===yt&&(e.value=null)}}return n}function ew(t){return typeof t=="object"&&(t.Collection||t.Node||t.Value)?Object.assign({Alias:t.Node,Map:t.Node,Scalar:t.Node,Seq:t.Node},t.Value&&{Map:t.Value,Scalar:t.Value,Seq:t.Value},t.Collection&&{Map:t.Collection,Seq:t.Collection},t):t}function tw(t,e,r,s){if(typeof r=="function")return r(t,e,s);if(_e.isMap(e))return r.Map?.(t,e,s);if(_e.isSeq(e))return r.Seq?.(t,e,s);if(_e.isPair(e))return r.Pair?.(t,e,s);if(_e.isScalar(e))return r.Scalar?.(t,e,s);if(_e.isAlias(e))return r.Alias?.(t,e,s)}function rw(t,e,r){let s=e[e.length-1];if(_e.isCollection(s))s.items[t]=r;else if(_e.isPair(s))t==="key"?s.key=r:s.value=r;else if(_e.isDocument(s))s.contents=r;else{let n=_e.isAlias(s)?"alias":"scalar";throw new Error(`Cannot replace node with ${n} parent`)}}Lc.visit=Gi;Lc.visitAsync=Qi});var xc=w(nw=>{"use strict";var sw=Q(),PT=tn(),LT={"!":"%21",",":"%2C","[":"%5B","]":"%5D","{":"%7B","}":"%7D"},xT=t=>t.replace(/[!,[\]{}]/g,e=>LT[e]),rn=class t{constructor(e,r){this.docStart=null,this.docEnd=!1,this.yaml=Object.assign({},t.defaultYaml,e),this.tags=Object.assign({},t.defaultTags,r)}clone(){let e=new t(this.yaml,this.tags);return e.docStart=this.docStart,e}atDocument(){let e=new t(this.yaml,this.tags);switch(this.yaml.version){case"1.1":this.atNextDocument=!0;break;case"1.2":this.atNextDocument=!1,this.yaml={explicit:t.defaultYaml.explicit,version:"1.2"},this.tags=Object.assign({},t.defaultTags);break}return e}add(e,r){this.atNextDocument&&(this.yaml={explicit:t.defaultYaml.explicit,version:"1.1"},this.tags=Object.assign({},t.defaultTags),this.atNextDocument=!1);let s=e.trim().split(/[ \t]+/),n=s.shift();switch(n){case"%TAG":{if(s.length!==2&&(r(0,"%TAG directive should contain exactly two parts"),s.length<2))return!1;let[i,o]=s;return this.tags[i]=o,!0}case"%YAML":{if(this.yaml.explicit=!0,s.length!==1)return r(0,"%YAML directive should contain exactly one part"),!1;let[i]=s;if(i==="1.1"||i==="1.2")return this.yaml.version=i,!0;{let o=/^\d+\.\d+$/.test(i);return r(6,`Unsupported YAML version ${i}`,o),!1}}default:return r(0,`Unknown directive ${n}`,!0),!1}}tagName(e,r){if(e==="!")return"!";if(e[0]!=="!")return r(`Not a valid tag: ${e}`),null;if(e[1]==="<"){let o=e.slice(2,-1);return o==="!"||o==="!!"?(r(`Verbatim tags aren't resolved, so ${e} is invalid.`),null):(e[e.length-1]!==">"&&r("Verbatim tags must end with a >"),o)}let[,s,n]=e.match(/^(.*!)([^!]*)$/s);n||r(`The ${e} tag has no suffix`);let i=this.tags[s];if(i)try{return i+decodeURIComponent(n)}catch(o){return r(String(o)),null}return s==="!"?e:(r(`Could not resolve tag: ${e}`),null)}tagString(e){for(let[r,s]of Object.entries(this.tags))if(e.startsWith(s))return r+xT(e.substring(s.length));return e[0]==="!"?e:`!<${e}>`}toString(e){let r=this.yaml.explicit?[`%YAML ${this.yaml.version||"1.2"}`]:[],s=Object.entries(this.tags),n;if(e&&s.length>0&&sw.isNode(e.contents)){let i={};PT.visit(e.contents,(o,a)=>{sw.isNode(a)&&a.tag&&(i[a.tag]=!0)}),n=Object.keys(i)}else n=[];for(let[i,o]of s)i==="!!"&&o==="tag:yaml.org,2002:"||(!e||n.some(a=>a.startsWith(o)))&&r.push(`%TAG ${i} ${o}`);return r.join(`
`)}};rn.defaultYaml={explicit:!1,version:"1.2"};rn.defaultTags={"!!":"tag:yaml.org,2002:"};nw.Directives=rn});var Ki=w(sn=>{"use strict";var iw=Q(),qT=tn();function MT(t){if(/[\x00-\x19\s,[\]{}]/.test(t)){let r=`Anchor must not contain whitespace or control characters: ${JSON.stringify(t)}`;throw new Error(r)}return!0}function ow(t){let e=new Set;return qT.visit(t,{Value(r,s){s.anchor&&e.add(s.anchor)}}),e}function aw(t,e){for(let r=1;;++r){let s=`${t}${r}`;if(!e.has(s))return s}}function BT(t,e){let r=[],s=new Map,n=null;return{onAnchor:i=>{r.push(i),n||(n=ow(t));let o=aw(e,n);return n.add(o),o},setAnchors:()=>{for(let i of r){let o=s.get(i);if(typeof o=="object"&&o.anchor&&(iw.isScalar(o.node)||iw.isCollection(o.node)))o.node.anchor=o.anchor;else{let a=new Error("Failed to resolve repeated object (this should not happen)");throw a.source=i,a}}},sourceObjects:s}}sn.anchorIsValid=MT;sn.anchorNames=ow;sn.createNodeAnchors=BT;sn.findNewAnchor=aw});var qc=w(lw=>{"use strict";function nn(t,e,r,s){if(s&&typeof s=="object")if(Array.isArray(s))for(let n=0,i=s.length;n<i;++n){let o=s[n],a=nn(t,s,String(n),o);a===void 0?delete s[n]:a!==o&&(s[n]=a)}else if(s instanceof Map)for(let n of Array.from(s.keys())){let i=s.get(n),o=nn(t,s,n,i);o===void 0?s.delete(n):o!==i&&s.set(n,o)}else if(s instanceof Set)for(let n of Array.from(s)){let i=nn(t,s,n,n);i===void 0?s.delete(n):i!==n&&(s.delete(n),s.add(i))}else for(let[n,i]of Object.entries(s)){let o=nn(t,s,n,i);o===void 0?delete s[n]:o!==i&&(s[n]=o)}return t.call(e,r,s)}lw.applyReviver=nn});var Vt=w(uw=>{"use strict";var $T=Q();function cw(t,e,r){if(Array.isArray(t))return t.map((s,n)=>cw(s,String(n),r));if(t&&typeof t.toJSON=="function"){if(!r||!$T.hasAnchor(t))return t.toJSON(e,r);let s={aliasCount:0,count:1,res:void 0};r.anchors.set(t,s),r.onCreate=i=>{s.res=i,delete r.onCreate};let n=t.toJSON(e,r);return r.onCreate&&r.onCreate(n),n}return typeof t=="bigint"&&!r?.keep?Number(t):t}uw.toJS=cw});var Hi=w(dw=>{"use strict";var WT=qc(),fw=Q(),UT=Vt(),Mc=class{constructor(e){Object.defineProperty(this,fw.NODE_TYPE,{value:e})}clone(){let e=Object.create(Object.getPrototypeOf(this),Object.getOwnPropertyDescriptors(this));return this.range&&(e.range=this.range.slice()),e}toJS(e,{mapAsMap:r,maxAliasCount:s,onAnchor:n,reviver:i}={}){if(!fw.isDocument(e))throw new TypeError("A document argument is required");let o={anchors:new Map,doc:e,keep:!0,mapAsMap:r===!0,mapKeyWarned:!1,maxAliasCount:typeof s=="number"?s:100},a=UT.toJS(this,"",o);if(typeof n=="function")for(let{count:l,res:c}of o.anchors.values())n(c,l);return typeof i=="function"?WT.applyReviver(i,{"":a},"",a):a}};dw.NodeBase=Mc});var on=w(pw=>{"use strict";var FT=Ki(),hw=tn(),Ji=Q(),zT=Hi(),jT=Vt(),Bc=class extends zT.NodeBase{constructor(e){super(Ji.ALIAS),this.source=e,Object.defineProperty(this,"tag",{set(){throw new Error("Alias nodes cannot have tags")}})}resolve(e){let r;return hw.visit(e,{Node:(s,n)=>{if(n===this)return hw.visit.BREAK;n.anchor===this.source&&(r=n)}}),r}toJSON(e,r){if(!r)return{source:this.source};let{anchors:s,doc:n,maxAliasCount:i}=r,o=this.resolve(n);if(!o){let l=`Unresolved alias (the anchor must be set before the alias): ${this.source}`;throw new ReferenceError(l)}let a=s.get(o);if(a||(jT.toJS(o,null,r),a=s.get(o)),!a||a.res===void 0){let l="This should not happen: Alias anchor was not resolved?";throw new ReferenceError(l)}if(i>=0&&(a.count+=1,a.aliasCount===0&&(a.aliasCount=Yi(n,o,s)),a.count*a.aliasCount>i)){let l="Excessive alias count indicates a resource exhaustion attack";throw new ReferenceError(l)}return a.res}toString(e,r,s){let n=`*${this.source}`;if(e){if(FT.anchorIsValid(this.source),e.options.verifyAliasOrder&&!e.anchors.has(this.source)){let i=`Unresolved alias (the anchor must be set before the alias): ${this.source}`;throw new Error(i)}if(e.implicitKey)return`${n} `}return n}};function Yi(t,e,r){if(Ji.isAlias(e)){let s=e.resolve(t),n=r&&s&&r.get(s);return n?n.count*n.aliasCount:0}else if(Ji.isCollection(e)){let s=0;for(let n of e.items){let i=Yi(t,n,r);i>s&&(s=i)}return s}else if(Ji.isPair(e)){let s=Yi(t,e.key,r),n=Yi(t,e.value,r);return Math.max(s,n)}return 1}pw.Alias=Bc});var we=w($c=>{"use strict";var VT=Q(),GT=Hi(),QT=Vt(),KT=t=>!t||typeof t!="function"&&typeof t!="object",Gt=class extends GT.NodeBase{constructor(e){super(VT.SCALAR),this.value=e}toJSON(e,r){return r?.keep?this.value:QT.toJS(this.value,e,r)}toString(){return String(this.value)}};Gt.BLOCK_FOLDED="BLOCK_FOLDED";Gt.BLOCK_LITERAL="BLOCK_LITERAL";Gt.PLAIN="PLAIN";Gt.QUOTE_DOUBLE="QUOTE_DOUBLE";Gt.QUOTE_SINGLE="QUOTE_SINGLE";$c.Scalar=Gt;$c.isScalarValue=KT});var an=w(ww=>{"use strict";var HT=on(),dr=Q(),mw=we(),JT="tag:yaml.org,2002:";function YT(t,e,r){if(e){let s=r.filter(i=>i.tag===e),n=s.find(i=>!i.format)??s[0];if(!n)throw new Error(`Tag ${e} not found`);return n}return r.find(s=>s.identify?.(t)&&!s.format)}function XT(t,e,r){if(dr.isDocument(t)&&(t=t.contents),dr.isNode(t))return t;if(dr.isPair(t)){let f=r.schema[dr.MAP].createNode?.(r.schema,null,r);return f.items.push(t),f}(t instanceof String||t instanceof Number||t instanceof Boolean||typeof BigInt<"u"&&t instanceof BigInt)&&(t=t.valueOf());let{aliasDuplicateObjects:s,onAnchor:n,onTagObj:i,schema:o,sourceObjects:a}=r,l;if(s&&t&&typeof t=="object"){if(l=a.get(t),l)return l.anchor||(l.anchor=n(t)),new HT.Alias(l.anchor);l={anchor:null,node:null},a.set(t,l)}e?.startsWith("!!")&&(e=JT+e.slice(2));let c=YT(t,e,o.tags);if(!c){if(t&&typeof t.toJSON=="function"&&(t=t.toJSON()),!t||typeof t!="object"){let f=new mw.Scalar(t);return l&&(l.node=f),f}c=t instanceof Map?o[dr.MAP]:Symbol.iterator in Object(t)?o[dr.SEQ]:o[dr.MAP]}i&&(i(c),delete r.onTagObj);let u=c?.createNode?c.createNode(r.schema,t,r):typeof c?.nodeClass?.from=="function"?c.nodeClass.from(r.schema,t,r):new mw.Scalar(t);return e?u.tag=e:c.default||(u.tag=c.tag),l&&(l.node=u),u}ww.createNode=XT});var eo=w(Zi=>{"use strict";var ZT=an(),_t=Q(),eI=Hi();function Wc(t,e,r){let s=r;for(let n=e.length-1;n>=0;--n){let i=e[n];if(typeof i=="number"&&Number.isInteger(i)&&i>=0){let o=[];o[i]=s,s=o}else s=new Map([[i,s]])}return ZT.createNode(s,void 0,{aliasDuplicateObjects:!1,keepUndefined:!1,onAnchor:()=>{throw new Error("This should not happen, please report a bug.")},schema:t,sourceObjects:new Map})}var gw=t=>t==null||typeof t=="object"&&!!t[Symbol.iterator]().next().done,Xi=class extends eI.NodeBase{constructor(e,r){super(e),Object.defineProperty(this,"schema",{value:r,configurable:!0,enumerable:!1,writable:!0})}clone(e){let r=Object.create(Object.getPrototypeOf(this),Object.getOwnPropertyDescriptors(this));return e&&(r.schema=e),r.items=r.items.map(s=>_t.isNode(s)||_t.isPair(s)?s.clone(e):s),this.range&&(r.range=this.range.slice()),r}addIn(e,r){if(gw(e))this.add(r);else{let[s,...n]=e,i=this.get(s,!0);if(_t.isCollection(i))i.addIn(n,r);else if(i===void 0&&this.schema)this.set(s,Wc(this.schema,n,r));else throw new Error(`Expected YAML collection at ${s}. Remaining path: ${n}`)}}deleteIn(e){let[r,...s]=e;if(s.length===0)return this.delete(r);let n=this.get(r,!0);if(_t.isCollection(n))return n.deleteIn(s);throw new Error(`Expected YAML collection at ${r}. Remaining path: ${s}`)}getIn(e,r){let[s,...n]=e,i=this.get(s,!0);return n.length===0?!r&&_t.isScalar(i)?i.value:i:_t.isCollection(i)?i.getIn(n,r):void 0}hasAllNullValues(e){return this.items.every(r=>{if(!_t.isPair(r))return!1;let s=r.value;return s==null||e&&_t.isScalar(s)&&s.value==null&&!s.commentBefore&&!s.comment&&!s.tag})}hasIn(e){let[r,...s]=e;if(s.length===0)return this.has(r);let n=this.get(r,!0);return _t.isCollection(n)?n.hasIn(s):!1}setIn(e,r){let[s,...n]=e;if(n.length===0)this.set(s,r);else{let i=this.get(s,!0);if(_t.isCollection(i))i.setIn(n,r);else if(i===void 0&&this.schema)this.set(s,Wc(this.schema,n,r));else throw new Error(`Expected YAML collection at ${s}. Remaining path: ${n}`)}}};Xi.maxFlowStringSingleLineLength=60;Zi.Collection=Xi;Zi.collectionFromPath=Wc;Zi.isEmptyPath=gw});var ln=w(to=>{"use strict";var tI=t=>t.replace(/^(?!$)(?: $)?/gm,"#");function Uc(t,e){return/^\n+$/.test(t)?t.substring(1):e?t.replace(/^(?! *$)/gm,e):t}var rI=(t,e,r)=>t.endsWith(`
`)?Uc(r,e):r.includes(`
`)?`
`+Uc(r,e):(t.endsWith(" ")?"":" ")+r;to.indentComment=Uc;to.lineComment=rI;to.stringifyComment=tI});var _w=w(cn=>{"use strict";var sI="flow",Fc="block",ro="quoted";function nI(t,e,r="flow",{indentAtStart:s,lineWidth:n=80,minContentWidth:i=20,onFold:o,onOverflow:a}={}){if(!n||n<0)return t;let l=Math.max(1+i,1+n-e.length);if(t.length<=l)return t;let c=[],u={},f=n-e.length;typeof s=="number"&&(s>n-Math.max(2,i)?c.push(0):f=n-s);let d,p,m=!1,h=-1,g=-1,y=-1;r===Fc&&(h=yw(t,h,e.length),h!==-1&&(f=h+l));for(let b;b=t[h+=1];){if(r===ro&&b==="\\"){switch(g=h,t[h+1]){case"x":h+=3;break;case"u":h+=5;break;case"U":h+=9;break;default:h+=1}y=h}if(b===`
`)r===Fc&&(h=yw(t,h,e.length)),f=h+e.length+l,d=void 0;else{if(b===" "&&p&&p!==" "&&p!==`
`&&p!=="	"){let v=t[h+1];v&&v!==" "&&v!==`
`&&v!=="	"&&(d=h)}if(h>=f)if(d)c.push(d),f=d+l,d=void 0;else if(r===ro){for(;p===" "||p==="	";)p=b,b=t[h+=1],m=!0;let v=h>y+1?h-2:g-1;if(u[v])return t;c.push(v),u[v]=!0,f=v+l,d=void 0}else m=!0}p=b}if(m&&a&&a(),c.length===0)return t;o&&o();let E=t.slice(0,c[0]);for(let b=0;b<c.length;++b){let v=c[b],I=c[b+1]||t.length;v===0?E=`
${e}${t.slice(0,I)}`:(r===ro&&u[v]&&(E+=`${t[v]}\\`),E+=`
${e}${t.slice(v+1,I)}`)}return E}function yw(t,e,r){let s=e,n=e+1,i=t[n];for(;i===" "||i==="	";)if(e<n+r)i=t[++e];else{do i=t[++e];while(i&&i!==`
`);s=e,n=e+1,i=t[n]}return s}cn.FOLD_BLOCK=Fc;cn.FOLD_FLOW=sI;cn.FOLD_QUOTED=ro;cn.foldFlowLines=nI});var fn=w(Sw=>{"use strict";var St=we(),Qt=_w(),no=(t,e)=>({indentAtStart:e?t.indent.length:t.indentAtStart,lineWidth:t.options.lineWidth,minContentWidth:t.options.minContentWidth}),io=t=>/^(%|---|\.\.\.)/m.test(t);function iI(t,e,r){if(!e||e<0)return!1;let s=e-r,n=t.length;if(n<=s)return!1;for(let i=0,o=0;i<n;++i)if(t[i]===`
`){if(i-o>s)return!0;if(o=i+1,n-o<=s)return!1}return!0}function un(t,e){let r=JSON.stringify(t);if(e.options.doubleQuotedAsJSON)return r;let{implicitKey:s}=e,n=e.options.doubleQuotedMinMultiLineLength,i=e.indent||(io(t)?"  ":""),o="",a=0;for(let l=0,c=r[l];c;c=r[++l])if(c===" "&&r[l+1]==="\\"&&r[l+2]==="n"&&(o+=r.slice(a,l)+"\\ ",l+=1,a=l,c="\\"),c==="\\")switch(r[l+1]){case"u":{o+=r.slice(a,l);let u=r.substr(l+2,4);switch(u){case"0000":o+="\\0";break;case"0007":o+="\\a";break;case"000b":o+="\\v";break;case"001b":o+="\\e";break;case"0085":o+="\\N";break;case"00a0":o+="\\_";break;case"2028":o+="\\L";break;case"2029":o+="\\P";break;default:u.substr(0,2)==="00"?o+="\\x"+u.substr(2):o+=r.substr(l,6)}l+=5,a=l+1}break;case"n":if(s||r[l+2]==='"'||r.length<n)l+=1;else{for(o+=r.slice(a,l)+`

`;r[l+2]==="\\"&&r[l+3]==="n"&&r[l+4]!=='"';)o+=`
`,l+=2;o+=i,r[l+2]===" "&&(o+="\\"),l+=1,a=l+1}break;default:l+=1}return o=a?o+r.slice(a):r,s?o:Qt.foldFlowLines(o,i,Qt.FOLD_QUOTED,no(e,!1))}function zc(t,e){if(e.options.singleQuote===!1||e.implicitKey&&t.includes(`
`)||/[ \t]\n|\n[ \t]/.test(t))return un(t,e);let r=e.indent||(io(t)?"  ":""),s="'"+t.replace(/'/g,"''").replace(/\n+/g,`$&
${r}`)+"'";return e.implicitKey?s:Qt.foldFlowLines(s,r,Qt.FOLD_FLOW,no(e,!1))}function Xr(t,e){let{singleQuote:r}=e.options,s;if(r===!1)s=un;else{let n=t.includes('"'),i=t.includes("'");n&&!i?s=zc:i&&!n?s=un:s=r?zc:un}return s(t,e)}var jc;try{jc=new RegExp(`(^|(?<!
))
+(?!
|$)`,"g")}catch{jc=/\n+(?!\n|$)/g}function so({comment:t,type:e,value:r},s,n,i){let{blockQuote:o,commentString:a,lineWidth:l}=s.options;if(!o||/\n[\t ]+$/.test(r)||/^\s*$/.test(r))return Xr(r,s);let c=s.indent||(s.forceBlockIndent||io(r)?"  ":""),u=o==="literal"?!0:o==="folded"||e===St.Scalar.BLOCK_FOLDED?!1:e===St.Scalar.BLOCK_LITERAL?!0:!iI(r,l,c.length);if(!r)return u?`|
`:`>
`;let f,d;for(d=r.length;d>0;--d){let S=r[d-1];if(S!==`
`&&S!=="	"&&S!==" ")break}let p=r.substring(d),m=p.indexOf(`
`);m===-1?f="-":r===p||m!==p.length-1?(f="+",i&&i()):f="",p&&(r=r.slice(0,-p.length),p[p.length-1]===`
`&&(p=p.slice(0,-1)),p=p.replace(jc,`$&${c}`));let h=!1,g,y=-1;for(g=0;g<r.length;++g){let S=r[g];if(S===" ")h=!0;else if(S===`
`)y=g;else break}let E=r.substring(0,y<g?y+1:g);E&&(r=r.substring(E.length),E=E.replace(/\n+/g,`$&${c}`));let v=(u?"|":">")+(h?c?"2":"1":"")+f;if(t&&(v+=" "+a(t.replace(/ ?[\r\n]+/g," ")),n&&n()),u)return r=r.replace(/\n+/g,`$&${c}`),`${v}
${c}${E}${r}${p}`;r=r.replace(/\n+/g,`
$&`).replace(/(?:^|\n)([\t ].*)(?:([\n\t ]*)\n(?![\n\t ]))?/g,"$1$2").replace(/\n+/g,`$&${c}`);let I=Qt.foldFlowLines(`${E}${r}${p}`,c,Qt.FOLD_BLOCK,no(s,!0));return`${v}
${c}${I}`}function oI(t,e,r,s){let{type:n,value:i}=t,{actualString:o,implicitKey:a,indent:l,indentStep:c,inFlow:u}=e;if(a&&i.includes(`
`)||u&&/[[\]{},]/.test(i))return Xr(i,e);if(!i||/^[\n\t ,[\]{}#&*!|>'"%@`]|^[?-]$|^[?-][ \t]|[\n:][ \t]|[ \t]\n|[\n\t ]#|[\n\t :]$/.test(i))return a||u||!i.includes(`
`)?Xr(i,e):so(t,e,r,s);if(!a&&!u&&n!==St.Scalar.PLAIN&&i.includes(`
`))return so(t,e,r,s);if(io(i)){if(l==="")return e.forceBlockIndent=!0,so(t,e,r,s);if(a&&l===c)return Xr(i,e)}let f=i.replace(/\n+/g,`$&
${l}`);if(o){let d=h=>h.default&&h.tag!=="tag:yaml.org,2002:str"&&h.test?.test(f),{compat:p,tags:m}=e.doc.schema;if(m.some(d)||p?.some(d))return Xr(i,e)}return a?f:Qt.foldFlowLines(f,l,Qt.FOLD_FLOW,no(e,!1))}function aI(t,e,r,s){let{implicitKey:n,inFlow:i}=e,o=typeof t.value=="string"?t:Object.assign({},t,{value:String(t.value)}),{type:a}=t;a!==St.Scalar.QUOTE_DOUBLE&&/[\x00-\x08\x0b-\x1f\x7f-\x9f\u{D800}-\u{DFFF}]/u.test(o.value)&&(a=St.Scalar.QUOTE_DOUBLE);let l=u=>{switch(u){case St.Scalar.BLOCK_FOLDED:case St.Scalar.BLOCK_LITERAL:return n||i?Xr(o.value,e):so(o,e,r,s);case St.Scalar.QUOTE_DOUBLE:return un(o.value,e);case St.Scalar.QUOTE_SINGLE:return zc(o.value,e);case St.Scalar.PLAIN:return oI(o,e,r,s);default:return null}},c=l(a);if(c===null){let{defaultKeyType:u,defaultStringType:f}=e.options,d=n&&u||f;if(c=l(d),c===null)throw new Error(`Unsupported default string type ${d}`)}return c}Sw.stringifyString=aI});var dn=w(Vc=>{"use strict";var lI=Ki(),Kt=Q(),cI=ln(),uI=fn();function fI(t,e){let r=Object.assign({blockQuote:!0,commentString:cI.stringifyComment,defaultKeyType:null,defaultStringType:"PLAIN",directives:null,doubleQuotedAsJSON:!1,doubleQuotedMinMultiLineLength:40,falseStr:"false",flowCollectionPadding:!0,indentSeq:!0,lineWidth:80,minContentWidth:20,nullStr:"null",simpleKeys:!1,singleQuote:null,trueStr:"true",verifyAliasOrder:!0},t.schema.toStringOptions,e),s;switch(r.collectionStyle){case"block":s=!1;break;case"flow":s=!0;break;default:s=null}return{anchors:new Set,doc:t,flowCollectionPadding:r.flowCollectionPadding?" ":"",indent:"",indentStep:typeof r.indent=="number"?" ".repeat(r.indent):"  ",inFlow:s,options:r}}function dI(t,e){if(e.tag){let n=t.filter(i=>i.tag===e.tag);if(n.length>0)return n.find(i=>i.format===e.format)??n[0]}let r,s;if(Kt.isScalar(e)){s=e.value;let n=t.filter(i=>i.identify?.(s));r=n.find(i=>i.format===e.format)??n.find(i=>!i.format)}else s=e,r=t.find(n=>n.nodeClass&&s instanceof n.nodeClass);if(!r){let n=s?.constructor?.name??typeof s;throw new Error(`Tag not resolved for ${n} value`)}return r}function hI(t,e,{anchors:r,doc:s}){if(!s.directives)return"";let n=[],i=(Kt.isScalar(t)||Kt.isCollection(t))&&t.anchor;i&&lI.anchorIsValid(i)&&(r.add(i),n.push(`&${i}`));let o=t.tag?t.tag:e.default?null:e.tag;return o&&n.push(s.directives.tagString(o)),n.join(" ")}function pI(t,e,r,s){if(Kt.isPair(t))return t.toString(e,r,s);if(Kt.isAlias(t)){if(e.doc.directives)return t.toString(e);if(e.resolvedAliases?.has(t))throw new TypeError("Cannot stringify circular structure without alias nodes");e.resolvedAliases?e.resolvedAliases.add(t):e.resolvedAliases=new Set([t]),t=t.resolve(e.doc)}let n,i=Kt.isNode(t)?t:e.doc.createNode(t,{onTagObj:l=>n=l});n||(n=dI(e.doc.schema.tags,i));let o=hI(i,n,e);o.length>0&&(e.indentAtStart=(e.indentAtStart??0)+o.length+1);let a=typeof n.stringify=="function"?n.stringify(i,e,r,s):Kt.isScalar(i)?uI.stringifyString(i,e,r,s):i.toString(e,r,s);return o?Kt.isScalar(i)||a[0]==="{"||a[0]==="["?`${o} ${a}`:`${o}
${e.indent}${a}`:a}Vc.createStringifyContext=fI;Vc.stringify=pI});var vw=w(kw=>{"use strict";var Ht=Q(),Ew=we(),bw=dn(),hn=ln();function mI({key:t,value:e},r,s,n){let{allNullValues:i,doc:o,indent:a,indentStep:l,options:{commentString:c,indentSeq:u,simpleKeys:f}}=r,d=Ht.isNode(t)&&t.comment||null;if(f){if(d)throw new Error("With simple keys, key nodes cannot have comments");if(Ht.isCollection(t)){let L="With simple keys, collection cannot be used as a key value";throw new Error(L)}}let p=!f&&(!t||d&&e==null&&!r.inFlow||Ht.isCollection(t)||(Ht.isScalar(t)?t.type===Ew.Scalar.BLOCK_FOLDED||t.type===Ew.Scalar.BLOCK_LITERAL:typeof t=="object"));r=Object.assign({},r,{allNullValues:!1,implicitKey:!p&&(f||!i),indent:a+l});let m=!1,h=!1,g=bw.stringify(t,r,()=>m=!0,()=>h=!0);if(!p&&!r.inFlow&&g.length>1024){if(f)throw new Error("With simple keys, single line scalar must not span more than 1024 characters");p=!0}if(r.inFlow){if(i||e==null)return m&&s&&s(),g===""?"?":p?`? ${g}`:g}else if(i&&!f||e==null&&p)return g=`? ${g}`,d&&!m?g+=hn.lineComment(g,r.indent,c(d)):h&&n&&n(),g;m&&(d=null),p?(d&&(g+=hn.lineComment(g,r.indent,c(d))),g=`? ${g}
${a}:`):(g=`${g}:`,d&&(g+=hn.lineComment(g,r.indent,c(d))));let y,E,b;Ht.isNode(e)?(y=!!e.spaceBefore,E=e.commentBefore,b=e.comment):(y=!1,E=null,b=null,e&&typeof e=="object"&&(e=o.createNode(e))),r.implicitKey=!1,!p&&!d&&Ht.isScalar(e)&&(r.indentAtStart=g.length+1),h=!1,!u&&l.length>=2&&!r.inFlow&&!p&&Ht.isSeq(e)&&!e.flow&&!e.tag&&!e.anchor&&(r.indent=r.indent.substring(2));let v=!1,I=bw.stringify(e,r,()=>v=!0,()=>h=!0),S=" ";if(d||y||E){if(S=y?`
`:"",E){let L=c(E);S+=`
${hn.indentComment(L,r.indent)}`}I===""&&!r.inFlow?S===`
`&&(S=`

`):S+=`
${r.indent}`}else if(!p&&Ht.isCollection(e)){let L=I[0],x=I.indexOf(`
`),V=x!==-1,ve=r.inFlow??e.flow??e.items.length===0;if(V||!ve){let K=!1;if(V&&(L==="&"||L==="!")){let re=I.indexOf(" ");L==="&"&&re!==-1&&re<x&&I[re+1]==="!"&&(re=I.indexOf(" ",re+1)),(re===-1||x<re)&&(K=!0)}K||(S=`
${r.indent}`)}}else(I===""||I[0]===`
`)&&(S="");return g+=S+I,r.inFlow?v&&s&&s():b&&!v?g+=hn.lineComment(g,r.indent,c(b)):h&&n&&n(),g}kw.stringifyPair=mI});var Qc=w(Gc=>{"use strict";function wI(t,...e){t==="debug"&&console.log(...e)}function gI(t,e){(t==="debug"||t==="warn")&&(typeof process<"u"&&process.emitWarning?process.emitWarning(e):console.warn(e))}Gc.debug=wI;Gc.warn=gI});var Jc=w(Dw=>{"use strict";var yI=Qc(),_I=dn(),Zr=Q(),SI=we(),Kc=Vt(),Ow="<<";function EI(t,e,{key:r,value:s}){if(t?.doc.schema.merge&&bI(r))if(s=Zr.isAlias(s)?s.resolve(t.doc):s,Zr.isSeq(s))for(let n of s.items)Hc(t,e,n);else if(Array.isArray(s))for(let n of s)Hc(t,e,n);else Hc(t,e,s);else{let n=Kc.toJS(r,"",t);if(e instanceof Map)e.set(n,Kc.toJS(s,n,t));else if(e instanceof Set)e.add(n);else{let i=kI(r,n,t),o=Kc.toJS(s,i,t);i in e?Object.defineProperty(e,i,{value:o,writable:!0,enumerable:!0,configurable:!0}):e[i]=o}}return e}var bI=t=>t===Ow||Zr.isScalar(t)&&t.value===Ow&&(!t.type||t.type===SI.Scalar.PLAIN);function Hc(t,e,r){let s=t&&Zr.isAlias(r)?r.resolve(t.doc):r;if(!Zr.isMap(s))throw new Error("Merge sources must be maps or map aliases");let n=s.toJSON(null,t,Map);for(let[i,o]of n)e instanceof Map?e.has(i)||e.set(i,o):e instanceof Set?e.add(i):Object.prototype.hasOwnProperty.call(e,i)||Object.defineProperty(e,i,{value:o,writable:!0,enumerable:!0,configurable:!0});return e}function kI(t,e,r){if(e===null)return"";if(typeof e!="object")return String(e);if(Zr.isNode(t)&&r?.doc){let s=_I.createStringifyContext(r.doc,{});s.anchors=new Set;for(let i of r.anchors.keys())s.anchors.add(i.anchor);s.inFlow=!0,s.inStringifyKey=!0;let n=t.toString(s);if(!r.mapKeyWarned){let i=JSON.stringify(n);i.length>40&&(i=i.substring(0,36)+'..."'),yI.warn(r.doc.options.logLevel,`Keys with collection values will be stringified due to JS Object restrictions: ${i}. Set mapAsMap: true to use object keys.`),r.mapKeyWarned=!0}return n}return JSON.stringify(e)}Dw.addPairToJSMap=EI});var Jt=w(Yc=>{"use strict";var Tw=an(),vI=vw(),OI=Jc(),oo=Q();function DI(t,e,r){let s=Tw.createNode(t,void 0,r),n=Tw.createNode(e,void 0,r);return new ao(s,n)}var ao=class t{constructor(e,r=null){Object.defineProperty(this,oo.NODE_TYPE,{value:oo.PAIR}),this.key=e,this.value=r}clone(e){let{key:r,value:s}=this;return oo.isNode(r)&&(r=r.clone(e)),oo.isNode(s)&&(s=s.clone(e)),new t(r,s)}toJSON(e,r){let s=r?.mapAsMap?new Map:{};return OI.addPairToJSMap(r,s,this)}toString(e,r,s){return e?.doc?vI.stringifyPair(this,e,r,s):JSON.stringify(this)}};Yc.Pair=ao;Yc.createPair=DI});var Xc=w(Rw=>{"use strict";var hr=Q(),Iw=dn(),lo=ln();function TI(t,e,r){return(e.inFlow??t.flow?RI:II)(t,e,r)}function II({comment:t,items:e},r,{blockItemPrefix:s,flowChars:n,itemIndent:i,onChompKeep:o,onComment:a}){let{indent:l,options:{commentString:c}}=r,u=Object.assign({},r,{indent:i,type:null}),f=!1,d=[];for(let m=0;m<e.length;++m){let h=e[m],g=null;if(hr.isNode(h))!f&&h.spaceBefore&&d.push(""),co(r,d,h.commentBefore,f),h.comment&&(g=h.comment);else if(hr.isPair(h)){let E=hr.isNode(h.key)?h.key:null;E&&(!f&&E.spaceBefore&&d.push(""),co(r,d,E.commentBefore,f))}f=!1;let y=Iw.stringify(h,u,()=>g=null,()=>f=!0);g&&(y+=lo.lineComment(y,i,c(g))),f&&g&&(f=!1),d.push(s+y)}let p;if(d.length===0)p=n.start+n.end;else{p=d[0];for(let m=1;m<d.length;++m){let h=d[m];p+=h?`
${l}${h}`:`
`}}return t?(p+=`
`+lo.indentComment(c(t),l),a&&a()):f&&o&&o(),p}function RI({items:t},e,{flowChars:r,itemIndent:s}){let{indent:n,indentStep:i,flowCollectionPadding:o,options:{commentString:a}}=e;s+=i;let l=Object.assign({},e,{indent:s,inFlow:!0,type:null}),c=!1,u=0,f=[];for(let m=0;m<t.length;++m){let h=t[m],g=null;if(hr.isNode(h))h.spaceBefore&&f.push(""),co(e,f,h.commentBefore,!1),h.comment&&(g=h.comment);else if(hr.isPair(h)){let E=hr.isNode(h.key)?h.key:null;E&&(E.spaceBefore&&f.push(""),co(e,f,E.commentBefore,!1),E.comment&&(c=!0));let b=hr.isNode(h.value)?h.value:null;b?(b.comment&&(g=b.comment),b.commentBefore&&(c=!0)):h.value==null&&E?.comment&&(g=E.comment)}g&&(c=!0);let y=Iw.stringify(h,l,()=>g=null);m<t.length-1&&(y+=","),g&&(y+=lo.lineComment(y,s,a(g))),!c&&(f.length>u||y.includes(`
`))&&(c=!0),f.push(y),u=f.length}let{start:d,end:p}=r;if(f.length===0)return d+p;if(!c){let m=f.reduce((h,g)=>h+g.length+2,2);c=e.options.lineWidth>0&&m>e.options.lineWidth}if(c){let m=d;for(let h of f)m+=h?`
${i}${n}${h}`:`
`;return`${m}
${n}${p}`}else return`${d}${o}${f.join(" ")}${o}${p}`}function co({indent:t,options:{commentString:e}},r,s,n){if(s&&n&&(s=s.replace(/^\n+/,"")),s){let i=lo.indentComment(e(s),t);r.push(i.trimStart())}}Rw.stringifyCollection=TI});var Xt=w(eu=>{"use strict";var CI=Xc(),NI=Jc(),AI=eo(),Yt=Q(),uo=Jt(),PI=we();function pn(t,e){let r=Yt.isScalar(e)?e.value:e;for(let s of t)if(Yt.isPair(s)&&(s.key===e||s.key===r||Yt.isScalar(s.key)&&s.key.value===r))return s}var Zc=class extends AI.Collection{static get tagName(){return"tag:yaml.org,2002:map"}constructor(e){super(Yt.MAP,e),this.items=[]}static from(e,r,s){let{keepUndefined:n,replacer:i}=s,o=new this(e),a=(l,c)=>{if(typeof i=="function")c=i.call(r,l,c);else if(Array.isArray(i)&&!i.includes(l))return;(c!==void 0||n)&&o.items.push(uo.createPair(l,c,s))};if(r instanceof Map)for(let[l,c]of r)a(l,c);else if(r&&typeof r=="object")for(let l of Object.keys(r))a(l,r[l]);return typeof e.sortMapEntries=="function"&&o.items.sort(e.sortMapEntries),o}add(e,r){let s;Yt.isPair(e)?s=e:!e||typeof e!="object"||!("key"in e)?s=new uo.Pair(e,e?.value):s=new uo.Pair(e.key,e.value);let n=pn(this.items,s.key),i=this.schema?.sortMapEntries;if(n){if(!r)throw new Error(`Key ${s.key} already set`);Yt.isScalar(n.value)&&PI.isScalarValue(s.value)?n.value.value=s.value:n.value=s.value}else if(i){let o=this.items.findIndex(a=>i(s,a)<0);o===-1?this.items.push(s):this.items.splice(o,0,s)}else this.items.push(s)}delete(e){let r=pn(this.items,e);return r?this.items.splice(this.items.indexOf(r),1).length>0:!1}get(e,r){let n=pn(this.items,e)?.value;return(!r&&Yt.isScalar(n)?n.value:n)??void 0}has(e){return!!pn(this.items,e)}set(e,r){this.add(new uo.Pair(e,r),!0)}toJSON(e,r,s){let n=s?new s:r?.mapAsMap?new Map:{};r?.onCreate&&r.onCreate(n);for(let i of this.items)NI.addPairToJSMap(r,n,i);return n}toString(e,r,s){if(!e)return JSON.stringify(this);for(let n of this.items)if(!Yt.isPair(n))throw new Error(`Map items must all be pairs; found ${JSON.stringify(n)} instead`);return!e.allNullValues&&this.hasAllNullValues(!1)&&(e=Object.assign({},e,{allNullValues:!0})),CI.stringifyCollection(this,e,{blockItemPrefix:"",flowChars:{start:"{",end:"}"},itemIndent:e.indent||"",onChompKeep:s,onComment:r})}};eu.YAMLMap=Zc;eu.findPair=pn});var es=w(Nw=>{"use strict";var LI=Q(),Cw=Xt(),xI={collection:"map",default:!0,nodeClass:Cw.YAMLMap,tag:"tag:yaml.org,2002:map",resolve(t,e){return LI.isMap(t)||e("Expected a mapping for this tag"),t},createNode:(t,e,r)=>Cw.YAMLMap.from(t,e,r)};Nw.map=xI});var Zt=w(Aw=>{"use strict";var qI=an(),MI=Xc(),BI=eo(),ho=Q(),$I=we(),WI=Vt(),tu=class extends BI.Collection{static get tagName(){return"tag:yaml.org,2002:seq"}constructor(e){super(ho.SEQ,e),this.items=[]}add(e){this.items.push(e)}delete(e){let r=fo(e);return typeof r!="number"?!1:this.items.splice(r,1).length>0}get(e,r){let s=fo(e);if(typeof s!="number")return;let n=this.items[s];return!r&&ho.isScalar(n)?n.value:n}has(e){let r=fo(e);return typeof r=="number"&&r<this.items.length}set(e,r){let s=fo(e);if(typeof s!="number")throw new Error(`Expected a valid index, not ${e}.`);let n=this.items[s];ho.isScalar(n)&&$I.isScalarValue(r)?n.value=r:this.items[s]=r}toJSON(e,r){let s=[];r?.onCreate&&r.onCreate(s);let n=0;for(let i of this.items)s.push(WI.toJS(i,String(n++),r));return s}toString(e,r,s){return e?MI.stringifyCollection(this,e,{blockItemPrefix:"- ",flowChars:{start:"[",end:"]"},itemIndent:(e.indent||"")+"  ",onChompKeep:s,onComment:r}):JSON.stringify(this)}static from(e,r,s){let{replacer:n}=s,i=new this(e);if(r&&Symbol.iterator in Object(r)){let o=0;for(let a of r){if(typeof n=="function"){let l=r instanceof Set?a:String(o++);a=n.call(r,l,a)}i.items.push(qI.createNode(a,void 0,s))}}return i}};function fo(t){let e=ho.isScalar(t)?t.value:t;return e&&typeof e=="string"&&(e=Number(e)),typeof e=="number"&&Number.isInteger(e)&&e>=0?e:null}Aw.YAMLSeq=tu});var ts=w(Lw=>{"use strict";var UI=Q(),Pw=Zt(),FI={collection:"seq",default:!0,nodeClass:Pw.YAMLSeq,tag:"tag:yaml.org,2002:seq",resolve(t,e){return UI.isSeq(t)||e("Expected a sequence for this tag"),t},createNode:(t,e,r)=>Pw.YAMLSeq.from(t,e,r)};Lw.seq=FI});var mn=w(xw=>{"use strict";var zI=fn(),jI={identify:t=>typeof t=="string",default:!0,tag:"tag:yaml.org,2002:str",resolve:t=>t,stringify(t,e,r,s){return e=Object.assign({actualString:!0},e),zI.stringifyString(t,e,r,s)}};xw.string=jI});var po=w(Bw=>{"use strict";var qw=we(),Mw={identify:t=>t==null,createNode:()=>new qw.Scalar(null),default:!0,tag:"tag:yaml.org,2002:null",test:/^(?:~|[Nn]ull|NULL)?$/,resolve:()=>new qw.Scalar(null),stringify:({source:t},e)=>typeof t=="string"&&Mw.test.test(t)?t:e.options.nullStr};Bw.nullTag=Mw});var ru=w(Ww=>{"use strict";var VI=we(),$w={identify:t=>typeof t=="boolean",default:!0,tag:"tag:yaml.org,2002:bool",test:/^(?:[Tt]rue|TRUE|[Ff]alse|FALSE)$/,resolve:t=>new VI.Scalar(t[0]==="t"||t[0]==="T"),stringify({source:t,value:e},r){if(t&&$w.test.test(t)){let s=t[0]==="t"||t[0]==="T";if(e===s)return t}return e?r.options.trueStr:r.options.falseStr}};Ww.boolTag=$w});var rs=w(Uw=>{"use strict";function GI({format:t,minFractionDigits:e,tag:r,value:s}){if(typeof s=="bigint")return String(s);let n=typeof s=="number"?s:Number(s);if(!isFinite(n))return isNaN(n)?".nan":n<0?"-.inf":".inf";let i=JSON.stringify(s);if(!t&&e&&(!r||r==="tag:yaml.org,2002:float")&&/^\d/.test(i)){let o=i.indexOf(".");o<0&&(o=i.length,i+=".");let a=e-(i.length-o-1);for(;a-- >0;)i+="0"}return i}Uw.stringifyNumber=GI});var nu=w(mo=>{"use strict";var QI=we(),su=rs(),KI={identify:t=>typeof t=="number",default:!0,tag:"tag:yaml.org,2002:float",test:/^(?:[-+]?\.(?:inf|Inf|INF|nan|NaN|NAN))$/,resolve:t=>t.slice(-3).toLowerCase()==="nan"?NaN:t[0]==="-"?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,stringify:su.stringifyNumber},HI={identify:t=>typeof t=="number",default:!0,tag:"tag:yaml.org,2002:float",format:"EXP",test:/^[-+]?(?:\.[0-9]+|[0-9]+(?:\.[0-9]*)?)[eE][-+]?[0-9]+$/,resolve:t=>parseFloat(t),stringify(t){let e=Number(t.value);return isFinite(e)?e.toExponential():su.stringifyNumber(t)}},JI={identify:t=>typeof t=="number",default:!0,tag:"tag:yaml.org,2002:float",test:/^[-+]?(?:\.[0-9]+|[0-9]+\.[0-9]*)$/,resolve(t){let e=new QI.Scalar(parseFloat(t)),r=t.indexOf(".");return r!==-1&&t[t.length-1]==="0"&&(e.minFractionDigits=t.length-r-1),e},stringify:su.stringifyNumber};mo.float=JI;mo.floatExp=HI;mo.floatNaN=KI});var ou=w(go=>{"use strict";var Fw=rs(),wo=t=>typeof t=="bigint"||Number.isInteger(t),iu=(t,e,r,{intAsBigInt:s})=>s?BigInt(t):parseInt(t.substring(e),r);function zw(t,e,r){let{value:s}=t;return wo(s)&&s>=0?r+s.toString(e):Fw.stringifyNumber(t)}var YI={identify:t=>wo(t)&&t>=0,default:!0,tag:"tag:yaml.org,2002:int",format:"OCT",test:/^0o[0-7]+$/,resolve:(t,e,r)=>iu(t,2,8,r),stringify:t=>zw(t,8,"0o")},XI={identify:wo,default:!0,tag:"tag:yaml.org,2002:int",test:/^[-+]?[0-9]+$/,resolve:(t,e,r)=>iu(t,0,10,r),stringify:Fw.stringifyNumber},ZI={identify:t=>wo(t)&&t>=0,default:!0,tag:"tag:yaml.org,2002:int",format:"HEX",test:/^0x[0-9a-fA-F]+$/,resolve:(t,e,r)=>iu(t,2,16,r),stringify:t=>zw(t,16,"0x")};go.int=XI;go.intHex=ZI;go.intOct=YI});var Vw=w(jw=>{"use strict";var eR=es(),tR=po(),rR=ts(),sR=mn(),nR=ru(),au=nu(),lu=ou(),iR=[eR.map,rR.seq,sR.string,tR.nullTag,nR.boolTag,lu.intOct,lu.int,lu.intHex,au.floatNaN,au.floatExp,au.float];jw.schema=iR});var Kw=w(Qw=>{"use strict";var oR=we(),aR=es(),lR=ts();function Gw(t){return typeof t=="bigint"||Number.isInteger(t)}var yo=({value:t})=>JSON.stringify(t),cR=[{identify:t=>typeof t=="string",default:!0,tag:"tag:yaml.org,2002:str",resolve:t=>t,stringify:yo},{identify:t=>t==null,createNode:()=>new oR.Scalar(null),default:!0,tag:"tag:yaml.org,2002:null",test:/^null$/,resolve:()=>null,stringify:yo},{identify:t=>typeof t=="boolean",default:!0,tag:"tag:yaml.org,2002:bool",test:/^true|false$/,resolve:t=>t==="true",stringify:yo},{identify:Gw,default:!0,tag:"tag:yaml.org,2002:int",test:/^-?(?:0|[1-9][0-9]*)$/,resolve:(t,e,{intAsBigInt:r})=>r?BigInt(t):parseInt(t,10),stringify:({value:t})=>Gw(t)?t.toString():JSON.stringify(t)},{identify:t=>typeof t=="number",default:!0,tag:"tag:yaml.org,2002:float",test:/^-?(?:0|[1-9][0-9]*)(?:\.[0-9]*)?(?:[eE][-+]?[0-9]+)?$/,resolve:t=>parseFloat(t),stringify:yo}],uR={default:!0,tag:"",test:/^/,resolve(t,e){return e(`Unresolved plain scalar ${JSON.stringify(t)}`),t}},fR=[aR.map,lR.seq].concat(cR,uR);Qw.schema=fR});var uu=w(Hw=>{"use strict";var cu=we(),dR=fn(),hR={identify:t=>t instanceof Uint8Array,default:!1,tag:"tag:yaml.org,2002:binary",resolve(t,e){if(typeof Buffer=="function")return Buffer.from(t,"base64");if(typeof atob=="function"){let r=atob(t.replace(/[\n\r]/g,"")),s=new Uint8Array(r.length);for(let n=0;n<r.length;++n)s[n]=r.charCodeAt(n);return s}else return e("This environment does not support reading binary tags; either Buffer or atob is required"),t},stringify({comment:t,type:e,value:r},s,n,i){let o=r,a;if(typeof Buffer=="function")a=o instanceof Buffer?o.toString("base64"):Buffer.from(o.buffer).toString("base64");else if(typeof btoa=="function"){let l="";for(let c=0;c<o.length;++c)l+=String.fromCharCode(o[c]);a=btoa(l)}else throw new Error("This environment does not support writing binary tags; either Buffer or btoa is required");if(e||(e=cu.Scalar.BLOCK_LITERAL),e!==cu.Scalar.QUOTE_DOUBLE){let l=Math.max(s.options.lineWidth-s.indent.length,s.options.minContentWidth),c=Math.ceil(a.length/l),u=new Array(c);for(let f=0,d=0;f<c;++f,d+=l)u[f]=a.substr(d,l);a=u.join(e===cu.Scalar.BLOCK_LITERAL?`
`:" ")}return dR.stringifyString({comment:t,type:e,value:a},s,n,i)}};Hw.binary=hR});var Eo=w(So=>{"use strict";var _o=Q(),fu=Jt(),pR=we(),mR=Zt();function Jw(t,e){if(_o.isSeq(t))for(let r=0;r<t.items.length;++r){let s=t.items[r];if(!_o.isPair(s)){if(_o.isMap(s)){s.items.length>1&&e("Each pair must have its own sequence indicator");let n=s.items[0]||new fu.Pair(new pR.Scalar(null));if(s.commentBefore&&(n.key.commentBefore=n.key.commentBefore?`${s.commentBefore}
${n.key.commentBefore}`:s.commentBefore),s.comment){let i=n.value??n.key;i.comment=i.comment?`${s.comment}
${i.comment}`:s.comment}s=n}t.items[r]=_o.isPair(s)?s:new fu.Pair(s)}}else e("Expected a sequence for this tag");return t}function Yw(t,e,r){let{replacer:s}=r,n=new mR.YAMLSeq(t);n.tag="tag:yaml.org,2002:pairs";let i=0;if(e&&Symbol.iterator in Object(e))for(let o of e){typeof s=="function"&&(o=s.call(e,String(i++),o));let a,l;if(Array.isArray(o))if(o.length===2)a=o[0],l=o[1];else throw new TypeError(`Expected [key, value] tuple: ${o}`);else if(o&&o instanceof Object){let c=Object.keys(o);if(c.length===1)a=c[0],l=o[a];else throw new TypeError(`Expected tuple with one key, not ${c.length} keys`)}else a=o;n.items.push(fu.createPair(a,l,r))}return n}var wR={collection:"seq",default:!1,tag:"tag:yaml.org,2002:pairs",resolve:Jw,createNode:Yw};So.createPairs=Yw;So.pairs=wR;So.resolvePairs=Jw});var pu=w(hu=>{"use strict";var Xw=Q(),du=Vt(),wn=Xt(),gR=Zt(),Zw=Eo(),pr=class t extends gR.YAMLSeq{constructor(){super(),this.add=wn.YAMLMap.prototype.add.bind(this),this.delete=wn.YAMLMap.prototype.delete.bind(this),this.get=wn.YAMLMap.prototype.get.bind(this),this.has=wn.YAMLMap.prototype.has.bind(this),this.set=wn.YAMLMap.prototype.set.bind(this),this.tag=t.tag}toJSON(e,r){if(!r)return super.toJSON(e);let s=new Map;r?.onCreate&&r.onCreate(s);for(let n of this.items){let i,o;if(Xw.isPair(n)?(i=du.toJS(n.key,"",r),o=du.toJS(n.value,i,r)):i=du.toJS(n,"",r),s.has(i))throw new Error("Ordered maps must not include duplicate keys");s.set(i,o)}return s}static from(e,r,s){let n=Zw.createPairs(e,r,s),i=new this;return i.items=n.items,i}};pr.tag="tag:yaml.org,2002:omap";var yR={collection:"seq",identify:t=>t instanceof Map,nodeClass:pr,default:!1,tag:"tag:yaml.org,2002:omap",resolve(t,e){let r=Zw.resolvePairs(t,e),s=[];for(let{key:n}of r.items)Xw.isScalar(n)&&(s.includes(n.value)?e(`Ordered maps must not include duplicate keys: ${n.value}`):s.push(n.value));return Object.assign(new pr,r)},createNode:(t,e,r)=>pr.from(t,e,r)};hu.YAMLOMap=pr;hu.omap=yR});var ng=w(mu=>{"use strict";var eg=we();function tg({value:t,source:e},r){return e&&(t?rg:sg).test.test(e)?e:t?r.options.trueStr:r.options.falseStr}var rg={identify:t=>t===!0,default:!0,tag:"tag:yaml.org,2002:bool",test:/^(?:Y|y|[Yy]es|YES|[Tt]rue|TRUE|[Oo]n|ON)$/,resolve:()=>new eg.Scalar(!0),stringify:tg},sg={identify:t=>t===!1,default:!0,tag:"tag:yaml.org,2002:bool",test:/^(?:N|n|[Nn]o|NO|[Ff]alse|FALSE|[Oo]ff|OFF)$/i,resolve:()=>new eg.Scalar(!1),stringify:tg};mu.falseTag=sg;mu.trueTag=rg});var ig=w(bo=>{"use strict";var _R=we(),wu=rs(),SR={identify:t=>typeof t=="number",default:!0,tag:"tag:yaml.org,2002:float",test:/^[-+]?\.(?:inf|Inf|INF|nan|NaN|NAN)$/,resolve:t=>t.slice(-3).toLowerCase()==="nan"?NaN:t[0]==="-"?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,stringify:wu.stringifyNumber},ER={identify:t=>typeof t=="number",default:!0,tag:"tag:yaml.org,2002:float",format:"EXP",test:/^[-+]?(?:[0-9][0-9_]*)?(?:\.[0-9_]*)?[eE][-+]?[0-9]+$/,resolve:t=>parseFloat(t.replace(/_/g,"")),stringify(t){let e=Number(t.value);return isFinite(e)?e.toExponential():wu.stringifyNumber(t)}},bR={identify:t=>typeof t=="number",default:!0,tag:"tag:yaml.org,2002:float",test:/^[-+]?(?:[0-9][0-9_]*)?\.[0-9_]*$/,resolve(t){let e=new _R.Scalar(parseFloat(t.replace(/_/g,""))),r=t.indexOf(".");if(r!==-1){let s=t.substring(r+1).replace(/_/g,"");s[s.length-1]==="0"&&(e.minFractionDigits=s.length)}return e},stringify:wu.stringifyNumber};bo.float=bR;bo.floatExp=ER;bo.floatNaN=SR});var ag=w(yn=>{"use strict";var og=rs(),gn=t=>typeof t=="bigint"||Number.isInteger(t);function ko(t,e,r,{intAsBigInt:s}){let n=t[0];if((n==="-"||n==="+")&&(e+=1),t=t.substring(e).replace(/_/g,""),s){switch(r){case 2:t=`0b${t}`;break;case 8:t=`0o${t}`;break;case 16:t=`0x${t}`;break}let o=BigInt(t);return n==="-"?BigInt(-1)*o:o}let i=parseInt(t,r);return n==="-"?-1*i:i}function gu(t,e,r){let{value:s}=t;if(gn(s)){let n=s.toString(e);return s<0?"-"+r+n.substr(1):r+n}return og.stringifyNumber(t)}var kR={identify:gn,default:!0,tag:"tag:yaml.org,2002:int",format:"BIN",test:/^[-+]?0b[0-1_]+$/,resolve:(t,e,r)=>ko(t,2,2,r),stringify:t=>gu(t,2,"0b")},vR={identify:gn,default:!0,tag:"tag:yaml.org,2002:int",format:"OCT",test:/^[-+]?0[0-7_]+$/,resolve:(t,e,r)=>ko(t,1,8,r),stringify:t=>gu(t,8,"0")},OR={identify:gn,default:!0,tag:"tag:yaml.org,2002:int",test:/^[-+]?[0-9][0-9_]*$/,resolve:(t,e,r)=>ko(t,0,10,r),stringify:og.stringifyNumber},DR={identify:gn,default:!0,tag:"tag:yaml.org,2002:int",format:"HEX",test:/^[-+]?0x[0-9a-fA-F_]+$/,resolve:(t,e,r)=>ko(t,2,16,r),stringify:t=>gu(t,16,"0x")};yn.int=OR;yn.intBin=kR;yn.intHex=DR;yn.intOct=vR});var _u=w(yu=>{"use strict";var Do=Q(),vo=Jt(),Oo=Xt(),mr=class t extends Oo.YAMLMap{constructor(e){super(e),this.tag=t.tag}add(e){let r;Do.isPair(e)?r=e:e&&typeof e=="object"&&"key"in e&&"value"in e&&e.value===null?r=new vo.Pair(e.key,null):r=new vo.Pair(e,null),Oo.findPair(this.items,r.key)||this.items.push(r)}get(e,r){let s=Oo.findPair(this.items,e);return!r&&Do.isPair(s)?Do.isScalar(s.key)?s.key.value:s.key:s}set(e,r){if(typeof r!="boolean")throw new Error(`Expected boolean value for set(key, value) in a YAML set, not ${typeof r}`);let s=Oo.findPair(this.items,e);s&&!r?this.items.splice(this.items.indexOf(s),1):!s&&r&&this.items.push(new vo.Pair(e))}toJSON(e,r){return super.toJSON(e,r,Set)}toString(e,r,s){if(!e)return JSON.stringify(this);if(this.hasAllNullValues(!0))return super.toString(Object.assign({},e,{allNullValues:!0}),r,s);throw new Error("Set items must all have null values")}static from(e,r,s){let{replacer:n}=s,i=new this(e);if(r&&Symbol.iterator in Object(r))for(let o of r)typeof n=="function"&&(o=n.call(r,o,o)),i.items.push(vo.createPair(o,null,s));return i}};mr.tag="tag:yaml.org,2002:set";var TR={collection:"map",identify:t=>t instanceof Set,nodeClass:mr,default:!1,tag:"tag:yaml.org,2002:set",createNode:(t,e,r)=>mr.from(t,e,r),resolve(t,e){if(Do.isMap(t)){if(t.hasAllNullValues(!0))return Object.assign(new mr,t);e("Set items must all have null values")}else e("Expected a mapping for this tag");return t}};yu.YAMLSet=mr;yu.set=TR});var Eu=w(To=>{"use strict";var IR=rs();function Su(t,e){let r=t[0],s=r==="-"||r==="+"?t.substring(1):t,n=o=>e?BigInt(o):Number(o),i=s.replace(/_/g,"").split(":").reduce((o,a)=>o*n(60)+n(a),n(0));return r==="-"?n(-1)*i:i}function lg(t){let{value:e}=t,r=o=>o;if(typeof e=="bigint")r=o=>BigInt(o);else if(isNaN(e)||!isFinite(e))return IR.stringifyNumber(t);let s="";e<0&&(s="-",e*=r(-1));let n=r(60),i=[e%n];return e<60?i.unshift(0):(e=(e-i[0])/n,i.unshift(e%n),e>=60&&(e=(e-i[0])/n,i.unshift(e))),s+i.map(o=>String(o).padStart(2,"0")).join(":").replace(/000000\d*$/,"")}var RR={identify:t=>typeof t=="bigint"||Number.isInteger(t),default:!0,tag:"tag:yaml.org,2002:int",format:"TIME",test:/^[-+]?[0-9][0-9_]*(?::[0-5]?[0-9])+$/,resolve:(t,e,{intAsBigInt:r})=>Su(t,r),stringify:lg},CR={identify:t=>typeof t=="number",default:!0,tag:"tag:yaml.org,2002:float",format:"TIME",test:/^[-+]?[0-9][0-9_]*(?::[0-5]?[0-9])+\.[0-9_]*$/,resolve:t=>Su(t,!1),stringify:lg},cg={identify:t=>t instanceof Date,default:!0,tag:"tag:yaml.org,2002:timestamp",test:RegExp("^([0-9]{4})-([0-9]{1,2})-([0-9]{1,2})(?:(?:t|T|[ \\t]+)([0-9]{1,2}):([0-9]{1,2}):([0-9]{1,2}(\\.[0-9]+)?)(?:[ \\t]*(Z|[-+][012]?[0-9](?::[0-9]{2})?))?)?$"),resolve(t){let e=t.match(cg.test);if(!e)throw new Error("!!timestamp expects a date, starting with yyyy-mm-dd");let[,r,s,n,i,o,a]=e.map(Number),l=e[7]?Number((e[7]+"00").substr(1,3)):0,c=Date.UTC(r,s-1,n,i||0,o||0,a||0,l),u=e[8];if(u&&u!=="Z"){let f=Su(u,!1);Math.abs(f)<30&&(f*=60),c-=6e4*f}return new Date(c)},stringify:({value:t})=>t.toISOString().replace(/((T00:00)?:00)?\.000Z$/,"")};To.floatTime=CR;To.intTime=RR;To.timestamp=cg});var dg=w(fg=>{"use strict";var NR=es(),AR=po(),PR=ts(),LR=mn(),xR=uu(),ug=ng(),bu=ig(),Io=ag(),qR=pu(),MR=Eo(),BR=_u(),ku=Eu(),$R=[NR.map,PR.seq,LR.string,AR.nullTag,ug.trueTag,ug.falseTag,Io.intBin,Io.intOct,Io.int,Io.intHex,bu.floatNaN,bu.floatExp,bu.float,xR.binary,qR.omap,MR.pairs,BR.set,ku.intTime,ku.floatTime,ku.timestamp];fg.schema=$R});var bg=w(Du=>{"use strict";var wg=es(),WR=po(),gg=ts(),UR=mn(),FR=ru(),vu=nu(),Ou=ou(),zR=Vw(),jR=Kw(),yg=uu(),_g=pu(),Sg=Eo(),hg=dg(),Eg=_u(),Ro=Eu(),pg=new Map([["core",zR.schema],["failsafe",[wg.map,gg.seq,UR.string]],["json",jR.schema],["yaml11",hg.schema],["yaml-1.1",hg.schema]]),mg={binary:yg.binary,bool:FR.boolTag,float:vu.float,floatExp:vu.floatExp,floatNaN:vu.floatNaN,floatTime:Ro.floatTime,int:Ou.int,intHex:Ou.intHex,intOct:Ou.intOct,intTime:Ro.intTime,map:wg.map,null:WR.nullTag,omap:_g.omap,pairs:Sg.pairs,seq:gg.seq,set:Eg.set,timestamp:Ro.timestamp},VR={"tag:yaml.org,2002:binary":yg.binary,"tag:yaml.org,2002:omap":_g.omap,"tag:yaml.org,2002:pairs":Sg.pairs,"tag:yaml.org,2002:set":Eg.set,"tag:yaml.org,2002:timestamp":Ro.timestamp};function GR(t,e){let r=pg.get(e);if(!r)if(Array.isArray(t))r=[];else{let s=Array.from(pg.keys()).filter(n=>n!=="yaml11").map(n=>JSON.stringify(n)).join(", ");throw new Error(`Unknown schema "${e}"; use one of ${s} or define customTags array`)}if(Array.isArray(t))for(let s of t)r=r.concat(s);else typeof t=="function"&&(r=t(r.slice()));return r.map(s=>{if(typeof s!="string")return s;let n=mg[s];if(n)return n;let i=Object.keys(mg).map(o=>JSON.stringify(o)).join(", ");throw new Error(`Unknown custom tag "${s}"; use one of ${i}`)})}Du.coreKnownTags=VR;Du.getTags=GR});var Ru=w(kg=>{"use strict";var Tu=Q(),QR=es(),KR=ts(),HR=mn(),Co=bg(),JR=(t,e)=>t.key<e.key?-1:t.key>e.key?1:0,Iu=class t{constructor({compat:e,customTags:r,merge:s,resolveKnownTags:n,schema:i,sortMapEntries:o,toStringDefaults:a}){this.compat=Array.isArray(e)?Co.getTags(e,"compat"):e?Co.getTags(null,e):null,this.merge=!!s,this.name=typeof i=="string"&&i||"core",this.knownTags=n?Co.coreKnownTags:{},this.tags=Co.getTags(r,this.name),this.toStringOptions=a??null,Object.defineProperty(this,Tu.MAP,{value:QR.map}),Object.defineProperty(this,Tu.SCALAR,{value:HR.string}),Object.defineProperty(this,Tu.SEQ,{value:KR.seq}),this.sortMapEntries=typeof o=="function"?o:o===!0?JR:null}clone(){let e=Object.create(t.prototype,Object.getOwnPropertyDescriptors(this));return e.tags=this.tags.slice(),e}};kg.Schema=Iu});var Og=w(vg=>{"use strict";var YR=Q(),Cu=dn(),_n=ln();function XR(t,e){let r=[],s=e.directives===!0;if(e.directives!==!1&&t.directives){let l=t.directives.toString(t);l?(r.push(l),s=!0):t.directives.docStart&&(s=!0)}s&&r.push("---");let n=Cu.createStringifyContext(t,e),{commentString:i}=n.options;if(t.commentBefore){r.length!==1&&r.unshift("");let l=i(t.commentBefore);r.unshift(_n.indentComment(l,""))}let o=!1,a=null;if(t.contents){if(YR.isNode(t.contents)){if(t.contents.spaceBefore&&s&&r.push(""),t.contents.commentBefore){let u=i(t.contents.commentBefore);r.push(_n.indentComment(u,""))}n.forceBlockIndent=!!t.comment,a=t.contents.comment}let l=a?void 0:()=>o=!0,c=Cu.stringify(t.contents,n,()=>a=null,l);a&&(c+=_n.lineComment(c,"",i(a))),(c[0]==="|"||c[0]===">")&&r[r.length-1]==="---"?r[r.length-1]=`--- ${c}`:r.push(c)}else r.push(Cu.stringify(t.contents,n));if(t.directives?.docEnd)if(t.comment){let l=i(t.comment);l.includes(`
`)?(r.push("..."),r.push(_n.indentComment(l,""))):r.push(`... ${l}`)}else r.push("...");else{let l=t.comment;l&&o&&(l=l.replace(/^\n+/,"")),l&&((!o||a)&&r[r.length-1]!==""&&r.push(""),r.push(_n.indentComment(i(l),"")))}return r.join(`
`)+`
`}vg.stringifyDocument=XR});var Sn=w(Dg=>{"use strict";var ZR=on(),ss=eo(),tt=Q(),eC=Jt(),tC=Vt(),rC=Ru(),sC=Og(),Nu=Ki(),nC=qc(),iC=an(),Au=xc(),Pu=class t{constructor(e,r,s){this.commentBefore=null,this.comment=null,this.errors=[],this.warnings=[],Object.defineProperty(this,tt.NODE_TYPE,{value:tt.DOC});let n=null;typeof r=="function"||Array.isArray(r)?n=r:s===void 0&&r&&(s=r,r=void 0);let i=Object.assign({intAsBigInt:!1,keepSourceTokens:!1,logLevel:"warn",prettyErrors:!0,strict:!0,uniqueKeys:!0,version:"1.2"},s);this.options=i;let{version:o}=i;s?._directives?(this.directives=s._directives.atDocument(),this.directives.yaml.explicit&&(o=this.directives.yaml.version)):this.directives=new Au.Directives({version:o}),this.setSchema(o,s),this.contents=e===void 0?null:this.createNode(e,n,s)}clone(){let e=Object.create(t.prototype,{[tt.NODE_TYPE]:{value:tt.DOC}});return e.commentBefore=this.commentBefore,e.comment=this.comment,e.errors=this.errors.slice(),e.warnings=this.warnings.slice(),e.options=Object.assign({},this.options),this.directives&&(e.directives=this.directives.clone()),e.schema=this.schema.clone(),e.contents=tt.isNode(this.contents)?this.contents.clone(e.schema):this.contents,this.range&&(e.range=this.range.slice()),e}add(e){ns(this.contents)&&this.contents.add(e)}addIn(e,r){ns(this.contents)&&this.contents.addIn(e,r)}createAlias(e,r){if(!e.anchor){let s=Nu.anchorNames(this);e.anchor=!r||s.has(r)?Nu.findNewAnchor(r||"a",s):r}return new ZR.Alias(e.anchor)}createNode(e,r,s){let n;if(typeof r=="function")e=r.call({"":e},"",e),n=r;else if(Array.isArray(r)){let g=E=>typeof E=="number"||E instanceof String||E instanceof Number,y=r.filter(g).map(String);y.length>0&&(r=r.concat(y)),n=r}else s===void 0&&r&&(s=r,r=void 0);let{aliasDuplicateObjects:i,anchorPrefix:o,flow:a,keepUndefined:l,onTagObj:c,tag:u}=s??{},{onAnchor:f,setAnchors:d,sourceObjects:p}=Nu.createNodeAnchors(this,o||"a"),m={aliasDuplicateObjects:i??!0,keepUndefined:l??!1,onAnchor:f,onTagObj:c,replacer:n,schema:this.schema,sourceObjects:p},h=iC.createNode(e,u,m);return a&&tt.isCollection(h)&&(h.flow=!0),d(),h}createPair(e,r,s={}){let n=this.createNode(e,null,s),i=this.createNode(r,null,s);return new eC.Pair(n,i)}delete(e){return ns(this.contents)?this.contents.delete(e):!1}deleteIn(e){return ss.isEmptyPath(e)?this.contents==null?!1:(this.contents=null,!0):ns(this.contents)?this.contents.deleteIn(e):!1}get(e,r){return tt.isCollection(this.contents)?this.contents.get(e,r):void 0}getIn(e,r){return ss.isEmptyPath(e)?!r&&tt.isScalar(this.contents)?this.contents.value:this.contents:tt.isCollection(this.contents)?this.contents.getIn(e,r):void 0}has(e){return tt.isCollection(this.contents)?this.contents.has(e):!1}hasIn(e){return ss.isEmptyPath(e)?this.contents!==void 0:tt.isCollection(this.contents)?this.contents.hasIn(e):!1}set(e,r){this.contents==null?this.contents=ss.collectionFromPath(this.schema,[e],r):ns(this.contents)&&this.contents.set(e,r)}setIn(e,r){ss.isEmptyPath(e)?this.contents=r:this.contents==null?this.contents=ss.collectionFromPath(this.schema,Array.from(e),r):ns(this.contents)&&this.contents.setIn(e,r)}setSchema(e,r={}){typeof e=="number"&&(e=String(e));let s;switch(e){case"1.1":this.directives?this.directives.yaml.version="1.1":this.directives=new Au.Directives({version:"1.1"}),s={merge:!0,resolveKnownTags:!1,schema:"yaml-1.1"};break;case"1.2":case"next":this.directives?this.directives.yaml.version=e:this.directives=new Au.Directives({version:e}),s={merge:!1,resolveKnownTags:!0,schema:"core"};break;case null:this.directives&&delete this.directives,s=null;break;default:{let n=JSON.stringify(e);throw new Error(`Expected '1.1', '1.2' or null as first argument, but found: ${n}`)}}if(r.schema instanceof Object)this.schema=r.schema;else if(s)this.schema=new rC.Schema(Object.assign(s,r));else throw new Error("With a null YAML version, the { schema: Schema } option is required")}toJS({json:e,jsonArg:r,mapAsMap:s,maxAliasCount:n,onAnchor:i,reviver:o}={}){let a={anchors:new Map,doc:this,keep:!e,mapAsMap:s===!0,mapKeyWarned:!1,maxAliasCount:typeof n=="number"?n:100},l=tC.toJS(this.contents,r??"",a);if(typeof i=="function")for(let{count:c,res:u}of a.anchors.values())i(u,c);return typeof o=="function"?nC.applyReviver(o,{"":l},"",l):l}toJSON(e,r){return this.toJS({json:!0,jsonArg:e,mapAsMap:!1,onAnchor:r})}toString(e={}){if(this.errors.length>0)throw new Error("Document with errors cannot be stringified");if("indent"in e&&(!Number.isInteger(e.indent)||Number(e.indent)<=0)){let r=JSON.stringify(e.indent);throw new Error(`"indent" option must be a positive integer, not ${r}`)}return sC.stringifyDocument(this,e)}};function ns(t){if(tt.isCollection(t))return!0;throw new Error("Expected a YAML collection as document contents")}Dg.Document=Pu});var kn=w(bn=>{"use strict";var En=class extends Error{constructor(e,r,s,n){super(),this.name=e,this.code=s,this.message=n,this.pos=r}},Lu=class extends En{constructor(e,r,s){super("YAMLParseError",e,r,s)}},xu=class extends En{constructor(e,r,s){super("YAMLWarning",e,r,s)}},oC=(t,e)=>r=>{if(r.pos[0]===-1)return;r.linePos=r.pos.map(a=>e.linePos(a));let{line:s,col:n}=r.linePos[0];r.message+=` at line ${s}, column ${n}`;let i=n-1,o=t.substring(e.lineStarts[s-1],e.lineStarts[s]).replace(/[\n\r]+$/,"");if(i>=60&&o.length>80){let a=Math.min(i-39,o.length-79);o="\u2026"+o.substring(a),i-=a-1}if(o.length>80&&(o=o.substring(0,79)+"\u2026"),s>1&&/^ *$/.test(o.substring(0,i))){let a=t.substring(e.lineStarts[s-2],e.lineStarts[s-1]);a.length>80&&(a=a.substring(0,79)+`\u2026
`),o=a+o}if(/[^ ]/.test(o)){let a=1,l=r.linePos[1];l&&l.line===s&&l.col>n&&(a=Math.max(1,Math.min(l.col-n,80-i)));let c=" ".repeat(i)+"^".repeat(a);r.message+=`:

${o}
${c}
`}};bn.YAMLError=En;bn.YAMLParseError=Lu;bn.YAMLWarning=xu;bn.prettifyError=oC});var vn=w(Tg=>{"use strict";function aC(t,{flow:e,indicator:r,next:s,offset:n,onError:i,startOnNewline:o}){let a=!1,l=o,c=o,u="",f="",d=!1,p=!1,m=!1,h=null,g=null,y=null,E=null,b=null;for(let S of t)switch(m&&(S.type!=="space"&&S.type!=="newline"&&S.type!=="comma"&&i(S.offset,"MISSING_CHAR","Tags and anchors must be separated from the next token by white space"),m=!1),S.type){case"space":!e&&l&&r!=="doc-start"&&S.source[0]==="	"&&i(S,"TAB_AS_INDENT","Tabs are not allowed as indentation"),c=!0;break;case"comment":{c||i(S,"MISSING_CHAR","Comments must be separated from other tokens by white space characters");let L=S.source.substring(1)||" ";u?u+=f+L:u=L,f="",l=!1;break}case"newline":l?u?u+=S.source:a=!0:f+=S.source,l=!0,d=!0,(h||g)&&(p=!0),c=!0;break;case"anchor":h&&i(S,"MULTIPLE_ANCHORS","A node can have at most one anchor"),S.source.endsWith(":")&&i(S.offset+S.source.length-1,"BAD_ALIAS","Anchor ending in : is ambiguous",!0),h=S,b===null&&(b=S.offset),l=!1,c=!1,m=!0;break;case"tag":{g&&i(S,"MULTIPLE_TAGS","A node can have at most one tag"),g=S,b===null&&(b=S.offset),l=!1,c=!1,m=!0;break}case r:(h||g)&&i(S,"BAD_PROP_ORDER",`Anchors and tags must be after the ${S.source} indicator`),E&&i(S,"UNEXPECTED_TOKEN",`Unexpected ${S.source} in ${e??"collection"}`),E=S,l=!1,c=!1;break;case"comma":if(e){y&&i(S,"UNEXPECTED_TOKEN",`Unexpected , in ${e}`),y=S,l=!1,c=!1;break}default:i(S,"UNEXPECTED_TOKEN",`Unexpected ${S.type} token`),l=!1,c=!1}let v=t[t.length-1],I=v?v.offset+v.source.length:n;return m&&s&&s.type!=="space"&&s.type!=="newline"&&s.type!=="comma"&&(s.type!=="scalar"||s.source!=="")&&i(s.offset,"MISSING_CHAR","Tags and anchors must be separated from the next token by white space"),{comma:y,found:E,spaceBefore:a,comment:u,hasNewline:d,hasNewlineAfterProp:p,anchor:h,tag:g,end:I,start:b??I}}Tg.resolveProps=aC});var No=w(Ig=>{"use strict";function qu(t){if(!t)return null;switch(t.type){case"alias":case"scalar":case"double-quoted-scalar":case"single-quoted-scalar":if(t.source.includes(`
`))return!0;if(t.end){for(let e of t.end)if(e.type==="newline")return!0}return!1;case"flow-collection":for(let e of t.items){for(let r of e.start)if(r.type==="newline")return!0;if(e.sep){for(let r of e.sep)if(r.type==="newline")return!0}if(qu(e.key)||qu(e.value))return!0}return!1;default:return!0}}Ig.containsNewline=qu});var Mu=w(Rg=>{"use strict";var lC=No();function cC(t,e,r){if(e?.type==="flow-collection"){let s=e.end[0];s.indent===t&&(s.source==="]"||s.source==="}")&&lC.containsNewline(e)&&r(s,"BAD_INDENT","Flow end indicator should be more indented than parent",!0)}}Rg.flowIndentCheck=cC});var Bu=w(Ng=>{"use strict";var Cg=Q();function uC(t,e,r){let{uniqueKeys:s}=t.options;if(s===!1)return!1;let n=typeof s=="function"?s:(i,o)=>i===o||Cg.isScalar(i)&&Cg.isScalar(o)&&i.value===o.value&&!(i.value==="<<"&&t.schema.merge);return e.some(i=>n(i.key,r))}Ng.mapIncludes=uC});var Mg=w(qg=>{"use strict";var Ag=Jt(),fC=Xt(),Pg=vn(),dC=No(),Lg=Mu(),hC=Bu(),xg="All mapping items must start at the same column";function pC({composeNode:t,composeEmptyNode:e},r,s,n,i){let o=i?.nodeClass??fC.YAMLMap,a=new o(r.schema);r.atRoot&&(r.atRoot=!1);let l=s.offset,c=null;for(let u of s.items){let{start:f,key:d,sep:p,value:m}=u,h=Pg.resolveProps(f,{indicator:"explicit-key-ind",next:d??p?.[0],offset:l,onError:n,startOnNewline:!0}),g=!h.found;if(g){if(d&&(d.type==="block-seq"?n(l,"BLOCK_AS_IMPLICIT_KEY","A block sequence may not be used as an implicit map key"):"indent"in d&&d.indent!==s.indent&&n(l,"BAD_INDENT",xg)),!h.anchor&&!h.tag&&!p){c=h.end,h.comment&&(a.comment?a.comment+=`
`+h.comment:a.comment=h.comment);continue}(h.hasNewlineAfterProp||dC.containsNewline(d))&&n(d??f[f.length-1],"MULTILINE_IMPLICIT_KEY","Implicit keys need to be on a single line")}else h.found?.indent!==s.indent&&n(l,"BAD_INDENT",xg);let y=h.end,E=d?t(r,d,h,n):e(r,y,f,null,h,n);r.schema.compat&&Lg.flowIndentCheck(s.indent,d,n),hC.mapIncludes(r,a.items,E)&&n(y,"DUPLICATE_KEY","Map keys must be unique");let b=Pg.resolveProps(p??[],{indicator:"map-value-ind",next:m,offset:E.range[2],onError:n,startOnNewline:!d||d.type==="block-scalar"});if(l=b.end,b.found){g&&(m?.type==="block-map"&&!b.hasNewline&&n(l,"BLOCK_AS_IMPLICIT_KEY","Nested mappings are not allowed in compact mappings"),r.options.strict&&h.start<b.found.offset-1024&&n(E.range,"KEY_OVER_1024_CHARS","The : indicator must be at most 1024 chars after the start of an implicit block mapping key"));let v=m?t(r,m,b,n):e(r,l,p,null,b,n);r.schema.compat&&Lg.flowIndentCheck(s.indent,m,n),l=v.range[2];let I=new Ag.Pair(E,v);r.options.keepSourceTokens&&(I.srcToken=u),a.items.push(I)}else{g&&n(E.range,"MISSING_CHAR","Implicit map keys need to be followed by map values"),b.comment&&(E.comment?E.comment+=`
`+b.comment:E.comment=b.comment);let v=new Ag.Pair(E);r.options.keepSourceTokens&&(v.srcToken=u),a.items.push(v)}}return c&&c<l&&n(c,"IMPOSSIBLE","Map comment with trailing content"),a.range=[s.offset,l,c??l],a}qg.resolveBlockMap=pC});var $g=w(Bg=>{"use strict";var mC=Zt(),wC=vn(),gC=Mu();function yC({composeNode:t,composeEmptyNode:e},r,s,n,i){let o=i?.nodeClass??mC.YAMLSeq,a=new o(r.schema);r.atRoot&&(r.atRoot=!1);let l=s.offset,c=null;for(let{start:u,value:f}of s.items){let d=wC.resolveProps(u,{indicator:"seq-item-ind",next:f,offset:l,onError:n,startOnNewline:!0});if(!d.found)if(d.anchor||d.tag||f)f&&f.type==="block-seq"?n(d.end,"BAD_INDENT","All sequence items must start at the same column"):n(l,"MISSING_CHAR","Sequence item without - indicator");else{c=d.end,d.comment&&(a.comment=d.comment);continue}let p=f?t(r,f,d,n):e(r,d.end,u,null,d,n);r.schema.compat&&gC.flowIndentCheck(s.indent,f,n),l=p.range[2],a.items.push(p)}return a.range=[s.offset,l,c??l],a}Bg.resolveBlockSeq=yC});var is=w(Wg=>{"use strict";function _C(t,e,r,s){let n="";if(t){let i=!1,o="";for(let a of t){let{source:l,type:c}=a;switch(c){case"space":i=!0;break;case"comment":{r&&!i&&s(a,"MISSING_CHAR","Comments must be separated from other tokens by white space characters");let u=l.substring(1)||" ";n?n+=o+u:n=u,o="";break}case"newline":n&&(o+=l),i=!0;break;default:s(a,"UNEXPECTED_TOKEN",`Unexpected ${c} at node end`)}e+=l.length}}return{comment:n,offset:e}}Wg.resolveEnd=_C});var jg=w(zg=>{"use strict";var SC=Q(),EC=Jt(),Ug=Xt(),bC=Zt(),kC=is(),Fg=vn(),vC=No(),OC=Bu(),$u="Block collections are not allowed within flow collections",Wu=t=>t&&(t.type==="block-map"||t.type==="block-seq");function DC({composeNode:t,composeEmptyNode:e},r,s,n,i){let o=s.start.source==="{",a=o?"flow map":"flow sequence",l=i?.nodeClass??(o?Ug.YAMLMap:bC.YAMLSeq),c=new l(r.schema);c.flow=!0;let u=r.atRoot;u&&(r.atRoot=!1);let f=s.offset+s.start.source.length;for(let g=0;g<s.items.length;++g){let y=s.items[g],{start:E,key:b,sep:v,value:I}=y,S=Fg.resolveProps(E,{flow:a,indicator:"explicit-key-ind",next:b??v?.[0],offset:f,onError:n,startOnNewline:!1});if(!S.found){if(!S.anchor&&!S.tag&&!v&&!I){g===0&&S.comma?n(S.comma,"UNEXPECTED_TOKEN",`Unexpected , in ${a}`):g<s.items.length-1&&n(S.start,"UNEXPECTED_TOKEN",`Unexpected empty item in ${a}`),S.comment&&(c.comment?c.comment+=`
`+S.comment:c.comment=S.comment),f=S.end;continue}!o&&r.options.strict&&vC.containsNewline(b)&&n(b,"MULTILINE_IMPLICIT_KEY","Implicit keys of flow sequence pairs need to be on a single line")}if(g===0)S.comma&&n(S.comma,"UNEXPECTED_TOKEN",`Unexpected , in ${a}`);else if(S.comma||n(S.start,"MISSING_CHAR",`Missing , between ${a} items`),S.comment){let L="";e:for(let x of E)switch(x.type){case"comma":case"space":break;case"comment":L=x.source.substring(1);break e;default:break e}if(L){let x=c.items[c.items.length-1];SC.isPair(x)&&(x=x.value??x.key),x.comment?x.comment+=`
`+L:x.comment=L,S.comment=S.comment.substring(L.length+1)}}if(!o&&!v&&!S.found){let L=I?t(r,I,S,n):e(r,S.end,v,null,S,n);c.items.push(L),f=L.range[2],Wu(I)&&n(L.range,"BLOCK_IN_FLOW",$u)}else{let L=S.end,x=b?t(r,b,S,n):e(r,L,E,null,S,n);Wu(b)&&n(x.range,"BLOCK_IN_FLOW",$u);let V=Fg.resolveProps(v??[],{flow:a,indicator:"map-value-ind",next:I,offset:x.range[2],onError:n,startOnNewline:!1});if(V.found){if(!o&&!S.found&&r.options.strict){if(v)for(let re of v){if(re===V.found)break;if(re.type==="newline"){n(re,"MULTILINE_IMPLICIT_KEY","Implicit keys of flow sequence pairs need to be on a single line");break}}S.start<V.found.offset-1024&&n(V.found,"KEY_OVER_1024_CHARS","The : indicator must be at most 1024 chars after the start of an implicit flow sequence key")}}else I&&("source"in I&&I.source&&I.source[0]===":"?n(I,"MISSING_CHAR",`Missing space after : in ${a}`):n(V.start,"MISSING_CHAR",`Missing , or : between ${a} items`));let ve=I?t(r,I,V,n):V.found?e(r,V.end,v,null,V,n):null;ve?Wu(I)&&n(ve.range,"BLOCK_IN_FLOW",$u):V.comment&&(x.comment?x.comment+=`
`+V.comment:x.comment=V.comment);let K=new EC.Pair(x,ve);if(r.options.keepSourceTokens&&(K.srcToken=y),o){let re=c;OC.mapIncludes(r,re.items,x)&&n(L,"DUPLICATE_KEY","Map keys must be unique"),re.items.push(K)}else{let re=new Ug.YAMLMap(r.schema);re.flow=!0,re.items.push(K),c.items.push(re)}f=ve?ve.range[2]:V.end}}let d=o?"}":"]",[p,...m]=s.end,h=f;if(p&&p.source===d)h=p.offset+p.source.length;else{let g=a[0].toUpperCase()+a.substring(1),y=u?`${g} must end with a ${d}`:`${g} in block collection must be sufficiently indented and end with a ${d}`;n(f,u?"MISSING_CHAR":"BAD_INDENT",y),p&&p.source.length!==1&&m.unshift(p)}if(m.length>0){let g=kC.resolveEnd(m,h,r.options.strict,n);g.comment&&(c.comment?c.comment+=`
`+g.comment:c.comment=g.comment),c.range=[s.offset,h,g.offset]}else c.range=[s.offset,h,h];return c}zg.resolveFlowCollection=DC});var Gg=w(Vg=>{"use strict";var TC=Q(),IC=we(),RC=Xt(),CC=Zt(),NC=Mg(),AC=$g(),PC=jg();function Uu(t,e,r,s,n,i){let o=r.type==="block-map"?NC.resolveBlockMap(t,e,r,s,i):r.type==="block-seq"?AC.resolveBlockSeq(t,e,r,s,i):PC.resolveFlowCollection(t,e,r,s,i),a=o.constructor;return n==="!"||n===a.tagName?(o.tag=a.tagName,o):(n&&(o.tag=n),o)}function LC(t,e,r,s,n){let i=s?e.directives.tagName(s.source,f=>n(s,"TAG_RESOLVE_FAILED",f)):null,o=r.type==="block-map"?"map":r.type==="block-seq"?"seq":r.start.source==="{"?"map":"seq";if(!s||!i||i==="!"||i===RC.YAMLMap.tagName&&o==="map"||i===CC.YAMLSeq.tagName&&o==="seq"||!o)return Uu(t,e,r,n,i);let a=e.schema.tags.find(f=>f.tag===i&&f.collection===o);if(!a){let f=e.schema.knownTags[i];if(f&&f.collection===o)e.schema.tags.push(Object.assign({},f,{default:!1})),a=f;else return f?.collection?n(s,"BAD_COLLECTION_TYPE",`${f.tag} used for ${o} collection, but expects ${f.collection}`,!0):n(s,"TAG_RESOLVE_FAILED",`Unresolved tag: ${i}`,!0),Uu(t,e,r,n,i)}let l=Uu(t,e,r,n,i,a),c=a.resolve?.(l,f=>n(s,"TAG_RESOLVE_FAILED",f),e.options)??l,u=TC.isNode(c)?c:new IC.Scalar(c);return u.range=l.range,u.tag=i,a?.format&&(u.format=a.format),u}Vg.composeCollection=LC});var zu=w(Qg=>{"use strict";var Fu=we();function xC(t,e,r){let s=t.offset,n=qC(t,e,r);if(!n)return{value:"",type:null,comment:"",range:[s,s,s]};let i=n.mode===">"?Fu.Scalar.BLOCK_FOLDED:Fu.Scalar.BLOCK_LITERAL,o=t.source?MC(t.source):[],a=o.length;for(let h=o.length-1;h>=0;--h){let g=o[h][1];if(g===""||g==="\r")a=h;else break}if(a===0){let h=n.chomp==="+"&&o.length>0?`
`.repeat(Math.max(1,o.length-1)):"",g=s+n.length;return t.source&&(g+=t.source.length),{value:h,type:i,comment:n.comment,range:[s,g,g]}}let l=t.indent+n.indent,c=t.offset+n.length,u=0;for(let h=0;h<a;++h){let[g,y]=o[h];if(y===""||y==="\r")n.indent===0&&g.length>l&&(l=g.length);else{g.length<l&&r(c+g.length,"MISSING_CHAR","Block scalars with more-indented leading empty lines must use an explicit indentation indicator"),n.indent===0&&(l=g.length),u=h;break}c+=g.length+y.length+1}for(let h=o.length-1;h>=a;--h)o[h][0].length>l&&(a=h+1);let f="",d="",p=!1;for(let h=0;h<u;++h)f+=o[h][0].slice(l)+`
`;for(let h=u;h<a;++h){let[g,y]=o[h];c+=g.length+y.length+1;let E=y[y.length-1]==="\r";if(E&&(y=y.slice(0,-1)),y&&g.length<l){let v=`Block scalar lines must not be less indented than their ${n.indent?"explicit indentation indicator":"first line"}`;r(c-y.length-(E?2:1),"BAD_INDENT",v),g=""}i===Fu.Scalar.BLOCK_LITERAL?(f+=d+g.slice(l)+y,d=`
`):g.length>l||y[0]==="	"?(d===" "?d=`
`:!p&&d===`
`&&(d=`

`),f+=d+g.slice(l)+y,d=`
`,p=!0):y===""?d===`
`?f+=`
`:d=`
`:(f+=d+y,d=" ",p=!1)}switch(n.chomp){case"-":break;case"+":for(let h=a;h<o.length;++h)f+=`
`+o[h][0].slice(l);f[f.length-1]!==`
`&&(f+=`
`);break;default:f+=`
`}let m=s+n.length+t.source.length;return{value:f,type:i,comment:n.comment,range:[s,m,m]}}function qC({offset:t,props:e},r,s){if(e[0].type!=="block-scalar-header")return s(e[0],"IMPOSSIBLE","Block scalar header not found"),null;let{source:n}=e[0],i=n[0],o=0,a="",l=-1;for(let d=1;d<n.length;++d){let p=n[d];if(!a&&(p==="-"||p==="+"))a=p;else{let m=Number(p);!o&&m?o=m:l===-1&&(l=t+d)}}l!==-1&&s(l,"UNEXPECTED_TOKEN",`Block scalar header includes extra characters: ${n}`);let c=!1,u="",f=n.length;for(let d=1;d<e.length;++d){let p=e[d];switch(p.type){case"space":c=!0;case"newline":f+=p.source.length;break;case"comment":r&&!c&&s(p,"MISSING_CHAR","Comments must be separated from other tokens by white space characters"),f+=p.source.length,u=p.source.substring(1);break;case"error":s(p,"UNEXPECTED_TOKEN",p.message),f+=p.source.length;break;default:{let m=`Unexpected token in block scalar header: ${p.type}`;s(p,"UNEXPECTED_TOKEN",m);let h=p.source;h&&typeof h=="string"&&(f+=h.length)}}}return{mode:i,indent:o,chomp:a,comment:u,length:f}}function MC(t){let e=t.split(/\n( *)/),r=e[0],s=r.match(/^( *)/),i=[s?.[1]?[s[1],r.slice(s[1].length)]:["",r]];for(let o=1;o<e.length;o+=2)i.push([e[o],e[o+1]]);return i}Qg.resolveBlockScalar=xC});var Vu=w(Hg=>{"use strict";var ju=we(),BC=is();function $C(t,e,r){let{offset:s,type:n,source:i,end:o}=t,a,l,c=(d,p,m)=>r(s+d,p,m);switch(n){case"scalar":a=ju.Scalar.PLAIN,l=WC(i,c);break;case"single-quoted-scalar":a=ju.Scalar.QUOTE_SINGLE,l=UC(i,c);break;case"double-quoted-scalar":a=ju.Scalar.QUOTE_DOUBLE,l=FC(i,c);break;default:return r(t,"UNEXPECTED_TOKEN",`Expected a flow scalar value, but found: ${n}`),{value:"",type:null,comment:"",range:[s,s+i.length,s+i.length]}}let u=s+i.length,f=BC.resolveEnd(o,u,e,r);return{value:l,type:a,comment:f.comment,range:[s,u,f.offset]}}function WC(t,e){let r="";switch(t[0]){case"	":r="a tab character";break;case",":r="flow indicator character ,";break;case"%":r="directive indicator character %";break;case"|":case">":{r=`block scalar indicator ${t[0]}`;break}case"@":case"`":{r=`reserved character ${t[0]}`;break}}return r&&e(0,"BAD_SCALAR_START",`Plain value cannot start with ${r}`),Kg(t)}function UC(t,e){return(t[t.length-1]!=="'"||t.length===1)&&e(t.length,"MISSING_CHAR","Missing closing 'quote"),Kg(t.slice(1,-1)).replace(/''/g,"'")}function Kg(t){let e,r;try{e=new RegExp(`(.*?)(?<![ 	])[ 	]*\r?
`,"sy"),r=new RegExp(`[ 	]*(.*?)(?:(?<![ 	])[ 	]*)?\r?
`,"sy")}catch{e=/(.*?)[ \t]*\r?\n/sy,r=/[ \t]*(.*?)[ \t]*\r?\n/sy}let s=e.exec(t);if(!s)return t;let n=s[1],i=" ",o=e.lastIndex;for(r.lastIndex=o;s=r.exec(t);)s[1]===""?i===`
`?n+=i:i=`
`:(n+=i+s[1],i=" "),o=r.lastIndex;let a=/[ \t]*(.*)/sy;return a.lastIndex=o,s=a.exec(t),n+i+(s?.[1]??"")}function FC(t,e){let r="";for(let s=1;s<t.length-1;++s){let n=t[s];if(!(n==="\r"&&t[s+1]===`
`))if(n===`
`){let{fold:i,offset:o}=zC(t,s);r+=i,s=o}else if(n==="\\"){let i=t[++s],o=jC[i];if(o)r+=o;else if(i===`
`)for(i=t[s+1];i===" "||i==="	";)i=t[++s+1];else if(i==="\r"&&t[s+1]===`
`)for(i=t[++s+1];i===" "||i==="	";)i=t[++s+1];else if(i==="x"||i==="u"||i==="U"){let a={x:2,u:4,U:8}[i];r+=VC(t,s+1,a,e),s+=a}else{let a=t.substr(s-1,2);e(s-1,"BAD_DQ_ESCAPE",`Invalid escape sequence ${a}`),r+=a}}else if(n===" "||n==="	"){let i=s,o=t[s+1];for(;o===" "||o==="	";)o=t[++s+1];o!==`
`&&!(o==="\r"&&t[s+2]===`
`)&&(r+=s>i?t.slice(i,s+1):n)}else r+=n}return(t[t.length-1]!=='"'||t.length===1)&&e(t.length,"MISSING_CHAR",'Missing closing "quote'),r}function zC(t,e){let r="",s=t[e+1];for(;(s===" "||s==="	"||s===`
`||s==="\r")&&!(s==="\r"&&t[e+2]!==`
`);)s===`
`&&(r+=`
`),e+=1,s=t[e+1];return r||(r=" "),{fold:r,offset:e}}var jC={0:"\0",a:"\x07",b:"\b",e:"\x1B",f:"\f",n:`
`,r:"\r",t:"	",v:"\v",N:"\x85",_:"\xA0",L:"\u2028",P:"\u2029"," ":" ",'"':'"',"/":"/","\\":"\\","	":"	"};function VC(t,e,r,s){let n=t.substr(e,r),o=n.length===r&&/^[0-9a-fA-F]+$/.test(n)?parseInt(n,16):NaN;if(isNaN(o)){let a=t.substr(e-2,r+2);return s(e-2,"BAD_DQ_ESCAPE",`Invalid escape sequence ${a}`),a}return String.fromCodePoint(o)}Hg.resolveFlowScalar=$C});var Xg=w(Yg=>{"use strict";var os=Q(),Jg=we(),GC=zu(),QC=Vu();function KC(t,e,r,s){let{value:n,type:i,comment:o,range:a}=e.type==="block-scalar"?GC.resolveBlockScalar(e,t.options.strict,s):QC.resolveFlowScalar(e,t.options.strict,s),l=r?t.directives.tagName(r.source,f=>s(r,"TAG_RESOLVE_FAILED",f)):null,c=r&&l?HC(t.schema,n,l,r,s):e.type==="scalar"?JC(t,n,e,s):t.schema[os.SCALAR],u;try{let f=c.resolve(n,d=>s(r??e,"TAG_RESOLVE_FAILED",d),t.options);u=os.isScalar(f)?f:new Jg.Scalar(f)}catch(f){let d=f instanceof Error?f.message:String(f);s(r??e,"TAG_RESOLVE_FAILED",d),u=new Jg.Scalar(n)}return u.range=a,u.source=n,i&&(u.type=i),l&&(u.tag=l),c.format&&(u.format=c.format),o&&(u.comment=o),u}function HC(t,e,r,s,n){if(r==="!")return t[os.SCALAR];let i=[];for(let a of t.tags)if(!a.collection&&a.tag===r)if(a.default&&a.test)i.push(a);else return a;for(let a of i)if(a.test?.test(e))return a;let o=t.knownTags[r];return o&&!o.collection?(t.tags.push(Object.assign({},o,{default:!1,test:void 0})),o):(n(s,"TAG_RESOLVE_FAILED",`Unresolved tag: ${r}`,r!=="tag:yaml.org,2002:str"),t[os.SCALAR])}function JC({directives:t,schema:e},r,s,n){let i=e.tags.find(o=>o.default&&o.test?.test(r))||e[os.SCALAR];if(e.compat){let o=e.compat.find(a=>a.default&&a.test?.test(r))??e[os.SCALAR];if(i.tag!==o.tag){let a=t.tagString(i.tag),l=t.tagString(o.tag),c=`Value may be parsed as either ${a} or ${l}`;n(s,"TAG_RESOLVE_FAILED",c,!0)}}return i}Yg.composeScalar=KC});var ey=w(Zg=>{"use strict";function YC(t,e,r){if(e){r===null&&(r=e.length);for(let s=r-1;s>=0;--s){let n=e[s];switch(n.type){case"space":case"comment":case"newline":t-=n.source.length;continue}for(n=e[++s];n?.type==="space";)t+=n.source.length,n=e[++s];break}}return t}Zg.emptyScalarPosition=YC});var sy=w(Qu=>{"use strict";var XC=on(),ZC=Gg(),ty=Xg(),eN=is(),tN=ey(),rN={composeNode:ry,composeEmptyNode:Gu};function ry(t,e,r,s){let{spaceBefore:n,comment:i,anchor:o,tag:a}=r,l,c=!0;switch(e.type){case"alias":l=sN(t,e,s),(o||a)&&s(e,"ALIAS_PROPS","An alias node must not specify any properties");break;case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":case"block-scalar":l=ty.composeScalar(t,e,a,s),o&&(l.anchor=o.source.substring(1));break;case"block-map":case"block-seq":case"flow-collection":l=ZC.composeCollection(rN,t,e,a,s),o&&(l.anchor=o.source.substring(1));break;default:{let u=e.type==="error"?e.message:`Unsupported token (type: ${e.type})`;s(e,"UNEXPECTED_TOKEN",u),l=Gu(t,e.offset,void 0,null,r,s),c=!1}}return o&&l.anchor===""&&s(o,"BAD_ALIAS","Anchor cannot be an empty string"),n&&(l.spaceBefore=!0),i&&(e.type==="scalar"&&e.source===""?l.comment=i:l.commentBefore=i),t.options.keepSourceTokens&&c&&(l.srcToken=e),l}function Gu(t,e,r,s,{spaceBefore:n,comment:i,anchor:o,tag:a,end:l},c){let u={type:"scalar",offset:tN.emptyScalarPosition(e,r,s),indent:-1,source:""},f=ty.composeScalar(t,u,a,c);return o&&(f.anchor=o.source.substring(1),f.anchor===""&&c(o,"BAD_ALIAS","Anchor cannot be an empty string")),n&&(f.spaceBefore=!0),i&&(f.comment=i,f.range[2]=l),f}function sN({options:t},{offset:e,source:r,end:s},n){let i=new XC.Alias(r.substring(1));i.source===""&&n(e,"BAD_ALIAS","Alias cannot be an empty string"),i.source.endsWith(":")&&n(e+r.length-1,"BAD_ALIAS","Alias ending in : is ambiguous",!0);let o=e+r.length,a=eN.resolveEnd(s,o,t.strict,n);return i.range=[e,o,a.offset],a.comment&&(i.comment=a.comment),i}Qu.composeEmptyNode=Gu;Qu.composeNode=ry});var oy=w(iy=>{"use strict";var nN=Sn(),ny=sy(),iN=is(),oN=vn();function aN(t,e,{offset:r,start:s,value:n,end:i},o){let a=Object.assign({_directives:e},t),l=new nN.Document(void 0,a),c={atRoot:!0,directives:l.directives,options:l.options,schema:l.schema},u=oN.resolveProps(s,{indicator:"doc-start",next:n??i?.[0],offset:r,onError:o,startOnNewline:!0});u.found&&(l.directives.docStart=!0,n&&(n.type==="block-map"||n.type==="block-seq")&&!u.hasNewline&&o(u.end,"MISSING_CHAR","Block collection cannot start on same line with directives-end marker")),l.contents=n?ny.composeNode(c,n,u,o):ny.composeEmptyNode(c,u.end,s,null,u,o);let f=l.contents.range[2],d=iN.resolveEnd(i,f,!1,o);return d.comment&&(l.comment=d.comment),l.range=[r,f,d.offset],l}iy.composeDoc=aN});var Hu=w(cy=>{"use strict";var lN=xc(),cN=Sn(),On=kn(),ay=Q(),uN=oy(),fN=is();function Dn(t){if(typeof t=="number")return[t,t+1];if(Array.isArray(t))return t.length===2?t:[t[0],t[1]];let{offset:e,source:r}=t;return[e,e+(typeof r=="string"?r.length:1)]}function ly(t){let e="",r=!1,s=!1;for(let n=0;n<t.length;++n){let i=t[n];switch(i[0]){case"#":e+=(e===""?"":s?`

`:`
`)+(i.substring(1)||" "),r=!0,s=!1;break;case"%":t[n+1]?.[0]!=="#"&&(n+=1),r=!1;break;default:r||(s=!0),r=!1}}return{comment:e,afterEmptyLine:s}}var Ku=class{constructor(e={}){this.doc=null,this.atDirectives=!1,this.prelude=[],this.errors=[],this.warnings=[],this.onError=(r,s,n,i)=>{let o=Dn(r);i?this.warnings.push(new On.YAMLWarning(o,s,n)):this.errors.push(new On.YAMLParseError(o,s,n))},this.directives=new lN.Directives({version:e.version||"1.2"}),this.options=e}decorate(e,r){let{comment:s,afterEmptyLine:n}=ly(this.prelude);if(s){let i=e.contents;if(r)e.comment=e.comment?`${e.comment}
${s}`:s;else if(n||e.directives.docStart||!i)e.commentBefore=s;else if(ay.isCollection(i)&&!i.flow&&i.items.length>0){let o=i.items[0];ay.isPair(o)&&(o=o.key);let a=o.commentBefore;o.commentBefore=a?`${s}
${a}`:s}else{let o=i.commentBefore;i.commentBefore=o?`${s}
${o}`:s}}r?(Array.prototype.push.apply(e.errors,this.errors),Array.prototype.push.apply(e.warnings,this.warnings)):(e.errors=this.errors,e.warnings=this.warnings),this.prelude=[],this.errors=[],this.warnings=[]}streamInfo(){return{comment:ly(this.prelude).comment,directives:this.directives,errors:this.errors,warnings:this.warnings}}*compose(e,r=!1,s=-1){for(let n of e)yield*this.next(n);yield*this.end(r,s)}*next(e){switch(process.env.LOG_STREAM&&console.dir(e,{depth:null}),e.type){case"directive":this.directives.add(e.source,(r,s,n)=>{let i=Dn(e);i[0]+=r,this.onError(i,"BAD_DIRECTIVE",s,n)}),this.prelude.push(e.source),this.atDirectives=!0;break;case"document":{let r=uN.composeDoc(this.options,this.directives,e,this.onError);this.atDirectives&&!r.directives.docStart&&this.onError(e,"MISSING_CHAR","Missing directives-end/doc-start indicator line"),this.decorate(r,!1),this.doc&&(yield this.doc),this.doc=r,this.atDirectives=!1;break}case"byte-order-mark":case"space":break;case"comment":case"newline":this.prelude.push(e.source);break;case"error":{let r=e.source?`${e.message}: ${JSON.stringify(e.source)}`:e.message,s=new On.YAMLParseError(Dn(e),"UNEXPECTED_TOKEN",r);this.atDirectives||!this.doc?this.errors.push(s):this.doc.errors.push(s);break}case"doc-end":{if(!this.doc){let s="Unexpected doc-end without preceding document";this.errors.push(new On.YAMLParseError(Dn(e),"UNEXPECTED_TOKEN",s));break}this.doc.directives.docEnd=!0;let r=fN.resolveEnd(e.end,e.offset+e.source.length,this.doc.options.strict,this.onError);if(this.decorate(this.doc,!0),r.comment){let s=this.doc.comment;this.doc.comment=s?`${s}
${r.comment}`:r.comment}this.doc.range[2]=r.offset;break}default:this.errors.push(new On.YAMLParseError(Dn(e),"UNEXPECTED_TOKEN",`Unsupported token ${e.type}`))}}*end(e=!1,r=-1){if(this.doc)this.decorate(this.doc,!0),yield this.doc,this.doc=null;else if(e){let s=Object.assign({_directives:this.directives},this.options),n=new cN.Document(void 0,s);this.atDirectives&&this.onError(r,"MISSING_CHAR","Missing directives-end indicator line"),n.range=[0,r,r],this.decorate(n,!1),yield n}}};cy.Composer=Ku});var dy=w(Ao=>{"use strict";var dN=zu(),hN=Vu(),pN=kn(),uy=fn();function mN(t,e=!0,r){if(t){let s=(n,i,o)=>{let a=typeof n=="number"?n:Array.isArray(n)?n[0]:n.offset;if(r)r(a,i,o);else throw new pN.YAMLParseError([a,a+1],i,o)};switch(t.type){case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":return hN.resolveFlowScalar(t,e,s);case"block-scalar":return dN.resolveBlockScalar(t,e,s)}}return null}function wN(t,e){let{implicitKey:r=!1,indent:s,inFlow:n=!1,offset:i=-1,type:o="PLAIN"}=e,a=uy.stringifyString({type:o,value:t},{implicitKey:r,indent:s>0?" ".repeat(s):"",inFlow:n,options:{blockQuote:!0,lineWidth:-1}}),l=e.end??[{type:"newline",offset:-1,indent:s,source:`
`}];switch(a[0]){case"|":case">":{let c=a.indexOf(`
`),u=a.substring(0,c),f=a.substring(c+1)+`
`,d=[{type:"block-scalar-header",offset:i,indent:s,source:u}];return fy(d,l)||d.push({type:"newline",offset:-1,indent:s,source:`
`}),{type:"block-scalar",offset:i,indent:s,props:d,source:f}}case'"':return{type:"double-quoted-scalar",offset:i,indent:s,source:a,end:l};case"'":return{type:"single-quoted-scalar",offset:i,indent:s,source:a,end:l};default:return{type:"scalar",offset:i,indent:s,source:a,end:l}}}function gN(t,e,r={}){let{afterKey:s=!1,implicitKey:n=!1,inFlow:i=!1,type:o}=r,a="indent"in t?t.indent:null;if(s&&typeof a=="number"&&(a+=2),!o)switch(t.type){case"single-quoted-scalar":o="QUOTE_SINGLE";break;case"double-quoted-scalar":o="QUOTE_DOUBLE";break;case"block-scalar":{let c=t.props[0];if(c.type!=="block-scalar-header")throw new Error("Invalid block scalar header");o=c.source[0]===">"?"BLOCK_FOLDED":"BLOCK_LITERAL";break}default:o="PLAIN"}let l=uy.stringifyString({type:o,value:e},{implicitKey:n||a===null,indent:a!==null&&a>0?" ".repeat(a):"",inFlow:i,options:{blockQuote:!0,lineWidth:-1}});switch(l[0]){case"|":case">":yN(t,l);break;case'"':Ju(t,l,"double-quoted-scalar");break;case"'":Ju(t,l,"single-quoted-scalar");break;default:Ju(t,l,"scalar")}}function yN(t,e){let r=e.indexOf(`
`),s=e.substring(0,r),n=e.substring(r+1)+`
`;if(t.type==="block-scalar"){let i=t.props[0];if(i.type!=="block-scalar-header")throw new Error("Invalid block scalar header");i.source=s,t.source=n}else{let{offset:i}=t,o="indent"in t?t.indent:-1,a=[{type:"block-scalar-header",offset:i,indent:o,source:s}];fy(a,"end"in t?t.end:void 0)||a.push({type:"newline",offset:-1,indent:o,source:`
`});for(let l of Object.keys(t))l!=="type"&&l!=="offset"&&delete t[l];Object.assign(t,{type:"block-scalar",indent:o,props:a,source:n})}}function fy(t,e){if(e)for(let r of e)switch(r.type){case"space":case"comment":t.push(r);break;case"newline":return t.push(r),!0}return!1}function Ju(t,e,r){switch(t.type){case"scalar":case"double-quoted-scalar":case"single-quoted-scalar":t.type=r,t.source=e;break;case"block-scalar":{let s=t.props.slice(1),n=e.length;t.props[0].type==="block-scalar-header"&&(n-=t.props[0].source.length);for(let i of s)i.offset+=n;delete t.props,Object.assign(t,{type:r,source:e,end:s});break}case"block-map":case"block-seq":{let n={type:"newline",offset:t.offset+e.length,indent:t.indent,source:`
`};delete t.items,Object.assign(t,{type:r,source:e,end:[n]});break}default:{let s="indent"in t?t.indent:-1,n="end"in t&&Array.isArray(t.end)?t.end.filter(i=>i.type==="space"||i.type==="comment"||i.type==="newline"):[];for(let i of Object.keys(t))i!=="type"&&i!=="offset"&&delete t[i];Object.assign(t,{type:r,indent:s,source:e,end:n})}}}Ao.createScalarToken=wN;Ao.resolveAsScalar=mN;Ao.setScalarValue=gN});var py=w(hy=>{"use strict";var _N=t=>"type"in t?Lo(t):Po(t);function Lo(t){switch(t.type){case"block-scalar":{let e="";for(let r of t.props)e+=Lo(r);return e+t.source}case"block-map":case"block-seq":{let e="";for(let r of t.items)e+=Po(r);return e}case"flow-collection":{let e=t.start.source;for(let r of t.items)e+=Po(r);for(let r of t.end)e+=r.source;return e}case"document":{let e=Po(t);if(t.end)for(let r of t.end)e+=r.source;return e}default:{let e=t.source;if("end"in t&&t.end)for(let r of t.end)e+=r.source;return e}}}function Po({start:t,key:e,sep:r,value:s}){let n="";for(let i of t)n+=i.source;if(e&&(n+=Lo(e)),r)for(let i of r)n+=i.source;return s&&(n+=Lo(s)),n}hy.stringify=_N});var yy=w(gy=>{"use strict";var Yu=Symbol("break visit"),SN=Symbol("skip children"),my=Symbol("remove item");function wr(t,e){"type"in t&&t.type==="document"&&(t={start:t.start,value:t.value}),wy(Object.freeze([]),t,e)}wr.BREAK=Yu;wr.SKIP=SN;wr.REMOVE=my;wr.itemAtPath=(t,e)=>{let r=t;for(let[s,n]of e){let i=r?.[s];if(i&&"items"in i)r=i.items[n];else return}return r};wr.parentCollection=(t,e)=>{let r=wr.itemAtPath(t,e.slice(0,-1)),s=e[e.length-1][0],n=r?.[s];if(n&&"items"in n)return n;throw new Error("Parent collection not found")};function wy(t,e,r){let s=r(e,t);if(typeof s=="symbol")return s;for(let n of["key","value"]){let i=e[n];if(i&&"items"in i){for(let o=0;o<i.items.length;++o){let a=wy(Object.freeze(t.concat([[n,o]])),i.items[o],r);if(typeof a=="number")o=a-1;else{if(a===Yu)return Yu;a===my&&(i.items.splice(o,1),o-=1)}}typeof s=="function"&&n==="key"&&(s=s(e,t))}}return typeof s=="function"?s(e,t):s}gy.visit=wr});var xo=w(Fe=>{"use strict";var Xu=dy(),EN=py(),bN=yy(),Zu="\uFEFF",ef="",tf="",rf="",kN=t=>!!t&&"items"in t,vN=t=>!!t&&(t.type==="scalar"||t.type==="single-quoted-scalar"||t.type==="double-quoted-scalar"||t.type==="block-scalar");function ON(t){switch(t){case Zu:return"<BOM>";case ef:return"<DOC>";case tf:return"<FLOW_END>";case rf:return"<SCALAR>";default:return JSON.stringify(t)}}function DN(t){switch(t){case Zu:return"byte-order-mark";case ef:return"doc-mode";case tf:return"flow-error-end";case rf:return"scalar";case"---":return"doc-start";case"...":return"doc-end";case"":case`
`:case`\r
`:return"newline";case"-":return"seq-item-ind";case"?":return"explicit-key-ind";case":":return"map-value-ind";case"{":return"flow-map-start";case"}":return"flow-map-end";case"[":return"flow-seq-start";case"]":return"flow-seq-end";case",":return"comma"}switch(t[0]){case" ":case"	":return"space";case"#":return"comment";case"%":return"directive-line";case"*":return"alias";case"&":return"anchor";case"!":return"tag";case"'":return"single-quoted-scalar";case'"':return"double-quoted-scalar";case"|":case">":return"block-scalar-header"}return null}Fe.createScalarToken=Xu.createScalarToken;Fe.resolveAsScalar=Xu.resolveAsScalar;Fe.setScalarValue=Xu.setScalarValue;Fe.stringify=EN.stringify;Fe.visit=bN.visit;Fe.BOM=Zu;Fe.DOCUMENT=ef;Fe.FLOW_END=tf;Fe.SCALAR=rf;Fe.isCollection=kN;Fe.isScalar=vN;Fe.prettyToken=ON;Fe.tokenType=DN});var af=w(Sy=>{"use strict";var Tn=xo();function rt(t){switch(t){case void 0:case" ":case`
`:case"\r":case"	":return!0;default:return!1}}var _y="0123456789ABCDEFabcdef".split(""),TN="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-#;/?:@&=+$_.!~*'()".split(""),sf=",[]{}".split(""),IN=` ,[]{}
\r	`.split(""),nf=t=>!t||IN.includes(t),of=class{constructor(){this.atEnd=!1,this.blockScalarIndent=-1,this.blockScalarKeep=!1,this.buffer="",this.flowKey=!1,this.flowLevel=0,this.indentNext=0,this.indentValue=0,this.lineEndPos=null,this.next=null,this.pos=0}*lex(e,r=!1){e&&(this.buffer=this.buffer?this.buffer+e:e,this.lineEndPos=null),this.atEnd=!r;let s=this.next??"stream";for(;s&&(r||this.hasChars(1));)s=yield*this.parseNext(s)}atLineEnd(){let e=this.pos,r=this.buffer[e];for(;r===" "||r==="	";)r=this.buffer[++e];return!r||r==="#"||r===`
`?!0:r==="\r"?this.buffer[e+1]===`
`:!1}charAt(e){return this.buffer[this.pos+e]}continueScalar(e){let r=this.buffer[e];if(this.indentNext>0){let s=0;for(;r===" ";)r=this.buffer[++s+e];if(r==="\r"){let n=this.buffer[s+e+1];if(n===`
`||!n&&!this.atEnd)return e+s+1}return r===`
`||s>=this.indentNext||!r&&!this.atEnd?e+s:-1}if(r==="-"||r==="."){let s=this.buffer.substr(e,3);if((s==="---"||s==="...")&&rt(this.buffer[e+3]))return-1}return e}getLine(){let e=this.lineEndPos;return(typeof e!="number"||e!==-1&&e<this.pos)&&(e=this.buffer.indexOf(`
`,this.pos),this.lineEndPos=e),e===-1?this.atEnd?this.buffer.substring(this.pos):null:(this.buffer[e-1]==="\r"&&(e-=1),this.buffer.substring(this.pos,e))}hasChars(e){return this.pos+e<=this.buffer.length}setNext(e){return this.buffer=this.buffer.substring(this.pos),this.pos=0,this.lineEndPos=null,this.next=e,null}peek(e){return this.buffer.substr(this.pos,e)}*parseNext(e){switch(e){case"stream":return yield*this.parseStream();case"line-start":return yield*this.parseLineStart();case"block-start":return yield*this.parseBlockStart();case"doc":return yield*this.parseDocument();case"flow":return yield*this.parseFlowCollection();case"quoted-scalar":return yield*this.parseQuotedScalar();case"block-scalar":return yield*this.parseBlockScalar();case"plain-scalar":return yield*this.parsePlainScalar()}}*parseStream(){let e=this.getLine();if(e===null)return this.setNext("stream");if(e[0]===Tn.BOM&&(yield*this.pushCount(1),e=e.substring(1)),e[0]==="%"){let r=e.length,s=e.indexOf("#");if(s!==-1){let i=e[s-1];(i===" "||i==="	")&&(r=s-1)}for(;;){let i=e[r-1];if(i===" "||i==="	")r-=1;else break}let n=(yield*this.pushCount(r))+(yield*this.pushSpaces(!0));return yield*this.pushCount(e.length-n),this.pushNewline(),"stream"}if(this.atLineEnd()){let r=yield*this.pushSpaces(!0);return yield*this.pushCount(e.length-r),yield*this.pushNewline(),"stream"}return yield Tn.DOCUMENT,yield*this.parseLineStart()}*parseLineStart(){let e=this.charAt(0);if(!e&&!this.atEnd)return this.setNext("line-start");if(e==="-"||e==="."){if(!this.atEnd&&!this.hasChars(4))return this.setNext("line-start");let r=this.peek(3);if(r==="---"&&rt(this.charAt(3)))return yield*this.pushCount(3),this.indentValue=0,this.indentNext=0,"doc";if(r==="..."&&rt(this.charAt(3)))return yield*this.pushCount(3),"stream"}return this.indentValue=yield*this.pushSpaces(!1),this.indentNext>this.indentValue&&!rt(this.charAt(1))&&(this.indentNext=this.indentValue),yield*this.parseBlockStart()}*parseBlockStart(){let[e,r]=this.peek(2);if(!r&&!this.atEnd)return this.setNext("block-start");if((e==="-"||e==="?"||e===":")&&rt(r)){let s=(yield*this.pushCount(1))+(yield*this.pushSpaces(!0));return this.indentNext=this.indentValue+1,this.indentValue+=s,yield*this.parseBlockStart()}return"doc"}*parseDocument(){yield*this.pushSpaces(!0);let e=this.getLine();if(e===null)return this.setNext("doc");let r=yield*this.pushIndicators();switch(e[r]){case"#":yield*this.pushCount(e.length-r);case void 0:return yield*this.pushNewline(),yield*this.parseLineStart();case"{":case"[":return yield*this.pushCount(1),this.flowKey=!1,this.flowLevel=1,"flow";case"}":case"]":return yield*this.pushCount(1),"doc";case"*":return yield*this.pushUntil(nf),"doc";case'"':case"'":return yield*this.parseQuotedScalar();case"|":case">":return r+=yield*this.parseBlockScalarHeader(),r+=yield*this.pushSpaces(!0),yield*this.pushCount(e.length-r),yield*this.pushNewline(),yield*this.parseBlockScalar();default:return yield*this.parsePlainScalar()}}*parseFlowCollection(){let e,r,s=-1;do e=yield*this.pushNewline(),e>0?(r=yield*this.pushSpaces(!1),this.indentValue=s=r):r=0,r+=yield*this.pushSpaces(!0);while(e+r>0);let n=this.getLine();if(n===null)return this.setNext("flow");if((s!==-1&&s<this.indentNext&&n[0]!=="#"||s===0&&(n.startsWith("---")||n.startsWith("..."))&&rt(n[3]))&&!(s===this.indentNext-1&&this.flowLevel===1&&(n[0]==="]"||n[0]==="}")))return this.flowLevel=0,yield Tn.FLOW_END,yield*this.parseLineStart();let i=0;for(;n[i]===",";)i+=yield*this.pushCount(1),i+=yield*this.pushSpaces(!0),this.flowKey=!1;switch(i+=yield*this.pushIndicators(),n[i]){case void 0:return"flow";case"#":return yield*this.pushCount(n.length-i),"flow";case"{":case"[":return yield*this.pushCount(1),this.flowKey=!1,this.flowLevel+=1,"flow";case"}":case"]":return yield*this.pushCount(1),this.flowKey=!0,this.flowLevel-=1,this.flowLevel?"flow":"doc";case"*":return yield*this.pushUntil(nf),"flow";case'"':case"'":return this.flowKey=!0,yield*this.parseQuotedScalar();case":":{let o=this.charAt(1);if(this.flowKey||rt(o)||o===",")return this.flowKey=!1,yield*this.pushCount(1),yield*this.pushSpaces(!0),"flow"}default:return this.flowKey=!1,yield*this.parsePlainScalar()}}*parseQuotedScalar(){let e=this.charAt(0),r=this.buffer.indexOf(e,this.pos+1);if(e==="'")for(;r!==-1&&this.buffer[r+1]==="'";)r=this.buffer.indexOf("'",r+2);else for(;r!==-1;){let i=0;for(;this.buffer[r-1-i]==="\\";)i+=1;if(i%2===0)break;r=this.buffer.indexOf('"',r+1)}let s=this.buffer.substring(0,r),n=s.indexOf(`
`,this.pos);if(n!==-1){for(;n!==-1;){let i=this.continueScalar(n+1);if(i===-1)break;n=s.indexOf(`
`,i)}n!==-1&&(r=n-(s[n-1]==="\r"?2:1))}if(r===-1){if(!this.atEnd)return this.setNext("quoted-scalar");r=this.buffer.length}return yield*this.pushToIndex(r+1,!1),this.flowLevel?"flow":"doc"}*parseBlockScalarHeader(){this.blockScalarIndent=-1,this.blockScalarKeep=!1;let e=this.pos;for(;;){let r=this.buffer[++e];if(r==="+")this.blockScalarKeep=!0;else if(r>"0"&&r<="9")this.blockScalarIndent=Number(r)-1;else if(r!=="-")break}return yield*this.pushUntil(r=>rt(r)||r==="#")}*parseBlockScalar(){let e=this.pos-1,r=0,s;e:for(let n=this.pos;s=this.buffer[n];++n)switch(s){case" ":r+=1;break;case`
`:e=n,r=0;break;case"\r":{let i=this.buffer[n+1];if(!i&&!this.atEnd)return this.setNext("block-scalar");if(i===`
`)break}default:break e}if(!s&&!this.atEnd)return this.setNext("block-scalar");if(r>=this.indentNext){this.blockScalarIndent===-1?this.indentNext=r:this.indentNext+=this.blockScalarIndent;do{let n=this.continueScalar(e+1);if(n===-1)break;e=this.buffer.indexOf(`
`,n)}while(e!==-1);if(e===-1){if(!this.atEnd)return this.setNext("block-scalar");e=this.buffer.length}}if(!this.blockScalarKeep)do{let n=e-1,i=this.buffer[n];i==="\r"&&(i=this.buffer[--n]);let o=n;for(;i===" "||i==="	";)i=this.buffer[--n];if(i===`
`&&n>=this.pos&&n+1+r>o)e=n;else break}while(!0);return yield Tn.SCALAR,yield*this.pushToIndex(e+1,!0),yield*this.parseLineStart()}*parsePlainScalar(){let e=this.flowLevel>0,r=this.pos-1,s=this.pos-1,n;for(;n=this.buffer[++s];)if(n===":"){let i=this.buffer[s+1];if(rt(i)||e&&i===",")break;r=s}else if(rt(n)){let i=this.buffer[s+1];if(n==="\r"&&(i===`
`?(s+=1,n=`
`,i=this.buffer[s+1]):r=s),i==="#"||e&&sf.includes(i))break;if(n===`
`){let o=this.continueScalar(s+1);if(o===-1)break;s=Math.max(s,o-2)}}else{if(e&&sf.includes(n))break;r=s}return!n&&!this.atEnd?this.setNext("plain-scalar"):(yield Tn.SCALAR,yield*this.pushToIndex(r+1,!0),e?"flow":"doc")}*pushCount(e){return e>0?(yield this.buffer.substr(this.pos,e),this.pos+=e,e):0}*pushToIndex(e,r){let s=this.buffer.slice(this.pos,e);return s?(yield s,this.pos+=s.length,s.length):(r&&(yield""),0)}*pushIndicators(){switch(this.charAt(0)){case"!":return(yield*this.pushTag())+(yield*this.pushSpaces(!0))+(yield*this.pushIndicators());case"&":return(yield*this.pushUntil(nf))+(yield*this.pushSpaces(!0))+(yield*this.pushIndicators());case"-":case"?":case":":{let e=this.flowLevel>0,r=this.charAt(1);if(rt(r)||e&&sf.includes(r))return e?this.flowKey&&(this.flowKey=!1):this.indentNext=this.indentValue+1,(yield*this.pushCount(1))+(yield*this.pushSpaces(!0))+(yield*this.pushIndicators())}}return 0}*pushTag(){if(this.charAt(1)==="<"){let e=this.pos+2,r=this.buffer[e];for(;!rt(r)&&r!==">";)r=this.buffer[++e];return yield*this.pushToIndex(r===">"?e+1:e,!1)}else{let e=this.pos+1,r=this.buffer[e];for(;r;)if(TN.includes(r))r=this.buffer[++e];else if(r==="%"&&_y.includes(this.buffer[e+1])&&_y.includes(this.buffer[e+2]))r=this.buffer[e+=3];else break;return yield*this.pushToIndex(e,!1)}}*pushNewline(){let e=this.buffer[this.pos];return e===`
`?yield*this.pushCount(1):e==="\r"&&this.charAt(1)===`
`?yield*this.pushCount(2):0}*pushSpaces(e){let r=this.pos-1,s;do s=this.buffer[++r];while(s===" "||e&&s==="	");let n=r-this.pos;return n>0&&(yield this.buffer.substr(this.pos,n),this.pos=r),n}*pushUntil(e){let r=this.pos,s=this.buffer[r];for(;!e(s);)s=this.buffer[++r];return yield*this.pushToIndex(r,!1)}};Sy.Lexer=of});var cf=w(Ey=>{"use strict";var lf=class{constructor(){this.lineStarts=[],this.addNewLine=e=>this.lineStarts.push(e),this.linePos=e=>{let r=0,s=this.lineStarts.length;for(;r<s;){let i=r+s>>1;this.lineStarts[i]<e?r=i+1:s=i}if(this.lineStarts[r]===e)return{line:r+1,col:1};if(r===0)return{line:0,col:e};let n=this.lineStarts[r-1];return{line:r,col:e-n+1}}}};Ey.LineCounter=lf});var ff=w(Dy=>{"use strict";var by=xo(),RN=af();function ut(t,e){for(let r=0;r<t.length;++r)if(t[r].type===e)return!0;return!1}function ky(t){for(let e=0;e<t.length;++e)switch(t[e].type){case"space":case"comment":case"newline":break;default:return e}return-1}function Oy(t){switch(t?.type){case"alias":case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":case"flow-collection":return!0;default:return!1}}function qo(t){switch(t.type){case"document":return t.start;case"block-map":{let e=t.items[t.items.length-1];return e.sep??e.start}case"block-seq":return t.items[t.items.length-1].start;default:return[]}}function as(t){if(t.length===0)return[];let e=t.length;e:for(;--e>=0;)switch(t[e].type){case"doc-start":case"explicit-key-ind":case"map-value-ind":case"seq-item-ind":case"newline":break e}for(;t[++e]?.type==="space";);return t.splice(e,t.length)}function vy(t){if(t.start.type==="flow-seq-start")for(let e of t.items)e.sep&&!e.value&&!ut(e.start,"explicit-key-ind")&&!ut(e.sep,"map-value-ind")&&(e.key&&(e.value=e.key),delete e.key,Oy(e.value)?e.value.end?Array.prototype.push.apply(e.value.end,e.sep):e.value.end=e.sep:Array.prototype.push.apply(e.start,e.sep),delete e.sep)}var uf=class{constructor(e){this.atNewLine=!0,this.atScalar=!1,this.indent=0,this.offset=0,this.onKeyLine=!1,this.stack=[],this.source="",this.type="",this.lexer=new RN.Lexer,this.onNewLine=e}*parse(e,r=!1){this.onNewLine&&this.offset===0&&this.onNewLine(0);for(let s of this.lexer.lex(e,r))yield*this.next(s);r||(yield*this.end())}*next(e){if(this.source=e,process.env.LOG_TOKENS&&console.log("|",by.prettyToken(e)),this.atScalar){this.atScalar=!1,yield*this.step(),this.offset+=e.length;return}let r=by.tokenType(e);if(r)if(r==="scalar")this.atNewLine=!1,this.atScalar=!0,this.type="scalar";else{switch(this.type=r,yield*this.step(),r){case"newline":this.atNewLine=!0,this.indent=0,this.onNewLine&&this.onNewLine(this.offset+e.length);break;case"space":this.atNewLine&&e[0]===" "&&(this.indent+=e.length);break;case"explicit-key-ind":case"map-value-ind":case"seq-item-ind":this.atNewLine&&(this.indent+=e.length);break;case"doc-mode":case"flow-error-end":return;default:this.atNewLine=!1}this.offset+=e.length}else{let s=`Not a YAML token: ${e}`;yield*this.pop({type:"error",offset:this.offset,message:s,source:e}),this.offset+=e.length}}*end(){for(;this.stack.length>0;)yield*this.pop()}get sourceToken(){return{type:this.type,offset:this.offset,indent:this.indent,source:this.source}}*step(){let e=this.peek(1);if(this.type==="doc-end"&&(!e||e.type!=="doc-end")){for(;this.stack.length>0;)yield*this.pop();this.stack.push({type:"doc-end",offset:this.offset,source:this.source});return}if(!e)return yield*this.stream();switch(e.type){case"document":return yield*this.document(e);case"alias":case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":return yield*this.scalar(e);case"block-scalar":return yield*this.blockScalar(e);case"block-map":return yield*this.blockMap(e);case"block-seq":return yield*this.blockSequence(e);case"flow-collection":return yield*this.flowCollection(e);case"doc-end":return yield*this.documentEnd(e)}yield*this.pop()}peek(e){return this.stack[this.stack.length-e]}*pop(e){let r=e??this.stack.pop();if(!r)yield{type:"error",offset:this.offset,source:"",message:"Tried to pop an empty stack"};else if(this.stack.length===0)yield r;else{let s=this.peek(1);switch(r.type==="block-scalar"?r.indent="indent"in s?s.indent:0:r.type==="flow-collection"&&s.type==="document"&&(r.indent=0),r.type==="flow-collection"&&vy(r),s.type){case"document":s.value=r;break;case"block-scalar":s.props.push(r);break;case"block-map":{let n=s.items[s.items.length-1];if(n.value){s.items.push({start:[],key:r,sep:[]}),this.onKeyLine=!0;return}else if(n.sep)n.value=r;else{Object.assign(n,{key:r,sep:[]}),this.onKeyLine=!ut(n.start,"explicit-key-ind");return}break}case"block-seq":{let n=s.items[s.items.length-1];n.value?s.items.push({start:[],value:r}):n.value=r;break}case"flow-collection":{let n=s.items[s.items.length-1];!n||n.value?s.items.push({start:[],key:r,sep:[]}):n.sep?n.value=r:Object.assign(n,{key:r,sep:[]});return}default:yield*this.pop(),yield*this.pop(r)}if((s.type==="document"||s.type==="block-map"||s.type==="block-seq")&&(r.type==="block-map"||r.type==="block-seq")){let n=r.items[r.items.length-1];n&&!n.sep&&!n.value&&n.start.length>0&&ky(n.start)===-1&&(r.indent===0||n.start.every(i=>i.type!=="comment"||i.indent<r.indent))&&(s.type==="document"?s.end=n.start:s.items.push({start:n.start}),r.items.splice(-1,1))}}}*stream(){switch(this.type){case"directive-line":yield{type:"directive",offset:this.offset,source:this.source};return;case"byte-order-mark":case"space":case"comment":case"newline":yield this.sourceToken;return;case"doc-mode":case"doc-start":{let e={type:"document",offset:this.offset,start:[]};this.type==="doc-start"&&e.start.push(this.sourceToken),this.stack.push(e);return}}yield{type:"error",offset:this.offset,message:`Unexpected ${this.type} token in YAML stream`,source:this.source}}*document(e){if(e.value)return yield*this.lineEnd(e);switch(this.type){case"doc-start":{ky(e.start)!==-1?(yield*this.pop(),yield*this.step()):e.start.push(this.sourceToken);return}case"anchor":case"tag":case"space":case"comment":case"newline":e.start.push(this.sourceToken);return}let r=this.startBlockValue(e);r?this.stack.push(r):yield{type:"error",offset:this.offset,message:`Unexpected ${this.type} token in YAML document`,source:this.source}}*scalar(e){if(this.type==="map-value-ind"){let r=qo(this.peek(2)),s=as(r),n;e.end?(n=e.end,n.push(this.sourceToken),delete e.end):n=[this.sourceToken];let i={type:"block-map",offset:e.offset,indent:e.indent,items:[{start:s,key:e,sep:n}]};this.onKeyLine=!0,this.stack[this.stack.length-1]=i}else yield*this.lineEnd(e)}*blockScalar(e){switch(this.type){case"space":case"comment":case"newline":e.props.push(this.sourceToken);return;case"scalar":if(e.source=this.source,this.atNewLine=!0,this.indent=0,this.onNewLine){let r=this.source.indexOf(`
`)+1;for(;r!==0;)this.onNewLine(this.offset+r),r=this.source.indexOf(`
`,r)+1}yield*this.pop();break;default:yield*this.pop(),yield*this.step()}}*blockMap(e){let r=e.items[e.items.length-1];switch(this.type){case"newline":if(this.onKeyLine=!1,r.value){let s="end"in r.value?r.value.end:void 0;(Array.isArray(s)?s[s.length-1]:void 0)?.type==="comment"?s?.push(this.sourceToken):e.items.push({start:[this.sourceToken]})}else r.sep?r.sep.push(this.sourceToken):r.start.push(this.sourceToken);return;case"space":case"comment":if(r.value)e.items.push({start:[this.sourceToken]});else if(r.sep)r.sep.push(this.sourceToken);else{if(this.atIndentedComment(r.start,e.indent)){let n=e.items[e.items.length-2]?.value?.end;if(Array.isArray(n)){Array.prototype.push.apply(n,r.start),n.push(this.sourceToken),e.items.pop();return}}r.start.push(this.sourceToken)}return}if(this.indent>=e.indent){let s=!this.onKeyLine&&this.indent===e.indent&&r.sep&&this.type!=="seq-item-ind",n=[];if(s&&r.sep&&!r.value){let i=[];for(let o=0;o<r.sep.length;++o){let a=r.sep[o];switch(a.type){case"newline":i.push(o);break;case"space":break;case"comment":a.indent>e.indent&&(i.length=0);break;default:i.length=0}}i.length>=2&&(n=r.sep.splice(i[1]))}switch(this.type){case"anchor":case"tag":s||r.value?(n.push(this.sourceToken),e.items.push({start:n}),this.onKeyLine=!0):r.sep?r.sep.push(this.sourceToken):r.start.push(this.sourceToken);return;case"explicit-key-ind":!r.sep&&!ut(r.start,"explicit-key-ind")?r.start.push(this.sourceToken):s||r.value?(n.push(this.sourceToken),e.items.push({start:n})):this.stack.push({type:"block-map",offset:this.offset,indent:this.indent,items:[{start:[this.sourceToken]}]}),this.onKeyLine=!0;return;case"map-value-ind":if(ut(r.start,"explicit-key-ind"))if(r.sep)if(r.value)e.items.push({start:[],key:null,sep:[this.sourceToken]});else if(ut(r.sep,"map-value-ind"))this.stack.push({type:"block-map",offset:this.offset,indent:this.indent,items:[{start:n,key:null,sep:[this.sourceToken]}]});else if(Oy(r.key)&&!ut(r.sep,"newline")){let i=as(r.start),o=r.key,a=r.sep;a.push(this.sourceToken),delete r.key,delete r.sep,this.stack.push({type:"block-map",offset:this.offset,indent:this.indent,items:[{start:i,key:o,sep:a}]})}else n.length>0?r.sep=r.sep.concat(n,this.sourceToken):r.sep.push(this.sourceToken);else if(ut(r.start,"newline"))Object.assign(r,{key:null,sep:[this.sourceToken]});else{let i=as(r.start);this.stack.push({type:"block-map",offset:this.offset,indent:this.indent,items:[{start:i,key:null,sep:[this.sourceToken]}]})}else r.sep?r.value||s?e.items.push({start:n,key:null,sep:[this.sourceToken]}):ut(r.sep,"map-value-ind")?this.stack.push({type:"block-map",offset:this.offset,indent:this.indent,items:[{start:[],key:null,sep:[this.sourceToken]}]}):r.sep.push(this.sourceToken):Object.assign(r,{key:null,sep:[this.sourceToken]});this.onKeyLine=!0;return;case"alias":case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":{let i=this.flowScalar(this.type);s||r.value?(e.items.push({start:n,key:i,sep:[]}),this.onKeyLine=!0):r.sep?this.stack.push(i):(Object.assign(r,{key:i,sep:[]}),this.onKeyLine=!0);return}default:{let i=this.startBlockValue(e);if(i){s&&i.type!=="block-seq"&&ut(r.start,"explicit-key-ind")&&e.items.push({start:n}),this.stack.push(i);return}}}}yield*this.pop(),yield*this.step()}*blockSequence(e){let r=e.items[e.items.length-1];switch(this.type){case"newline":if(r.value){let s="end"in r.value?r.value.end:void 0;(Array.isArray(s)?s[s.length-1]:void 0)?.type==="comment"?s?.push(this.sourceToken):e.items.push({start:[this.sourceToken]})}else r.start.push(this.sourceToken);return;case"space":case"comment":if(r.value)e.items.push({start:[this.sourceToken]});else{if(this.atIndentedComment(r.start,e.indent)){let n=e.items[e.items.length-2]?.value?.end;if(Array.isArray(n)){Array.prototype.push.apply(n,r.start),n.push(this.sourceToken),e.items.pop();return}}r.start.push(this.sourceToken)}return;case"anchor":case"tag":if(r.value||this.indent<=e.indent)break;r.start.push(this.sourceToken);return;case"seq-item-ind":if(this.indent!==e.indent)break;r.value||ut(r.start,"seq-item-ind")?e.items.push({start:[this.sourceToken]}):r.start.push(this.sourceToken);return}if(this.indent>e.indent){let s=this.startBlockValue(e);if(s){this.stack.push(s);return}}yield*this.pop(),yield*this.step()}*flowCollection(e){let r=e.items[e.items.length-1];if(this.type==="flow-error-end"){let s;do yield*this.pop(),s=this.peek(1);while(s&&s.type==="flow-collection")}else if(e.end.length===0){switch(this.type){case"comma":case"explicit-key-ind":!r||r.sep?e.items.push({start:[this.sourceToken]}):r.start.push(this.sourceToken);return;case"map-value-ind":!r||r.value?e.items.push({start:[],key:null,sep:[this.sourceToken]}):r.sep?r.sep.push(this.sourceToken):Object.assign(r,{key:null,sep:[this.sourceToken]});return;case"space":case"comment":case"newline":case"anchor":case"tag":!r||r.value?e.items.push({start:[this.sourceToken]}):r.sep?r.sep.push(this.sourceToken):r.start.push(this.sourceToken);return;case"alias":case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":{let n=this.flowScalar(this.type);!r||r.value?e.items.push({start:[],key:n,sep:[]}):r.sep?this.stack.push(n):Object.assign(r,{key:n,sep:[]});return}case"flow-map-end":case"flow-seq-end":e.end.push(this.sourceToken);return}let s=this.startBlockValue(e);s?this.stack.push(s):(yield*this.pop(),yield*this.step())}else{let s=this.peek(2);if(s.type==="block-map"&&(this.type==="map-value-ind"&&s.indent===e.indent||this.type==="newline"&&!s.items[s.items.length-1].sep))yield*this.pop(),yield*this.step();else if(this.type==="map-value-ind"&&s.type!=="flow-collection"){let n=qo(s),i=as(n);vy(e);let o=e.end.splice(1,e.end.length);o.push(this.sourceToken);let a={type:"block-map",offset:e.offset,indent:e.indent,items:[{start:i,key:e,sep:o}]};this.onKeyLine=!0,this.stack[this.stack.length-1]=a}else yield*this.lineEnd(e)}}flowScalar(e){if(this.onNewLine){let r=this.source.indexOf(`
`)+1;for(;r!==0;)this.onNewLine(this.offset+r),r=this.source.indexOf(`
`,r)+1}return{type:e,offset:this.offset,indent:this.indent,source:this.source}}startBlockValue(e){switch(this.type){case"alias":case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":return this.flowScalar(this.type);case"block-scalar-header":return{type:"block-scalar",offset:this.offset,indent:this.indent,props:[this.sourceToken],source:""};case"flow-map-start":case"flow-seq-start":return{type:"flow-collection",offset:this.offset,indent:this.indent,start:this.sourceToken,items:[],end:[]};case"seq-item-ind":return{type:"block-seq",offset:this.offset,indent:this.indent,items:[{start:[this.sourceToken]}]};case"explicit-key-ind":{this.onKeyLine=!0;let r=qo(e),s=as(r);return s.push(this.sourceToken),{type:"block-map",offset:this.offset,indent:this.indent,items:[{start:s}]}}case"map-value-ind":{this.onKeyLine=!0;let r=qo(e),s=as(r);return{type:"block-map",offset:this.offset,indent:this.indent,items:[{start:s,key:null,sep:[this.sourceToken]}]}}}return null}atIndentedComment(e,r){return this.type!=="comment"||this.indent<=r?!1:e.every(s=>s.type==="newline"||s.type==="space")}*documentEnd(e){this.type!=="doc-mode"&&(e.end?e.end.push(this.sourceToken):e.end=[this.sourceToken],this.type==="newline"&&(yield*this.pop()))}*lineEnd(e){switch(this.type){case"comma":case"doc-start":case"doc-end":case"flow-seq-end":case"flow-map-end":case"map-value-ind":yield*this.pop(),yield*this.step();break;case"newline":this.onKeyLine=!1;default:e.end?e.end.push(this.sourceToken):e.end=[this.sourceToken],this.type==="newline"&&(yield*this.pop())}}};Dy.Parser=uf});var Ny=w(Rn=>{"use strict";var Ty=Hu(),CN=Sn(),In=kn(),NN=Qc(),AN=cf(),Iy=ff();function Ry(t){let e=t.prettyErrors!==!1;return{lineCounter:t.lineCounter||e&&new AN.LineCounter||null,prettyErrors:e}}function PN(t,e={}){let{lineCounter:r,prettyErrors:s}=Ry(e),n=new Iy.Parser(r?.addNewLine),i=new Ty.Composer(e),o=Array.from(i.compose(n.parse(t)));if(s&&r)for(let a of o)a.errors.forEach(In.prettifyError(t,r)),a.warnings.forEach(In.prettifyError(t,r));return o.length>0?o:Object.assign([],{empty:!0},i.streamInfo())}function Cy(t,e={}){let{lineCounter:r,prettyErrors:s}=Ry(e),n=new Iy.Parser(r?.addNewLine),i=new Ty.Composer(e),o=null;for(let a of i.compose(n.parse(t),!0,t.length))if(!o)o=a;else if(o.options.logLevel!=="silent"){o.errors.push(new In.YAMLParseError(a.range.slice(0,2),"MULTIPLE_DOCS","Source contains multiple documents; please use YAML.parseAllDocuments()"));break}return s&&r&&(o.errors.forEach(In.prettifyError(t,r)),o.warnings.forEach(In.prettifyError(t,r))),o}function LN(t,e,r){let s;typeof e=="function"?s=e:r===void 0&&e&&typeof e=="object"&&(r=e);let n=Cy(t,r);if(!n)return null;if(n.warnings.forEach(i=>NN.warn(n.options.logLevel,i)),n.errors.length>0){if(n.options.logLevel!=="silent")throw n.errors[0];n.errors=[]}return n.toJS(Object.assign({reviver:s},r))}function xN(t,e,r){let s=null;if(typeof e=="function"||Array.isArray(e)?s=e:r===void 0&&e&&(r=e),typeof r=="string"&&(r=r.length),typeof r=="number"){let n=Math.round(r);r=n<1?void 0:n>8?{indent:8}:{indent:n}}if(t===void 0){let{keepUndefined:n}=r??e??{};if(!n)return}return new CN.Document(t,s,r).toString(r)}Rn.parse=LN;Rn.parseAllDocuments=PN;Rn.parseDocument=Cy;Rn.stringify=xN});var Py=w(J=>{"use strict";var qN=Hu(),MN=Sn(),BN=Ru(),df=kn(),$N=on(),er=Q(),WN=Jt(),UN=we(),FN=Xt(),zN=Zt(),jN=xo(),VN=af(),GN=cf(),QN=ff(),Mo=Ny(),Ay=tn();J.Composer=qN.Composer;J.Document=MN.Document;J.Schema=BN.Schema;J.YAMLError=df.YAMLError;J.YAMLParseError=df.YAMLParseError;J.YAMLWarning=df.YAMLWarning;J.Alias=$N.Alias;J.isAlias=er.isAlias;J.isCollection=er.isCollection;J.isDocument=er.isDocument;J.isMap=er.isMap;J.isNode=er.isNode;J.isPair=er.isPair;J.isScalar=er.isScalar;J.isSeq=er.isSeq;J.Pair=WN.Pair;J.Scalar=UN.Scalar;J.YAMLMap=FN.YAMLMap;J.YAMLSeq=zN.YAMLSeq;J.CST=jN;J.Lexer=VN.Lexer;J.LineCounter=GN.LineCounter;J.Parser=QN.Parser;J.parse=Mo.parse;J.parseAllDocuments=Mo.parseAllDocuments;J.parseDocument=Mo.parseDocument;J.stringify=Mo.stringify;J.visit=Ay.visit;J.visitAsync=Ay.visitAsync});var Fy=w(Z=>{"use strict";var hf=Z&&Z.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(Z,"__esModule",{value:!0});Z.overwriteConfigForDBOSCloud=Z.translateRuntimeConfig=Z.getRuntimeConfig=Z.translateDbosConfig=Z.getDbosConfig=Z.getSystemDatabaseUrl=Z.isValidDatabaseName=Z.writeConfigFile=Z.readConfigFile=Z.substituteEnvVars=Z.dbosConfigFilePath=void 0;var KN=Oe(),qy=hf(Py()),HN=require("fs"),Ly=hf(require("path")),pf=hf(require("assert")),JN=ki(),YN=Ot();Z.dbosConfigFilePath="dbos-config.yaml";function My(t){let e=/\${([^}]+)}/g;return t.replace(e,(r,s)=>process.env[s]||'""')}Z.substituteEnvVars=My;async function XN(t){t??=process.cwd();let e=Ly.default.join(t,Z.dbosConfigFilePath),r=await n(e),s=r?qy.default.parse(My(r)):{};if(!s.name){let i=Ly.default.join(t,"package.json"),o=await n(i),a=o?JSON.parse(o):{};s.name=a.name}return s;async function n(i){try{return await(0,KN.readFile)(i)}catch(o){if(o&&typeof o=="object"&&"code"in o&&o.code==="ENOENT")return;throw o}}}Z.readConfigFile=XN;function ZN(t,e){try{let r=qy.default.stringify(t);(0,HN.writeFileSync)(e,r)}catch(r){throw r instanceof Error?new Error(`Failed to write config to ${e}: ${r.message}`):r}}Z.writeConfigFile=ZN;function By(t){return!(t.length<1||t.length>63)}Z.isValidDatabaseName=By;function $y(t){let e=t.system_database_url||i(t.name),r=new URL(e),s=r.pathname.slice(1),n=[];if(r.username||n.push("username"),r.hostname||n.push("hostname"),s||n.push("database name"),n.length>0)throw new Error(`Invalid database URL: missing required field(s): ${n.join(", ")}`);if(!By(s))throw new Error(`Database name "${s}" in database_url ${(0,JN.maskDatabaseUrl)(e)} is invalid.`);return e;function i(a){(0,pf.default)(a,"Application name must be defined to construct a valid database URL.");let l=process.env.PGHOST||"localhost",c=process.env.PGPORT||"5432",u=process.env.PGUSER||"postgres",f=process.env.PGPASSWORD||"dbos",d=o(a)+"_dbos_sys",p=process.env.PGCONNECT_TIMEOUT||"10",m=process.env.PGSSLMODE||(l==="localhost"?"disable":"allow"),h=new URL("postgresql://host/database");return h.username=u,h.password=f,h.hostname=l,h.port=c,h.protocol="postgresql",h.pathname=`/${d}`,h.searchParams.set("connect_timeout",p),h.searchParams.set("sslmode",m),h.toString()}function o(a){let l=a.toLowerCase().replaceAll("-","_").replaceAll(" ","_");return l.match(/^\d/)?"_"+l:l}}Z.getSystemDatabaseUrl=$y;function eA(t,e={}){return(0,pf.default)(t.language===void 0||t.language==="node",`Config file specifies invalid language ${t.language}`),Wy({name:t.name,systemDatabaseUrl:t.system_database_url,systemDatabaseSchemaName:t.system_database_schema_name,logLevel:e.logLevel??t.telemetry?.logs?.logLevel,addContextMetadata:t.telemetry?.logs?.addContextMetadata,otlpTracesEndpoints:xy(t.telemetry?.OTLPExporter?.tracesEndpoint),otlpLogsEndpoints:xy(t.telemetry?.OTLPExporter?.logsEndpoint),runAdminServer:t.runtimeConfig?.runAdminServer,adminPort:t.runtimeConfig?.admin_port},e.forceConsole)}Z.getDbosConfig=eA;function xy(t){return t?Array.isArray(t)?t:[t]:[]}function Wy(t,e=!1){let r=$y({system_database_url:t.systemDatabaseUrl,name:t.name});return{name:t.name,systemDatabaseUrl:r,sysDbPoolSize:t.systemDatabasePoolSize,systemDatabasePool:t.systemDatabasePool,systemDatabaseSchemaName:t.systemDatabaseSchemaName??"dbos",serializer:t.serializer??YN.DBOSJSON,telemetry:{logs:{logLevel:t.logLevel||"info",addContextMetadata:t.addContextMetadata,forceConsole:e},OTLPExporter:{tracesEndpoint:t.otlpTracesEndpoints,logsEndpoint:t.otlpLogsEndpoints}}}}Z.translateDbosConfig=Wy;function tA(t){return Uy(t.runtimeConfig)}Z.getRuntimeConfig=tA;function Uy(t={}){return{runAdminServer:t.runAdminServer??!0,admin_port:t.admin_port??t.adminPort??3001,start:t.start??[],setup:t.setup??[]}}Z.translateRuntimeConfig=Uy;function rA(t,e,r){let s=process.env.DBOS_SYSTEM_DATABASE_URL;(0,pf.default)(s,"DBOS_SYSTEM_DATABASE_URL must be set in DBOS Cloud environment");let n=r.name??t.name,i=new Set(t.telemetry.OTLPExporter?.logsEndpoint),o=r.telemetry?.OTLPExporter?.logsEndpoint;o&&(Array.isArray(o)?o.forEach(f=>i.add(f)):i.add(o));let a=new Set(t.telemetry.OTLPExporter?.tracesEndpoint),l=r.telemetry?.OTLPExporter?.tracesEndpoint;l&&(Array.isArray(l)?l.forEach(f=>a.add(f)):a.add(l));let c={...t,name:n,systemDatabaseUrl:s,systemDatabaseSchemaName:r.system_database_schema_name??t.systemDatabaseSchemaName,telemetry:{logs:{...t.telemetry.logs},OTLPExporter:{logsEndpoint:Array.from(i).filter(f=>!!f),tracesEndpoint:Array.from(a).filter(f=>!!f)}}},u={...e,admin_port:3001,runAdminServer:!0};return[c,u]}Z.overwriteConfigForDBOSCloud=rA});var Jf=w(O=>{"use strict";Object.defineProperty(O,"__esModule",{value:!0});O.AlertResponse=O.ImportWorkflowResponse=O.ImportWorkflowRequest=O.ExportWorkflowResponse=O.ExportWorkflowRequest=O.GetMetricsResponse=O.MetricDataOutput=O.GetMetricsRequest=O.RetentionResponse=O.RetentionRequest=O.ForkWorkflowResponse=O.ForkWorkflowRequest=O.ListStepsResponse=O.ListStepsRequest=O.ExistPendingWorkflowsResponse=O.ExistPendingWorkflowsRequest=O.GetWorkflowResponse=O.GetWorkflowRequest=O.ListQueuedWorkflowsResponse=O.ListQueuedWorkflowsRequest=O.ListWorkflowsResponse=O.ListWorkflowsRequest=O.WorkflowSteps=O.WorkflowsOutput=O.RestartResponse=O.RestartRequest=O.ResumeResponse=O.ResumeRequest=O.DeleteResponse=O.DeleteRequest=O.CancelResponse=O.CancelRequest=O.RecoveryResponse=O.RecoveryRequest=O.ExecutorInfoResponse=O.BaseResponse=O.MessageType=void 0;var zy=Wn(),U;(function(t){t.EXECUTOR_INFO="executor_info",t.RECOVERY="recovery",t.CANCEL="cancel",t.DELETE="delete",t.LIST_WORKFLOWS="list_workflows",t.LIST_QUEUED_WORKFLOWS="list_queued_workflows",t.RESUME="resume",t.RESTART="restart",t.GET_WORKFLOW="get_workflow",t.EXIST_PENDING_WORKFLOWS="exist_pending_workflows",t.LIST_STEPS="list_steps",t.FORK_WORKFLOW="fork_workflow",t.RETENTION="retention",t.GET_METRICS="get_metrics",t.EXPORT_WORKFLOW="export_workflow",t.IMPORT_WORKFLOW="import_workflow",t.ALERT="alert"})(U||(O.MessageType=U={}));var ge=class{type;request_id;error_message;constructor(e,r,s){this.type=e,this.request_id=r,this.error_message=s}};O.BaseResponse=ge;var mf=class extends ge{executor_id;application_version;hostname;language;dbos_version;constructor(e,r,s,n,i,o,a){super(U.EXECUTOR_INFO,e,a),this.executor_id=r,this.application_version=s,this.hostname=n,this.language=i,this.dbos_version=o}};O.ExecutorInfoResponse=mf;var wf=class{type=U.RECOVERY;request_id;executor_ids;constructor(e,r){this.request_id=e,this.executor_ids=r}};O.RecoveryRequest=wf;var gf=class extends ge{success;constructor(e,r,s){super(U.RECOVERY,e,s),this.success=r}};O.RecoveryResponse=gf;var yf=class{type=U.CANCEL;request_id;workflow_id;constructor(e,r){this.request_id=e,this.workflow_id=r}};O.CancelRequest=yf;var _f=class extends ge{success;constructor(e,r,s){super(U.CANCEL,e,s),this.success=r}};O.CancelResponse=_f;var Sf=class{type=U.DELETE;request_id;workflow_id;delete_children;constructor(e,r,s=!1){this.request_id=e,this.workflow_id=r,this.delete_children=s}};O.DeleteRequest=Sf;var Ef=class extends ge{success;constructor(e,r,s){super(U.DELETE,e,s),this.success=r}};O.DeleteResponse=Ef;var bf=class{type=U.RESUME;request_id;workflow_id;constructor(e,r){this.request_id=e,this.workflow_id=r}};O.ResumeRequest=bf;var kf=class extends ge{success;constructor(e,r,s){super(U.RESUME,e,s),this.success=r}};O.ResumeResponse=kf;var vf=class{type=U.RESTART;request_id;workflow_id;constructor(e,r){this.request_id=e,this.workflow_id=r}};O.RestartRequest=vf;var Of=class extends ge{success;constructor(e,r,s){super(U.RESTART,e,s),this.success=r}};O.RestartResponse=Of;var Df=class{WorkflowUUID;Status;WorkflowName;WorkflowClassName;WorkflowConfigName;AuthenticatedUser;AssumedRole;AuthenticatedRoles;Input;Output;Error;CreatedAt;UpdatedAt;QueueName;ApplicationVersion;ExecutorID;WorkflowTimeoutMS;WorkflowDeadlineEpochMS;DeduplicationID;Priority;QueuePartitionKey;DequeuedAt;ForkedFrom;ParentWorkflowID;constructor(e){this.WorkflowUUID=e.workflowID,this.Status=e.status,this.WorkflowName=e.workflowName,this.WorkflowClassName=e.workflowClassName?e.workflowClassName:void 0,this.WorkflowConfigName=e.workflowConfigName?e.workflowConfigName:void 0,this.AuthenticatedUser=e.authenticatedUser?e.authenticatedUser:void 0,this.AssumedRole=e.assumedRole?e.assumedRole:void 0,this.AuthenticatedRoles=(e.authenticatedRoles??[]).length>0?JSON.stringify(e.authenticatedRoles):void 0,this.Input=e.input?JSON.stringify(e.input):void 0,this.Output=e.output?JSON.stringify(e.output):void 0,this.Error=e.error?JSON.stringify((0,zy.serializeError)(e.error)):void 0,this.CreatedAt=e.createdAt?String(e.createdAt):void 0,this.UpdatedAt=e.updatedAt?String(e.updatedAt):void 0,this.QueueName=e.queueName?e.queueName:void 0,this.ApplicationVersion=e.applicationVersion,this.ExecutorID=e.executorId,this.WorkflowTimeoutMS=e.timeoutMS!==void 0?String(e.timeoutMS):void 0,this.WorkflowDeadlineEpochMS=e.deadlineEpochMS!==void 0?String(e.deadlineEpochMS):void 0,this.DeduplicationID=e.deduplicationID,this.Priority=String(e.priority),this.QueuePartitionKey=e.queuePartitionKey,this.DequeuedAt=e.dequeuedAt!==void 0?String(e.dequeuedAt):void 0,this.ForkedFrom=e.forkedFrom,this.ParentWorkflowID=e.parentWorkflowID}};O.WorkflowsOutput=Df;var Tf=class{function_id;function_name;output;error;child_workflow_id;started_at_epoch_ms;completed_at_epoch_ms;constructor(e){this.function_id=e.functionID,this.function_name=e.name,this.output=e.output?JSON.stringify(e.output):void 0,this.error=e.error?JSON.stringify((0,zy.serializeError)(e.error)):void 0,this.child_workflow_id=e.childWorkflowID??void 0,this.started_at_epoch_ms=e.startedAtEpochMs!==void 0?String(e.startedAtEpochMs):void 0,this.completed_at_epoch_ms=e.completedAtEpochMs!==void 0?String(e.completedAtEpochMs):void 0}};O.WorkflowSteps=Tf;var If=class{type=U.LIST_WORKFLOWS;request_id;body;constructor(e,r){this.request_id=e,this.body=r}};O.ListWorkflowsRequest=If;var Rf=class extends ge{output;constructor(e,r,s){super(U.LIST_WORKFLOWS,e,s),this.output=r}};O.ListWorkflowsResponse=Rf;var Cf=class{type=U.LIST_QUEUED_WORKFLOWS;request_id;body;constructor(e,r){this.request_id=e,this.body=r}};O.ListQueuedWorkflowsRequest=Cf;var Nf=class extends ge{output;constructor(e,r,s){super(U.LIST_QUEUED_WORKFLOWS,e,s),this.output=r}};O.ListQueuedWorkflowsResponse=Nf;var Af=class{type=U.GET_WORKFLOW;request_id;workflow_id;constructor(e,r){this.request_id=e,this.workflow_id=r}};O.GetWorkflowRequest=Af;var Pf=class extends ge{output;constructor(e,r,s){super(U.GET_WORKFLOW,e,s),this.output=r}};O.GetWorkflowResponse=Pf;var Lf=class{type=U.EXIST_PENDING_WORKFLOWS;request_id;executor_id;application_version;constructor(e,r,s){this.request_id=e,this.executor_id=r,this.application_version=s}};O.ExistPendingWorkflowsRequest=Lf;var xf=class extends ge{exist;constructor(e,r,s){super(U.EXIST_PENDING_WORKFLOWS,e,s),this.exist=r}};O.ExistPendingWorkflowsResponse=xf;var qf=class{type=U.LIST_STEPS;request_id;workflow_id;constructor(e,r){this.request_id=e,this.workflow_id=r}};O.ListStepsRequest=qf;var Mf=class extends ge{output;constructor(e,r,s){super(U.LIST_STEPS,e,s),this.output=r}};O.ListStepsResponse=Mf;var Bf=class{type=U.FORK_WORKFLOW;request_id;body;constructor(e,r){this.request_id=e,this.body=r}};O.ForkWorkflowRequest=Bf;var $f=class extends ge{new_workflow_id;constructor(e,r,s){super(U.FORK_WORKFLOW,e,s),this.new_workflow_id=r}};O.ForkWorkflowResponse=$f;var Wf=class{type=U.RETENTION;request_id;body;constructor(e,r){this.request_id=e,this.body=r}};O.RetentionRequest=Wf;var Uf=class extends ge{success;constructor(e,r,s){super(U.RETENTION,e,s),this.success=r}};O.RetentionResponse=Uf;var Ff=class{type=U.GET_METRICS;request_id;start_time;end_time;metric_class;constructor(e,r,s,n){this.request_id=e,this.start_time=r,this.end_time=s,this.metric_class=n}};O.GetMetricsRequest=Ff;var zf=class{metric_type;metric_name;value;constructor(e,r,s){this.metric_type=e,this.metric_name=r,this.value=s}};O.MetricDataOutput=zf;var jf=class extends ge{metrics;constructor(e,r,s){super(U.GET_METRICS,e,s),this.metrics=r}};O.GetMetricsResponse=jf;var Vf=class{type=U.EXPORT_WORKFLOW;request_id;workflow_id;export_children;constructor(e,r,s=!1){this.request_id=e,this.workflow_id=r,this.export_children=s}};O.ExportWorkflowRequest=Vf;var Gf=class extends ge{serialized_workflow;constructor(e,r,s){super(U.EXPORT_WORKFLOW,e,s),this.serialized_workflow=r}};O.ExportWorkflowResponse=Gf;var Qf=class{type=U.IMPORT_WORKFLOW;request_id;serialized_workflow;constructor(e,r){this.request_id=e,this.serialized_workflow=r}};O.ImportWorkflowRequest=Qf;var Kf=class extends ge{success;constructor(e,r,s){super(U.IMPORT_WORKFLOW,e,s),this.success=r}};O.ImportWorkflowResponse=Kf;var Hf=class extends ge{success;constructor(e,r,s){super(U.ALERT,e,s),this.success=r}};O.AlertResponse=Hf});var Qy=w(j=>{"use strict";var sA=j&&j.__createBinding||(Object.create?(function(t,e,r,s){s===void 0&&(s=r);var n=Object.getOwnPropertyDescriptor(e,r);(!n||("get"in n?!e.__esModule:n.writable||n.configurable))&&(n={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,s,n)}):(function(t,e,r,s){s===void 0&&(s=r),t[s]=e[r]})),nA=j&&j.__setModuleDefault||(Object.create?(function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}):function(t,e){t.default=e}),Wo=j&&j.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(t!=null)for(var r in t)r!=="default"&&Object.prototype.hasOwnProperty.call(t,r)&&sA(e,t,r);return nA(e,t),e};Object.defineProperty(j,"__esModule",{value:!0});j.DBOSAdminServer=j.WorkflowQueuesMetadataUrl=j.DeactivateUrl=j.PerfUrl=j.HealthUrl=j.WorkflowRecoveryUrl=j.WorkflowUUIDHeader=void 0;var iA=Wo(require("http")),oA=Wo(require("url")),jy=He(),aA=Wo(require("net")),Yf=require("perf_hooks"),Vy=Oe(),lA=Vs(),cA=Js(),Bo=Wo(Jf());j.WorkflowUUIDHeader="dbos-idempotency-key";j.WorkflowRecoveryUrl="/dbos-workflow-recovery";j.HealthUrl="/dbos-healthz";j.PerfUrl="/dbos-perf";j.DeactivateUrl="/deactivate";j.WorkflowQueuesMetadataUrl="/dbos-workflow-queues-metadata";async function ls(t){return new Promise((e,r)=>{let s="";t.on("data",n=>{s+=String(n)}),t.on("end",()=>{try{e(s?JSON.parse(s):{})}catch{r(new Error("Invalid JSON"))}}),t.on("error",r)})}function ze(t,e,r){t.writeHead(e,{"Content-Type":"application/json","Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type"}),t.end(JSON.stringify(r))}function Gy(t,e,r){t.writeHead(e,{"Content-Type":"text/plain","Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type"}),t.end(r)}function $o(t){t.writeHead(204,{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type"}),t.end()}function uA(t,e){let r=t.split("/"),s=e.split("/");if(r.length!==s.length)return null;let n={};for(let i=0;i<r.length;i++){let o=r[i],a=s[i];if(o.startsWith(":")){let l=o.substring(1);n[l]=a}else if(o!==a)return null}return n}var Xf=class t{static setupAdminApp(e){let r=[];return t.registerHealthEndpoint(e,r),t.registerRecoveryEndpoint(e,r),t.registerPerfEndpoint(e,r),t.registerDeactivateEndpoint(e,r),t.registerCancelWorkflowEndpoint(e,r),t.registerResumeWorkflowEndpoint(e,r),t.registerRestartWorkflowEndpoint(e,r),t.registerQueueMetadataEndpoint(e,r),t.registerListWorkflowStepsEndpoint(e,r),t.registerListWorkflowsEndpoint(e,r),t.registerListQueuedWorkflowsEndpoint(e,r),t.registerGetWorkflowEndpoint(e,r),t.registerForkWorkflowEndpoint(e,r),t.registerGarbageCollectEndpoint(e,r),t.registerGlobalTimeoutEndpoint(e,r),iA.createServer(async(n,i)=>{if(n.method==="OPTIONS"){i.writeHead(200,{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type","Access-Control-Max-Age":"86400"}),i.end();return}let a=oA.parse(n.url||"",!0).pathname||"",l=!1;for(let c of r)if(n.method===c.method){let u=uA(c.path,a);if(u!==null){l=!0;try{await c.handler(n,i,u)}catch(f){e.logger.error(`Request handler error: ${String(f)}`),ze(i,500,{error:"Internal server error"})}break}}l||(i.writeHead(404,{"Content-Type":"text/plain"}),i.end("Not Found"))})}static async checkPortAvailabilityIPv4Ipv6(e,r){try{await this.checkPortAvailability(e,"127.0.0.1")}catch(s){let n=s;if(n.code==="EADDRINUSE")throw r.warn(`Port ${e} is already used for IPv4 address "127.0.0.1". Please use the -p option to choose another port.
${n.message}`),s;r.warn(`Error occurred while checking port availability for IPv4 address "127.0.0.1" : ${n.code}
${n.message}`)}try{await this.checkPortAvailability(e,"::1")}catch(s){let n=s;if(n.code==="EADDRINUSE")throw r.warn(`Port ${e} is already used for IPv6 address "::1". Please use the -p option to choose another port.
${n.message}`),s;r.warn(`Error occurred while checking port availability for IPv6 address "::1" : ${n.code}
${n.message}`)}}static async checkPortAvailability(e,r){return new Promise((s,n)=>{let i=new aA.Server;i.on("error",o=>{n(o)}),i.on("listening",()=>{i.close(),s()}),i.listen({port:e,host:r},()=>{s()})})}static registerHealthEndpoint(e,r){r.push({method:"GET",path:j.HealthUrl,handler:async(s,n)=>(Gy(n,200,"healthy"),Promise.resolve())}),e.logger.debug(`DBOS Server Registered Healthz GET ${j.HealthUrl}`)}static registerQueueMetadataEndpoint(e,r){r.push({method:"GET",path:j.WorkflowQueuesMetadataUrl,handler:async(s,n)=>{let i=[];return lA.wfQueueRunner.wfQueuesByName.forEach((o,a)=>{i.push({name:a,concurrency:o.concurrency,workerConcurrency:o.workerConcurrency,rateLimit:o.rateLimit})}),ze(n,200,i),Promise.resolve()}}),e.logger.debug(`DBOS Server Registered Queue Metadata GET ${j.WorkflowQueuesMetadataUrl}`)}static registerRecoveryEndpoint(e,r){r.push({method:"POST",path:j.WorkflowRecoveryUrl,handler:async(s,n)=>{let i=await ls(s);e.logger.info("Recovering workflows for executors: "+i.toString());let o=await e.recoverPendingWorkflows(i),a=await Promise.allSettled(o.map(l=>l.workflowID)).then(l=>l.filter(c=>c.status==="fulfilled").map(c=>c.value));ze(n,200,a)}}),e.logger.debug(`DBOS Server Registered Recovery POST ${j.WorkflowRecoveryUrl}`)}static lastELU=Yf.performance.eventLoopUtilization();static registerPerfEndpoint(e,r){r.push({method:"GET",path:j.PerfUrl,handler:async(s,n)=>{let i=Yf.performance.eventLoopUtilization(),o=Yf.performance.eventLoopUtilization(i,t.lastELU);return ze(n,200,o),t.lastELU=i,Promise.resolve()}}),e.logger.debug(`DBOS Server Registered Perf GET ${j.PerfUrl}`)}static isDeactivated=!1;static registerDeactivateEndpoint(e,r){r.push({method:"GET",path:j.DeactivateUrl,handler:async(s,n)=>{t.isDeactivated||(e.logger.info(`Deactivating DBOS executor ${Vy.globalParams.executorID} with version ${Vy.globalParams.appVersion}. This executor will complete existing workflows but will not create new workflows.`),t.isDeactivated=!0),await e.deactivateEventReceivers(!1),Gy(n,200,"Deactivated")}}),e.logger.debug(`DBOS Server Registered Deactivate GET ${j.DeactivateUrl}`)}static registerGarbageCollectEndpoint(e,r){r.push({method:"POST",path:"/dbos-garbage-collect",handler:async(n,i)=>{let o=await ls(n);await e.systemDatabase.garbageCollect(o.cutoff_epoch_timestamp_ms,o.rows_threshold),$o(i)}})}static registerGlobalTimeoutEndpoint(e,r){r.push({method:"POST",path:"/dbos-global-timeout",handler:async(n,i)=>{let o=await ls(n);await(0,cA.globalTimeout)(e.systemDatabase,o.cutoff_epoch_timestamp_ms),$o(i)}})}static registerCancelWorkflowEndpoint(e,r){let s="/workflows/:workflow_id/cancel";r.push({method:"POST",path:s,handler:async(n,i,o)=>{let a=o.workflow_id;await e.cancelWorkflow(a),$o(i)}}),e.logger.debug(`DBOS Server Registered Cancel Workflow POST ${s}`)}static registerResumeWorkflowEndpoint(e,r){let s="/workflows/:workflow_id/resume";r.push({method:"POST",path:s,handler:async(n,i,o)=>{let a=o.workflow_id;e.logger.info(`Resuming workflow with ID: ${a}`);try{await e.resumeWorkflow(a),$o(i)}catch(l){let c="";l instanceof jy.DBOSError?c=l.message:c="Unknown error",e.logger.error(`Error resuming workflow ${a}: ${c}`),ze(i,500,{error:`Error resuming workflow ${a}: ${c}`})}}}),e.logger.debug(`DBOS Server Registered Resume Workflow POST ${s}`)}static registerRestartWorkflowEndpoint(e,r){let s="/workflows/:workflow_id/restart";r.push({method:"POST",path:s,handler:async(n,i,o)=>{let a=o.workflow_id;e.logger.info(`Restarting workflow: ${a} with a new id`);let l=await e.forkWorkflow(a,0);ze(i,200,{workflow_id:l})}}),e.logger.debug(`DBOS Server Registered Restart Workflow POST ${s}`)}static registerForkWorkflowEndpoint(e,r){let s="/workflows/:workflow_id/fork";r.push({method:"POST",path:s,handler:async(n,i,o)=>{let a=o.workflow_id,l=await ls(n);if(l.start_step===void 0){ze(i,400,{error:"Missing start_step in request body"});return}e.logger.info(`Forking workflow: ${a} from step ${l.start_step} with a new id`);try{let c=await e.forkWorkflow(a,l.start_step,{newWorkflowID:l.new_workflow_id,applicationVersion:l.application_version,timeoutMS:l.timeout_ms});ze(i,200,{workflow_id:c})}catch(c){let u="";c instanceof jy.DBOSError?u=c.message:u="Unknown error",e.logger.error(`Error forking workflow ${a}: ${u}`),ze(i,500,{error:`Error forking workflow ${a}: ${u}`})}}}),e.logger.debug(`DBOS Server Registered Fork Workflow POST ${s}`)}static registerListWorkflowStepsEndpoint(e,r){let s="/workflows/:workflow_id/steps";r.push({method:"GET",path:s,handler:async(n,i,o)=>{let a=o.workflow_id,c=(await e.listWorkflowSteps(a))?.map(u=>new Bo.WorkflowSteps(u));ze(i,200,c)}}),e.logger.debug(`DBOS Server Registered List Workflow steps Get ${s}`)}static registerListWorkflowsEndpoint(e,r){let s="/workflows";r.push({method:"POST",path:s,handler:async(n,i)=>{let o=await ls(n),a={workflowIDs:o.workflow_uuids,workflowName:o.workflow_name,authenticatedUser:o.authenticated_user,startTime:o.start_time,endTime:o.end_time,status:o.status,applicationVersion:o.application_version,forkedFrom:o.fork_from,parentWorkflowID:o.parent_workflow_id,limit:o.limit,offset:o.offset,sortDesc:o.sort_desc,workflow_id_prefix:o.workflow_id_prefix,loadInput:o.load_input??!1,loadOutput:o.load_output??!1},c=(await e.listWorkflows(a)).map(u=>new Bo.WorkflowsOutput(u));ze(i,200,c)}}),e.logger.debug(`DBOS Server Registered List Workflows POST ${s}`)}static registerListQueuedWorkflowsEndpoint(e,r){let s="/queues";r.push({method:"POST",path:s,handler:async(n,i)=>{let o=await ls(n),a={workflowName:o.workflow_name,startTime:o.start_time,endTime:o.end_time,status:o.status,forkedFrom:o.fork_from,parentWorkflowID:o.parent_workflow_id,queueName:o.queue_name,limit:o.limit,offset:o.offset,sortDesc:o.sort_desc,loadInput:o.load_input??!1},c=(await e.listQueuedWorkflows(a)).map(u=>new Bo.WorkflowsOutput(u));ze(i,200,c)}}),e.logger.debug(`DBOS Server Registered List Queued Workflows POST ${s}`)}static registerGetWorkflowEndpoint(e,r){let s="/workflows/:workflow_id";r.push({method:"GET",path:s,handler:async(n,i,o)=>{let a=o.workflow_id,l=await e.getWorkflowStatus(a);if(l){let c=new Bo.WorkflowsOutput(l);ze(i,200,c)}else ze(i,404,{error:`Workflow ${a} not found`})}}),e.logger.debug(`DBOS Server Registered Get Workflow GET ${s}`)}};j.DBOSAdminServer=Xf});var Nt=w((Xx,Jy)=>{"use strict";var Ky=["nodebuffer","arraybuffer","fragments"],Hy=typeof Blob<"u";Hy&&Ky.push("blob");Jy.exports={BINARY_TYPES:Ky,CLOSE_TIMEOUT:3e4,EMPTY_BUFFER:Buffer.alloc(0),GUID:"258EAFA5-E914-47DA-95CA-C5AB0DC85B11",hasBlob:Hy,kForOnEventAttribute:Symbol("kIsForOnEventAttribute"),kListener:Symbol("kListener"),kStatusCode:Symbol("status-code"),kWebSocket:Symbol("websocket"),NOOP:()=>{}}});var Cn=w((Zx,Uo)=>{"use strict";var{EMPTY_BUFFER:fA}=Nt(),Zf=Buffer[Symbol.species];function dA(t,e){if(t.length===0)return fA;if(t.length===1)return t[0];let r=Buffer.allocUnsafe(e),s=0;for(let n=0;n<t.length;n++){let i=t[n];r.set(i,s),s+=i.length}return s<e?new Zf(r.buffer,r.byteOffset,s):r}function Yy(t,e,r,s,n){for(let i=0;i<n;i++)r[s+i]=t[i]^e[i&3]}function Xy(t,e){for(let r=0;r<t.length;r++)t[r]^=e[r&3]}function hA(t){return t.length===t.buffer.byteLength?t.buffer:t.buffer.slice(t.byteOffset,t.byteOffset+t.length)}function ed(t){if(ed.readOnly=!0,Buffer.isBuffer(t))return t;let e;return t instanceof ArrayBuffer?e=new Zf(t):ArrayBuffer.isView(t)?e=new Zf(t.buffer,t.byteOffset,t.byteLength):(e=Buffer.from(t),ed.readOnly=!1),e}Uo.exports={concat:dA,mask:Yy,toArrayBuffer:hA,toBuffer:ed,unmask:Xy};if(!process.env.WS_NO_BUFFER_UTIL)try{let t=require("bufferutil");Uo.exports.mask=function(e,r,s,n,i){i<48?Yy(e,r,s,n,i):t.mask(e,r,s,n,i)},Uo.exports.unmask=function(e,r){e.length<32?Xy(e,r):t.unmask(e,r)}}catch{}});var t_=w((eq,e_)=>{"use strict";var Zy=Symbol("kDone"),td=Symbol("kRun"),rd=class{constructor(e){this[Zy]=()=>{this.pending--,this[td]()},this.concurrency=e||1/0,this.jobs=[],this.pending=0}add(e){this.jobs.push(e),this[td]()}[td](){if(this.pending!==this.concurrency&&this.jobs.length){let e=this.jobs.shift();this.pending++,e(this[Zy])}}};e_.exports=rd});var An=w((tq,i_)=>{"use strict";var Nn=require("zlib"),r_=Cn(),pA=t_(),{kStatusCode:s_}=Nt(),mA=Buffer[Symbol.species],wA=Buffer.from([0,0,255,255]),zo=Symbol("permessage-deflate"),At=Symbol("total-length"),cs=Symbol("callback"),tr=Symbol("buffers"),us=Symbol("error"),Fo,sd=class{constructor(e,r,s){if(this._maxPayload=s|0,this._options=e||{},this._threshold=this._options.threshold!==void 0?this._options.threshold:1024,this._isServer=!!r,this._deflate=null,this._inflate=null,this.params=null,!Fo){let n=this._options.concurrencyLimit!==void 0?this._options.concurrencyLimit:10;Fo=new pA(n)}}static get extensionName(){return"permessage-deflate"}offer(){let e={};return this._options.serverNoContextTakeover&&(e.server_no_context_takeover=!0),this._options.clientNoContextTakeover&&(e.client_no_context_takeover=!0),this._options.serverMaxWindowBits&&(e.server_max_window_bits=this._options.serverMaxWindowBits),this._options.clientMaxWindowBits?e.client_max_window_bits=this._options.clientMaxWindowBits:this._options.clientMaxWindowBits==null&&(e.client_max_window_bits=!0),e}accept(e){return e=this.normalizeParams(e),this.params=this._isServer?this.acceptAsServer(e):this.acceptAsClient(e),this.params}cleanup(){if(this._inflate&&(this._inflate.close(),this._inflate=null),this._deflate){let e=this._deflate[cs];this._deflate.close(),this._deflate=null,e&&e(new Error("The deflate stream was closed while data was being processed"))}}acceptAsServer(e){let r=this._options,s=e.find(n=>!(r.serverNoContextTakeover===!1&&n.server_no_context_takeover||n.server_max_window_bits&&(r.serverMaxWindowBits===!1||typeof r.serverMaxWindowBits=="number"&&r.serverMaxWindowBits>n.server_max_window_bits)||typeof r.clientMaxWindowBits=="number"&&!n.client_max_window_bits));if(!s)throw new Error("None of the extension offers can be accepted");return r.serverNoContextTakeover&&(s.server_no_context_takeover=!0),r.clientNoContextTakeover&&(s.client_no_context_takeover=!0),typeof r.serverMaxWindowBits=="number"&&(s.server_max_window_bits=r.serverMaxWindowBits),typeof r.clientMaxWindowBits=="number"?s.client_max_window_bits=r.clientMaxWindowBits:(s.client_max_window_bits===!0||r.clientMaxWindowBits===!1)&&delete s.client_max_window_bits,s}acceptAsClient(e){let r=e[0];if(this._options.clientNoContextTakeover===!1&&r.client_no_context_takeover)throw new Error('Unexpected parameter "client_no_context_takeover"');if(!r.client_max_window_bits)typeof this._options.clientMaxWindowBits=="number"&&(r.client_max_window_bits=this._options.clientMaxWindowBits);else if(this._options.clientMaxWindowBits===!1||typeof this._options.clientMaxWindowBits=="number"&&r.client_max_window_bits>this._options.clientMaxWindowBits)throw new Error('Unexpected or invalid parameter "client_max_window_bits"');return r}normalizeParams(e){return e.forEach(r=>{Object.keys(r).forEach(s=>{let n=r[s];if(n.length>1)throw new Error(`Parameter "${s}" must have only a single value`);if(n=n[0],s==="client_max_window_bits"){if(n!==!0){let i=+n;if(!Number.isInteger(i)||i<8||i>15)throw new TypeError(`Invalid value for parameter "${s}": ${n}`);n=i}else if(!this._isServer)throw new TypeError(`Invalid value for parameter "${s}": ${n}`)}else if(s==="server_max_window_bits"){let i=+n;if(!Number.isInteger(i)||i<8||i>15)throw new TypeError(`Invalid value for parameter "${s}": ${n}`);n=i}else if(s==="client_no_context_takeover"||s==="server_no_context_takeover"){if(n!==!0)throw new TypeError(`Invalid value for parameter "${s}": ${n}`)}else throw new Error(`Unknown parameter "${s}"`);r[s]=n})}),e}decompress(e,r,s){Fo.add(n=>{this._decompress(e,r,(i,o)=>{n(),s(i,o)})})}compress(e,r,s){Fo.add(n=>{this._compress(e,r,(i,o)=>{n(),s(i,o)})})}_decompress(e,r,s){let n=this._isServer?"client":"server";if(!this._inflate){let i=`${n}_max_window_bits`,o=typeof this.params[i]!="number"?Nn.Z_DEFAULT_WINDOWBITS:this.params[i];this._inflate=Nn.createInflateRaw({...this._options.zlibInflateOptions,windowBits:o}),this._inflate[zo]=this,this._inflate[At]=0,this._inflate[tr]=[],this._inflate.on("error",yA),this._inflate.on("data",n_)}this._inflate[cs]=s,this._inflate.write(e),r&&this._inflate.write(wA),this._inflate.flush(()=>{let i=this._inflate[us];if(i){this._inflate.close(),this._inflate=null,s(i);return}let o=r_.concat(this._inflate[tr],this._inflate[At]);this._inflate._readableState.endEmitted?(this._inflate.close(),this._inflate=null):(this._inflate[At]=0,this._inflate[tr]=[],r&&this.params[`${n}_no_context_takeover`]&&this._inflate.reset()),s(null,o)})}_compress(e,r,s){let n=this._isServer?"server":"client";if(!this._deflate){let i=`${n}_max_window_bits`,o=typeof this.params[i]!="number"?Nn.Z_DEFAULT_WINDOWBITS:this.params[i];this._deflate=Nn.createDeflateRaw({...this._options.zlibDeflateOptions,windowBits:o}),this._deflate[At]=0,this._deflate[tr]=[],this._deflate.on("data",gA)}this._deflate[cs]=s,this._deflate.write(e),this._deflate.flush(Nn.Z_SYNC_FLUSH,()=>{if(!this._deflate)return;let i=r_.concat(this._deflate[tr],this._deflate[At]);r&&(i=new mA(i.buffer,i.byteOffset,i.length-4)),this._deflate[cs]=null,this._deflate[At]=0,this._deflate[tr]=[],r&&this.params[`${n}_no_context_takeover`]&&this._deflate.reset(),s(null,i)})}};i_.exports=sd;function gA(t){this[tr].push(t),this[At]+=t.length}function n_(t){if(this[At]+=t.length,this[zo]._maxPayload<1||this[At]<=this[zo]._maxPayload){this[tr].push(t);return}this[us]=new RangeError("Max payload size exceeded"),this[us].code="WS_ERR_UNSUPPORTED_MESSAGE_LENGTH",this[us][s_]=1009,this.removeListener("data",n_),this.reset()}function yA(t){if(this[zo]._inflate=null,this[us]){this[cs](this[us]);return}t[s_]=1007,this[cs](t)}});var fs=w((rq,jo)=>{"use strict";var{isUtf8:o_}=require("buffer"),{hasBlob:_A}=Nt(),SA=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0];function EA(t){return t>=1e3&&t<=1014&&t!==1004&&t!==1005&&t!==1006||t>=3e3&&t<=4999}function nd(t){let e=t.length,r=0;for(;r<e;)if((t[r]&128)===0)r++;else if((t[r]&224)===192){if(r+1===e||(t[r+1]&192)!==128||(t[r]&254)===192)return!1;r+=2}else if((t[r]&240)===224){if(r+2>=e||(t[r+1]&192)!==128||(t[r+2]&192)!==128||t[r]===224&&(t[r+1]&224)===128||t[r]===237&&(t[r+1]&224)===160)return!1;r+=3}else if((t[r]&248)===240){if(r+3>=e||(t[r+1]&192)!==128||(t[r+2]&192)!==128||(t[r+3]&192)!==128||t[r]===240&&(t[r+1]&240)===128||t[r]===244&&t[r+1]>143||t[r]>244)return!1;r+=4}else return!1;return!0}function bA(t){return _A&&typeof t=="object"&&typeof t.arrayBuffer=="function"&&typeof t.type=="string"&&typeof t.stream=="function"&&(t[Symbol.toStringTag]==="Blob"||t[Symbol.toStringTag]==="File")}jo.exports={isBlob:bA,isValidStatusCode:EA,isValidUTF8:nd,tokenChars:SA};if(o_)jo.exports.isValidUTF8=function(t){return t.length<24?nd(t):o_(t)};else if(!process.env.WS_NO_UTF_8_VALIDATE)try{let t=require("utf-8-validate");jo.exports.isValidUTF8=function(e){return e.length<32?nd(e):t(e)}}catch{}});var cd=w((sq,h_)=>{"use strict";var{Writable:kA}=require("stream"),a_=An(),{BINARY_TYPES:vA,EMPTY_BUFFER:l_,kStatusCode:OA,kWebSocket:DA}=Nt(),{concat:id,toArrayBuffer:TA,unmask:IA}=Cn(),{isValidStatusCode:RA,isValidUTF8:c_}=fs(),Vo=Buffer[Symbol.species],st=0,u_=1,f_=2,d_=3,od=4,ad=5,Go=6,ld=class extends kA{constructor(e={}){super(),this._allowSynchronousEvents=e.allowSynchronousEvents!==void 0?e.allowSynchronousEvents:!0,this._binaryType=e.binaryType||vA[0],this._extensions=e.extensions||{},this._isServer=!!e.isServer,this._maxPayload=e.maxPayload|0,this._skipUTF8Validation=!!e.skipUTF8Validation,this[DA]=void 0,this._bufferedBytes=0,this._buffers=[],this._compressed=!1,this._payloadLength=0,this._mask=void 0,this._fragmented=0,this._masked=!1,this._fin=!1,this._opcode=0,this._totalPayloadLength=0,this._messageLength=0,this._fragments=[],this._errored=!1,this._loop=!1,this._state=st}_write(e,r,s){if(this._opcode===8&&this._state==st)return s();this._bufferedBytes+=e.length,this._buffers.push(e),this.startLoop(s)}consume(e){if(this._bufferedBytes-=e,e===this._buffers[0].length)return this._buffers.shift();if(e<this._buffers[0].length){let s=this._buffers[0];return this._buffers[0]=new Vo(s.buffer,s.byteOffset+e,s.length-e),new Vo(s.buffer,s.byteOffset,e)}let r=Buffer.allocUnsafe(e);do{let s=this._buffers[0],n=r.length-e;e>=s.length?r.set(this._buffers.shift(),n):(r.set(new Uint8Array(s.buffer,s.byteOffset,e),n),this._buffers[0]=new Vo(s.buffer,s.byteOffset+e,s.length-e)),e-=s.length}while(e>0);return r}startLoop(e){this._loop=!0;do switch(this._state){case st:this.getInfo(e);break;case u_:this.getPayloadLength16(e);break;case f_:this.getPayloadLength64(e);break;case d_:this.getMask();break;case od:this.getData(e);break;case ad:case Go:this._loop=!1;return}while(this._loop);this._errored||e()}getInfo(e){if(this._bufferedBytes<2){this._loop=!1;return}let r=this.consume(2);if((r[0]&48)!==0){let n=this.createError(RangeError,"RSV2 and RSV3 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_2_3");e(n);return}let s=(r[0]&64)===64;if(s&&!this._extensions[a_.extensionName]){let n=this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");e(n);return}if(this._fin=(r[0]&128)===128,this._opcode=r[0]&15,this._payloadLength=r[1]&127,this._opcode===0){if(s){let n=this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");e(n);return}if(!this._fragmented){let n=this.createError(RangeError,"invalid opcode 0",!0,1002,"WS_ERR_INVALID_OPCODE");e(n);return}this._opcode=this._fragmented}else if(this._opcode===1||this._opcode===2){if(this._fragmented){let n=this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE");e(n);return}this._compressed=s}else if(this._opcode>7&&this._opcode<11){if(!this._fin){let n=this.createError(RangeError,"FIN must be set",!0,1002,"WS_ERR_EXPECTED_FIN");e(n);return}if(s){let n=this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");e(n);return}if(this._payloadLength>125||this._opcode===8&&this._payloadLength===1){let n=this.createError(RangeError,`invalid payload length ${this._payloadLength}`,!0,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH");e(n);return}}else{let n=this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE");e(n);return}if(!this._fin&&!this._fragmented&&(this._fragmented=this._opcode),this._masked=(r[1]&128)===128,this._isServer){if(!this._masked){let n=this.createError(RangeError,"MASK must be set",!0,1002,"WS_ERR_EXPECTED_MASK");e(n);return}}else if(this._masked){let n=this.createError(RangeError,"MASK must be clear",!0,1002,"WS_ERR_UNEXPECTED_MASK");e(n);return}this._payloadLength===126?this._state=u_:this._payloadLength===127?this._state=f_:this.haveLength(e)}getPayloadLength16(e){if(this._bufferedBytes<2){this._loop=!1;return}this._payloadLength=this.consume(2).readUInt16BE(0),this.haveLength(e)}getPayloadLength64(e){if(this._bufferedBytes<8){this._loop=!1;return}let r=this.consume(8),s=r.readUInt32BE(0);if(s>Math.pow(2,21)-1){let n=this.createError(RangeError,"Unsupported WebSocket frame: payload length > 2^53 - 1",!1,1009,"WS_ERR_UNSUPPORTED_DATA_PAYLOAD_LENGTH");e(n);return}this._payloadLength=s*Math.pow(2,32)+r.readUInt32BE(4),this.haveLength(e)}haveLength(e){if(this._payloadLength&&this._opcode<8&&(this._totalPayloadLength+=this._payloadLength,this._totalPayloadLength>this._maxPayload&&this._maxPayload>0)){let r=this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH");e(r);return}this._masked?this._state=d_:this._state=od}getMask(){if(this._bufferedBytes<4){this._loop=!1;return}this._mask=this.consume(4),this._state=od}getData(e){let r=l_;if(this._payloadLength){if(this._bufferedBytes<this._payloadLength){this._loop=!1;return}r=this.consume(this._payloadLength),this._masked&&(this._mask[0]|this._mask[1]|this._mask[2]|this._mask[3])!==0&&IA(r,this._mask)}if(this._opcode>7){this.controlMessage(r,e);return}if(this._compressed){this._state=ad,this.decompress(r,e);return}r.length&&(this._messageLength=this._totalPayloadLength,this._fragments.push(r)),this.dataMessage(e)}decompress(e,r){this._extensions[a_.extensionName].decompress(e,this._fin,(n,i)=>{if(n)return r(n);if(i.length){if(this._messageLength+=i.length,this._messageLength>this._maxPayload&&this._maxPayload>0){let o=this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH");r(o);return}this._fragments.push(i)}this.dataMessage(r),this._state===st&&this.startLoop(r)})}dataMessage(e){if(!this._fin){this._state=st;return}let r=this._messageLength,s=this._fragments;if(this._totalPayloadLength=0,this._messageLength=0,this._fragmented=0,this._fragments=[],this._opcode===2){let n;this._binaryType==="nodebuffer"?n=id(s,r):this._binaryType==="arraybuffer"?n=TA(id(s,r)):this._binaryType==="blob"?n=new Blob(s):n=s,this._allowSynchronousEvents?(this.emit("message",n,!0),this._state=st):(this._state=Go,setImmediate(()=>{this.emit("message",n,!0),this._state=st,this.startLoop(e)}))}else{let n=id(s,r);if(!this._skipUTF8Validation&&!c_(n)){let i=this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");e(i);return}this._state===ad||this._allowSynchronousEvents?(this.emit("message",n,!1),this._state=st):(this._state=Go,setImmediate(()=>{this.emit("message",n,!1),this._state=st,this.startLoop(e)}))}}controlMessage(e,r){if(this._opcode===8){if(e.length===0)this._loop=!1,this.emit("conclude",1005,l_),this.end();else{let s=e.readUInt16BE(0);if(!RA(s)){let i=this.createError(RangeError,`invalid status code ${s}`,!0,1002,"WS_ERR_INVALID_CLOSE_CODE");r(i);return}let n=new Vo(e.buffer,e.byteOffset+2,e.length-2);if(!this._skipUTF8Validation&&!c_(n)){let i=this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");r(i);return}this._loop=!1,this.emit("conclude",s,n),this.end()}this._state=st;return}this._allowSynchronousEvents?(this.emit(this._opcode===9?"ping":"pong",e),this._state=st):(this._state=Go,setImmediate(()=>{this.emit(this._opcode===9?"ping":"pong",e),this._state=st,this.startLoop(r)}))}createError(e,r,s,n,i){this._loop=!1,this._errored=!0;let o=new e(s?`Invalid WebSocket frame: ${r}`:r);return Error.captureStackTrace(o,this.createError),o.code=i,o[OA]=n,o}};h_.exports=ld});var dd=w((iq,w_)=>{"use strict";var{Duplex:nq}=require("stream"),{randomFillSync:CA}=require("crypto"),p_=An(),{EMPTY_BUFFER:NA,kWebSocket:AA,NOOP:PA}=Nt(),{isBlob:ds,isValidStatusCode:LA}=fs(),{mask:m_,toBuffer:gr}=Cn(),nt=Symbol("kByteLength"),xA=Buffer.alloc(4),Qo=8*1024,yr,hs=Qo,ft=0,qA=1,MA=2,ud=class t{constructor(e,r,s){this._extensions=r||{},s&&(this._generateMask=s,this._maskBuffer=Buffer.alloc(4)),this._socket=e,this._firstFragment=!0,this._compress=!1,this._bufferedBytes=0,this._queue=[],this._state=ft,this.onerror=PA,this[AA]=void 0}static frame(e,r){let s,n=!1,i=2,o=!1;r.mask&&(s=r.maskBuffer||xA,r.generateMask?r.generateMask(s):(hs===Qo&&(yr===void 0&&(yr=Buffer.alloc(Qo)),CA(yr,0,Qo),hs=0),s[0]=yr[hs++],s[1]=yr[hs++],s[2]=yr[hs++],s[3]=yr[hs++]),o=(s[0]|s[1]|s[2]|s[3])===0,i=6);let a;typeof e=="string"?(!r.mask||o)&&r[nt]!==void 0?a=r[nt]:(e=Buffer.from(e),a=e.length):(a=e.length,n=r.mask&&r.readOnly&&!o);let l=a;a>=65536?(i+=8,l=127):a>125&&(i+=2,l=126);let c=Buffer.allocUnsafe(n?a+i:i);return c[0]=r.fin?r.opcode|128:r.opcode,r.rsv1&&(c[0]|=64),c[1]=l,l===126?c.writeUInt16BE(a,2):l===127&&(c[2]=c[3]=0,c.writeUIntBE(a,4,6)),r.mask?(c[1]|=128,c[i-4]=s[0],c[i-3]=s[1],c[i-2]=s[2],c[i-1]=s[3],o?[c,e]:n?(m_(e,s,c,i,a),[c]):(m_(e,s,e,0,a),[c,e])):[c,e]}close(e,r,s,n){let i;if(e===void 0)i=NA;else{if(typeof e!="number"||!LA(e))throw new TypeError("First argument must be a valid error code number");if(r===void 0||!r.length)i=Buffer.allocUnsafe(2),i.writeUInt16BE(e,0);else{let a=Buffer.byteLength(r);if(a>123)throw new RangeError("The message must not be greater than 123 bytes");i=Buffer.allocUnsafe(2+a),i.writeUInt16BE(e,0),typeof r=="string"?i.write(r,2):i.set(r,2)}}let o={[nt]:i.length,fin:!0,generateMask:this._generateMask,mask:s,maskBuffer:this._maskBuffer,opcode:8,readOnly:!1,rsv1:!1};this._state!==ft?this.enqueue([this.dispatch,i,!1,o,n]):this.sendFrame(t.frame(i,o),n)}ping(e,r,s){let n,i;if(typeof e=="string"?(n=Buffer.byteLength(e),i=!1):ds(e)?(n=e.size,i=!1):(e=gr(e),n=e.length,i=gr.readOnly),n>125)throw new RangeError("The data size must not be greater than 125 bytes");let o={[nt]:n,fin:!0,generateMask:this._generateMask,mask:r,maskBuffer:this._maskBuffer,opcode:9,readOnly:i,rsv1:!1};ds(e)?this._state!==ft?this.enqueue([this.getBlobData,e,!1,o,s]):this.getBlobData(e,!1,o,s):this._state!==ft?this.enqueue([this.dispatch,e,!1,o,s]):this.sendFrame(t.frame(e,o),s)}pong(e,r,s){let n,i;if(typeof e=="string"?(n=Buffer.byteLength(e),i=!1):ds(e)?(n=e.size,i=!1):(e=gr(e),n=e.length,i=gr.readOnly),n>125)throw new RangeError("The data size must not be greater than 125 bytes");let o={[nt]:n,fin:!0,generateMask:this._generateMask,mask:r,maskBuffer:this._maskBuffer,opcode:10,readOnly:i,rsv1:!1};ds(e)?this._state!==ft?this.enqueue([this.getBlobData,e,!1,o,s]):this.getBlobData(e,!1,o,s):this._state!==ft?this.enqueue([this.dispatch,e,!1,o,s]):this.sendFrame(t.frame(e,o),s)}send(e,r,s){let n=this._extensions[p_.extensionName],i=r.binary?2:1,o=r.compress,a,l;typeof e=="string"?(a=Buffer.byteLength(e),l=!1):ds(e)?(a=e.size,l=!1):(e=gr(e),a=e.length,l=gr.readOnly),this._firstFragment?(this._firstFragment=!1,o&&n&&n.params[n._isServer?"server_no_context_takeover":"client_no_context_takeover"]&&(o=a>=n._threshold),this._compress=o):(o=!1,i=0),r.fin&&(this._firstFragment=!0);let c={[nt]:a,fin:r.fin,generateMask:this._generateMask,mask:r.mask,maskBuffer:this._maskBuffer,opcode:i,readOnly:l,rsv1:o};ds(e)?this._state!==ft?this.enqueue([this.getBlobData,e,this._compress,c,s]):this.getBlobData(e,this._compress,c,s):this._state!==ft?this.enqueue([this.dispatch,e,this._compress,c,s]):this.dispatch(e,this._compress,c,s)}getBlobData(e,r,s,n){this._bufferedBytes+=s[nt],this._state=MA,e.arrayBuffer().then(i=>{if(this._socket.destroyed){let a=new Error("The socket was closed while the blob was being read");process.nextTick(fd,this,a,n);return}this._bufferedBytes-=s[nt];let o=gr(i);r?this.dispatch(o,r,s,n):(this._state=ft,this.sendFrame(t.frame(o,s),n),this.dequeue())}).catch(i=>{process.nextTick(BA,this,i,n)})}dispatch(e,r,s,n){if(!r){this.sendFrame(t.frame(e,s),n);return}let i=this._extensions[p_.extensionName];this._bufferedBytes+=s[nt],this._state=qA,i.compress(e,s.fin,(o,a)=>{if(this._socket.destroyed){let l=new Error("The socket was closed while data was being compressed");fd(this,l,n);return}this._bufferedBytes-=s[nt],this._state=ft,s.readOnly=!1,this.sendFrame(t.frame(a,s),n),this.dequeue()})}dequeue(){for(;this._state===ft&&this._queue.length;){let e=this._queue.shift();this._bufferedBytes-=e[3][nt],Reflect.apply(e[0],this,e.slice(1))}}enqueue(e){this._bufferedBytes+=e[3][nt],this._queue.push(e)}sendFrame(e,r){e.length===2?(this._socket.cork(),this._socket.write(e[0]),this._socket.write(e[1],r),this._socket.uncork()):this._socket.write(e[0],r)}};w_.exports=ud;function fd(t,e,r){typeof r=="function"&&r(e);for(let s=0;s<t._queue.length;s++){let n=t._queue[s],i=n[n.length-1];typeof i=="function"&&i(e)}}function BA(t,e,r){fd(t,e,r),t.onerror(e)}});var O_=w((oq,v_)=>{"use strict";var{kForOnEventAttribute:Pn,kListener:hd}=Nt(),g_=Symbol("kCode"),y_=Symbol("kData"),__=Symbol("kError"),S_=Symbol("kMessage"),E_=Symbol("kReason"),ps=Symbol("kTarget"),b_=Symbol("kType"),k_=Symbol("kWasClean"),Pt=class{constructor(e){this[ps]=null,this[b_]=e}get target(){return this[ps]}get type(){return this[b_]}};Object.defineProperty(Pt.prototype,"target",{enumerable:!0});Object.defineProperty(Pt.prototype,"type",{enumerable:!0});var _r=class extends Pt{constructor(e,r={}){super(e),this[g_]=r.code===void 0?0:r.code,this[E_]=r.reason===void 0?"":r.reason,this[k_]=r.wasClean===void 0?!1:r.wasClean}get code(){return this[g_]}get reason(){return this[E_]}get wasClean(){return this[k_]}};Object.defineProperty(_r.prototype,"code",{enumerable:!0});Object.defineProperty(_r.prototype,"reason",{enumerable:!0});Object.defineProperty(_r.prototype,"wasClean",{enumerable:!0});var ms=class extends Pt{constructor(e,r={}){super(e),this[__]=r.error===void 0?null:r.error,this[S_]=r.message===void 0?"":r.message}get error(){return this[__]}get message(){return this[S_]}};Object.defineProperty(ms.prototype,"error",{enumerable:!0});Object.defineProperty(ms.prototype,"message",{enumerable:!0});var Ln=class extends Pt{constructor(e,r={}){super(e),this[y_]=r.data===void 0?null:r.data}get data(){return this[y_]}};Object.defineProperty(Ln.prototype,"data",{enumerable:!0});var $A={addEventListener(t,e,r={}){for(let n of this.listeners(t))if(!r[Pn]&&n[hd]===e&&!n[Pn])return;let s;if(t==="message")s=function(i,o){let a=new Ln("message",{data:o?i:i.toString()});a[ps]=this,Ko(e,this,a)};else if(t==="close")s=function(i,o){let a=new _r("close",{code:i,reason:o.toString(),wasClean:this._closeFrameReceived&&this._closeFrameSent});a[ps]=this,Ko(e,this,a)};else if(t==="error")s=function(i){let o=new ms("error",{error:i,message:i.message});o[ps]=this,Ko(e,this,o)};else if(t==="open")s=function(){let i=new Pt("open");i[ps]=this,Ko(e,this,i)};else return;s[Pn]=!!r[Pn],s[hd]=e,r.once?this.once(t,s):this.on(t,s)},removeEventListener(t,e){for(let r of this.listeners(t))if(r[hd]===e&&!r[Pn]){this.removeListener(t,r);break}}};v_.exports={CloseEvent:_r,ErrorEvent:ms,Event:Pt,EventTarget:$A,MessageEvent:Ln};function Ko(t,e,r){typeof t=="object"&&t.handleEvent?t.handleEvent.call(t,r):t.call(e,r)}});var pd=w((aq,D_)=>{"use strict";var{tokenChars:xn}=fs();function Et(t,e,r){t[e]===void 0?t[e]=[r]:t[e].push(r)}function WA(t){let e=Object.create(null),r=Object.create(null),s=!1,n=!1,i=!1,o,a,l=-1,c=-1,u=-1,f=0;for(;f<t.length;f++)if(c=t.charCodeAt(f),o===void 0)if(u===-1&&xn[c]===1)l===-1&&(l=f);else if(f!==0&&(c===32||c===9))u===-1&&l!==-1&&(u=f);else if(c===59||c===44){if(l===-1)throw new SyntaxError(`Unexpected character at index ${f}`);u===-1&&(u=f);let p=t.slice(l,u);c===44?(Et(e,p,r),r=Object.create(null)):o=p,l=u=-1}else throw new SyntaxError(`Unexpected character at index ${f}`);else if(a===void 0)if(u===-1&&xn[c]===1)l===-1&&(l=f);else if(c===32||c===9)u===-1&&l!==-1&&(u=f);else if(c===59||c===44){if(l===-1)throw new SyntaxError(`Unexpected character at index ${f}`);u===-1&&(u=f),Et(r,t.slice(l,u),!0),c===44&&(Et(e,o,r),r=Object.create(null),o=void 0),l=u=-1}else if(c===61&&l!==-1&&u===-1)a=t.slice(l,f),l=u=-1;else throw new SyntaxError(`Unexpected character at index ${f}`);else if(n){if(xn[c]!==1)throw new SyntaxError(`Unexpected character at index ${f}`);l===-1?l=f:s||(s=!0),n=!1}else if(i)if(xn[c]===1)l===-1&&(l=f);else if(c===34&&l!==-1)i=!1,u=f;else if(c===92)n=!0;else throw new SyntaxError(`Unexpected character at index ${f}`);else if(c===34&&t.charCodeAt(f-1)===61)i=!0;else if(u===-1&&xn[c]===1)l===-1&&(l=f);else if(l!==-1&&(c===32||c===9))u===-1&&(u=f);else if(c===59||c===44){if(l===-1)throw new SyntaxError(`Unexpected character at index ${f}`);u===-1&&(u=f);let p=t.slice(l,u);s&&(p=p.replace(/\\/g,""),s=!1),Et(r,a,p),c===44&&(Et(e,o,r),r=Object.create(null),o=void 0),a=void 0,l=u=-1}else throw new SyntaxError(`Unexpected character at index ${f}`);if(l===-1||i||c===32||c===9)throw new SyntaxError("Unexpected end of input");u===-1&&(u=f);let d=t.slice(l,u);return o===void 0?Et(e,d,r):(a===void 0?Et(r,d,!0):s?Et(r,a,d.replace(/\\/g,"")):Et(r,a,d),Et(e,o,r)),e}function UA(t){return Object.keys(t).map(e=>{let r=t[e];return Array.isArray(r)||(r=[r]),r.map(s=>[e].concat(Object.keys(s).map(n=>{let i=s[n];return Array.isArray(i)||(i=[i]),i.map(o=>o===!0?n:`${n}=${o}`).join("; ")})).join("; ")).join(", ")}).join(", ")}D_.exports={format:UA,parse:WA}});var Xo=w((uq,B_)=>{"use strict";var FA=require("events"),zA=require("https"),jA=require("http"),R_=require("net"),VA=require("tls"),{randomBytes:GA,createHash:QA}=require("crypto"),{Duplex:lq,Readable:cq}=require("stream"),{URL:md}=require("url"),rr=An(),KA=cd(),HA=dd(),{isBlob:JA}=fs(),{BINARY_TYPES:T_,CLOSE_TIMEOUT:YA,EMPTY_BUFFER:Ho,GUID:XA,kForOnEventAttribute:wd,kListener:ZA,kStatusCode:e1,kWebSocket:Ee,NOOP:C_}=Nt(),{EventTarget:{addEventListener:t1,removeEventListener:r1}}=O_(),{format:s1,parse:n1}=pd(),{toBuffer:i1}=Cn(),N_=Symbol("kAborted"),gd=[8,13],Lt=["CONNECTING","OPEN","CLOSING","CLOSED"],o1=/^[!#$%&'*+\-.0-9A-Z^_`|a-z~]+$/,ie=class t extends FA{constructor(e,r,s){super(),this._binaryType=T_[0],this._closeCode=1006,this._closeFrameReceived=!1,this._closeFrameSent=!1,this._closeMessage=Ho,this._closeTimer=null,this._errorEmitted=!1,this._extensions={},this._paused=!1,this._protocol="",this._readyState=t.CONNECTING,this._receiver=null,this._sender=null,this._socket=null,e!==null?(this._bufferedAmount=0,this._isServer=!1,this._redirects=0,r===void 0?r=[]:Array.isArray(r)||(typeof r=="object"&&r!==null?(s=r,r=[]):r=[r]),A_(this,e,r,s)):(this._autoPong=s.autoPong,this._closeTimeout=s.closeTimeout,this._isServer=!0)}get binaryType(){return this._binaryType}set binaryType(e){T_.includes(e)&&(this._binaryType=e,this._receiver&&(this._receiver._binaryType=e))}get bufferedAmount(){return this._socket?this._socket._writableState.length+this._sender._bufferedBytes:this._bufferedAmount}get extensions(){return Object.keys(this._extensions).join()}get isPaused(){return this._paused}get onclose(){return null}get onerror(){return null}get onopen(){return null}get onmessage(){return null}get protocol(){return this._protocol}get readyState(){return this._readyState}get url(){return this._url}setSocket(e,r,s){let n=new KA({allowSynchronousEvents:s.allowSynchronousEvents,binaryType:this.binaryType,extensions:this._extensions,isServer:this._isServer,maxPayload:s.maxPayload,skipUTF8Validation:s.skipUTF8Validation}),i=new HA(e,this._extensions,s.generateMask);this._receiver=n,this._sender=i,this._socket=e,n[Ee]=this,i[Ee]=this,e[Ee]=this,n.on("conclude",c1),n.on("drain",u1),n.on("error",f1),n.on("message",d1),n.on("ping",h1),n.on("pong",p1),i.onerror=m1,e.setTimeout&&e.setTimeout(0),e.setNoDelay&&e.setNoDelay(),r.length>0&&e.unshift(r),e.on("close",x_),e.on("data",Yo),e.on("end",q_),e.on("error",M_),this._readyState=t.OPEN,this.emit("open")}emitClose(){if(!this._socket){this._readyState=t.CLOSED,this.emit("close",this._closeCode,this._closeMessage);return}this._extensions[rr.extensionName]&&this._extensions[rr.extensionName].cleanup(),this._receiver.removeAllListeners(),this._readyState=t.CLOSED,this.emit("close",this._closeCode,this._closeMessage)}close(e,r){if(this.readyState!==t.CLOSED){if(this.readyState===t.CONNECTING){Ke(this,this._req,"WebSocket was closed before the connection was established");return}if(this.readyState===t.CLOSING){this._closeFrameSent&&(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end();return}this._readyState=t.CLOSING,this._sender.close(e,r,!this._isServer,s=>{s||(this._closeFrameSent=!0,(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end())}),L_(this)}}pause(){this.readyState===t.CONNECTING||this.readyState===t.CLOSED||(this._paused=!0,this._socket.pause())}ping(e,r,s){if(this.readyState===t.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if(typeof e=="function"?(s=e,e=r=void 0):typeof r=="function"&&(s=r,r=void 0),typeof e=="number"&&(e=e.toString()),this.readyState!==t.OPEN){yd(this,e,s);return}r===void 0&&(r=!this._isServer),this._sender.ping(e||Ho,r,s)}pong(e,r,s){if(this.readyState===t.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if(typeof e=="function"?(s=e,e=r=void 0):typeof r=="function"&&(s=r,r=void 0),typeof e=="number"&&(e=e.toString()),this.readyState!==t.OPEN){yd(this,e,s);return}r===void 0&&(r=!this._isServer),this._sender.pong(e||Ho,r,s)}resume(){this.readyState===t.CONNECTING||this.readyState===t.CLOSED||(this._paused=!1,this._receiver._writableState.needDrain||this._socket.resume())}send(e,r,s){if(this.readyState===t.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if(typeof r=="function"&&(s=r,r={}),typeof e=="number"&&(e=e.toString()),this.readyState!==t.OPEN){yd(this,e,s);return}let n={binary:typeof e!="string",mask:!this._isServer,compress:!0,fin:!0,...r};this._extensions[rr.extensionName]||(n.compress=!1),this._sender.send(e||Ho,n,s)}terminate(){if(this.readyState!==t.CLOSED){if(this.readyState===t.CONNECTING){Ke(this,this._req,"WebSocket was closed before the connection was established");return}this._socket&&(this._readyState=t.CLOSING,this._socket.destroy())}}};Object.defineProperty(ie,"CONNECTING",{enumerable:!0,value:Lt.indexOf("CONNECTING")});Object.defineProperty(ie.prototype,"CONNECTING",{enumerable:!0,value:Lt.indexOf("CONNECTING")});Object.defineProperty(ie,"OPEN",{enumerable:!0,value:Lt.indexOf("OPEN")});Object.defineProperty(ie.prototype,"OPEN",{enumerable:!0,value:Lt.indexOf("OPEN")});Object.defineProperty(ie,"CLOSING",{enumerable:!0,value:Lt.indexOf("CLOSING")});Object.defineProperty(ie.prototype,"CLOSING",{enumerable:!0,value:Lt.indexOf("CLOSING")});Object.defineProperty(ie,"CLOSED",{enumerable:!0,value:Lt.indexOf("CLOSED")});Object.defineProperty(ie.prototype,"CLOSED",{enumerable:!0,value:Lt.indexOf("CLOSED")});["binaryType","bufferedAmount","extensions","isPaused","protocol","readyState","url"].forEach(t=>{Object.defineProperty(ie.prototype,t,{enumerable:!0})});["open","error","close","message"].forEach(t=>{Object.defineProperty(ie.prototype,`on${t}`,{enumerable:!0,get(){for(let e of this.listeners(t))if(e[wd])return e[ZA];return null},set(e){for(let r of this.listeners(t))if(r[wd]){this.removeListener(t,r);break}typeof e=="function"&&this.addEventListener(t,e,{[wd]:!0})}})});ie.prototype.addEventListener=t1;ie.prototype.removeEventListener=r1;B_.exports=ie;function A_(t,e,r,s){let n={allowSynchronousEvents:!0,autoPong:!0,closeTimeout:YA,protocolVersion:gd[1],maxPayload:104857600,skipUTF8Validation:!1,perMessageDeflate:!0,followRedirects:!1,maxRedirects:10,...s,socketPath:void 0,hostname:void 0,protocol:void 0,timeout:void 0,method:"GET",host:void 0,path:void 0,port:void 0};if(t._autoPong=n.autoPong,t._closeTimeout=n.closeTimeout,!gd.includes(n.protocolVersion))throw new RangeError(`Unsupported protocol version: ${n.protocolVersion} (supported versions: ${gd.join(", ")})`);let i;if(e instanceof md)i=e;else try{i=new md(e)}catch{throw new SyntaxError(`Invalid URL: ${e}`)}i.protocol==="http:"?i.protocol="ws:":i.protocol==="https:"&&(i.protocol="wss:"),t._url=i.href;let o=i.protocol==="wss:",a=i.protocol==="ws+unix:",l;if(i.protocol!=="ws:"&&!o&&!a?l=`The URL's protocol must be one of "ws:", "wss:", "http:", "https:", or "ws+unix:"`:a&&!i.pathname?l="The URL's pathname is empty":i.hash&&(l="The URL contains a fragment identifier"),l){let h=new SyntaxError(l);if(t._redirects===0)throw h;Jo(t,h);return}let c=o?443:80,u=GA(16).toString("base64"),f=o?zA.request:jA.request,d=new Set,p;if(n.createConnection=n.createConnection||(o?l1:a1),n.defaultPort=n.defaultPort||c,n.port=i.port||c,n.host=i.hostname.startsWith("[")?i.hostname.slice(1,-1):i.hostname,n.headers={...n.headers,"Sec-WebSocket-Version":n.protocolVersion,"Sec-WebSocket-Key":u,Connection:"Upgrade",Upgrade:"websocket"},n.path=i.pathname+i.search,n.timeout=n.handshakeTimeout,n.perMessageDeflate&&(p=new rr(n.perMessageDeflate!==!0?n.perMessageDeflate:{},!1,n.maxPayload),n.headers["Sec-WebSocket-Extensions"]=s1({[rr.extensionName]:p.offer()})),r.length){for(let h of r){if(typeof h!="string"||!o1.test(h)||d.has(h))throw new SyntaxError("An invalid or duplicated subprotocol was specified");d.add(h)}n.headers["Sec-WebSocket-Protocol"]=r.join(",")}if(n.origin&&(n.protocolVersion<13?n.headers["Sec-WebSocket-Origin"]=n.origin:n.headers.Origin=n.origin),(i.username||i.password)&&(n.auth=`${i.username}:${i.password}`),a){let h=n.path.split(":");n.socketPath=h[0],n.path=h[1]}let m;if(n.followRedirects){if(t._redirects===0){t._originalIpc=a,t._originalSecure=o,t._originalHostOrSocketPath=a?n.socketPath:i.host;let h=s&&s.headers;if(s={...s,headers:{}},h)for(let[g,y]of Object.entries(h))s.headers[g.toLowerCase()]=y}else if(t.listenerCount("redirect")===0){let h=a?t._originalIpc?n.socketPath===t._originalHostOrSocketPath:!1:t._originalIpc?!1:i.host===t._originalHostOrSocketPath;(!h||t._originalSecure&&!o)&&(delete n.headers.authorization,delete n.headers.cookie,h||delete n.headers.host,n.auth=void 0)}n.auth&&!s.headers.authorization&&(s.headers.authorization="Basic "+Buffer.from(n.auth).toString("base64")),m=t._req=f(n),t._redirects&&t.emit("redirect",t.url,m)}else m=t._req=f(n);n.timeout&&m.on("timeout",()=>{Ke(t,m,"Opening handshake has timed out")}),m.on("error",h=>{m===null||m[N_]||(m=t._req=null,Jo(t,h))}),m.on("response",h=>{let g=h.headers.location,y=h.statusCode;if(g&&n.followRedirects&&y>=300&&y<400){if(++t._redirects>n.maxRedirects){Ke(t,m,"Maximum redirects exceeded");return}m.abort();let E;try{E=new md(g,e)}catch{let v=new SyntaxError(`Invalid URL: ${g}`);Jo(t,v);return}A_(t,E,r,s)}else t.emit("unexpected-response",m,h)||Ke(t,m,`Unexpected server response: ${h.statusCode}`)}),m.on("upgrade",(h,g,y)=>{if(t.emit("upgrade",h),t.readyState!==ie.CONNECTING)return;m=t._req=null;let E=h.headers.upgrade;if(E===void 0||E.toLowerCase()!=="websocket"){Ke(t,g,"Invalid Upgrade header");return}let b=QA("sha1").update(u+XA).digest("base64");if(h.headers["sec-websocket-accept"]!==b){Ke(t,g,"Invalid Sec-WebSocket-Accept header");return}let v=h.headers["sec-websocket-protocol"],I;if(v!==void 0?d.size?d.has(v)||(I="Server sent an invalid subprotocol"):I="Server sent a subprotocol but none was requested":d.size&&(I="Server sent no subprotocol"),I){Ke(t,g,I);return}v&&(t._protocol=v);let S=h.headers["sec-websocket-extensions"];if(S!==void 0){if(!p){Ke(t,g,"Server sent a Sec-WebSocket-Extensions header but no extension was requested");return}let L;try{L=n1(S)}catch{Ke(t,g,"Invalid Sec-WebSocket-Extensions header");return}let x=Object.keys(L);if(x.length!==1||x[0]!==rr.extensionName){Ke(t,g,"Server indicated an extension that was not requested");return}try{p.accept(L[rr.extensionName])}catch{Ke(t,g,"Invalid Sec-WebSocket-Extensions header");return}t._extensions[rr.extensionName]=p}t.setSocket(g,y,{allowSynchronousEvents:n.allowSynchronousEvents,generateMask:n.generateMask,maxPayload:n.maxPayload,skipUTF8Validation:n.skipUTF8Validation})}),n.finishRequest?n.finishRequest(m,t):m.end()}function Jo(t,e){t._readyState=ie.CLOSING,t._errorEmitted=!0,t.emit("error",e),t.emitClose()}function a1(t){return t.path=t.socketPath,R_.connect(t)}function l1(t){return t.path=void 0,!t.servername&&t.servername!==""&&(t.servername=R_.isIP(t.host)?"":t.host),VA.connect(t)}function Ke(t,e,r){t._readyState=ie.CLOSING;let s=new Error(r);Error.captureStackTrace(s,Ke),e.setHeader?(e[N_]=!0,e.abort(),e.socket&&!e.socket.destroyed&&e.socket.destroy(),process.nextTick(Jo,t,s)):(e.destroy(s),e.once("error",t.emit.bind(t,"error")),e.once("close",t.emitClose.bind(t)))}function yd(t,e,r){if(e){let s=JA(e)?e.size:i1(e).length;t._socket?t._sender._bufferedBytes+=s:t._bufferedAmount+=s}if(r){let s=new Error(`WebSocket is not open: readyState ${t.readyState} (${Lt[t.readyState]})`);process.nextTick(r,s)}}function c1(t,e){let r=this[Ee];r._closeFrameReceived=!0,r._closeMessage=e,r._closeCode=t,r._socket[Ee]!==void 0&&(r._socket.removeListener("data",Yo),process.nextTick(P_,r._socket),t===1005?r.close():r.close(t,e))}function u1(){let t=this[Ee];t.isPaused||t._socket.resume()}function f1(t){let e=this[Ee];e._socket[Ee]!==void 0&&(e._socket.removeListener("data",Yo),process.nextTick(P_,e._socket),e.close(t[e1])),e._errorEmitted||(e._errorEmitted=!0,e.emit("error",t))}function I_(){this[Ee].emitClose()}function d1(t,e){this[Ee].emit("message",t,e)}function h1(t){let e=this[Ee];e._autoPong&&e.pong(t,!this._isServer,C_),e.emit("ping",t)}function p1(t){this[Ee].emit("pong",t)}function P_(t){t.resume()}function m1(t){let e=this[Ee];e.readyState!==ie.CLOSED&&(e.readyState===ie.OPEN&&(e._readyState=ie.CLOSING,L_(e)),this._socket.end(),e._errorEmitted||(e._errorEmitted=!0,e.emit("error",t)))}function L_(t){t._closeTimer=setTimeout(t._socket.destroy.bind(t._socket),t._closeTimeout)}function x_(){let t=this[Ee];if(this.removeListener("close",x_),this.removeListener("data",Yo),this.removeListener("end",q_),t._readyState=ie.CLOSING,!this._readableState.endEmitted&&!t._closeFrameReceived&&!t._receiver._writableState.errorEmitted&&this._readableState.length!==0){let e=this.read(this._readableState.length);t._receiver.write(e)}t._receiver.end(),this[Ee]=void 0,clearTimeout(t._closeTimer),t._receiver._writableState.finished||t._receiver._writableState.errorEmitted?t.emitClose():(t._receiver.on("error",I_),t._receiver.on("finish",I_))}function Yo(t){this[Ee]._receiver.write(t)||this.pause()}function q_(){let t=this[Ee];t._readyState=ie.CLOSING,t._receiver.end(),this.end()}function M_(){let t=this[Ee];this.removeListener("error",M_),this.on("error",C_),t&&(t._readyState=ie.CLOSING,this.destroy())}});var F_=w((dq,U_)=>{"use strict";var fq=Xo(),{Duplex:w1}=require("stream");function $_(t){t.emit("close")}function g1(){!this.destroyed&&this._writableState.finished&&this.destroy()}function W_(t){this.removeListener("error",W_),this.destroy(),this.listenerCount("error")===0&&this.emit("error",t)}function y1(t,e){let r=!0,s=new w1({...e,autoDestroy:!1,emitClose:!1,objectMode:!1,writableObjectMode:!1});return t.on("message",function(i,o){let a=!o&&s._readableState.objectMode?i.toString():i;s.push(a)||t.pause()}),t.once("error",function(i){s.destroyed||(r=!1,s.destroy(i))}),t.once("close",function(){s.destroyed||s.push(null)}),s._destroy=function(n,i){if(t.readyState===t.CLOSED){i(n),process.nextTick($_,s);return}let o=!1;t.once("error",function(l){o=!0,i(l)}),t.once("close",function(){o||i(n),process.nextTick($_,s)}),r&&t.terminate()},s._final=function(n){if(t.readyState===t.CONNECTING){t.once("open",function(){s._final(n)});return}t._socket!==null&&(t._socket._writableState.finished?(n(),s._readableState.endEmitted&&s.destroy()):(t._socket.once("finish",function(){n()}),t.close()))},s._read=function(){t.isPaused&&t.resume()},s._write=function(n,i,o){if(t.readyState===t.CONNECTING){t.once("open",function(){s._write(n,i,o)});return}t.send(n,o)},s.on("end",g1),s.on("error",W_),s}U_.exports=y1});var j_=w((hq,z_)=>{"use strict";var{tokenChars:_1}=fs();function S1(t){let e=new Set,r=-1,s=-1,n=0;for(n;n<t.length;n++){let o=t.charCodeAt(n);if(s===-1&&_1[o]===1)r===-1&&(r=n);else if(n!==0&&(o===32||o===9))s===-1&&r!==-1&&(s=n);else if(o===44){if(r===-1)throw new SyntaxError(`Unexpected character at index ${n}`);s===-1&&(s=n);let a=t.slice(r,s);if(e.has(a))throw new SyntaxError(`The "${a}" subprotocol is duplicated`);e.add(a),r=s=-1}else throw new SyntaxError(`Unexpected character at index ${n}`)}if(r===-1||s!==-1)throw new SyntaxError("Unexpected end of input");let i=t.slice(r,n);if(e.has(i))throw new SyntaxError(`The "${i}" subprotocol is duplicated`);return e.add(i),e}z_.exports={parse:S1}});var Y_=w((mq,J_)=>{"use strict";var E1=require("events"),Zo=require("http"),{Duplex:pq}=require("stream"),{createHash:b1}=require("crypto"),V_=pd(),Sr=An(),k1=j_(),v1=Xo(),{CLOSE_TIMEOUT:O1,GUID:D1,kWebSocket:T1}=Nt(),I1=/^[+/0-9A-Za-z]{22}==$/,G_=0,Q_=1,H_=2,_d=class extends E1{constructor(e,r){if(super(),e={allowSynchronousEvents:!0,autoPong:!0,maxPayload:100*1024*1024,skipUTF8Validation:!1,perMessageDeflate:!1,handleProtocols:null,clientTracking:!0,closeTimeout:O1,verifyClient:null,noServer:!1,backlog:null,server:null,host:null,path:null,port:null,WebSocket:v1,...e},e.port==null&&!e.server&&!e.noServer||e.port!=null&&(e.server||e.noServer)||e.server&&e.noServer)throw new TypeError('One and only one of the "port", "server", or "noServer" options must be specified');if(e.port!=null?(this._server=Zo.createServer((s,n)=>{let i=Zo.STATUS_CODES[426];n.writeHead(426,{"Content-Length":i.length,"Content-Type":"text/plain"}),n.end(i)}),this._server.listen(e.port,e.host,e.backlog,r)):e.server&&(this._server=e.server),this._server){let s=this.emit.bind(this,"connection");this._removeListeners=R1(this._server,{listening:this.emit.bind(this,"listening"),error:this.emit.bind(this,"error"),upgrade:(n,i,o)=>{this.handleUpgrade(n,i,o,s)}})}e.perMessageDeflate===!0&&(e.perMessageDeflate={}),e.clientTracking&&(this.clients=new Set,this._shouldEmitClose=!1),this.options=e,this._state=G_}address(){if(this.options.noServer)throw new Error('The server is operating in "noServer" mode');return this._server?this._server.address():null}close(e){if(this._state===H_){e&&this.once("close",()=>{e(new Error("The server is not running"))}),process.nextTick(qn,this);return}if(e&&this.once("close",e),this._state!==Q_)if(this._state=Q_,this.options.noServer||this.options.server)this._server&&(this._removeListeners(),this._removeListeners=this._server=null),this.clients?this.clients.size?this._shouldEmitClose=!0:process.nextTick(qn,this):process.nextTick(qn,this);else{let r=this._server;this._removeListeners(),this._removeListeners=this._server=null,r.close(()=>{qn(this)})}}shouldHandle(e){if(this.options.path){let r=e.url.indexOf("?");if((r!==-1?e.url.slice(0,r):e.url)!==this.options.path)return!1}return!0}handleUpgrade(e,r,s,n){r.on("error",K_);let i=e.headers["sec-websocket-key"],o=e.headers.upgrade,a=+e.headers["sec-websocket-version"];if(e.method!=="GET"){Er(this,e,r,405,"Invalid HTTP method");return}if(o===void 0||o.toLowerCase()!=="websocket"){Er(this,e,r,400,"Invalid Upgrade header");return}if(i===void 0||!I1.test(i)){Er(this,e,r,400,"Missing or invalid Sec-WebSocket-Key header");return}if(a!==13&&a!==8){Er(this,e,r,400,"Missing or invalid Sec-WebSocket-Version header",{"Sec-WebSocket-Version":"13, 8"});return}if(!this.shouldHandle(e)){Mn(r,400);return}let l=e.headers["sec-websocket-protocol"],c=new Set;if(l!==void 0)try{c=k1.parse(l)}catch{Er(this,e,r,400,"Invalid Sec-WebSocket-Protocol header");return}let u=e.headers["sec-websocket-extensions"],f={};if(this.options.perMessageDeflate&&u!==void 0){let d=new Sr(this.options.perMessageDeflate,!0,this.options.maxPayload);try{let p=V_.parse(u);p[Sr.extensionName]&&(d.accept(p[Sr.extensionName]),f[Sr.extensionName]=d)}catch{Er(this,e,r,400,"Invalid or unacceptable Sec-WebSocket-Extensions header");return}}if(this.options.verifyClient){let d={origin:e.headers[`${a===8?"sec-websocket-origin":"origin"}`],secure:!!(e.socket.authorized||e.socket.encrypted),req:e};if(this.options.verifyClient.length===2){this.options.verifyClient(d,(p,m,h,g)=>{if(!p)return Mn(r,m||401,h,g);this.completeUpgrade(f,i,c,e,r,s,n)});return}if(!this.options.verifyClient(d))return Mn(r,401)}this.completeUpgrade(f,i,c,e,r,s,n)}completeUpgrade(e,r,s,n,i,o,a){if(!i.readable||!i.writable)return i.destroy();if(i[T1])throw new Error("server.handleUpgrade() was called more than once with the same socket, possibly due to a misconfiguration");if(this._state>G_)return Mn(i,503);let c=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade",`Sec-WebSocket-Accept: ${b1("sha1").update(r+D1).digest("base64")}`],u=new this.options.WebSocket(null,void 0,this.options);if(s.size){let f=this.options.handleProtocols?this.options.handleProtocols(s,n):s.values().next().value;f&&(c.push(`Sec-WebSocket-Protocol: ${f}`),u._protocol=f)}if(e[Sr.extensionName]){let f=e[Sr.extensionName].params,d=V_.format({[Sr.extensionName]:[f]});c.push(`Sec-WebSocket-Extensions: ${d}`),u._extensions=e}this.emit("headers",c,n),i.write(c.concat(`\r
`).join(`\r
`)),i.removeListener("error",K_),u.setSocket(i,o,{allowSynchronousEvents:this.options.allowSynchronousEvents,maxPayload:this.options.maxPayload,skipUTF8Validation:this.options.skipUTF8Validation}),this.clients&&(this.clients.add(u),u.on("close",()=>{this.clients.delete(u),this._shouldEmitClose&&!this.clients.size&&process.nextTick(qn,this)})),a(u,n)}};J_.exports=_d;function R1(t,e){for(let r of Object.keys(e))t.on(r,e[r]);return function(){for(let s of Object.keys(e))t.removeListener(s,e[s])}}function qn(t){t._state=H_,t.emit("close")}function K_(){this.destroy()}function Mn(t,e,r,s){r=r||Zo.STATUS_CODES[e],s={Connection:"close","Content-Type":"text/html","Content-Length":Buffer.byteLength(r),...s},t.once("finish",t.destroy),t.end(`HTTP/1.1 ${e} ${Zo.STATUS_CODES[e]}\r
`+Object.keys(s).map(n=>`${n}: ${s[n]}`).join(`\r
`)+`\r
\r
`+r)}function Er(t,e,r,s,n,i){if(t.listenerCount("wsClientError")){let o=new Error(n);Error.captureStackTrace(o,Er),t.emit("wsClientError",o,r,e)}else Mn(r,s,n,i)}});var Z_=w((wq,X_)=>{"use strict";var xt=Xo();xt.createWebSocketStream=F_();xt.Server=Y_();xt.Receiver=cd();xt.Sender=dd();xt.WebSocket=xt;xt.WebSocketServer=xt.Server;X_.exports=xt});var nS=w(it=>{"use strict";var C1=it&&it.__createBinding||(Object.create?(function(t,e,r,s){s===void 0&&(s=r);var n=Object.getOwnPropertyDescriptor(e,r);(!n||("get"in n?!e.__esModule:n.writable||n.configurable))&&(n={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,s,n)}):(function(t,e,r,s){s===void 0&&(s=r),t[s]=e[r]})),N1=it&&it.__setModuleDefault||(Object.create?(function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}):function(t,e){t.default=e}),eS=it&&it.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(t!=null)for(var r in t)r!=="default"&&Object.prototype.hasOwnProperty.call(t,r)&&C1(e,t,r);return N1(e,t),e},tS=it&&it.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(it,"__esModule",{value:!0});it.Conductor=void 0;var A1=Ft(),Sd=Oe(),ea=tS(Z_()),M=eS(Jf()),P1=require("node:os"),L1=Js(),x1=tS(require("node:assert")),rS=eS(require("node:zlib")),sS=require("node:util"),q1=(0,sS.promisify)(rS.gzip),M1=(0,sS.promisify)(rS.gunzip),Ed=class{dbosExec;conductorKey;conductorURL;url;websocket=void 0;isShuttingDown=!1;isClosed=!1;pingPeriodMs=2e4;pingTimeoutMs=15e3;pingIntervalTimeout=void 0;reconnectDelayMs=1e3;reconnectTimeout=void 0;constructor(e,r,s){this.dbosExec=e,this.conductorKey=r,this.conductorURL=s;let n=e.appName;(0,x1.default)(n,"Application name must be set in configuration in order to use DBOS Conductor");let i=s.replace(/\/+$/,"");this.url=`${i}/websocket/${n}/${r}`}resetWebsocket(e,r){clearInterval(r?.interval),clearTimeout(r?.timeout),e&&(e.terminate(),this.websocket===e&&(this.websocket=void 0)),!(this.reconnectTimeout||this.isShuttingDown)&&(this.dbosExec.logger.debug(`Reconnecting in ${this.reconnectDelayMs/1e3} second`),this.reconnectTimeout=setTimeout(()=>{this.dispatchLoop()},this.reconnectDelayMs))}setPingInterval(e,r){clearInterval(r.interval),clearTimeout(r.timeout),r.interval=setInterval(()=>{r.timeout=setTimeout(()=>{this.isShuttingDown||this.reconnectTimeout===void 0&&(this.dbosExec.logger.warn("Connection to conductor lost. Reconnecting..."),this.resetWebsocket(e,r))},this.pingTimeoutMs),e.readyState===ea.default.OPEN&&(this.dbosExec.logger.debug("Sending ping to conductor"),e.ping())},this.pingPeriodMs)}dispatchLoop(){if(this.websocket&&(this.websocket.readyState===ea.default.OPEN||this.websocket.readyState===ea.default.CONNECTING)){this.dbosExec.logger.warn("Conductor websocket already exists");return}if(clearTimeout(this.pingIntervalTimeout?.timeout),clearInterval(this.pingIntervalTimeout?.interval),clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0,this.isShuttingDown){this.dbosExec.logger.debug("Not starting dispatch loop as conductor is shutting down");return}try{this.dbosExec.logger.debug(`Connecting to conductor at ${this.url}`);let e=new ea.default(this.url,{handshakeTimeout:5e3});this.websocket=e;let r={interval:void 0,timeout:void 0};this.setPingInterval(e,r),this.pingIntervalTimeout=r,e.on("open",()=>{this.dbosExec.logger.debug("Opened connection to DBOS conductor"),clearTimeout(r.timeout)}),e.on("pong",()=>{this.dbosExec.logger.debug("Received pong from conductor"),clearTimeout(r.timeout)}),e.on("message",async s=>{this.dbosExec.logger.debug(`Received message from conductor: ${s}`);let n=JSON.parse(s),i=n.type,o;switch(clearTimeout(r.timeout),i){case M.MessageType.EXECUTOR_INFO:let a=new M.ExecutorInfoResponse(n.request_id,Sd.globalParams.executorID,Sd.globalParams.appVersion,(0,P1.hostname)(),"typescript",Sd.globalParams.dbosVersion);e.send(JSON.stringify(a)),this.dbosExec.logger.info("Connected to DBOS conductor");break;case M.MessageType.RECOVERY:let l=n,c=!0;try{await this.dbosExec.recoverPendingWorkflows(l.executor_ids)}catch(N){o=`Exception encountered when recovering workflows: ${N.message}`,this.dbosExec.logger.error(o),c=!1}let u=new M.RecoveryResponse(n.request_id,c,o);e.send(JSON.stringify(u));break;case M.MessageType.CANCEL:let f=n,d=!0;try{await this.dbosExec.cancelWorkflow(f.workflow_id)}catch(N){o=`Exception encountered when cancelling workflow ${f.workflow_id}: ${N.message}`,this.dbosExec.logger.error(o),d=!1}let p=new M.CancelResponse(n.request_id,d,o);e.send(JSON.stringify(p));break;case M.MessageType.DELETE:let m=n,h=!0;try{await this.dbosExec.deleteWorkflow(m.workflow_id,m.delete_children??!1)}catch(N){o=`Exception encountered when deleting workflow ${m.workflow_id}: ${N.message}`,this.dbosExec.logger.error(o),h=!1}let g=new M.DeleteResponse(n.request_id,h,o);e.send(JSON.stringify(g));break;case M.MessageType.RESUME:let y=n,E=!0;try{await this.dbosExec.resumeWorkflow(y.workflow_id)}catch(N){o=`Exception encountered when resuming workflow ${y.workflow_id}: ${N.message}`,this.dbosExec.logger.error(o),E=!1}let b=new M.ResumeResponse(n.request_id,E,o);e.send(JSON.stringify(b));break;case M.MessageType.RESTART:let v=n,I=!0;try{await this.dbosExec.forkWorkflow(v.workflow_id,0)}catch(N){o=`Exception encountered when restarting workflow ${v.workflow_id}: ${N.message}`,this.dbosExec.logger.error(o),I=!1}let S=new M.RestartResponse(n.request_id,I,o);e.send(JSON.stringify(S));break;case M.MessageType.FORK_WORKFLOW:let L=n,x=L.body.new_workflow_id;try{x=await this.dbosExec.forkWorkflow(L.body.workflow_id,L.body.start_step,{newWorkflowID:x,applicationVersion:L.body.application_version})}catch(N){o=`Exception encountered when forking workflow ${L.body.workflow_id} to new workflow ${x} on step ${L.body.start_step}, app version ${L.body.application_version}: ${N.message}`,this.dbosExec.logger.error(o),x=void 0}let V=new M.ForkWorkflowResponse(n.request_id,x,o);e.send(JSON.stringify(V));break;case M.MessageType.LIST_WORKFLOWS:let ve=n,K=ve.body,re={workflowIDs:K.workflow_uuids,workflowName:K.workflow_name,authenticatedUser:K.authenticated_user,startTime:K.start_time,endTime:K.end_time,status:K.status,applicationVersion:K.application_version,forkedFrom:K.forked_from,parentWorkflowID:K.parent_workflow_id,queueName:K.queue_name,limit:K.limit,offset:K.offset,sortDesc:K.sort_desc,workflow_id_prefix:K.workflow_id_prefix,loadInput:K.load_input??!1,loadOutput:K.load_output??!1,executorId:K.executor_id,queuesOnly:K.queues_only},Bn=[];try{Bn=(await this.dbosExec.listWorkflows(re)).map(je=>new M.WorkflowsOutput(je))}catch(N){o=`Exception encountered when listing workflows: ${N.message}`,this.dbosExec.logger.error(o)}let ee=new M.ListWorkflowsResponse(ve.request_id,Bn,o);e.send(JSON.stringify(ee));break;case M.MessageType.LIST_QUEUED_WORKFLOWS:let ue=n,G=ue.body,ot={workflowIDs:G.workflow_uuids,workflowName:G.workflow_name,authenticatedUser:G.authenticated_user,startTime:G.start_time,endTime:G.end_time,status:G.status,applicationVersion:G.application_version,forkedFrom:G.forked_from,parentWorkflowID:G.parent_workflow_id,queueName:G.queue_name,limit:G.limit,offset:G.offset,sortDesc:G.sort_desc,workflow_id_prefix:G.workflow_id_prefix,loadInput:G.load_input??!1,loadOutput:G.load_output??!1,executorId:G.executor_id},Ss=[];try{Ss=(await this.dbosExec.listQueuedWorkflows(ot)).map(je=>new M.WorkflowsOutput(je))}catch(N){o=`Exception encountered when listing queued workflows: ${N.message}`,this.dbosExec.logger.error(o)}let sa=new M.ListQueuedWorkflowsResponse(ue.request_id,Ss,o);e.send(JSON.stringify(sa));break;case M.MessageType.GET_WORKFLOW:let nr=n,$n;try{let N=await this.dbosExec.getWorkflowStatus(nr.workflow_id);N&&($n=new M.WorkflowsOutput(N))}catch(N){o=`Exception encountered when getting workflow ${nr.workflow_id}: ${N.message}`,this.dbosExec.logger.error(o)}let SS=new M.GetWorkflowResponse(nr.request_id,$n,o);e.send(JSON.stringify(SS));break;case M.MessageType.EXIST_PENDING_WORKFLOWS:let Cd=n,Nd=!1;try{Nd=(await this.dbosExec.systemDatabase.getPendingWorkflows(Cd.executor_id,Cd.application_version)).length>0}catch(N){o=`Exception encountered when checking for pending workflows: ${N.message}`,this.dbosExec.logger.error(o)}let ES=new M.ExistPendingWorkflowsResponse(n.request_id,Nd,o);e.send(JSON.stringify(ES));break;case M.MessageType.LIST_STEPS:let na=n,Ad;try{Ad=(await this.dbosExec.listWorkflowSteps(na.workflow_id))?.map(je=>new M.WorkflowSteps(je))}catch(N){o=`Exception encountered when listing steps ${na.workflow_id}: ${N.message}`,this.dbosExec.logger.error(o)}let bS=new M.ListStepsResponse(na.request_id,Ad,o);e.send(JSON.stringify(bS));break;case M.MessageType.RETENTION:let Es=n,Pd=!0;try{await this.dbosExec.systemDatabase.garbageCollect(Es.body.gc_cutoff_epoch_ms,Es.body.gc_rows_threshold),Es.body.timeout_cutoff_epoch_ms&&await(0,L1.globalTimeout)(this.dbosExec.systemDatabase,Es.body.timeout_cutoff_epoch_ms)}catch(N){Pd=!1,o=`Exception encountered during enforcing retention policy: ${N.message}`,this.dbosExec.logger.error(o)}let kS=new M.RetentionResponse(Es.request_id,Pd,o);e.send(JSON.stringify(kS));break;case M.MessageType.GET_METRICS:let ir=n;this.dbosExec.logger.debug(`Received metrics request for time range ${ir.start_time} to ${ir.end_time}`);let Ld=[];if(ir.metric_class==="workflow_step_count")try{Ld=(await this.dbosExec.systemDatabase.getMetrics(ir.start_time,ir.end_time)).map(je=>new M.MetricDataOutput(je.metricType,je.metricName,je.value))}catch(N){o=`Exception encountered when getting metrics: ${N.message}`,this.dbosExec.logger.error(o)}else o=`Unexpected metric class: ${ir.metric_class}`,this.dbosExec.logger.warn(o);let vS=new M.GetMetricsResponse(ir.request_id,Ld,o);e.send(JSON.stringify(vS));break;case M.MessageType.EXPORT_WORKFLOW:let ia=n,xd=null;try{let N=await this.dbosExec.systemDatabase.exportWorkflow(ia.workflow_id,ia.export_children??!1);if(N.length>0){let je=JSON.stringify(N);xd=(await q1(je)).toString("base64")}}catch(N){o=`Exception encountered when exporting workflow ${ia.workflow_id}: ${N.message}`,this.dbosExec.logger.error(o)}let OS=new M.ExportWorkflowResponse(n.request_id,xd,o);e.send(JSON.stringify(OS));break;case M.MessageType.IMPORT_WORKFLOW:let DS=n,qd=!0;try{let N=Buffer.from(DS.serialized_workflow,"base64"),je=await M1(N),Bd=JSON.parse(je.toString());await this.dbosExec.systemDatabase.importWorkflow(Bd)}catch(N){o=`Exception encountered when importing workflow: ${N.message}`,this.dbosExec.logger.error(o),qd=!1}let TS=new M.ImportWorkflowResponse(n.request_id,qd,o);e.send(JSON.stringify(TS));break;case M.MessageType.ALERT:let vr=n,Md=!0;try{let N=(0,A1.getAlertHandler)();N?await Promise.resolve(N(vr.name,vr.message,vr.metadata)):this.dbosExec.logger.warn(`Alert received (no handler registered): [${vr.name}] ${vr.message} | Metadata: ${JSON.stringify(vr.metadata)}`)}catch(N){o=`Exception in alert handler: ${N.message}`,this.dbosExec.logger.error(o),Md=!1}let IS=new M.AlertResponse(n.request_id,Md,o);e.send(JSON.stringify(IS));break;default:this.dbosExec.logger.warn(`Unknown message type: ${n.type}`);let RS=new M.BaseResponse(n.type,n.request_id,"Unknown message type");e.send(JSON.stringify(RS))}}),e.on("close",()=>{if(this.isShuttingDown){this.dbosExec.logger.info("Shutdown Conductor connection");return}else this.reconnectTimeout===void 0&&(this.dbosExec.logger.warn("Connection to conductor lost. Reconnecting."),this.resetWebsocket(e,r))}),e.on("unexpected-response",(s,n)=>{this.dbosExec.logger.warn(`Unexpected response from conductor: ${n.statusCode} ${n.statusMessage}}`),this.reconnectTimeout===void 0&&this.resetWebsocket(e,r)}),e.on("error",s=>{this.dbosExec.logger.warn(`Unexpected exception in connection to conductor. Reconnecting: ${s.message}`),this.reconnectTimeout===void 0&&this.resetWebsocket(e,r)})}catch(e){this.dbosExec.logger.warn(`Error in conductor loop. Reconnecting: ${e.message}`),this.reconnectTimeout===void 0&&this.resetWebsocket(this.websocket,this.pingIntervalTimeout)}}stop(){this.isShuttingDown=!0,clearInterval(this.pingIntervalTimeout?.interval),clearTimeout(this.pingIntervalTimeout?.timeout),clearTimeout(this.reconnectTimeout),this.websocket&&this.websocket.close(),this.isClosed=!0}};it.Conductor=Ed});var oS=w(ta=>{"use strict";Object.defineProperty(ta,"__esModule",{value:!0});ta.registerAuthChecker=void 0;var iS=Ui(),bd=Os(),kd=Ft(),B1=He();function $1(t,e){let r=t.getRequiredRoles();if(r.length>0){bd.DBOS.span?.setAttribute("requiredRoles",r);let s=bd.DBOS.authenticatedRoles,n=!1,i=new Set(s);for(let o of r)if(i.has(o)){n=!0,(0,iS.getCurrentContextStore)()&&((0,iS.getCurrentContextStore)().assumedRole=o);break}if(!n){let o=new B1.DBOSNotAuthorizedError(`User does not have a role with permission to call ${t.name}`,403);throw bd.DBOS.span?.addEvent("DBOSNotAuthorizedError",{message:o.message}),o}}return e}var vd=class{installMiddleware(e){let r=e?.defaults?.getRegisteredInfo(kd.DBOS_AUTH),s=e?.getRegisteredInfo(kd.DBOS_AUTH);(r?.requiredRole!==void 0||s?.requiredRole!==void 0)&&e.addEntryInterceptor($1,10)}},W1=new vd;function U1(){(0,kd.registerMiddlewareInstaller)(W1)}ta.registerAuthChecker=U1});var Os=w(bt=>{"use strict";var F1=bt&&bt.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(bt,"__esModule",{value:!0});bt.DBOS=bt.runInternalStep=bt.getExecutor=void 0;var B=Ui(),q=lr(),Od=Ha(),aS=Ir(),z1=ii(),W=He(),ws=Fy(),j1=Mi(),T=Ft(),Pe=Oe(),br=Ot(),lS=Qy(),Dd=require("node:crypto"),V1=nS(),cS=Ii(),uS=Vs(),fS=oS(),dS=F1(require("node:assert"));function hS(){if(!q.DBOSExecutor.globalInstance)throw new W.DBOSExecutorNotInitializedError;return q.DBOSExecutor.globalInstance}bt.getExecutor=hS;function dt(t,e,r,s){if(kr.isWithinWorkflow()){if(kr.isInStep())return t();if(kr.isInWorkflow())return q.DBOSExecutor.globalInstance.runInternalStep(t,e,kr.workflowID,s??(0,B.functionIDGetIncrement)(),r);throw new W.DBOSInvalidWorkflowTransitionError(`Invalid call to \`${e}\` inside a \`transaction\` or \`procedure\``)}return t()}bt.runInternalStep=dt;var kr=class t{static adminServer=void 0;static conductor=void 0;static setConfig(e){(0,dS.default)(!t.isInitialized(),"Cannot call DBOS.setConfig after DBOS.launch"),t.#t=e}static isInitialized(){return!!q.DBOSExecutor.globalInstance?.initialized}static async launch(e){let r=await(0,ws.readConfigFile)(),s=t.#t?(0,ws.translateDbosConfig)(t.#t):(0,ws.getDbosConfig)(r),n=t.#t?(0,ws.translateRuntimeConfig)(t.#t):(0,ws.getRuntimeConfig)(r);if(process.env.DBOS__CLOUD==="true"&&([s,n]=(0,ws.overwriteConfigForDBOSCloud)(s,n,r)),Pe.globalParams.enableOTLP=t.#t?.enableOTLP??(0,Pe.defaultEnableOTLP)(),(0,Od.isTraceContextWorking)()||(0,Od.installTraceContextManager)(s.name),t.isInitialized())return;(0,T.finalizeClassRegistrations)(),(0,T.insertAllMiddleware)(),process.env.DBOS__CLOUD!=="true"&&(t.#t?.applicationVersion?Pe.globalParams.appVersion=t.#t.applicationVersion:t.#t?.enablePatching&&(Pe.globalParams.appVersion="PATCHING_ENABLED"),t.#t?.executorID&&(Pe.globalParams.executorID=t.#t.executorID)),e?.conductorKey&&(Pe.globalParams.executorID=(0,Dd.randomUUID)()),q.DBOSExecutor.createDebouncerWorkflow(),q.DBOSExecutor.createInternalQueue(),q.DBOSExecutor.globalInstance=new q.DBOSExecutor(s),(0,T.recordDBOSLaunch)();let i=q.DBOSExecutor.globalInstance;await i.init(),await q.DBOSExecutor.globalInstance.initEventReceivers(this.#t?.listenQueues||null);for(let[a,l]of T.transactionalDataSources)await l.initialize();if(e?.conductorKey){if(!e.conductorURL){let a=process.env.DBOS_DOMAIN||"cloud.dbos.dev";e.conductorURL=`wss://${a}/conductor/v1alpha1`}t.conductor=new V1.Conductor(q.DBOSExecutor.globalInstance,e.conductorKey,e.conductorURL),t.conductor.dispatchLoop()}let o=t.logger;if(n.runAdminServer){let a=lS.DBOSAdminServer.setupAdminApp(i);try{await lS.DBOSAdminServer.checkPortAvailabilityIPv4Ipv6(n.admin_port,o),t.adminServer=await new Promise((l,c)=>{let u=a.listen(n?.admin_port,()=>{t.logger.debug(`DBOS Admin Server is running at http://localhost:${n?.admin_port}`),l(u)});u.on("error",f=>{c(f)})})}catch{o.warn(`Unable to start DBOS admin server on port ${n.admin_port}`)}}}static logRegisteredEndpoints(){if(q.DBOSExecutor.globalInstance){uS.wfQueueRunner.logRegisteredEndpoints(q.DBOSExecutor.globalInstance);for(let e of(0,T.getLifecycleListeners)())e.logRegisteredEndpoints?.()}}static async shutdown(e){if(t.adminServer&&(t.adminServer.close(),t.adminServer=void 0),t.conductor){for(t.conductor.stop();!t.conductor.isClosed;)await(0,Pe.sleepms)(500);t.conductor=void 0}q.DBOSExecutor.globalInstance&&(await q.DBOSExecutor.globalInstance.deactivateEventReceivers(),await q.DBOSExecutor.globalInstance.destroy(),q.DBOSExecutor.globalInstance=void 0);for(let[r,s]of T.transactionalDataSources)await s.destroy();Pe.globalParams.appVersion=process.env.DBOS__APPVERSION||"",Pe.globalParams.wasComputed=!1,Pe.globalParams.appID=process.env.DBOS__APPID||"",Pe.globalParams.executorID=process.env.DBOS__VMID||"local",(0,T.recordDBOSShutdown)(),e?.deregister&&t.clearRegistry()}static clearRegistry(){(0,dS.default)(!t.isInitialized(),"Cannot call DBOS.clearRegistry after DBOS.launch"),(0,T.clearAllRegistrations)(),uS.wfQueueRunner.clearRegistrations(),q.DBOSExecutor.debouncerWorkflow=void 0,q.DBOSExecutor.internalQueue=void 0}static async deactivateEventReceivers(){return q.DBOSExecutor.globalInstance?.deactivateEventReceivers()}static async initEventReceivers(){return q.DBOSExecutor.globalInstance?.initEventReceivers(this.#t?.listenQueues||null)}static get#e(){return hS()}static#t;static get logger(){let e=(0,B.getCurrentContextStore)();if(e?.logger)return e.logger;let r=q.DBOSExecutor.globalInstance;return r?r.logger:new z1.GlobalLogger}static get tracer(){let e=q.DBOSExecutor.globalInstance;if(e)return e.tracer}static get span(){return(0,Od.getActiveSpan)()}static requestObject(){return(0,B.getCurrentContextStore)()?.request}static getRequest(){return this.requestObject()}static get request(){let e=t.getRequest();if(!e)throw new W.DBOSError("`DBOS.request` accessed from outside of HTTP requests");return e}static get applicationVersion(){return Pe.globalParams.appVersion}static get executorID(){return Pe.globalParams.executorID}static get workflowID(){return(0,B.getCurrentContextStore)()?.workflowId}static get defaultSerializationType(){return(0,B.getCurrentContextStore)()?.serializationType}static get stepID(){return t.isInStep()?(0,B.getCurrentContextStore)()?.curStepFunctionId:t.isInTransaction()?(0,B.getCurrentContextStore)()?.curTxFunctionId:void 0}static get stepStatus(){return(0,B.getCurrentContextStore)()?.stepStatus}static get authenticatedUser(){return(0,B.getCurrentContextStore)()?.authenticatedUser??""}static get authenticatedRoles(){return(0,B.getCurrentContextStore)()?.authenticatedRoles??[]}static get assumedRole(){return(0,B.getCurrentContextStore)()?.assumedRole??""}static isInTransaction(){return(0,B.getCurrentContextStore)()?.curTxFunctionId!==void 0}static isInStep(){return(0,B.getCurrentContextStore)()?.curStepFunctionId!==void 0}static isWithinWorkflow(){return(0,B.getCurrentContextStore)()?.workflowId!==void 0}static isInWorkflow(){return t.isWithinWorkflow()&&!t.isInTransaction()&&!t.isInStep()}static async getEventDispatchState(e,r,s){return(0,T.ensureDBOSIsLaunched)("getEventDispatchState"),await t.#e.getEventDispatchState(e,r,s)}static async upsertEventDispatchState(e){return(0,T.ensureDBOSIsLaunched)("upsertEventDispatchState"),await t.#e.upsertEventDispatchState(e)}static getWorkflowStatus(e){if((0,T.ensureDBOSIsLaunched)("getWorkflowStatus"),t.isWithinWorkflow()){if(t.isInStep())return t.#e.getWorkflowStatus(e);if(t.isInWorkflow())return t.#e.getWorkflowStatus(e,t.workflowID,(0,B.functionIDGetIncrement)());throw new W.DBOSInvalidWorkflowTransitionError("Invalid call to `getWorkflowStatus` inside a `transaction` or `procedure`")}return t.#e.getWorkflowStatus(e)}static async getResult(e,r){(0,T.ensureDBOSIsLaunched)("getResult");let s;return t.isWithinWorkflow()&&r!==void 0&&(s=(0,B.functionIDGetIncrement)()),await t.getResultInternal(e,r,s,void 0)}static async getResultInternal(e,r,s,n){return await dt(async()=>{let i=await q.DBOSExecutor.globalInstance.systemDatabase.awaitWorkflowResult(e,r,t.workflowID,s);if(!i)return null;if(i?.cancelled)throw new W.DBOSAwaitedWorkflowCancelledError(e);if(i?.maxRecoveryAttemptsExceeded)throw new W.DBOSAwaitedWorkflowExceededMaxRecoveryAttempts(e);return q.DBOSExecutor.reviveResultOrError(i,t.#e.serializer)},"DBOS.getResult",e,n)}static retrieveWorkflow(e){if((0,T.ensureDBOSIsLaunched)("retrieveWorkflow"),t.isWithinWorkflow()){if(!t.isInWorkflow())throw new W.DBOSInvalidWorkflowTransitionError("Invalid call to `retrieveWorkflow` inside a `transaction` or `step`");return new aS.RetrievedHandle(q.DBOSExecutor.globalInstance.systemDatabase,e)}return t.#e.retrieveWorkflow(e)}static async listWorkflows(e){return(0,T.ensureDBOSIsLaunched)("listWorkflows"),await dt(async()=>await t.#e.listWorkflows(e),"DBOS.listWorkflows")}static async listQueuedWorkflows(e){return(0,T.ensureDBOSIsLaunched)("listQueuedWorkflows"),await dt(async()=>await t.#e.listQueuedWorkflows(e),"DBOS.listQueuedWorkflows")}static async listWorkflowSteps(e){return(0,T.ensureDBOSIsLaunched)("listWorkflowSteps"),await dt(async()=>await t.#e.listWorkflowSteps(e),"DBOS.listWorkflowSteps")}static async cancelWorkflow(e){return(0,T.ensureDBOSIsLaunched)("cancelWorkflow"),await dt(async()=>await t.#e.cancelWorkflow(e),"DBOS.cancelWorkflow")}static async resumeWorkflow(e){return(0,T.ensureDBOSIsLaunched)("resumeWorkflow"),await dt(async()=>await t.#e.resumeWorkflow(e),"DBOS.resumeWorkflow"),this.retrieveWorkflow(e)}static async deleteWorkflow(e,r=!1){return(0,T.ensureDBOSIsLaunched)("deleteWorkflow"),await dt(async()=>await t.#e.deleteWorkflow(e,r),"DBOS.deleteWorkflow")}static async forkWorkflow(e,r,s){(0,T.ensureDBOSIsLaunched)("forkWorkflow");let n=await dt(async()=>await t.#e.forkWorkflow(e,r,s),"DBOS.forkWorkflow");return this.retrieveWorkflow(n)}static async sleepms(e){if(t.isWithinWorkflow()&&!t.isInStep()){if(t.isInTransaction())throw new W.DBOSInvalidWorkflowTransitionError("Invalid call to `DBOS.sleep` inside a `transaction`");let r=(0,B.functionIDGetIncrement)();return e<=0?void 0:await q.DBOSExecutor.globalInstance.systemDatabase.durableSleepms(t.workflowID,r,e)}await(0,Pe.sleepms)(e)}static async sleepSeconds(e){return t.sleepms(e*1e3)}static async sleep(e){return t.sleepms(e)}static async now(){return t.isInWorkflow()?dt(async()=>Promise.resolve(Date.now()),"DBOS.now"):Date.now()}static async randomUUID(){return t.isInWorkflow()?dt(async()=>Promise.resolve((0,Dd.randomUUID)()),"DBOS.randomUUID"):(0,Dd.randomUUID)()}static async withNextWorkflowID(e,r){return(0,T.ensureDBOSIsLaunched)("workflows"),t.#r({idAssignedForNextWorkflow:e},r)}static async withAuthedContext(e,r,s){return(0,T.ensureDBOSIsLaunched)("auth"),t.#r({authenticatedUser:e,authenticatedRoles:r},s)}static async withNamedContext(e,r){return(0,T.ensureDBOSIsLaunched)("tracing"),t.#r({operationCaller:e},r)}static async withWorkflowQueue(e,r){return(0,T.ensureDBOSIsLaunched)("workflows"),t.#r({queueAssignedForWorkflows:e},r)}static async withWorkflowTimeout(e,r){return(0,T.ensureDBOSIsLaunched)("workflows"),t.#r({workflowTimeoutMS:e},r)}static async runWithContext(e,r){return(0,T.ensureDBOSIsLaunched)("contexts"),t.#r(e,r)}static async#r(e,r){let s=(0,B.getCurrentContextStore)();if(s){let n={};for(let i of Object.keys(e))Object.hasOwn(s,i)&&(n[i]=e[i]),s[i]=e[i];try{return await r()}finally{for(let i of Object.keys(e))Object.hasOwn(n,i)?s[i]=n[i]:delete s[i]}}else return await(0,B.runWithTopContext)(e,r)}static startWorkflow(e,r){(0,T.ensureDBOSIsLaunched)("workflows");let s=typeof e=="function"?null:e;if(s&&typeof s!="function"&&!(s instanceof T.ConfiguredInstance))throw new W.DBOSInvalidWorkflowTransitionError("Attempt to call `startWorkflow` on an object that is not a `ConfiguredInstance`");if(r&&r.queueName){let o=this.#e.getQueueByName(r.queueName),a=r.enqueueOptions?.queuePartitionKey;if(o.partitionQueue&&!a)throw Error(`A workflow cannot be enqueued on partitioned queue ${r.queueName} without a partition key`);if(a&&!o.partitionQueue)throw Error(`You can only use a partition key on a partition-enabled queue. Key ${a} was used with non-partitioned queue ${r.queueName}`);if(a&&r.enqueueOptions?.deduplicationID)throw Error("Deduplication is not supported for partitioned queues")}let n=(0,T.getRegisteredOperations)(e),i={apply(o,a,l){let c=(0,T.getFunctionRegistration)(o);if(!c){let u=typeof o=="function"?o.name:o.toString();throw new W.DBOSNotRegisteredError(u,`${u} is not a registered DBOS workflow function`)}return t.#s(s,c,l,r)},get(o,a,l){let c=Reflect.get(o,a,l),u=(0,T.getFunctionRegistration)(c)??n.find(d=>d.name===a);if(u)return(...d)=>t.#s(s,u,d,r);let f=typeof a=="string"?a:String(a);throw new W.DBOSNotRegisteredError(f,`${f} is not a registered DBOS workflow function`)}};return new Proxy(e,i)}static async send(e,r,s,n,i){if((0,T.ensureDBOSIsLaunched)("send"),t.isWithinWorkflow()){if(!t.isInWorkflow())throw new W.DBOSInvalidWorkflowTransitionError("Invalid call to `DBOS.send` inside a `step` or `transaction`");if(n)throw new W.DBOSInvalidWorkflowTransitionError("Invalid call to `DBOS.send` with an idempotency key from within a workflow");let o=(0,B.functionIDGetIncrement)(),a=(0,br.serializeValue)(r,t.#e.serializer,i?.serializationType??t.defaultSerializationType);return await q.DBOSExecutor.globalInstance.systemDatabase.send(t.workflowID,o,e,a.serializedValue,s,a.serialization)}return t.#e.runSendTempWF(e,r,s,n,i?.serializationType??t.defaultSerializationType)}static async recv(e,r){if((0,T.ensureDBOSIsLaunched)("recv"),t.isWithinWorkflow()){if(!t.isInWorkflow())throw new W.DBOSInvalidWorkflowTransitionError("Invalid call to `DBOS.recv` inside a `step` or `transaction`");let s=(0,B.functionIDGetIncrement)(),n=(0,B.functionIDGetIncrement)(),i=await q.DBOSExecutor.globalInstance.systemDatabase.recv(t.workflowID,s,n,e,r);return(0,br.deserializeValue)(i.serializedValue,i.serialization,t.#e.serializer)}throw new W.DBOSInvalidWorkflowTransitionError("Attempt to call `DBOS.recv` outside of a workflow")}static async setEvent(e,r,s){if((0,T.ensureDBOSIsLaunched)("setEvent"),t.isWithinWorkflow()){if(!t.isInWorkflow())throw new W.DBOSInvalidWorkflowTransitionError("Invalid call to `DBOS.setEvent` inside a `step` or `transaction`");let n=(0,B.functionIDGetIncrement)(),i=(0,br.serializeValue)(r,t.#e.serializer,s?.serializationType??t.defaultSerializationType);return q.DBOSExecutor.globalInstance.systemDatabase.setEvent(t.workflowID,n,e,i.serializedValue,i.serialization)}throw new W.DBOSInvalidWorkflowTransitionError("Attempt to call `DBOS.setEvent` outside of a workflow")}static async getEvent(e,r,s){if((0,T.ensureDBOSIsLaunched)("getEvent"),t.isWithinWorkflow()){if(!t.isInWorkflow())throw new W.DBOSInvalidWorkflowTransitionError("Invalid call to `DBOS.getEvent` inside a `step` or `transaction`");let n=(0,B.functionIDGetIncrement)(),i=(0,B.functionIDGetIncrement)(),o={workflowID:t.workflowID,functionID:n,timeoutFunctionID:i},a=await q.DBOSExecutor.globalInstance.systemDatabase.getEvent(e,r,s??q.DBOSExecutor.defaultNotificationTimeoutSec,o);return(0,br.deserializeValue)(a.serializedValue,a.serialization,t.#e.serializer)}return t.#e.getEvent(e,r,s)}static async writeStream(e,r,s={}){if((0,T.ensureDBOSIsLaunched)("writeStream"),t.isWithinWorkflow()){let n=(0,br.serializeValue)(r,t.#e.serializer,s.serializationType??t.defaultSerializationType);if(t.isInWorkflow()){let i=(0,B.functionIDGetIncrement)();return await q.DBOSExecutor.globalInstance.systemDatabase.writeStreamFromWorkflow(t.workflowID,i,e,n.serializedValue,n.serialization,cS.DBOS_FUNCNAME_WRITESTREAM)}else{if(t.isInStep())return await q.DBOSExecutor.globalInstance.systemDatabase.writeStreamFromStep(t.workflowID,t.stepID,e,n.serializedValue,n.serialization);throw new W.DBOSInvalidWorkflowTransitionError("Invalid call to `DBOS.writeStream` outside of a workflow or step")}}else throw new W.DBOSInvalidWorkflowTransitionError("Invalid call to `DBOS.writeStream` outside of a workflow or step")}static async closeStream(e){if((0,T.ensureDBOSIsLaunched)("closeStream"),t.isWithinWorkflow())if(t.isInWorkflow()){let r=(0,B.functionIDGetIncrement)();return await q.DBOSExecutor.globalInstance.systemDatabase.closeStream(t.workflowID,r,e)}else throw new W.DBOSInvalidWorkflowTransitionError("Invalid call to `DBOS.closeStream` outside of a workflow or step");else throw new W.DBOSInvalidWorkflowTransitionError("Invalid call to `DBOS.closeStream` outside of a workflow")}static async*readStream(e,r){(0,T.ensureDBOSIsLaunched)("readStream");let s=0;for(;;)try{let n=await q.DBOSExecutor.globalInstance.systemDatabase.readStream(e,r,s);if(n.serializedValue===cS.DBOS_STREAM_CLOSED_SENTINEL)break;yield(0,br.deserializeValue)(n.serializedValue,n.serialization,q.DBOSExecutor.globalInstance.serializer),s+=1}catch(n){if(n instanceof Error&&n.message.includes("No value found")){let i=await t.getWorkflowStatus(e);if(!i||!(0,aS.isWorkflowActive)(i.status))break;await(0,Pe.sleepms)(1e3);continue}throw n}}static registerScheduled(e,r){j1.ScheduledReceiver.registerScheduled(e,r)}static className(e){function r(s){let n=(0,T.getClassRegistration)(s,!0);if(n.reg?.name&&n.reg.name!==e&&n.reg.name!==s.name)throw new W.DBOSConflictingRegistrationError(`Attempt to assign name ${e} to class ${s.name}, which has already been aliased to ${n.reg.name}`);n.reg.name=e}return r}static scheduled(e){function r(s,n,i){return i.value&&t.registerScheduled(i.value,{...e,ctorOrProto:s,name:String(n)}),i}return r}static workflow(e={}){function r(s,n,i){let{descriptor:o,registration:a}=(0,T.wrapDBOSFunctionAndRegisterByTarget)(s,n,e.name??n,i),l=t.#n(a,e);return o.value=l,a.wrappedFunction=l,(0,T.registerFunctionWrapper)(l,a),o}return r}static registerWorkflow(e,r){let s=(0,T.wrapDBOSFunctionAndRegisterByUniqueName)(r?.ctorOrProto,r?.className,r?.name??e.name,r?.name??e.name,e);return t.#n(s,r)}static async#s(e,r,s,n={},i){(0,T.ensureDBOSIsLaunched)("workflows");let o=(0,B.getNextWFID)(n.workflowID),a=(0,B.getCurrentContextStore)(),l=n.queueName??a?.queueAssignedForWorkflows,c=n.timeoutMS??a?.workflowTimeoutMS,u=e===void 0||typeof e=="function"?void 0:e;if(u&&!(u instanceof T.ConfiguredInstance))throw new W.DBOSInvalidWorkflowTransitionError("Attempt to call a `workflow` function on an object that is not a `ConfiguredInstance`");if(t.isWithinWorkflow()){if(!t.isInWorkflow())throw new W.DBOSInvalidWorkflowTransitionError("Invalid call to a `workflow` function from within a `step` or `transaction`");let d=i??(0,B.functionIDGetIncrement)(),p=(0,B.getCurrentContextStore)(),m=p.workflowId,h={workflowUUID:o||m+"-"+d,configuredInstance:u,queueName:l,timeoutMS:c,deadlineEpochMS:n.timeoutMS===null||p?.workflowTimeoutMS===null?void 0:p?.deadlineEpochMS,enqueueOptions:n.enqueueOptions};return await f(h,m,d)}else{let d={workflowUUID:o,queueName:l,enqueueOptions:n.enqueueOptions,configuredInstance:u,timeoutMS:c};return await f(d,void 0,void 0)}function f(d,p,m){if(r.workflowConfig){let h=r.registeredFunction;return q.DBOSExecutor.globalInstance.internalWorkflow(h,d,p,m,...s)}if(r.stepConfig){let h=r.registeredFunction;return q.DBOSExecutor.globalInstance.startStepTempWF(h,d,p,m,...s)}throw new W.DBOSNotRegisteredError(r.name,`${r.name} is not a registered DBOS workflow, step, or transaction function`)}}static#n(e,r){e.setWorkflowConfig(r??{});let s=async function(...n){if((0,T.ensureDBOSIsLaunched)("workflows"),t.isInWorkflow()){let o=(0,B.functionIDGetIncrement)(),a=(0,B.functionIDGetIncrement)();return await(await t.#s(this,e,n,void 0,o)).getResult(a)}return await(await t.#s(this,e,n)).getResult()};return(0,T.registerFunctionWrapper)(s,e),Object.defineProperty(s,"name",{value:e.name}),s}static step(e={}){function r(s,n,i){let{descriptor:o,registration:a}=(0,T.wrapDBOSFunctionAndRegisterByTarget)(s,n,e.name,i);a.setStepConfig(e);let l=async function(...c){(0,T.ensureDBOSIsLaunched)("steps");let u;if(!(this===void 0||typeof this=="function")){if(u=this,!(u instanceof T.ConfiguredInstance))throw new W.DBOSInvalidWorkflowTransitionError("Attempt to call a `step` function on an object that is not a `ConfiguredInstance`")}if(t.isWithinWorkflow()){if(t.isInTransaction())throw new W.DBOSInvalidWorkflowTransitionError("Invalid call to a `step` function from within a `transaction`");return t.isInStep()?a.registeredFunction.call(this,...c):await q.DBOSExecutor.globalInstance.callStepFunction(a.registeredFunction,void 0,void 0,u??null,...c)}let f=(0,B.getNextWFID)(void 0),d={configuredInstance:u,workflowUUID:f};return await t.#e.runStepTempWF(a.registeredFunction,d,...c)};return o.value=l,a.wrappedFunction=l,(0,T.registerFunctionWrapper)(l,a),Object.defineProperty(l,"name",{value:a.name}),o}return r}static registerStep(e,r={}){let s=r.name??e.name,n=(0,T.wrapDBOSFunctionAndRegister)(r?.ctorOrProto,r?.className,s,s,e),i=async function(...o){(0,T.ensureDBOSIsLaunched)("steps");let a=this,l=n.registeredFunction??n.origFunction;if(t.isWithinWorkflow()){if(t.isInTransaction())throw new W.DBOSInvalidWorkflowTransitionError("Invalid call to a `step` function from within a `transaction`");return t.isInStep()?l.call(this,...o):await q.DBOSExecutor.globalInstance.callStepFunction(l,s,r,a??null,...o)}if((0,B.getNextWFID)(void 0))throw new W.DBOSInvalidWorkflowTransitionError(`Invalid call to step '${s}' outside of a workflow; with directive to start a workflow.`);return l.call(this,...o)};return(0,T.registerFunctionWrapper)(i,n),Object.defineProperty(i,"name",{value:s}),i}static runStep(e,r={}){(0,T.ensureDBOSIsLaunched)("steps");let s=r.name??e.name;if(t.isWithinWorkflow()){if(t.isInTransaction())throw new W.DBOSInvalidWorkflowTransitionError("Invalid call to a runStep from within a `transaction`");return t.isInStep()?e():q.DBOSExecutor.globalInstance.callStepFunction(e,s,r,null)}if((0,B.getNextWFID)(void 0))throw new W.DBOSInvalidWorkflowTransitionError(`Invalid call to step '${s}' outside of a workflow; with directive to start a workflow.`);return e()}static registerSerialization(e){if(t.isInitialized())throw new TypeError("Serializers/deserializers should not be registered after DBOS.launch()");(0,br.registerSerializationRecipe)(e)}static defaultRequiredRole(e){function r(s){let n=(0,T.associateClassWithExternal)(T.DBOS_AUTH,s);n.requiredRole=e,(0,fS.registerAuthChecker)()}return r}static requiredRole(e){function r(s,n,i){let o=(0,T.associateMethodWithExternal)(T.DBOS_AUTH,s,void 0,n.toString(),i.value);return o.regInfo.requiredRole=e,(0,fS.registerAuthChecker)(),i.value=o.registration.wrappedFunction??o.registration.registeredFunction,i}return r}static async patch(e){if(!t.isInWorkflow())throw new W.DBOSInvalidWorkflowTransitionError("`DBOS.patch` must be called from a workflow, and not within a step");if(!t.#t?.enablePatching)throw new W.DBOSInvalidWorkflowTransitionError("Patching is not enabled.  See `enablePatching` in `DBOSConfig`");let r=await q.DBOSExecutor.globalInstance.systemDatabase.checkPatch(t.workflowID,(0,B.functionIDGet)(),e,!1);return r.hasEntry&&(0,B.functionIDGetIncrement)(),r.isPatched}static async deprecatePatch(e){if(!t.isInWorkflow())throw new W.DBOSInvalidWorkflowTransitionError("`DBOS.deprecatePatch` must be called from a workflow, and not within a step");if(!t.#t?.enablePatching)throw new W.DBOSInvalidWorkflowTransitionError("Patching is not enabled.  See `enablePatching` in `DBOSConfig`");let r=await q.DBOSExecutor.globalInstance.systemDatabase.checkPatch(t.workflowID,(0,B.functionIDGet)(),e,!0);return r.hasEntry&&(0,B.functionIDGetIncrement)(),r.isPatched}static registerLifecycleCallback(e){(0,T.registerLifecycleCallback)(e)}static registerMiddlewareInstaller(e){(0,T.registerMiddlewareInstaller)(e)}static associateClassWithInfo(e,r){return(0,T.associateClassWithExternal)(e,r)}static associateFunctionWithInfo(e,r,s){return(0,T.associateMethodWithExternal)(e,s.ctorOrProto,s.className,s.name??r.name,r)}static associateParamWithInfo(e,r,s){return(0,T.associateParameterWithExternal)(e,s.ctorOrProto,s.className,s.name??r?.name??"<unknown>",r,s.param)}static getAssociatedInfo(e,r,s){return(0,T.getRegistrationsForExternal)(e,r,s)}static setAlertHandler(e){if(t.isInitialized())throw new W.DBOSError("Cannot set alert handler after DBOS.launch()");if((0,T.getAlertHandler)())throw new W.DBOSError("Alert handler is already registered. Only one handler is allowed.");(0,T.setAlertHandler)(e)}};bt.DBOS=kr});var pS=w(_s=>{"use strict";Object.defineProperty(_s,"__esModule",{value:!0});_s.DBOSClient=_s.ClientHandle=void 0;var Td=Ii(),G1=ii(),Id=require("node:crypto"),ra=Ir(),Q1=Oe(),sr=Ot(),gs=Js(),K1=lr(),H1=He(),ys=class{systemDatabase;workflowUUID;constructor(e,r){this.systemDatabase=e,this.workflowUUID=r}getWorkflowUUID(){return this.workflowUUID}get workflowID(){return this.workflowUUID}async getStatus(){let e=await this.systemDatabase.getWorkflowStatus(this.workflowUUID);return e?(0,gs.toWorkflowStatus)(e,this.systemDatabase.getSerializer()):null}async getResult(){let e=await this.systemDatabase.awaitWorkflowResult(this.workflowID);if(e?.cancelled)throw new H1.DBOSAwaitedWorkflowCancelledError(this.workflowID);return K1.DBOSExecutor.reviveResultOrError(e,this.systemDatabase.getSerializer())}async getWorkflowInputs(){let e=await this.systemDatabase.getWorkflowStatus(this.workflowUUID);return(0,sr.deserializePositionalArgs)(e.input,e.serialization,this.systemDatabase.getSerializer())}};_s.ClientHandle=ys;var Rd=class t{serializer;logger;systemDatabase;constructor(e,r,s){this.serializer=s,this.logger=new G1.GlobalLogger,this.systemDatabase=new Td.PostgresSystemDatabase(e,this.logger,s,Td.DEFAULT_POOL_SIZE,r)}static async create({systemDatabaseUrl:e,systemDatabasePool:r,serializer:s}){let n=new t(e,r,s??sr.DBOSJSON);return Promise.resolve(n)}async destroy(){await this.systemDatabase.destroy()}async enqueue(e,...r){let{workflowName:s,workflowClassName:n,workflowConfigName:i,queueName:o,appVersion:a}=e,l=e.workflowID??(0,Id.randomUUID)(),c=(0,sr.serializeArgs)(r,void 0,this.serializer,e?.serializationType),u={workflowUUID:l,status:ra.StatusString.ENQUEUED,workflowName:s,workflowClassName:n??"",workflowConfigName:i??"",queueName:o,authenticatedUser:"",output:null,error:null,assumedRole:"",authenticatedRoles:[],request:{},executorId:"",applicationVersion:a,applicationID:"",createdAt:Date.now(),timeoutMS:e.workflowTimeoutMS,deadlineEpochMS:void 0,input:c.serializedValue,deduplicationID:e.deduplicationID,priority:e.priority??0,queuePartitionKey:e.queuePartitionKey,serialization:c.serialization};return await this.systemDatabase.initWorkflowStatus(u,null),new ys(this.systemDatabase,l)}async enqueuePortable(e,r,s){let{workflowName:n,workflowClassName:i,workflowConfigName:o,queueName:a,appVersion:l}=e,c=e.workflowID??(0,Id.randomUUID)(),u=(0,sr.serializeArgs)(r,s,this.serializer,e?.serializationType??"portable"),f={workflowUUID:c,status:ra.StatusString.ENQUEUED,workflowName:n,workflowClassName:i??"",workflowConfigName:o??"",queueName:a,authenticatedUser:"",output:null,error:null,assumedRole:"",authenticatedRoles:[],request:{},executorId:"",applicationVersion:l,applicationID:"",createdAt:Date.now(),timeoutMS:e.workflowTimeoutMS,deadlineEpochMS:void 0,input:u.serializedValue,deduplicationID:e.deduplicationID,priority:e.priority??0,queuePartitionKey:e.queuePartitionKey,serialization:u.serialization};return await this.systemDatabase.initWorkflowStatus(f,null),new ys(this.systemDatabase,c)}async send(e,r,s,n,i){n??=(0,Id.randomUUID)();let o=(0,sr.serializeValue)(r,this.serializer,i?.serializationType),a=(0,sr.serializeArgs)([e,r,s,i?.serializationType],void 0,this.serializer,i?.serializationType),l={workflowUUID:`${e}-${n}`,status:ra.StatusString.SUCCESS,workflowName:"temp_workflow-send-client",workflowClassName:"",workflowConfigName:"",authenticatedUser:"",output:null,error:null,assumedRole:"",authenticatedRoles:[],request:{},executorId:"",applicationID:"",createdAt:Date.now(),input:a.serializedValue,deduplicationID:void 0,priority:0,queuePartitionKey:void 0,serialization:a.serialization};await this.systemDatabase.initWorkflowStatus(l,null),await this.systemDatabase.send(l.workflowUUID,0,e,o.serializedValue,s,o.serialization)}async getEvent(e,r,s){let n=await this.systemDatabase.getEvent(e,r,s??60);return(0,sr.deserializeValue)(n.serializedValue,n.serialization,this.serializer)}retrieveWorkflow(e){return new ys(this.systemDatabase,e)}cancelWorkflow(e){return this.systemDatabase.cancelWorkflow(e)}resumeWorkflow(e){return this.systemDatabase.resumeWorkflow(e)}forkWorkflow(e,r,s){return(0,gs.forkWorkflow)(this.systemDatabase,e,r,s)}getWorkflow(e){return(0,gs.getWorkflow)(this.systemDatabase,e)}listWorkflows(e){return(0,gs.listWorkflows)(this.systemDatabase,e)}listQueuedWorkflows(e){return(0,gs.listQueuedWorkflows)(this.systemDatabase,e)}listWorkflowSteps(e){return(0,gs.listWorkflowSteps)(this.systemDatabase,e)}async*readStream(e,r){let s=0;for(;;)try{let n=await this.systemDatabase.readStream(e,r,s);if(n.serializedValue===Td.DBOS_STREAM_CLOSED_SENTINEL)break;yield(0,sr.deserializeValue)(n.serializedValue,n.serialization,this.serializer),s+=1}catch(n){if(n instanceof Error&&n.message.includes("No value found")){let i=await this.getWorkflow(e);if(!i||!(0,ra.isWorkflowActive)(i.status))break;await(0,Q1.sleepms)(1e3);continue}throw n}}};_s.DBOSClient=Rd});var Ks=w(F=>{"use strict";var J1=F&&F.__createBinding||(Object.create?(function(t,e,r,s){s===void 0&&(s=r);var n=Object.getOwnPropertyDescriptor(e,r);(!n||("get"in n?!e.__esModule:n.writable||n.configurable))&&(n={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,s,n)}):(function(t,e,r,s){s===void 0&&(s=r),t[s]=e[r]})),Y1=F&&F.__setModuleDefault||(Object.create?(function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}):function(t,e){t.default=e}),X1=F&&F.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(t!=null)for(var r in t)r!=="default"&&Object.prototype.hasOwnProperty.call(t,r)&&J1(e,t,r);return Y1(e,t),e};Object.defineProperty(F,"__esModule",{value:!0});F.MethodParameter=F.ConfiguredInstance=F.DebouncerClient=F.Debouncer=F.StatusString=F.DBOSWorkflowConflictError=F.Error=F.WorkflowQueue=F.ArgName=F.DBOSDataType=F.SchedulerMode=F.DBOSClient=F.DBOS=void 0;var Z1=Os();Object.defineProperty(F,"DBOS",{enumerable:!0,get:function(){return Z1.DBOS}});var eP=pS();Object.defineProperty(F,"DBOSClient",{enumerable:!0,get:function(){return eP.DBOSClient}});var tP=Mi();Object.defineProperty(F,"SchedulerMode",{enumerable:!0,get:function(){return tP.SchedulerMode}});var mS=Ft();Object.defineProperty(F,"DBOSDataType",{enumerable:!0,get:function(){return mS.DBOSDataType}});Object.defineProperty(F,"ArgName",{enumerable:!0,get:function(){return mS.ArgName}});var rP=Vs();Object.defineProperty(F,"WorkflowQueue",{enumerable:!0,get:function(){return rP.WorkflowQueue}});F.Error=X1(He());var sP=He();Object.defineProperty(F,"DBOSWorkflowConflictError",{enumerable:!0,get:function(){return sP.DBOSWorkflowConflictError}});var nP=Ir();Object.defineProperty(F,"StatusString",{enumerable:!0,get:function(){return nP.StatusString}});var wS=Rc();Object.defineProperty(F,"Debouncer",{enumerable:!0,get:function(){return wS.Debouncer}});Object.defineProperty(F,"DebouncerClient",{enumerable:!0,get:function(){return wS.DebouncerClient}});var gS=Ft();Object.defineProperty(F,"ConfiguredInstance",{enumerable:!0,get:function(){return gS.ConfiguredInstance}});Object.defineProperty(F,"MethodParameter",{enumerable:!0,get:function(){return gS.MethodParameter}})});var _S=qS(Ks()),yS=process.argv[2];function ke(t,e,r){let s=JSON.stringify(t),n=JSON.stringify(e);if(s!==n)throw new Error(`${r}: expected ${n}, got ${s}`)}async function iP(){console.log(`Using DB URL: ${yS}`);let t=await _S.DBOSClient.create({systemDatabaseUrl:yS});try{let e=await t.enqueuePortable({workflowName:"workflowPortable",workflowClassName:"workflows",queueName:"testq"},["s",1,{k:"k",v:["v"]}]);await t.send(e.workflowID,"m","incoming",void 0,{serializationType:"portable"});let r=0;ke(await t.getEvent(e.workflowID,"defstat",2),{status:"Happy"},"defstat event");try{ke(await t.getEvent(e.workflowID,"nstat",2),{status:"Happy"},"nstat event")}catch(a){if(++r,!a.message.includes("deserialization type py_pickle is not available"))throw a}ke(await t.getEvent(e.workflowID,"pstat",2),{status:"Happy"},"pstat event");let{value:s}=await t.readStream(e.workflowID,"defstream").next();ke(s,{stream:"OhYeah"},"defstream value");try{let{value:a}=await t.readStream(e.workflowID,"nstream").next();ke(a,{stream:"OhYeah"},"nstream value")}catch(a){if(++r,!a.message.includes("deserialization type py_pickle is not available"))throw a}let{value:n}=await t.readStream(e.workflowID,"pstream").next();if(ke(n,{stream:"OhYeah"},"pstream value"),ke(await e.getResult(),'s-1-k:v@"m"',"basic workflow result"),r!==2)throw new Error("Expected 2 deserialization errors");console.log("Basic types test passed."),console.log("Testing rich types...");let i=await t.enqueuePortable({workflowName:"workflowRichTypes",workflowClassName:"workflows",queueName:"testq"},[new Date("2025-06-15T10:30:00Z"),[1,"two",[3,4],{nested:!0},null,3.14],{a:1,b:{c:[2,3]},d:"hello",e:null}]);await t.send(i.workflowID,{timestamp:new Date("2025-01-01T00:00:00Z"),data:[1,{x:"y"}]},"rich_incoming",void 0,{serializationType:"portable"}),ke(await t.getEvent(i.workflowID,"date_event",10),"2025-06-15T10:30:00.000Z","date_event"),ke(await t.getEvent(i.workflowID,"array_event",10),[1,"two",[3,4],{nested:!0},null,3.14],"array_event"),ke(await t.getEvent(i.workflowID,"map_event",10),{a:1,b:{c:[2,3]},d:"hello",e:null},"map_event");let o=await i.getResult();ke(o.date_echo,"2025-06-15T10:30:00.000Z","date_echo"),ke(o.date_obj,"2025-06-15T10:30:00.000Z","date_obj"),ke(o.items,[1,"two",[3,4],{nested:!0},null,3.14],"items echo"),ke(o.items_count,6,"items_count"),ke(o.nested,{a:1,b:{c:[2,3]},d:"hello",e:null},"nested echo"),ke(o.nested_keys,["a","b","d","e"],"nested_keys"),ke(o.received_msg,{timestamp:"2025-01-01T00:00:00.000Z",data:[1,{x:"y"}]},"received_msg"),console.log("Rich types test passed!")}finally{await t.destroy()}}iP().then(()=>{}).catch(t=>{console.error(t),process.exit(1)});
